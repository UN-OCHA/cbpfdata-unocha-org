(()=>{(function(){let sn=window.navigator.userAgent.indexOf("MSIE")>-1||window.navigator.userAgent.indexOf("Trident")>-1,Pe=window.fetch,Ae=window.URLSearchParams,Nn=window.matchMedia("(pointer: coarse)").matches&&!window.matchMedia("(any-pointer: fine)").matches,_e=window.location.hostname==="cbpf.data.unocha.org",ln=window.location.hostname+window.location.pathname==="cbpf.data.unocha.org/bookmark.html",cn="https://use.fontawesome.com/releases/v5.6.3/css/all.css",Hn=["https://cbpfgms.github.io/css/d3chartstyles.css","https://cbpfgms.github.io/css/d3chartstylespbinad.css",cn],ue="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js",Qt="https://unpkg.com/d3-sankey@0",dn="https://cbpfgms.github.io/libraries/html2canvas.min.js",un="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js",ke="https://cdn.jsdelivr.net/npm/@ungap/url-search-params@0.1.2/min.min.js",pn="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js",fn="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.4/fetch.min.js";if(Hn.forEach(function(O){if(!jn(O)){let V=document.createElement("link");V.setAttribute("rel","stylesheet"),V.setAttribute("type","text/css"),V.setAttribute("href",O),O===cn&&(V.setAttribute("integrity","sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"),V.setAttribute("crossorigin","anonymous")),document.getElementsByTagName("head")[0].appendChild(V)}}),!qe(ue))Pe&&Ae?st(Qt,function(){st(ue,te)}):Pe&&!Ae?st(ke,function(){st(Qt,function(){st(ue,te)})}):st(pn,function(){st(fn,function(){st(ke,function(){st(Qt,function(){st(ue,te)})})})});else if(typeof d3<"u")Pe&&Ae?st(Qt,te):Pe&&!Ae?st(ke,function(){st(Qt,te)}):st(pn,function(){st(fn,function(){st(ke,function(){st(Qt,te)})})});else{let O,V=document.getElementsByTagName("script");for(let xt=V.length;xt--;)V[xt].src==ue&&(O=V[xt]);st(Qt,null),O.addEventListener("load",te)}function st(O,V){let xt=document.getElementsByTagName("head")[0],Ht=document.createElement("script");Ht.type="text/javascript",Ht.src=O,Ht.onreadystatechange=V,Ht.onload=V,xt.appendChild(Ht)}function jn(O){let V=document.getElementsByTagName("link");for(let xt=V.length;xt--;)if(V[xt].href==O)return!0;return!1}function qe(O){let V=document.getElementsByTagName("script");for(let xt=V.length;xt--;)if(V[xt].src==O)return!0;return!1}function te(){Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(n){if(this==null)throw new TypeError('"this" is null or not defined');var c=Object(this),a=c.length>>>0;if(typeof n!="function")throw new TypeError("predicate must be a function");for(var s=arguments[1],p=0;p<a;){var u=c[p];if(n.call(s,u,p,c))return u;p++}},configurable:!0,writable:!0}),HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(n,c,a){var s=this.toDataURL(c,a).split(",")[1];setTimeout(function(){for(var p=atob(s),u=p.length,h=new Uint8Array(u),i=0;i<u;i++)h[i]=p.charCodeAt(i);n(new Blob([h],{type:c||"image/png"}))})}});let O=900,V=[4,4,4,4],xt=4,Ht=30,gn=60,hn=620,pe=V[0]+V[2]+gn+Ht+hn+2*xt,lt=8,Dt=16,fe=10,Un=8,Wn=11,yn=26,Ce=12,$n=2,_n=10,jt=2,ee=.3,G=.1,ge=.02,Se=.05,Yt=12,he=4,mn=12,xn=3,et=10,bn=.6,ht=4,qn=window.innerHeight,ne="#1F69B3",Te="#418FDE",Le="#F9D25B",we="#BFBFBF",bt="#E56A54",ye="#7FB92F",me="#CD3A1F",Xn="#F79A3B",Ut=300,Ie=14,kt=2,Wt=4,Be=2,Kn=425,Zn=50,Xe=220,Ke=50,$t=[10,38,10,44],le=d3.local(),De=d3.local(),vn=4,Fe=3,Ze=new Date,Ft=Ze.getFullYear(),Jn=6e5,P=1e3,ft=d3.local(),H=d3.local(),Qn=d3.format("~s"),Oe=d3.format(".3s"),Et=d3.format(",.0f"),it=d3.format(".1%"),ai=d3.format(".0%"),ta="National Partners",ea=["CBPF","CERF","Direct Partners","Sub-implementing Partners"],na="Allocation flow (net funding)",aa="netfunding",ia="https://cbpf.data.unocha.org/bookmark.html?",oa="https://gms.unocha.org/content/allocation-flow",Je=d3.utcFormat("_%Y%m%d_%H%M%S_UTC"),ra="https://cbpfapi.unocha.org/vo2/odata/AllocationFlowByOrgType?PoolfundCodeAbbrv=&$format=csv",sa="https://cbpfapi.unocha.org/vo2/odata/AllocationTypes?PoolfundCodeAbbrv=&$format=csv",la="https://cbpfapi.unocha.org/vo2/odata/MstPooledFund?$format=csv",ca="https://cbpfapi.unocha.org/vo2/odata/MstOrgType?$format=csv",da="https://cbpfapi.unocha.org/vo2/odata/SubIPType?$format=csv",ua=["M83.277,10.493l-13.132,12.22H22.821L9.689,10.493c0,0,6.54-9.154,17.311-10.352c10.547-1.172,14.206,5.293,19.493,5.56 c5.273-0.267,8.945-6.731,19.479-5.56C76.754,1.339,83.277,10.493,83.277,10.493z","M48.297,69.165v9.226c1.399-0.228,2.545-0.768,3.418-1.646c0.885-0.879,1.321-1.908,1.321-3.08 c0-1.055-0.371-1.966-1.113-2.728C51.193,70.168,49.977,69.582,48.297,69.165z","M40.614,57.349c0,0.84,0.299,1.615,0.898,2.324c0.599,0.729,1.504,1.303,2.718,1.745v-8.177 c-1.104,0.306-1.979,0.846-2.633,1.602C40.939,55.61,40.614,56.431,40.614,57.349z","M73.693,30.584H19.276c0,0-26.133,20.567-17.542,58.477c0,0,2.855,10.938,15.996,10.938h57.54 c13.125,0,15.97-10.938,15.97-10.938C99.827,51.151,73.693,30.584,73.693,30.584z M56.832,80.019 c-2.045,1.953-4.89,3.151-8.535,3.594v4.421H44.23v-4.311c-3.232-0.318-5.853-1.334-7.875-3.047 c-2.018-1.699-3.307-4.102-3.864-7.207l7.314-0.651c0.3,1.25,0.856,2.338,1.677,3.256c0.823,0.911,1.741,1.575,2.747,1.979v-9.903 c-3.659-0.879-6.348-2.22-8.053-3.997c-1.716-1.804-2.565-3.958-2.565-6.523c0-2.578,0.96-4.753,2.897-6.511 c1.937-1.751,4.508-2.767,7.721-3.034v-2.344h4.066v2.344c2.969,0.306,5.338,1.159,7.09,2.565c1.758,1.406,2.877,3.3,3.372,5.658 l-7.097,0.774c-0.43-1.849-1.549-3.118-3.365-3.776v9.238c4.485,1.035,7.539,2.357,9.16,3.984c1.634,1.635,2.441,3.725,2.441,6.289 C59.898,75.656,58.876,78.072,56.832,80.019z"],pa=[{text:"Funds...",size:50},{text:"... transfer resources to direct partners...",size:100},{text:"... who may or may not transfer them to sub-implementing partners.",size:130}],fa={partner:"Amount kept with Direct Partners",subpartner:"Transferred to Sub-impl. Partners"},Ot={},ae={},vt={},Ve={},Re=[],ie=[],ga=[],oe=[],Pn=["subpartner","partner"],j=[],Pt={},_t={},ce={},Ge=["level","type"],l={selectedYear:[],selectedAggregation:null,selectedCbpfs:null,cbpfsInData:[]},xe=!1,An=!1,Vt,dt=new URLSearchParams(location.search);dt.has("viz")||dt.append("viz",aa);let M=d3.select("#d3chartcontainerpbinad"),ha=M.node().getAttribute("data-showhelp")==="true",ya=M.node().getAttribute("data-showlink")==="true",kn=+M.node().getAttribute("data-minpercentage")||0,Cn=M.node().getAttribute("data-title")?M.node().getAttribute("data-title"):na,ma=dt.has("year")?dt.get("year").replace(/\|/g,","):M.node().getAttribute("data-year"),xa=dt.has("fund")?dt.get("fund").replace(/\|/g,","):M.node().getAttribute("data-cbpf"),ba=dt.has("aggregate")?dt.get("aggregate"):Ge.indexOf(M.node().getAttribute("data-aggregate"))>-1?M.node().getAttribute("data-aggregate"):Ge[1];l.selectedAggregation=ba;let va=M.node().getAttribute("data-responsive")==="true",Pa=M.node().getAttribute("data-lazyload")==="true";va===!1&&M.style("width",O+"px").style("height",pe+"px");let be=M.append("div").attr("class","pbinadTopDiv"),Aa=be.append("div").attr("class","pbinadTitleDiv"),Mt=be.append("div").attr("class","pbinadIconsDiv d3chartIconsDiv"),Qe=M.append("div").attr("class","pbinadSelectTitleDiv"),Me=M.append("div").attr("class","pbinadSelectDiv"),ut=M.append("svg").attr("viewBox","0 0 "+O+" "+pe).style("background-color","white");sn&&ut.attr("height",pe);let ka=M.append("div").attr("class","pbinadYearsDescriptionDiv"),Ye=M.append("div").attr("class","pbinadtimelineDiv"),Ca=_e?null:M.append("div").attr("class","pbinadFooterDiv");Rn(ut,O,pe,"Loading visualisation...");let de=M.append("div").attr("id","pbinadSnapshotTooltip").attr("class","pbinadSnapshotContent").style("display","none").on("mouseleave",function(){xe=!1,de.style("display","none"),F.style("display","none"),Vt&&d3.select(Vt).dispatch("mouseout")});de.append("p").attr("id","pbinadSnapshotTooltipPdfText").html("Download PDF").on("click",function(){xe=!1,Ue("pdf",!0)}),de.append("p").attr("id","pbinadSnapshotTooltipPngText").html("Download Image (PNG)").on("click",function(){xe=!1,Ue("png",!0)});let Sn=!Nn&&(window.safari||window.navigator.userAgent.indexOf("Edge")>-1);Sn&&de.append("p").attr("id","pbinadTooltipBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default");let F=M.append("div").attr("id","pbinadtooltipdiv").style("display","none");M.on("contextmenu",function(){d3.event.preventDefault();let n=d3.mouse(this);xe=!0,de.style("display","block").style("top",n[1]-4+"px").style("left",n[0]-4+"px")});let x={main:ut.append("g").attr("class","pbinadtopPanel").attr("transform","translate("+V[3]+","+V[0]+")"),width:O-V[1]-V[3],height:gn,padding:[0,0,0,0],moneyBagPadding:4,leftPadding:[174,412,638],mainValueVerPadding:12,mainValueHorPadding:2,linePadding:8},A={main:ut.append("g").attr("class","pbinadbuttonsPanel").attr("transform","translate("+V[3]+","+(V[0]+x.height+xt)+")"),width:O-V[1]-V[3],height:Ht,padding:[0,0,0,0],buttonWidth:52,buttonAggregationWidth:158,buttonsMargin:4,buttonVerticalPadding:4,arrowPadding:18},B={main:ut.append("g").attr("class","pbinadsankeyPanel").attr("transform","translate("+V[3]+","+(V[0]+A.height+x.height+2*xt)+")"),width:O-V[1]-V[3],height:hn,padding:[40,80,44,116]},qt=ut.append("g").attr("opacity",0),Ee=d3.sankey().nodeSort(null).linkSort(null).nodeWidth(Dt).nodePadding(fe).nodeId(function(n){return n.id}).extent([[B.padding[3],B.padding[0]],[B.width-B.padding[1],B.height-B.padding[2]]]),Xt=d3.scalePoint().padding(0).domain(d3.range(3)).range([B.padding[3]+Dt/2,B.width-B.padding[1]-Dt/2]),Lt=d3.scalePoint().padding(.5),ot=d3.scaleLinear(),Kt=d3.axisLeft(Lt).tickSize(0).tickPadding(5),Zt=d3.axisTop(ot).tickSizeOuter(0).ticks(3).tickPadding(4).tickFormat(function(n){return"$"+Qn(n).replace("G","B")}),Tn=d3.scalePoint().domain(d3.range(4)).range([$t[3],Xe-$t[1]]);qe(dn)||st(dn,null),qe(un)||st(un,null),_e&&!ln?Promise.all([window.cbpfbiDataObject.allocationFlowData,window.cbpfbiDataObject.masterPooledFunds,window.cbpfbiDataObject.masterPartners,window.cbpfbiDataObject.masterSubPartners,window.cbpfbiDataObject.launchedAllocationsData]).then(Ln):ve("pbinad",ra,[],"data").then(function(n){return ve("pbinadcbpfList",la,n,"cbpfList")}).then(function(n){return ve("pbinadpartnersList",ca,n,"partnersList")}).then(function(n){return ve("pbinadsubpartnersList",da,n,"subPartnersList")}).then(function(n){return ve("launchedAllocationsData",sa,n,"launched allocations data")}).then(function(n){Ln(n)});function ve(n,c,a,s){let p=n==="launchedAllocationsData"?d3.autoType:null;if(localStorage.getItem(n)&&JSON.parse(localStorage.getItem(n)).timestamp>Ze.getTime()-Jn){let u=d3.csvParse(JSON.parse(localStorage.getItem(n)).data,p);return console.info("pbinad: "+s+" from local storage"),a.push(u),Promise.resolve(a)}else return d3.csv(c,p).then(function(u){try{localStorage.setItem(n,JSON.stringify({data:d3.csvFormat(u),timestamp:Ze.getTime()}))}catch(h){console.info("D3 chart pbinad, "+h)}return console.info("pbinad: "+s+" from API"),a.push(u),a})}function Ln(n){n[2][3].OrgTypeNm="Red Cross/Red Crescent Society",nn(),Fa(n[1]),Oa(n[2]),Va(n[3]),wa(n[0],n[4]),Ra(ma),l.selectedCbpfs=Ga(xa),Pa?(d3.select(window).on("scroll.pbinad",c),d3.select("body").on("d3ChartsYear.pbinad",function(){l.selectedYear=[Bn(+d3.event.detail)]}),c()):wn(n[0],n[4]);function c(){let a=M.node().getBoundingClientRect();a.bottom<0||a.top-qn>0||(d3.select(window).on("scroll.pbinad",null),wn(n[0],n[4]))}}function wn(n,c){let a=en(n,c);Sa(n),Ta(n,c),tn(a),La(n,c),ze(a),Dn(),In(n),_e||Ea(),ha&&On()}function Sa(n){let c=Aa.append("p").attr("id","pbinadd3chartTitle").html(Cn),a=Mt.append("button").attr("id","pbinadHelpButton");a.html("HELP  ").append("span").attr("class","fas fa-info");let s=Mt.append("button").attr("id","pbinadDownloadButton");s.html(".CSV  ").append("span").attr("class","fas fa-download");let p=Mt.append("div").attr("class","pbinadSnapshotDiv");p.append("button").attr("id","pbinadSnapshotButton").html("IMAGE ").append("span").attr("class","fas fa-camera");let h=p.append("div").attr("class","pbinadSnapshotContent"),i=h.append("p").attr("id","pbinadSnapshotPdfText").html("Download PDF").on("click",function(){Ue("pdf",!1)}),T=h.append("p").attr("id","pbinadSnapshotPngText").html("Download Image (PNG)").on("click",function(){Ue("png",!1)}),g=Mt.append("button").datum({clicked:!1}).attr("id","pbinadPlayButton");if(g.html("PLAY  ").append("span").attr("class","fas fa-play"),g.on("click",function(S){S.clicked=!S.clicked,g.html(S.clicked?"PAUSE ":"PLAY  ").append("span").attr("class",S.clicked?"fas fa-pause":"fas fa-play"),S.clicked?(l.selectedYear.length=1,f(),timer=d3.interval(f,3*P)):timer.stop();function f(){let R=j.indexOf(l.selectedYear[0]);if(l.selectedYear[0]=j[(R+1)%j.length],d3.selectAll(".pbinadbuttonsRects").filter(function(k){return k===l.selectedYear[0]}).dispatch("click"),j.length>lt){let k=l.selectedYear[0]<j[lt/2]?0:l.selectedYear[0]>j[j.length-lt/2]?j.length-lt:j.indexOf(l.selectedYear[0])-lt/2,K=-(A.buttonWidth*k);K===0?(ut.select(".pbinadLeftArrowGroup").select("text").style("fill","#ccc"),ut.select(".pbinadLeftArrowGroup").attr("pointer-events","none")):(ut.select(".pbinadLeftArrowGroup").select("text").style("fill","#666"),ut.select(".pbinadLeftArrowGroup").attr("pointer-events","all")),Math.abs(K)>=(j.length-lt)*A.buttonWidth?(ut.select(".pbinadRightArrowGroup").select("text").style("fill","#ccc"),ut.select(".pbinadRightArrowGroup").attr("pointer-events","none")):(ut.select(".pbinadRightArrowGroup").select("text").style("fill","#666"),ut.select(".pbinadRightArrowGroup").attr("pointer-events","all")),ut.select(".pbinadbuttonsGroup").transition().duration(P).attrTween("transform",function(){return d3.interpolateString(this.getAttribute("transform"),"translate("+K+",0)")})}}}),!ln){let S=Mt.append("button").attr("id","pbinadShareButton");S.html("SHARE  ").append("span").attr("class","fas fa-share");let f=M.append("div").attr("class","d3chartShareDiv").style("display","none");S.on("mouseover",function(){f.html("Click to copy").style("display","block");let R=this.getBoundingClientRect(),nt=M.node().getBoundingClientRect(),k=f.node().getBoundingClientRect(),K=R.top-nt.top-(k.height-R.height)/2,U=R.left-nt.left-k.width-12;f.style("top",K+"px").style("left",U+"20px")}).on("mouseout",function(){f.style("display","none")}).on("click",function(){let R=ia+dt.toString();f.append("input").attr("type","text").attr("readonly",!0).attr("spellcheck","false").property("value",R).node().select(),document.execCommand("copy"),f.html("Copied!");let k=this.getBoundingClientRect(),K=M.node().getBoundingClientRect(),U=f.node().getBoundingClientRect(),Y=k.left-K.left-U.width-12;f.style("left",Y+"20px")})}if(Sn){let S=h.append("p").attr("id","pbinadBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default")}p.on("mouseover",function(){h.style("display","block")}).on("mouseout",function(){h.style("display","none")}),a.on("click",On),s.on("click",function(){let S=Da(n),R="AllocationFlow_"+Je(new Date)+".csv",nt=new Blob([S],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(nt,filename);else{let k=document.createElement("a");if(k.download!==void 0){let K=URL.createObjectURL(nt);k.setAttribute("href",K),k.setAttribute("download",R),k.style="visibility:hidden",document.body.appendChild(k),k.click(),document.body.removeChild(k)}}})}function Ta(n,c){Qe.html("Select CBPF:");let a=d3.keys(Pt).sort(function(g,S){return Ot[g].localeCompare(Ot[S])});a.unshift("All CBPFs");let s=Me.selectAll(null).data(a).enter().append("div").attr("class","pbinadCheckboxDiv");s.filter(function(g){return g!=="All CBPFs"}).style("opacity",function(g){return l.cbpfsInData.indexOf(g)===-1?bn:1});let p=s.append("label"),u=p.append("input").attr("type","checkbox").property("checked",function(g){return l.selectedCbpfs.length!==d3.keys(Pt).length&&l.selectedCbpfs.indexOf(g)>-1}).attr("value",function(g){return g}),h=p.append("span").attr("class","pbinadCheckboxText").html(function(g){return Pt[g]||g}),i=s.filter(function(g){return g==="All CBPFs"}).select("input");d3.select(i.node().nextSibling).attr("class","pbinadCheckboxTextAllCbpfs");let T=s.filter(function(g){return g!=="All CBPFs"}).select("input");T.property("disabled",function(g){return l.cbpfsInData.indexOf(g)===-1}),i.property("checked",function(){return l.selectedCbpfs.length===d3.keys(Pt).length}),p.select("input").on("change",function(){if(this.value==="All CBPFs")this.checked?(l.selectedCbpfs=d3.keys(Pt),T.property("checked",!1)):l.selectedCbpfs.length=0;else{if(this.checked)l.selectedCbpfs.length===d3.keys(Pt).length?l.selectedCbpfs=[this.value]:l.selectedCbpfs.push(this.value);else{let S=l.selectedCbpfs.indexOf(this.value);l.selectedCbpfs.splice(S,1)}i.property("checked",!1)}if(!l.selectedCbpfs.length||l.selectedCbpfs.length===d3.keys(Pt).length)dt.delete("fund");else{let S=l.selectedCbpfs.map(function(f){return Pt[f]}).join("|");dt.has("fund")?dt.set("fund",S):dt.append("fund",S)}let g=en(n,c);tn(g),ze(g),In(n)})}function tn(n){let c=ce.launched,a=d3.sum(n.nodes.filter(function(b){return b.level===1}),function(b){return b.amount}),s=l.selectedYear.some(b=>_t[b])?c:a,p=d3.sum(n.nodes.filter(function(b){return b.level===3&&b.id.split("#")[0]==="partner"}),function(b){return b.amount}),u=d3.sum(n.nodes.filter(function(b){return b.level===3&&b.id.split("#")[0]==="subpartner"}),function(b){return b.amount}),h=ce.underApproval,i=x.main.selectAll(".pbinadtopPanelMoneyBag").data([!0]).enter().append("g").attr("class","pbinadtopPanelMoneyBag contributionColorFill").attr("transform","translate("+x.moneyBagPadding+",6) scale(0.5)").each(function(b,m,L){ua.forEach(function(z){d3.select(L[m]).append("path").attr("d",z)})}),T=d3.select(".pbinadtopPanelMainValue").size()!==0?d3.select(".pbinadtopPanelMainValue").datum():0,g=d3.select(".pbinadtopPanelAllocatedValue").size()!==0?d3.select(".pbinadtopPanelAllocatedValue").datum():0,S=d3.select(".pbinadtopPanelUnderApprovalValue").size()!==0?d3.select(".pbinadtopPanelUnderApprovalValue").datum():0,f=d3.select(".pbinadtopPanelPartnersValue").size()!==0?d3.select(".pbinadtopPanelPartnersValue").datum():0,R=d3.select(".pbinadtopPanelSubpartnersValue").size()!==0?d3.select(".pbinadtopPanelSubpartnersValue").datum():0,nt=x.main.selectAll(".pbinadtopPanelMainValue").data([s]);nt=nt.enter().append("text").attr("class","pbinadtopPanelMainValue contributionColorFill").attr("text-anchor","end").attr("y",x.height-x.mainValueVerPadding).attr("x",x.moneyBagPadding+x.leftPadding[0]-x.mainValueHorPadding).merge(nt),nt.transition().duration(P).tween("text",function(b){let m=this,L=d3.interpolate(T,b);return function(z){let _=tt(L(z));m.textContent="$"+(b<1e3?b:_.substring(0,_.length-1))}});let k=x.main.selectAll(".pbinadtopPanelMainText").data([s]);k=k.enter().append("text").attr("class","pbinadtopPanelMainText").style("opacity",0).attr("text-anchor","start").attr("y",x.height-x.mainValueVerPadding*2.7).attr("x",x.moneyBagPadding+x.leftPadding[0]+x.mainValueHorPadding).merge(k),k.transition().duration(P).style("opacity",1).text(function(b){let m=tt(b),L=m[m.length-1];return(L==="k"?"Thousand":L==="M"?"Million":L==="G"?"Billion":"")+(l.selectedYear.some(z=>_t[z])?" in Allocations":" Allocated in")});let K=x.main.selectAll(".pbinadtopPanelSubText").data([!0]);K=K.enter().append("text").attr("class","pbinadtopPanelSubText").style("opacity",0).attr("text-anchor","start").attr("y",x.height-x.mainValueVerPadding*1.2).attr("x",x.moneyBagPadding+x.leftPadding[0]+x.mainValueHorPadding).merge(K),K.transition().duration(P).style("opacity",1).text((l.selectedYear.some(b=>_t[b])?"Launched in ":"")+(l.selectedYear.length===1?l.selectedYear[0]:"years*"));let U=x.main.selectAll(".pbinadtopPanelAllocatedValue").data([a]);U=U.enter().append("text").attr("class","pbinadtopPanelAllocatedValue contributionColorFill").attr("text-anchor","end").style("opacity",0).attr("y",x.height-x.mainValueVerPadding*3).attr("x",x.moneyBagPadding+x.leftPadding[1]-x.mainValueHorPadding).merge(U),U.transition().duration(P).style("opacity",l.selectedYear.some(b=>_t[b])?1:0).tween("text",function(b){let m=this,L=d3.interpolate(f,b);return function(z){let _=tt(L(z));m.textContent="$"+(b<1e3?b:_.substring(0,_.length-1))}});let Y=x.main.selectAll(".pbinadtopPanelAllocatedText").data([a]);Y=Y.enter().append("text").attr("class","pbinadtopPanelAllocatedText").style("opacity",0).attr("text-anchor","start").attr("y",x.height-x.mainValueVerPadding*3).attr("x",x.moneyBagPadding+x.leftPadding[1]+x.mainValueHorPadding).merge(Y),Y.transition().duration(P).style("opacity",l.selectedYear.some(b=>_t[b])?1:0).text(function(b){let m=tt(b),L=m[m.length-1];return(L==="k"?"Thousand":L==="M"?"Million":L==="G"?"Billion":"")+" Allocated"});let Ct=x.main.selectAll(".pbinadtopPanelUnderApprovalValue").data([h]);Ct=Ct.enter().append("text").attr("class","pbinadtopPanelUnderApprovalValue contributionColorFill").attr("text-anchor","end").attr("y",x.height-x.mainValueVerPadding).attr("x",x.moneyBagPadding+x.leftPadding[1]-x.mainValueHorPadding).merge(Ct),Ct.transition().duration(P).tween("text",function(b){let m=this,L=d3.interpolate(R,b);return function(z){let _=tt(L(z));m.textContent="$"+(b<1e3?b:_.substring(0,_.length-1))}});let y=x.main.selectAll(".pbinadtopPanelUnderApprovalText").data([h]);y=y.enter().append("text").attr("class","pbinadtopPanelUnderApprovalText").style("opacity",0).attr("text-anchor","start").attr("y",x.height-x.mainValueVerPadding).attr("x",x.moneyBagPadding+x.leftPadding[1]+x.mainValueHorPadding).merge(y),y.transition().duration(P).style("opacity",1).text(function(b){let m=tt(b),L=m[m.length-1];return(L==="k"?"Thousand":L==="M"?"Million":L==="G"?"Billion":"")+" Under Approval"});let q=x.main.selectAll(".pbinadtopPanelPartnersValue").data([p]);q=q.enter().append("text").attr("class","pbinadtopPanelPartnersValue contributionColorFill").attr("text-anchor","end").attr("y",x.height-x.mainValueVerPadding*3).attr("x",x.moneyBagPadding+x.leftPadding[2]-x.mainValueHorPadding).merge(q),q.transition().duration(P).tween("text",function(b){let m=this,L=d3.interpolate(f,b);return function(z){let _=tt(L(z));m.textContent="$"+(b<1e3?b:_.substring(0,_.length-1))}});let X=x.main.selectAll(".pbinadtopPanelPartnersText").data([p]);X=X.enter().append("text").attr("class","pbinadtopPanelPartnersText").style("opacity",0).attr("text-anchor","start").attr("y",x.height-x.mainValueVerPadding*3).attr("x",x.moneyBagPadding+x.leftPadding[2]+x.mainValueHorPadding).merge(X),X.transition().duration(P).style("opacity",1).text(function(b){let m=tt(b),L=m[m.length-1];return(L==="k"?"Thousand":L==="M"?"Million":L==="G"?"Billion":"")+" to direct partners ("+it(b/a||0)+")"});let J=x.main.selectAll(".pbinadtopPanelSubpartnersValue").data([u]);J=J.enter().append("text").attr("class","pbinadtopPanelSubpartnersValue contributionColorFill").attr("text-anchor","end").attr("y",x.height-x.mainValueVerPadding).attr("x",x.moneyBagPadding+x.leftPadding[2]-x.mainValueHorPadding).merge(J),J.transition().duration(P).tween("text",function(b){let m=this,L=d3.interpolate(R,b);return function(z){let _=tt(L(z));m.textContent="$"+(b<1e3?b:_.substring(0,_.length-1))}});let gt=x.main.selectAll(".pbinadtopPanelSubpartnersText").data([u]);gt=gt.enter().append("text").attr("class","pbinadtopPanelSubpartnersText").style("opacity",0).attr("text-anchor","start").attr("y",x.height-x.mainValueVerPadding).attr("x",x.moneyBagPadding+x.leftPadding[2]+x.mainValueHorPadding).merge(gt),gt.transition().duration(P).style("opacity",1).text(function(b){let m=tt(b),L=m[m.length-1];return(L==="k"?"Thousand":L==="M"?"Million":L==="G"?"Billion":"")+" to sub-impl. partners ("+it(b/a||0)+")"})}function La(n,c){let a=A.main.append("clipPath").attr("id","pbinadclip").append("rect").attr("width",lt*A.buttonWidth).attr("height",A.height),s=j.length>lt?A.arrowPadding:-2,u=A.main.append("g").attr("class","pbinadClipPathGroup").attr("transform","translate("+(A.padding[3]+s)+",0)").attr("clip-path","url(#pbinadclip)").append("g").attr("class","pbinadbuttonsGroup").attr("transform","translate(0,0)").style("cursor","pointer"),h=u.selectAll(null).data(j).enter().append("rect").attr("rx","2px").attr("ry","2px").attr("class","pbinadbuttonsRects").attr("width",A.buttonWidth-A.buttonsMargin).attr("height",A.height-A.buttonVerticalPadding*2).attr("y",A.buttonVerticalPadding).attr("x",function(m,L){return L*A.buttonWidth+A.buttonsMargin/2}).style("fill",function(m){return l.selectedYear.indexOf(m)>-1?ne:"#eaeaea"}),i=u.selectAll(null).data(j).enter().append("text").attr("text-anchor","middle").attr("class","pbinadbuttonsText").attr("y",A.height/1.6).attr("x",function(m,L){return L*A.buttonWidth+A.buttonWidth/2}).style("fill",function(m){return l.selectedYear.indexOf(m)>-1?"white":"#444"}).text(function(m){return m}),T=A.main.append("g").attr("class","pbinadbuttonsAggegationGroup").style("cursor","pointer"),g=T.selectAll(null).data(Ge).enter().append("rect").attr("rx","2px").attr("ry","2px").attr("class","pbinadbuttonsAggregationRects").attr("width",A.buttonAggregationWidth-A.buttonsMargin).attr("height",A.height-A.padding[0]-A.buttonVerticalPadding*2).attr("y",A.padding[0]+A.buttonVerticalPadding).attr("x",function(m,L){return L*A.buttonAggregationWidth+A.buttonsMargin/2}).style("fill",function(m){return m===l.selectedAggregation?ne:"#eaeaea"}),S=T.selectAll(null).data(Ge).enter().append("text").attr("text-anchor","middle").attr("class","pbinadbuttonsAggregationText").attr("y",A.height/1.6).attr("x",function(m,L){return L*A.buttonAggregationWidth+A.buttonAggregationWidth/2}).style("fill",function(m){return m===l.selectedAggregation?"white":"#444"}).text(function(m){return"Aggregate by Partner "+Ya(m)});T.attr("transform","translate("+(A.width-2*A.buttonAggregationWidth)+",0)");let f=A.main.append("g").attr("class","pbinadLeftArrowGroup").style("opacity",0).attr("pointer-events","none").style("cursor","pointer").attr("transform","translate("+A.padding[3]+",0)"),R=f.append("rect").style("fill","white").attr("width",A.arrowPadding).attr("height",A.height),nt=f.append("text").attr("class","pbinadleftArrowText").attr("x",0).attr("y",A.height-A.buttonVerticalPadding*2.1).style("fill","#666").text("\u25C4"),k=A.main.append("g").attr("class","pbinadRightArrowGroup").style("opacity",0).attr("pointer-events","none").style("cursor","pointer").attr("transform","translate("+(A.padding[3]+A.arrowPadding+lt*A.buttonWidth)+",0)"),K=k.append("rect").style("fill","white").attr("width",A.arrowPadding).attr("height",A.height),U=k.append("text").attr("class","pbinadrightArrowText").attr("x",-1).attr("y",A.height-A.buttonVerticalPadding*2.1).style("fill","#666").text("\u25BA");h.on("mouseover",q).on("mouseout",X).on("click",function(m){let L=this;if(d3.event.altKey){J(m,!1);return}ft.get(this)!=="clicked"?(ft.set(this,"clicked"),setTimeout(function(){ft.get(L)==="clicked"&&J(m,!0),ft.set(L,null)},250)):(J(m,!1),ft.set(this,null))}),d3.select("body").on("d3ChartsYear.pbinad",function(){J(Bn(+d3.event.detail),!0),j.length>lt&&(y(),Y())}),g.on("mouseover",gt).on("mouseout",b),j.length>lt&&(k.style("opacity",1).attr("pointer-events","all"),f.style("opacity",1).attr("pointer-events","all"),y(),Ct(),f.on("click",function(){f.attr("pointer-events","none");let m=Ne(u.attr("transform"))[0];k.select("text").style("fill","#666"),k.attr("pointer-events","all"),u.transition().duration(P).attr("transform","translate("+Math.min(0,m+lt*A.buttonWidth)+",0)").on("end",Y)}),k.on("click",function(){k.attr("pointer-events","none");let m=Ne(u.attr("transform"))[0];f.select("text").style("fill","#666"),f.attr("pointer-events","all"),u.transition().duration(P).attr("transform","translate("+Math.max(-((j.length-lt)*A.buttonWidth),-(Math.abs(m)+lt*A.buttonWidth))+",0)").on("end",Y)}));function Y(){let m=Ne(u.attr("transform"))[0];m===0?(f.select("text").style("fill","#ccc"),f.attr("pointer-events","none")):(f.select("text").style("fill","#666"),f.attr("pointer-events","all")),Math.abs(m)>=(j.length-lt)*A.buttonWidth?(k.select("text").style("fill","#ccc"),k.attr("pointer-events","none")):(k.select("text").style("fill","#666"),k.attr("pointer-events","all"))}function Ct(){let m=Ne(u.attr("transform"))[0];m===0&&(f.select("text").style("fill","#ccc"),f.attr("pointer-events","none")),Math.abs(m)>=(j.length-lt)*A.buttonWidth&&(k.select("text").style("fill","#ccc"),k.attr("pointer-events","none"))}function y(){let m=j.indexOf(l.selectedYear[0])<lt/2?0:j.indexOf(l.selectedYear[0])>j.length-lt/2?Math.max(j.length-lt,0):j.indexOf(j.indexOf(l.selectedYear[0]))-lt/2;u.attr("transform","translate("+-(A.buttonWidth*m)+",0)")}function q(m){F.style("display","block").html(null),F.append("div").style("max-width","200px").attr("id","pbinadInnerTooltipDiv").html("Click for selecting a single year. Double-click or ALT + click for selecting multiple years.");let z=M.node().getBoundingClientRect(),_=this.getBoundingClientRect();tooltipSize=F.node().getBoundingClientRect(),F.style("left",_.left+_.width/2-z.left>z.width-tooltipSize.width/2-V[1]?z.width-tooltipSize.width-V[1]+"px":_.left+_.width/2-z.left<tooltipSize.width/2+A.padding[3]+V[0]?A.padding[3]+V[0]+"px":_.left+_.width/2-z.left-tooltipSize.width/2+"px").style("top",_.top+_.height/2-z.top<tooltipSize.height?_.top-z.top+_.height+2+"px":_.top-z.top-tooltipSize.height-4+"px"),d3.select(this).style("fill",ne),i.filter(function(pt){return pt===m}).style("fill","white")}function X(m){F.style("display","none"),!(l.selectedYear.indexOf(m)>-1)&&(d3.select(this).style("fill","#eaeaea"),i.filter(function(L){return L===m}).style("fill","#444"))}function J(m,L){if(F.style("display","none"),L)l.selectedYear=[m];else{let pt=l.selectedYear.indexOf(m);if(pt>-1){if(l.selectedYear.length===1)return;l.selectedYear.splice(pt,1)}else l.selectedYear.push(m)}let z=l.selectedYear.map(function(pt){return pt}).join("|");dt.has("year")?dt.set("year",z):dt.append("year",z),d3.selectAll(".pbinadbuttonsRects").style("fill",function(pt){return l.selectedYear.indexOf(pt)>-1?ne:"#eaeaea"}),d3.selectAll(".pbinadbuttonsText").style("fill",function(pt){return l.selectedYear.indexOf(pt)>-1?"white":"#444"}),Dn();let _=en(n,c);Me.selectAll(".pbinadCheckboxDiv").filter(function(pt){return pt!=="All CBPFs"}).select("input").property("disabled",function(pt){return l.cbpfsInData.indexOf(pt)===-1}),Me.selectAll(".pbinadCheckboxDiv").filter(function(pt){return pt!=="All CBPFs"}).style("opacity",function(pt){return l.cbpfsInData.indexOf(pt)===-1?bn:1}),tn(_),ze(_)}function gt(m){d3.select(this).style("fill",ne),S.filter(function(L){return L===m}).style("fill","white")}function b(m){m!==l.selectedAggregation&&(d3.select(this).style("fill","#eaeaea"),S.filter(function(L){return L===m}).style("fill","#444"))}}function ze(n){let c=B.main.selectAll(".pbinadsankeyNoData").data(n.nodes.length?[]:[!0]),a=c.exit().transition().duration(P).style("opacity",0).remove();c=c.enter().append("text").attr("class","pbinadsankeyNoData").attr("x",B.width/2).attr("y",B.height/3).style("opacity",0).text("No fund selected").merge(c).transition().duration(P).style("opacity",1);let p=B.main.selectAll(".pbinadsankeyAnnotationsGroups").data(pa).enter().append("g").attr("class","pbinadsankeyAnnotationsGroups").attr("transform",function(t,r){return"translate("+Xt(r)+","+(B.padding[0]-r*Wn-Un)+")"}).append("text").attr("class","pbinadsankeyAnnotations").attr("text-anchor","middle").attr("x",0).attr("y",0).text(function(t){return t.text}).each(function(t){Vn(d3.select(this),t.size)}),u=B.main.selectAll(".pbinadsankeyLegendTitle").data([!0]).enter().append("text").attr("class","pbinadsankeyLegendTitle").attr("x",B.padding[3]).attr("y",B.height-B.padding[2]+yn).text("Legend:"),h=ea.filter(function(t){return An||t!=="CERF"}),i=B.main.selectAll(".pbinadsankeyLegendGroups").data(h).enter().append("g").attr("class","pbinadsankeyLegendGroups"),T=i.append("rect").attr("width",Ce).attr("height",Ce).style("fill",function(t){return t==="CBPF"?Te:t==="CERF"?Le:t==="Direct Partners"?we:bt}),g=i.append("text").attr("class","pbinadlegendText").attr("x",Ce+$n).attr("y",Ce-2).text(function(t){return t});i.size()&&i.each(function(t,r){d3.select(this).attr("transform","translate("+(r?ft.get(this.previousSibling):B.padding[3])+","+(B.height-B.padding[2]+yn+4)+")"),ft.set(this,this.getBBox().width+_n+(r?ft.get(this.previousSibling):B.padding[3]))});let S=oe.map(function(t){return t.partner});Ee.nodeSort(function(t,r){return t.level===1&&r.level===1?t.codeId==="999"?1:r.codeId==="999"?-1:r.amount-t.amount:t.level===2&&r.level===2?r.amount-t.amount:l.selectedAggregation==="type"&&t.level===3&&r.level===3?S.indexOf(r.codeId)-S.indexOf(t.codeId)||r.amount-t.amount:l.selectedAggregation==="level"&&t.level===3&&r.level===3?Pn.indexOf(r.id.split("#")[0])-Pn.indexOf(t.id.split("#")[0])||r.amount-t.amount:null}),Ee.linkSort(function(t,r){return t.sourceLevel===1&&r.sourceLevel===1?r.value-t.value:t.sourceLevel===2&&r.sourceLevel===2?r.source.targetLinks.find(function(o){return o.fund===r.fund}).value-t.source.targetLinks.find(function(o){return o.fund===t.fund}).value||r.value-t.value:null});let f=n.nodes.length?Ee(n):n,R=f.nodes.filter(function(t){return t.level===2}).sort(function(t,r){return t.y0-r.y0}),nt=f.nodes.filter(function(t){return t.level===3}).sort(function(t,r){return t.y0-r.y0});Fn(R,!1),Fn(nt,l.selectedAggregation==="type",S),Ee.update(f);let k=B.main.selectAll(".pbinadsankeyNodes").data(f.nodes,function(t){return t.id}),K=k.exit().transition().duration(P).style("opacity",0).remove();k=k.enter().append("rect").attr("class","pbinadsankeyNodes").style("fill",function(t){let r=t.id.split("#");return r[0]==="fund"&&r[1]==="999"?Le:r[0]==="fund"&&r[1]!=="999"?Te:r[0]==="partner"?we:bt}).style("opacity",0).attr("x",function(t){return t.x0}).attr("y",function(t){return t.y0}).attr("height",function(t){return Math.max(1,t.y1-t.y0)}).attr("width",function(t){return t.x1-t.x0}).merge(k),k.transition().duration(P).style("opacity",1).attr("x",function(t){return t.x0}).attr("y",function(t){return t.y0}).attr("height",function(t){return Math.max(1,t.y1-t.y0)}).attr("width",function(t){return t.x1-t.x0});let Y=B.main.selectAll(".pbinadsankeyLinks").data(f.links,function(t){return t.fund+t.source.id+t.target.id}),Ct=Y.exit().transition().duration(P).style("stroke-opacity",0).remove();Y=Y.enter().append("path").attr("class","pbinadsankeyLinks").attr("stroke-width",function(t){return t.width}).style("fill","none").style("stroke",function(t){return t.sourceLevel===1?t.fund==="999"?Le:Te:t.target.id.split("#")[0]==="subpartner"?bt:t.fund==="999"?Le:Te}).style("stroke-opacity",0).attr("d",d3.sankeyLinkHorizontal()).merge(Y),Y.transition().duration(P).style("stroke-opacity",ee).attr("stroke-width",function(t){return t.width}).attr("d",d3.sankeyLinkHorizontal());let q=f.nodes.filter(function(t){return t.depth===0}),X=f.nodes.filter(function(t){return t.depth===1}),J=f.nodes.reduce(function(t,r){if(r.depth===2)if(l.selectedAggregation==="level")t.push({codeId:r.codeId,name:r.name,y0:r.y0,y1:r.y1,amount:r.amount,targetLinks:r.targetLinks,id:r.id});else{let o=t.find(function(e){return e.aggregatedName===r.aggregatedName});if(o)o.y0=Math.min(o.y0,r.y0),o.y1=Math.max(o.y1,r.y1),o.amount+=r.amount,o.targetLinks.push.apply(o.targetLinks,r.targetLinks);else{let e=X.find(function(d){return r.name===d.name});t.push({codeId:r.codeId,name:r.name,aggregatedName:r.aggregatedName,y0:r.y0,y1:r.y1,amount:r.amount,targetLinks:r.targetLinks,id:r.id,amountSecondLevel:e?e.amount:"n/a"})}}return t},[]),gt=n.nodes.reduce(function(t,r){return r.level===2?t+r.amount:t},0),b=B.main.selectAll(".pbinadsankeyFundLabels").data(q,function(t){return t.codeId}),m=b.exit().transition().duration(P).style("opacity",0).remove();b=b.enter().append("text").attr("class","pbinadsankeyFundLabels").attr("text-anchor","end").attr("x",B.padding[3]-jt).attr("y",function(t){return 3+(t.y0+t.y1)/2}).style("opacity",0).text(function(t){return t.name}).merge(b),b.call(rt,et).transition().duration(P).style("opacity",1).attr("y",function(t){return 3+(t.y0+t.y1)/2});let z=B.main.selectAll(".pbinadsankeyPartnerLabels").data(X,function(t){return t.codeId}),_=z.exit().transition().duration(P).style("opacity",0).remove();z=z.enter().append("text").attr("class","pbinadsankeyPartnerLabels").attr("text-anchor","end").attr("x",Xt(1)-Dt/2-jt).attr("y",function(t){return 3+(t.y0+t.y1)/2}).style("opacity",0).text(function(t){return t.name}).merge(z),z.call(rt,et).transition().duration(P).style("opacity",1).attr("y",function(t){return 3+(t.y0+t.y1)/2});let wt=B.main.selectAll(".pbinadsankeyPartnerValuesLabelsGroup").data(X,function(t){return t.codeId}),ii=wt.exit().transition().duration(P).style("opacity",0).remove(),an=wt.enter().append("g").attr("class","pbinadsankeyPartnerValuesLabelsGroup").style("opacity",0).attr("transform",function(t){return"translate("+(Xt(1)+Dt/2+jt)+","+(3+(t.y0+t.y1)/2)+")"});an.append("text").attr("class","pbinadsankeyPartnerValuesLabels").text(function(t){return"$"+tt(t.amount).replace("G","B")}),an.append("text").attr("class","pbinadsankeyPartnerValuesLabelsSubText").attr("dy","1em").text(function(t){return ft.set(this,t.amount/gt),"("+it(t.amount/gt)+")"}),wt=an.merge(wt),wt.call(rt,et*2).transition().duration(P).style("opacity",1).attr("transform",function(t){return"translate("+(Xt(1)+Dt/2+jt)+","+(3+(t.y0+t.y1)/2)+")"}),wt.select(".pbinadsankeyPartnerValuesLabels").transition().duration(P).tween("text",function(t){let r=this,o=d3.interpolate(je(r.textContent.substring(1))||0,t.amount);return function(e){r.textContent="$"+tt(o(e)).replace("G","B")}}),wt.select(".pbinadsankeyPartnerValuesLabelsSubText").transition().duration(P).tween("text",function(t){let r=this,o=ft.get(this);ft.set(this,t.amount/gt);let e=d3.interpolate(o,t.amount/gt);return function(d){r.textContent="("+it(e(d))+")"}});let yt=B.main.selectAll(".pbinadsankeySubpartnerLabels").data(J,function(t){return t.id}),oi=yt.exit().transition().duration(P).style("opacity",0).remove(),Gn=yt.enter().append("g").attr("class","pbinadsankeySubpartnerLabels").attr("text-anchor","end").attr("transform",function(t){return"translate("+(l.selectedAggregation==="level"||ie.indexOf(t.codeId)===-1?Xt(2)-Dt/2-jt:Xt(2)-Dt/2-jt-he/2-Yt)+","+(3+(t.y0+t.y1)/2)+")"}).style("opacity",0),ri=Gn.append("text").attr("class","pbinadsankeySubpartnerLabelsEnterText").text(function(t){return l.selectedAggregation==="type"?t.aggregatedName:t.name});yt=Gn.merge(yt);let Mn=yt.selectAll(".pbinadtypeArrowSpan").data(function(t){return l.selectedAggregation==="level"?[]:[t]}),si=Mn.exit().remove(),on=Mn.enter().append("text").attr("class","pbinadtypeArrowSpan").attr("dy","1em").text("");on.append("tspan").attr("class","pbinadtypePercentageBoldPar").text(function(t){return t.amountSecondLevel==="n/a"?"":"("}),on.append("tspan").attr("class","pbinadtypePercentageArrow").style("fill",function(t){return t.amountSecondLevel==="n/a"?"none":t.amount/t.amountSecondLevel-1<0?me:ye}).text(function(t){return t.amountSecondLevel==="n/a"?"":t.amount/t.amountSecondLevel-1<0?"\u25BC":"\u25B2"}),on.append("tspan").attr("class","pbinadtypePercentageBoldNumber").text(function(t){if(t.amountSecondLevel==="n/a")return"";{let r=t.amount/t.amountSecondLevel-1;return ft.set(this,r),it(Math.abs(r))+")"}}),yt.call(rt,et*(l.selectedAggregation==="level"?1:2)).transition().duration(P).style("opacity",1).attr("transform",function(t){return"translate("+(l.selectedAggregation==="level"||ie.indexOf(t.codeId)===-1?Xt(2)-Dt/2-jt:Xt(2)-Dt/2-jt-he/2-Yt)+","+(3+(t.y0+t.y1)/2)+")"}),yt.select(".pbinadsankeySubpartnerLabelsEnterText").text(function(t){return l.selectedAggregation==="type"?t.aggregatedName:t.name}),yt.select(".pbinadtypePercentageBoldPar").text(function(t){return t.amountSecondLevel==="n/a"?"":"("}),yt.select(".pbinadtypePercentageArrow").style("fill",function(t){return t.amountSecondLevel==="n/a"?"none":t.amount/t.amountSecondLevel-1<0?me:ye}).text(function(t){return t.amountSecondLevel==="n/a"?"":t.amount/t.amountSecondLevel-1<0?"\u25BC":"\u25B2"}),yt.select(".pbinadtypePercentageBoldNumber").transition().duration(P).tween("text",function(t){let r=this,o=ft.get(this)||0,e=t.amount/t.amountSecondLevel-1;ft.set(this,e);let d=d3.interpolate(o,e);return function(w){r.textContent=t.amountSecondLevel==="n/a"?"":it(Math.abs(d(w)))+")"}});let Gt=B.main.selectAll(".pbinadcurlyPathsType").data(l.selectedAggregation==="type"?J.filter(function(t){return ie.indexOf(t.codeId)>-1}):[],function(t){return t.codeId}),li=Gt.exit().transition().duration(P).style("opacity",0).remove();Gt=Gt.enter().append("path").attr("class","pbinadcurlyPathsType").style("opacity",0).attr("transform",function(t){return"translate("+(B.width-B.padding[1]-Dt-he/2)+",0)"}).style("fill","none").style("stroke","darkslategray").style("stroke-width","1px").attr("d",function(t){let r=t.y1-t.y0<et?2.5:1;return He(t.y0+.5,t.y1-.5,-Yt,Se*r)}).merge(Gt),Gt.transition().duration(P).style("opacity",function(t){return yt.filter(function(o){return o.codeId===t.codeId}).style("display")!=="none"?1:0}).attr("d",function(t){let r=t.y1-t.y0<et?2.5:1;return He(t.y0+.5,t.y1-.5,-Yt,Se*r)});let re={partner:0,subpartner:0},ja=l.selectedAggregation==="type"?[]:f.nodes.reduce(function(t,r){if(r.depth===2){let o=r.id.split("#")[0],e=t.find(function(d){return d.partnerType===o});return e?(e.y0=Math.min(e.y0,r.y0+1),e.y1=Math.max(e.y1,r.y1-1)):t.push({partnerType:o,y0:r.y0+1,y1:r.y1-1}),re[o]+=r.amount,t}else return t},[]),St=B.main.selectAll(".pbinadcurlyGroups").data(ja,function(t){return t.partnerType}),di=St.exit().transition().duration(P).style("opacity",0).remove(),We=St.enter().append("g").attr("class","pbinadcurlyGroups").style("opacity",0).attr("transform",function(t){return"translate("+(B.width-B.padding[1]+he)+",0)"}),ui=We.append("path").style("fill","none").style("stroke","darkslategray").style("stroke-width","1px").attr("d",function(t){return He(t.y0,t.y1,Yt,Se)}),pi=We.append("text").attr("class","pbinadcurlyText").attr("x",Yt+2).attr("y",function(t){return(t.y0+t.y1)/2-mn}).text(function(t){return fa[t.partnerType]}).call(za,B.padding[1]-he-Yt-2).append("tspan").attr("dy","1.1em").attr("x",Yt+2).attr("class","pbinadcurlyTspan").text(function(t){return"("+it(re[t.partnerType]/(re.partner+re.subpartner))+")"});St=We.merge(St),We.size()&&St.transition().duration(P).style("opacity",1),St.select("path").transition().duration(P).attr("d",function(t){return He(t.y0,t.y1,Yt,Se)}),St.select("text").transition().duration(P).attr("y",function(t){return(t.y0+t.y1)/2-mn}),St.select(".pbinadcurlyTspan").text(function(t){return"("+it(re[t.partnerType]/(re.partner+re.subpartner))+")"});let It=B.main.selectAll(".pbinadtypePercentageGroup").data(J,function(t){return t.id}),fi=It.exit().transition().duration(P).style("opacity",0).remove(),rn=It.enter().append("g").attr("class","pbinadtypePercentageGroup").style("opacity",0).attr("transform",function(t){return"translate("+(B.width-B.padding[1]+xn)+","+(t.y0+t.y1)/2+")"});rn.append("text").attr("class","pbinadtypePercentage").text(function(t){return"$"+tt(t.amount).replace("G","B")});let gi=rn.append("text").attr("class","pbinadtypePercentageSubText").attr("dy","1em").text(function(t){return ft.set(this,t.amount/gt),"("+it(t.amount/gt)+")"});It=rn.merge(It),It.call(rt,et*2).transition().duration(P).style("opacity",l.selectedAggregation==="type"?1:0).attr("transform",function(t){return"translate("+(B.width-B.padding[1]+xn)+","+(t.y0+t.y1)/2+")"}),It.select(".pbinadtypePercentage").transition().duration(P).tween("text",function(t){let r=this,o=d3.interpolate(je(r.textContent.substring(1))||0,t.amount);return function(e){r.textContent="$"+tt(o(e)).replace("G","B")}}),It.select(".pbinadtypePercentageSubText").transition().duration(P).tween("text",function(t){let r=this,o=ft.get(this);ft.set(this,t.amount/gt);let e=d3.interpolate(o,t.amount/gt);return function(d){r.textContent="("+it(e(d))+")"}}),k.on("mouseover",function(t){t.level===1&&Ua(t,this),t.level===2&&Wa(t,this),t.level===3&&$a(t,this)}).on("mouseout",Yn),Y.on("mouseover",function(t){t.sourceLevel===1&&_a(t,this),t.sourceLevel===2&&qa(t,this)}).on("mouseout",Yn);function Yn(){xe||(Vt=null,F.style("display","none"),k.style("opacity",1),Y.style("stroke-opacity",ee),b.style("opacity",1).call(rt,et),z.style("opacity",1).call(rt,et),wt.style("opacity",1).each(function(t){H.get(this)&&(d3.select(this).select(".pbinadsankeyPartnerValuesLabels").each(function(r){this.textContent=H.get(this)}),d3.select(this).select(".pbinadsankeyPartnerValuesLabelsSubText").each(function(r){this.textContent=H.get(this)})),H.set(this,!1)}).call(rt,et*2),yt.style("opacity",1).call(rt,et*(l.selectedAggregation==="level"?1:2)),Gt.style("opacity",1),It.style("opacity",l.selectedAggregation==="type"?1:0).each(function(t){H.get(this)&&(d3.select(this).select(".pbinadtypePercentage").each(function(r){this.textContent=H.get(this)}),d3.select(this).select(".pbinadtypePercentageSubText").each(function(r){this.textContent=H.get(this)})),H.set(this,!1)}).call(rt,et*2),St.style("opacity",1))}function Ua(t,r){Vt=r,k.style("opacity",function(o){return o.id===t.id||o.targetLinks.find(function(e){return e.fund===t.codeId})?1:G}),l.selectedAggregation==="type"&&$e(),Y.style("stroke-opacity",function(o){return o.fund===t.codeId?ee:ge}),b.style("opacity",function(o){return o.id===t.id?1:G}).filter(function(o){return o.id===t.id}).style("display",null),z.style("opacity",function(o){return o.targetLinks.find(function(e){return e.fund===t.codeId})?1:G}).filter(function(o){return o.targetLinks.find(function(e){return e.fund===t.codeId})}).style("display",null).call(rt,et),wt.style("opacity",function(o){return o.targetLinks.find(function(e){return e.fund===t.codeId})?1:G}).filter(function(o){return o.targetLinks.find(function(e){return e.fund===t.codeId})}).each(function(o){let e=o.targetLinks.find(function(d){return d.fund===t.codeId}).value;H.set(this,!0),d3.select(this).select(".pbinadsankeyPartnerValuesLabels").each(function(d){H.set(this,this.textContent),this.textContent="$"+tt(e)}),d3.select(this).select(".pbinadsankeyPartnerValuesLabelsSubText").each(function(d){H.set(this,this.textContent),this.textContent=""})}).style("display",null).call(rt,et*2),yt.style("opacity",function(o){return o.targetLinks.find(function(e){return e.fund===t.codeId})?1:G}).filter(function(o){return o.targetLinks.find(function(e){return e.fund===t.codeId})}).style("display",null).call(rt,et*(l.selectedAggregation==="level"?1:2)),Gt.style("opacity",function(o){return o.targetLinks.find(function(e){return e.fund===t.codeId})?1:G}),It.style("opacity",function(o){return o.targetLinks.find(function(e){return e.fund===t.codeId})?1:G}).filter(function(o){return o.targetLinks.find(function(e){return e.fund===t.codeId})}).each(function(o){let e=d3.sum(o.targetLinks.filter(function(d){return d.fund===t.codeId}),function(d){return d.value});H.set(this,!0),d3.select(this).select(".pbinadtypePercentage").each(function(d){H.set(this,this.textContent),this.textContent="$"+tt(e)}),d3.select(this).select(".pbinadtypePercentageSubText").each(function(d){H.set(this,this.textContent),this.textContent=""})}).style("display",null).call(rt,et),St.style("opacity",0),Xa(t,r)}function Wa(t,r){Vt=r,k.style("opacity",function(o){return o.id===t.id||o.sourceLinks.find(function(e){return e.target.id===t.id})||o.targetLinks.find(function(e){return e.source.id===t.id})?1:G}),l.selectedAggregation==="type"&&$e(),Y.style("stroke-opacity",function(o){return o.source.id===t.id||o.target.id===t.id?ee:ge}),b.style("opacity",function(o){return o.sourceLinks.find(function(e){return e.target.id===t.id})?1:G}).filter(function(o){return o.sourceLinks.find(function(e){return e.target.id===t.id})}).style("display",null).call(rt,et),z.style("opacity",function(o){return o.codeId===t.codeId?1:G}).filter(function(o){return o.codeId===t.codeId}).style("display",null),wt.style("opacity",function(o){return o.codeId===t.codeId?1:G}).filter(function(o){return o.codeId===t.codeId}).style("display",null),yt.style("opacity",function(o){return o.targetLinks.find(function(e){return e.source.id===t.id})?1:G}).filter(function(o){return o.targetLinks.find(function(e){return e.source.id===t.id})}).style("display",null).call(rt,et*(l.selectedAggregation==="level"?1:2)),Gt.style("opacity",function(o){return o.targetLinks.find(function(e){return e.source.id===t.id})?1:G}),It.style("opacity",function(o){return o.targetLinks.find(function(e){return e.source.id===t.id})?1:G}).filter(function(o){return o.targetLinks.find(function(e){return e.source.id===t.id})}).each(function(o){let e=d3.sum(o.targetLinks.filter(function(d){return d.source.codeId===t.codeId}),function(d){return d.value});H.set(this,!0),d3.select(this).select(".pbinadtypePercentage").each(function(d){H.set(this,this.textContent),this.textContent="$"+tt(e)}),d3.select(this).select(".pbinadtypePercentageSubText").each(function(d){H.set(this,this.textContent),this.textContent=""})}).style("display",null).call(rt,et*2),St.style("opacity",0),Ka(t,r)}function $a(t,r){Vt=r;let o;l.selectedAggregation==="level"?o=t.targetLinks.map(function(e){return e.fund+"_"+e.source.id}):(o=[],k.each(function(e){e.codeId===t.codeId&&e.level===3&&o.push.apply(o,e.targetLinks.map(function(d){return d.fund+"_"+d.source.id}))})),k.style("opacity",function(e){return e.id===t.id||e.sourceLinks.find(function(d){return l.selectedAggregation==="level"?d.target.id===t.id:d.target.codeId===t.codeId})||o.find(function(d){return d.split("_")[0]===e.codeId})||l.selectedAggregation==="type"&&t.codeId===e.codeId?1:G}),Y.style("stroke-opacity",function(e){return(l.selectedAggregation==="level"?e.target.id===t.id:e.target.codeId===t.codeId)||e.sourceLevel===1&&o.indexOf(e.fund+"_"+e.target.id)>-1?ee:ge}),b.style("opacity",function(e){return o.find(function(d){return d.split("_")[0]===e.codeId})?1:G}).filter(function(e){return o.find(function(d){return d.split("_")[0]===e.codeId})}).style("display",null).call(rt,et),z.style("opacity",function(e){return e.sourceLinks.find(function(d){return l.selectedAggregation==="level"?d.target.id===t.id:d.target.codeId===t.codeId})?1:G}).filter(function(e){return e.sourceLinks.find(function(d){return l.selectedAggregation==="level"?d.target.id===t.id:d.target.codeId===t.codeId})}).style("display",null).call(rt,et),wt.style("opacity",function(e){return e.sourceLinks.find(function(d){return l.selectedAggregation==="level"?d.target.id===t.id:d.target.codeId===t.codeId})?1:G}).filter(function(e){return e.sourceLinks.find(function(d){return l.selectedAggregation==="level"?d.target.id===t.id:d.target.codeId===t.codeId})}).each(function(e){let d=d3.sum(e.sourceLinks.filter(function(w){return l.selectedAggregation==="level"?w.target.id===t.id:w.target.codeId===t.codeId}),function(w){return w.value});H.set(this,!0),d3.select(this).select(".pbinadsankeyPartnerValuesLabels").each(function(w){H.set(this,this.textContent),this.textContent="$"+tt(d)}),d3.select(this).select(".pbinadsankeyPartnerValuesLabelsSubText").each(function(w){H.set(this,this.textContent),this.textContent=""})}).style("display",null).call(rt,et*2),yt.style("opacity",function(e){return l.selectedAggregation==="level"?e.id===t.id?1:G:e.codeId===t.codeId?1:G}).filter(function(e){return l.selectedAggregation==="level"?e.id===t.id:e.codeId===t.codeId}).style("display",null),Gt.style("opacity",function(e){return e.codeId===t.codeId?1:G}),It.style("opacity",function(e){return l.selectedAggregation==="level"?e.id===t.id?1:G:e.codeId===t.codeId?1:G}).filter(function(e){return l.selectedAggregation==="level"?e.id===t.id:e.codeId===t.codeId}).style("display",null),St.style("opacity",0),l.selectedAggregation==="type"?Qa(t,r):t.id.split("#")[0]==="partner"?Za(t,r):Ja(t,r)}function _a(t,r){Vt=r;let o=Y.filter(function(e){return e.source.id===t.target.id&&e.fund===t.fund}).data();k.style("opacity",function(e){return e.codeId===t.fund||e.id===t.target.id||o.find(function(d){return d.target.id===e.id})?1:G}),l.selectedAggregation==="type"&&$e(),Y.style("stroke-opacity",function(e){return e.index===t.index||e.source.id===t.target.id&&e.fund===t.fund?ee:ge}),b.style("opacity",function(e){return e.codeId===t.fund?1:G}).filter(function(e){return e.codeId===t.fund}).style("display",null),z.style("opacity",function(e){return e.id===t.target.id?1:G}).filter(function(e){return e.id===t.target.id}).style("display",null),wt.style("opacity",function(e){return e.id===t.target.id?1:G}).filter(function(e){return e.id===t.target.id}).each(function(e){let d=t.value;H.set(this,!0),d3.select(this).select(".pbinadsankeyPartnerValuesLabels").each(function(w){H.set(this,this.textContent),this.textContent="$"+tt(d)}),d3.select(this).select(".pbinadsankeyPartnerValuesLabelsSubText").each(function(w){H.set(this,this.textContent),this.textContent=""})}).style("display",null),yt.style("opacity",function(e){return o.find(function(d){return l.selectedAggregation==="level"?d.target.id===e.id:d.target.codeId===e.codeId})?1:G}).filter(function(e){return o.find(function(d){return l.selectedAggregation==="level"?d.target.id===e.id:d.target.codeId===e.codeId})}).style("display",null).call(rt,et*(l.selectedAggregation==="level"?1:2)),Gt.style("opacity",function(e){return o.find(function(d){return d.target.codeId===e.codeId})?1:G}),It.style("opacity",function(e){return o.find(function(d){return l.selectedAggregation==="level"?d.target.id===e.id:d.target.codeId===e.codeId})?1:G}).filter(function(e){return o.find(function(d){return l.selectedAggregation==="level"?d.target.id===e.id:d.target.codeId===e.codeId})}).each(function(e){let d=d3.sum(o.filter(function(w){return l.selectedAggregation==="level"?w.target.id===e.id:w.target.codeId===e.codeId}),function(w){return w.value});H.set(this,!0),d3.select(this).select(".pbinadtypePercentage").each(function(w){H.set(this,this.textContent),this.textContent="$"+tt(d)}),d3.select(this).select(".pbinadtypePercentageSubText").each(function(w){H.set(this,this.textContent),this.textContent=""})}).style("display",null).call(rt,et*2),St.style("opacity",0),ti(t,r)}function qa(t,r){Vt=r;let o=Y.filter(function(e){return e.target.id===t.source.id&&e.fund===t.fund}).data();k.style("opacity",function(e){return e.id===t.source.id||e.id===t.target.id||o.find(function(d){return d.source.id===e.id})?1:G}),l.selectedAggregation==="type"&&$e(),Y.style("stroke-opacity",function(e){return e.index===t.index||e.target.id===t.source.id&&e.fund===t.fund?ee:ge}),b.style("opacity",function(e){return o.find(function(d){return d.fund===e.codeId})?1:G}).filter(function(e){return o.find(function(d){return d.fund===e.codeId})}).style("display",null),z.style("opacity",function(e){return e.id===t.source.id?1:G}).filter(function(e){return e.id===t.source.id}).style("display",null),wt.style("opacity",function(e){return e.id===t.source.id?1:G}).filter(function(e){return e.id===t.source.id}).each(function(e){let d=t.value;H.set(this,!0),d3.select(this).select(".pbinadsankeyPartnerValuesLabels").each(function(w){H.set(this,this.textContent),this.textContent="$"+tt(d)}),d3.select(this).select(".pbinadsankeyPartnerValuesLabelsSubText").each(function(w){H.set(this,this.textContent),this.textContent=""})}).style("display",null),yt.style("opacity",function(e){return l.selectedAggregation==="level"?e.id===t.target.id?1:G:e.codeId===t.target.codeId?1:G}).filter(function(e){return l.selectedAggregation==="level"?e.id===t.target.id:e.codeId===t.target.codeId}).style("display",null),Gt.style("opacity",function(e){return e.codeId===t.target.codeId?1:G}),It.style("opacity",function(e){return l.selectedAggregation==="level"?e.id===t.target.id?1:G:e.codeId===t.target.codeId?1:G}).filter(function(e){return l.selectedAggregation==="level"?e.id===t.target.id:e.codeId===t.target.codeId}).each(function(e){let d=t.value;H.set(this,!0),d3.select(this).select(".pbinadtypePercentage").each(function(w){H.set(this,this.textContent),this.textContent="$"+tt(d)}),d3.select(this).select(".pbinadtypePercentageSubText").each(function(w){H.set(this,this.textContent),this.textContent=""})}).style("display",null),St.style("opacity",0),ei(t,r)}function Xa(t,r){F.style("display","block").html(null);let o=F.append("div").style("margin-bottom","10px").style("color","dimgray").style("width","300px");o.append("div").append("strong").html(t.name),o.append("div").style("margin-bottom","8px").style("font-size","12px").html("(Fund)");let e=o.append("div").style("margin","0px").style("display","flex").style("flex-wrap","wrap").style("width","100%"),d=f.links.filter(function(C){return C.fund===t.codeId}),w=[t.amount,d3.sum(d.filter(function(C){return C.target.id.split("#")[0]==="subpartner"}),function(C){return C.value})],N=d3.sum(f.nodes.filter(function(C){return C.level===1}),function(C){return C.amount});w.forEach(function(C,$){e.append("div").style("display","flex").style("flex","0 56%").html($?"Transferred to sub-impl.:":"Total allocated:"),e.append("div").style("display","flex").style("flex","0 44%").style("justify-content","flex-end").style("align-items","flex-end").html("$"+Et(C)),e.append("div").style("display","flex").style("width","100%").style("font-size","12px").style("margin-bottom","6px").style("justify-content","flex-end").html($?"("+it(w[0]?w[1]/w[0]:0)+" of total fund allocation: "+Rt(w[0])+")":"("+it(N?w[0]/N:0)+" of total CBPFs allocation: "+Rt(N)+")")});let W=d.reduce(function(C,$){if($.sourceLevel===2){let ct=$.target.id.split("#")[0],I=C.find(function(Tt){return Tt.codeId===$.target.codeId});I?(I.partnerValue+=ct==="partner"?$.value:0,I.subpartnerValue+=ct==="subpartner"?$.value:0):C.push({codeId:$.target.codeId,partnerValue:ct==="partner"?$.value:0,subpartnerValue:ct==="subpartner"?$.value:0})}return C},[]);if(W.length){let C=[12,60,2,70];W.sort(function(E,Bt){return Bt.partnerValue+Bt.subpartnerValue-(E.partnerValue+E.subpartnerValue)}),o.append("div").style("margin-bottom","4px").style("margin-top","10px").html("Net funding (numbers represent <span style='color:#333;font-style:italic;'>total</span> and <span style='color:"+bt+";font-style:italic;'>sub-implementing</span>):");let $=C[0]+C[2]+W.length*Ie,ct=F.append("svg").attr("width",Ut).attr("height",$);Lt.range([C[0],$-C[2]]).domain(W.map(function(E){return E.codeId})).padding(.5),Zt.tickSizeInner(-($-C[0]-C[2])),Kt.tickFormat(function(E){return E==="O"?"RC/RCS":vt[E]});let I=[],Tt=qt.selectAll(null).data(Lt.domain()).enter().append("text").style("font-size","11px").style("font-family","Arial").text(function(E){return E==="O"?"RC/RCS":vt[E]}).each(function(E){I.push(this.getComputedTextLength())});qt.selectAll("*").remove(),C[3]=d3.max(I)+6,ot.range([C[3],Ut-C[1]]).domain([0,d3.max(W,function(E){return E.partnerValue+E.subpartnerValue})]);let zt=ct.append("g").attr("class","pbinadTooltipSvgYAxisGroup").attr("transform","translate("+C[3]+",0)").call(Kt),se=ct.append("g").attr("class","pbinadTooltipSvgXAxisGroup").attr("transform","translate(0,"+C[0]+")").call(Zt).selectAll(".tick").filter(function(E){return E===0}).remove(),D=ct.selectAll(null).data(W).enter().append("g").attr("transform",function(E){return"translate(0,"+Lt(E.codeId)+")"}).each(function(E){d3.select(this).append("rect").attr("x",C[3]).attr("y",-kt/4).attr("height",kt).attr("width",0).style("fill",we).transition().duration(P).attr("width",ot(E.partnerValue+E.subpartnerValue)-C[3]),d3.select(this).append("rect").attr("x",C[3]).attr("y",-kt/4).attr("height",kt).attr("width",0).style("fill",bt).transition().duration(P).attr("width",ot(E.subpartnerValue)-C[3]),d3.select(this).append("circle").attr("cx",C[3]).attr("cy",kt/4).attr("r",Wt).style("fill",function(Bt){return Bt.partnerValue?we:bt}).transition().duration(P).attr("cx",ot(E.partnerValue+E.subpartnerValue)),d3.select(this).append("text").attr("class","pbinadtooltipSvgLabel").attr("x",ot(0)).attr("y",4).text(Oe(0)).transition().duration(P).attr("x",ot(E.partnerValue+E.subpartnerValue)+Be+Wt).tween("text",function(){let Bt=this,Nt=d3.interpolate(0,E.partnerValue+E.subpartnerValue),at=d3.interpolate(0,E.subpartnerValue);return function(Jt){d3.select(Bt).text(d3.formatPrefix(".0",Nt(Jt))(Nt(Jt)).replace("G","B")).append("tspan").style("fill",bt).text(" ("+d3.formatPrefix(".0",at(Jt))(at(Jt)).replace("G","B")+")")}})})}let Q=r.getBoundingClientRect(),Z=M.node().getBoundingClientRect(),mt=F.node().getBoundingClientRect(),At=Q.top-ht>mt.height?Q.top-Z.top-mt.height-ht:Q.top-Z.top+Q.height+ht,v=Math.max(0,Q.left-Z.left+Q.width/2-mt.width/2);F.style("top",At+"px").style("left",v+"px")}function Ka(t,r){F.style("display","block").html(null);let o=F.append("div").style("margin-bottom","10px").style("color","dimgray").style("width","300px");o.append("div").append("strong").html(t.name),o.append("div").style("margin-bottom","8px").style("font-size","12px").html("(Direct Partner)");let e=o.append("div").style("margin","0px").style("display","flex").style("flex-wrap","wrap").style("width","100%"),d=[t.amount,t.amount-d3.sum(t.sourceLinks.filter(function(v){return v.target.id.split("@")[0]==="partner#"+t.codeId}),function(v){return v.value})],w=d3.sum(f.nodes.filter(function(v){return v.level===2}),function(v){return v.amount});d.forEach(function(v,C){e.append("div").style("display","flex").style("flex","0 56%").html(C?"Transferred to sub-impl.:":"Total received:"),e.append("div").style("display","flex").style("flex","0 44%").style("justify-content","flex-end").style("align-items","flex-end").html("$"+Et(v)),e.append("div").style("display","flex").style("width","100%").style("font-size","12px").style("margin-bottom","6px").style("justify-content","flex-end").html(C?"("+it(d[0]?d[1]/d[0]:0)+" of total "+t.name+": "+Rt(d[0])+")":"("+it(d[0]?d[1]/d[0]:0)+" of total direct allocation: "+Rt(w)+")")});let N=t.sourceLinks.reduce(function(v,C){if(C.target.id.split("#")[0]==="subpartner"){let $=v.find(function(ct){return ct.codeId===C.target.codeId});$?$.value+=C.value:v.push({codeId:C.target.codeId,value:C.value})}return v},[]);if(N.length){let v=[12,36,2,70];N.sort(function(D,E){return E.value-D.value}),o.append("div").style("margin-bottom","4px").style("margin-top","10px").html("Sub-implementing partners:");let C=v[0]+v[2]+N.length*Ie,$=F.append("svg").attr("width",Ut).attr("height",C);Lt.range([v[0],C-v[2]]).domain(N.map(function(D){return D.codeId})).padding(.5),Zt.tickSizeInner(-(C-v[0]-v[2])),Kt.tickFormat(function(D){return D==="O"?"RC/RCS":vt[D]});let ct=[],I=qt.selectAll(null).data(Lt.domain()).enter().append("text").style("font-size","11px").style("font-family","Arial").text(function(D){return D==="O"?"RC/RCS":vt[D]}).each(function(D){ct.push(this.getComputedTextLength())});qt.selectAll("*").remove(),v[3]=d3.max(ct)+6,ot.range([v[3],Ut-v[1]]).domain([0,d3.max(N,function(D){return D.value})]);let Tt=$.append("g").attr("class","pbinadTooltipSvgYAxisGroup").attr("transform","translate("+v[3]+",0)").call(Kt),zt=$.append("g").attr("class","pbinadTooltipSvgXAxisGroup").attr("transform","translate(0,"+v[0]+")").call(Zt).selectAll(".tick").filter(function(D){return D===0}).remove(),se=$.selectAll(null).data(N).enter().append("g").attr("transform",function(D){return"translate(0,"+Lt(D.codeId)+")"}).each(function(D){d3.select(this).append("rect").attr("x",v[3]).attr("y",-kt/4).attr("height",kt).attr("width",0).style("fill",bt).transition().duration(P).attr("width",ot(D.value)-v[3]),d3.select(this).append("circle").attr("cx",v[3]).attr("cy",kt/4).attr("r",Wt).style("fill",bt).transition().duration(P).attr("cx",ot(D.value)),d3.select(this).append("text").attr("class","pbinadtooltipSvgLabel").attr("x",ot(0)).attr("y",4).text(Oe(0)).transition().duration(P).attr("x",ot(D.value)+Be+Wt).tween("text",function(){let E=this,Bt=d3.interpolate(0,D.value);return function(Nt){E.textContent=d3.formatPrefix(".0",Bt(Nt))(Bt(Nt)).replace("G","B")}})})}let W=r.getBoundingClientRect(),Q=M.node().getBoundingClientRect(),Z=F.node().getBoundingClientRect(),mt=W.top-ht>Z.height?W.top-Q.top-Z.height-ht:W.top-Q.top+W.height+ht,At=W.right-W.width/2-Z.width/2-Q.left;F.style("top",mt+"px").style("left",At+"px")}function Za(t,r){F.style("display","block").html(null);let o=F.append("div").style("margin-bottom","10px").style("color","dimgray").style("width","300px");o.append("div").append("strong").html(t.name),o.append("div").style("margin-bottom","8px").style("font-size","12px").html("(Direct Partner)");let e=o.append("div").style("margin","0px").style("display","flex").style("flex-wrap","wrap").style("width","100%"),d=d3.sum(f.nodes.filter(function(At){return At.level===2&&At.codeId===t.codeId}),function(At){return At.amount});e.append("div").style("display","flex").style("flex","0 56%").html("Total direct fund kept:"),e.append("div").style("display","flex").style("flex","0 44%").style("justify-content","flex-end").style("align-items","flex-end").html("$"+Et(t.amount));let w=d>t.amount?it(Math.abs(t.amount/d-1))+" reduced from ":"the same of ";e.append("div").style("display","flex").style("width","100%").style("font-size","12px").style("justify-content","flex-end").html("("+w+"actual direct funding: "+Rt(d)+")");let N=r.getBoundingClientRect(),W=M.node().getBoundingClientRect(),Q=F.node().getBoundingClientRect(),Z=N.top-ht>Q.height?N.top-W.top-Q.height-ht:N.top-W.top+N.height+ht,mt=W.width-Q.width;F.style("top",Z+"px").style("left",mt+"px")}function Ja(t,r){F.style("display","block").html(null);let o=F.append("div").style("margin-bottom","10px").style("color","dimgray").style("width","300px");o.append("div").append("strong").html(t.name),o.append("div").style("margin-bottom","8px").style("font-size","12px").html("(Sub-implementing Partner)");let e=o.append("div").style("margin","0px").style("display","flex").style("flex-wrap","wrap").style("width","100%");e.append("div").style("display","flex").style("flex","0 56%").html("Total received:"),e.append("div").style("display","flex").style("flex","0 44%").style("justify-content","flex-end").style("align-items","flex-end").html("$"+Et(t.value));let d=d3.sum(f.nodes.filter(function(v){return v.id.split("#")[0]==="subpartner"}),function(v){return v.amount}),w=d3.sum(f.nodes.filter(function(v){return v.level===3}),function(v){return v.amount});e.append("div").style("display","flex").style("width","100%").style("font-size","12px").style("justify-content","flex-end").html("("+it(d?t.value/d:0)+" of total sub-impl. funding: "+Rt(d)+")"),e.append("div").style("display","flex").style("width","100%").style("font-size","12px").style("justify-content","flex-end").html("("+it(w?t.value/w:0)+" of total funding: "+Rt(w)+")");let N=t.targetLinks.reduce(function(v,C){if(C.target.id.split("#")[0]==="subpartner"){let $=v.find(function(ct){return ct.codeId===C.source.codeId});$?$.value+=C.value:v.push({codeId:C.source.codeId,value:C.value})}return v},[]);if(N.length){let v=[12,36,2,70];N.sort(function(D,E){return E.value-D.value}),o.append("div").style("margin-bottom","4px").style("margin-top","10px").html("Funding received:");let C=v[0]+v[2]+N.length*Ie,$=F.append("svg").attr("width",Ut).attr("height",C);Lt.range([v[0],C-v[2]]).domain(N.map(function(D){return D.codeId})).padding(.5),Zt.tickSizeInner(-(C-v[0]-v[2])),Kt.tickFormat(function(D){return D==="O"?"RC/RCS":vt[D]});let ct=[],I=qt.selectAll(null).data(Lt.domain()).enter().append("text").style("font-size","11px").style("font-family","Arial").text(function(D){return D==="O"?"RC/RCS":vt[D]}).each(function(D){ct.push(this.getComputedTextLength())});qt.selectAll("*").remove(),v[3]=d3.max(ct)+6,ot.range([v[3],Ut-v[1]]).domain([0,d3.max(N,function(D){return D.value})]);let Tt=$.append("g").attr("class","pbinadTooltipSvgYAxisGroup").attr("transform","translate("+v[3]+",0)").call(Kt),zt=$.append("g").attr("class","pbinadTooltipSvgXAxisGroup").attr("transform","translate(0,"+v[0]+")").call(Zt).selectAll(".tick").filter(function(D){return D===0}).remove(),se=$.selectAll(null).data(N).enter().append("g").attr("transform",function(D){return"translate(0,"+Lt(D.codeId)+")"}).each(function(D){d3.select(this).append("rect").attr("x",v[3]).attr("y",-kt/4).attr("height",kt).attr("width",0).style("fill",bt).transition().duration(P).attr("width",ot(D.value)-v[3]),d3.select(this).append("circle").attr("cx",v[3]).attr("cy",kt/4).attr("r",Wt).style("fill",bt).transition().duration(P).attr("cx",ot(D.value)),d3.select(this).append("text").attr("class","pbinadtooltipSvgLabel").attr("x",ot(0)).attr("y",4).text(Oe(0)).transition().duration(P).attr("x",ot(D.value)+Be+Wt).tween("text",function(){let E=this,Bt=d3.interpolate(0,D.value);return function(Nt){E.textContent=d3.formatPrefix(".0",Bt(Nt))(Bt(Nt)).replace("G","B")}})})}let W=r.getBoundingClientRect(),Q=M.node().getBoundingClientRect(),Z=F.node().getBoundingClientRect(),mt=W.top-ht>Z.height?W.top-Q.top-Z.height-ht:W.top-Q.top+W.height+ht,At=Q.width-Z.width;F.style("top",mt+"px").style("left",At+"px")}function Qa(t,r){let o=t.id.split("#")[0]==="subpartner"?t:f.nodes.find(function(I){return I.codeId===t.codeId&&I.level===3&&I.id.split("#")[0]==="subpartner"}),e=d3.sum(f.nodes.filter(function(I){return I.codeId===t.codeId&&I.level===3}),function(I){return I.amount}),d=d3.sum(f.nodes.filter(function(I){return I.level===2&&I.codeId===t.codeId}),function(I){return I.amount}),w=d3.sum(f.nodes.filter(function(I){return I.level===3}),function(I){return I.amount}),N,W;t.id.split("#")[0]==="partner"?(N=t.amount,W=e-N):(W=t.amount,N=e-W),F.style("display","block").html(null);let Q=F.append("div").style("margin-bottom","10px").style("color","dimgray").style("width","300px");Q.append("div").append("strong").html(t.name),Q.append("div").style("margin-bottom","8px").style("font-size","12px").html("(Net funding)");let Z=Q.append("div").style("margin","0px").style("display","flex").style("flex-wrap","wrap").style("width","100%");if(Z.append("div").style("display","flex").style("flex","0 56%").html("Total received:"),Z.append("div").style("display","flex").style("flex","0 44%").style("justify-content","flex-end").style("align-items","flex-end").html("$"+Et(e)),Z.append("div").style("display","flex").style("width","100%").style("font-size","12px").style("justify-content","flex-end").style("text-align","right").html("("+it(w?e/w:0)+" of total allocation: "+Rt(w)+")"),ie.indexOf(t.codeId)>-1){let I=e>d?" increase":" decrease";Z.append("div").style("display","flex").style("width","100%").style("font-size","12px").style("justify-content","flex-end").style("text-align","right").style("margin-bottom","8px").html("("+it(Math.abs(e/d-1))+I+" from direct funding: "+Rt(d)+")"),Z.append("div").style("display","flex").style("flex","0 56%").html("Direct partner funding:"),Z.append("div").style("display","flex").style("flex","0 44%").style("justify-content","flex-end").style("align-items","flex-end").html("$"+Et(N)),Z.append("div").style("display","flex").style("width","100%").style("font-size","12px").style("justify-content","flex-end").style("text-align","right").html("("+it(e?N/e:0)+" of total "+(t.codeId==="O"?"RC/RCS":t.name)+" allocation: "+Rt(e)+")")}Z.append("div").style("display","flex").style("flex","0 56%").style("margin-top","8px").html("Sub-impl. funding:"),Z.append("div").style("display","flex").style("flex","0 44%").style("justify-content","flex-end").style("align-items","flex-end").html("$"+Et(W)),Z.append("div").style("display","flex").style("width","100%").style("font-size","12px").style("justify-content","flex-end").style("text-align","right").style("margin-bottom","8px").html("("+it(e?W/e:0)+" of total "+(t.codeId==="O"?"RC/RCS":t.name)+" allocation: "+Rt(e)+")");let mt=o?o.targetLinks.reduce(function(I,Tt){if(Tt.target.id.split("#")[0]==="subpartner"){let zt=I.find(function(se){return se.codeId===Tt.source.codeId});zt?zt.value+=Tt.value:I.push({codeId:Tt.source.codeId,value:Tt.value})}return I},[]):[];if(mt.length){let I=[12,36,2,70];mt.sort(function(at,Jt){return Jt.value-at.value}),Q.append("div").style("margin-bottom","4px").style("margin-top","10px").html("Funding received as sub-impl.:");let Tt=I[0]+I[2]+mt.length*Ie,zt=F.append("svg").attr("width",Ut).attr("height",Tt);Lt.range([I[0],Tt-I[2]]).domain(mt.map(function(at){return at.codeId})).padding(.5),Zt.tickSizeInner(-(Tt-I[0]-I[2])),Kt.tickFormat(function(at){return at==="O"?"RC/RCS":vt[at]});let se=[],D=qt.selectAll(null).data(Lt.domain()).enter().append("text").style("font-size","11px").style("font-family","Arial").text(function(at){return at==="O"?"RC/RCS":vt[at]}).each(function(at){se.push(this.getComputedTextLength())});qt.selectAll("*").remove(),I[3]=d3.max(se)+6,ot.range([I[3],Ut-I[1]]).domain([0,d3.max(mt,function(at){return at.value})]);let E=zt.append("g").attr("class","pbinadTooltipSvgYAxisGroup").attr("transform","translate("+I[3]+",0)").call(Kt),Bt=zt.append("g").attr("class","pbinadTooltipSvgXAxisGroup").attr("transform","translate(0,"+I[0]+")").call(Zt).selectAll(".tick").filter(function(at){return at===0}).remove(),Nt=zt.selectAll(null).data(mt).enter().append("g").attr("transform",function(at){return"translate(0,"+Lt(at.codeId)+")"}).each(function(at){d3.select(this).append("rect").attr("x",I[3]).attr("y",-kt/4).attr("height",kt).attr("width",0).style("fill",bt).transition().duration(P).attr("width",ot(at.value)-I[3]),d3.select(this).append("circle").attr("cx",I[3]).attr("cy",kt/4).attr("r",Wt).style("fill",bt).transition().duration(P).attr("cx",ot(at.value)),d3.select(this).append("text").attr("class","pbinadtooltipSvgLabel").attr("x",ot(0)).attr("y",4).text(Oe(0)).transition().duration(P).attr("x",ot(at.value)+Be+Wt).tween("text",function(){let Jt=this,En=d3.interpolate(0,at.value);return function(zn){Jt.textContent=d3.formatPrefix(".0",En(zn))(En(zn)).replace("G","B")}})})}let At=r.getBoundingClientRect(),v=M.node().getBoundingClientRect(),C=F.node().getBoundingClientRect(),$=At.top-ht>C.height?At.top-v.top-C.height-ht:At.top-v.top+At.height+ht,ct=v.width-C.width;F.style("top",$+"px").style("left",ct+"px")}function ti(t,r){F.style("display","block").html(null);let o=F.append("div").style("margin-bottom","10px").style("color","dimgray").style("width","250px");o.append("div").html("From: <strong>"+Ot[t.fund]+"</strong>"),o.append("div").style("margin-bottom","8px").html("To: "+ae[t.target.codeId]+" (Direct Partner)");let e=o.append("div").style("margin","0px").style("display","flex").style("flex-wrap","wrap").style("width","100%");e.append("div").style("display","flex").style("flex","0 56%").html("Amount:"),e.append("div").style("display","flex").style("flex","0 44%").style("justify-content","flex-end").style("align-items","flex-end").html("$"+Et(t.value));let d=r.getBoundingClientRect(),w=M.node().getBoundingClientRect(),N=F.node().getBoundingClientRect(),W=r.getBBox().height/(O/w.width),Q=(d.top+d.bottom)/2-W/2-w.top-N.height-ht,Z=d.left+d.width/2-w.left-N.width/2;F.style("top",Q+"px").style("left",Z+"px")}function ei(t,r){F.style("display","block").html(null);let o=F.append("div").style("margin-bottom","10px").style("color","dimgray").style("width","250px");o.append("div").style("margin-bottom","8px").html("Fund: <strong>"+Ot[t.fund]+"</strong>"),o.append("div").html("From: "+ae[t.source.codeId]),o.append("div").style("margin-bottom","8px").html("To: "+t.target.id.split("#")[0]=="partner"?ae[t.target.codeId]+" (direct partner)":vt[t.target.codeId]+" (sub-implementing partner)");let e=o.append("div").style("margin","0px").style("display","flex").style("flex-wrap","wrap").style("width","100%");e.append("div").style("display","flex").style("flex","0 56%").html("Amount:"),e.append("div").style("display","flex").style("flex","0 44%").style("justify-content","flex-end").style("align-items","flex-end").html("$"+Et(t.value)),t.target.id.split("#")[0]==="partner"&&o.append("div").style("margin-top","10px").style("font-size","12px").html("Note: this link just represents the amount kept by the direct partner.");let d=r.getBoundingClientRect(),w=M.node().getBoundingClientRect(),N=F.node().getBoundingClientRect(),W=r.getBBox().height/(O/w.width),Q=(d.top+d.bottom)/2-W/2-w.top-N.height-ht,Z=d.left+d.width/2-w.left-N.width/2;F.style("top",Q+"px").style("left",Z+"px")}function $e(){let t=[];k.each(function(r){r.level===3&&this.style.opacity==="1"&&t.push(r.codeId)}),k.each(function(r){r.level===3&&t.indexOf(r.codeId)>-1&&this.style.opacity!=="1"&&d3.select(this).style("opacity",1)})}A.main.selectAll(".pbinadbuttonsAggregationRects").on("click",function(t){l.selectedAggregation=t,dt.has("aggregate")?dt.set("aggregate",t):dt.append("aggregate",t),A.main.selectAll(".pbinadbuttonsAggregationRects").style("fill",function(r){return r===l.selectedAggregation?ne:"#eaeaea"}),A.main.selectAll(".pbinadbuttonsAggregationText").style("fill",function(r){return r===l.selectedAggregation?"white":"#444"}),ze(n)})}function In(n){let c=Ba(n),a=Ye.selectAll(".pbinadtimelineHeader").data([!0]).enter().append("div").attr("class","pbinadtimelineHeader").html("Allocation trends by Partners types"),s=Ye.selectAll(".pbinadtimelineSubtitle").data([!0]).enter().append("div").attr("class","pbinadtimelineSubtitle").html("Trends for the last three complete years (from "+(Ft-4)+" to "+(Ft-1)+"). Green triangle (<span class='fa' style='color:"+ye+";'>\u25B2</span>) means increase, red triangle (<span class='fa' style='color:"+me+";'>\u25BC</span>) means decrease."),p=Ye.selectAll(".pbinadtimelineContainer").data([!0]);p=p.enter().append("div").attr("class","pbinadtimelineContainer").merge(p);let u=p.selectAll(".pbinadtimelines").data(c,function(y){return y.partner}),h=u.exit().transition().duration(P).style("opacity",0).remove(),i=u.enter().append("div").attr("class","pbinadtimelines").style("width",Kn+"px").style("height",Zn+"px"),T=i.append("div").attr("class","pbinadtimelinesNameDiv").append("p").html(function(y){return y.partner==="NGO"?ta+"<span style='color: "+bt+";'>*</span>":Ve[y.partner]}),g=i.append("div").attr("class","pbinadtimelinesChartDiv"),S=g.append("svg").attr("width",Xe).attr("height",Ke).each(function(y){let q=le.set(this,d3.scaleLinear().range([Ke-$t[2],$t[0]]).domain(d3.extent(y.values)));De.set(this,d3.line().x(function(X,J){return Tn(J)}).y(function(X){return q(X)}))}),f=S.append("text").attr("class","pbinadtimelineSvgInitialValue").attr("text-anchor","end").attr("x",$t[3]-vn).attr("y",function(y){return le.get(this)(y.values[0])+Fe}).text(function(y){return tt(y.values[0]).replace("G","B")}),R=S.append("text").attr("class","pbinadtimelineSvgFinalValue").attr("x",Xe-$t[1]+vn).attr("y",function(y){return le.get(this)(y.values[3])+Fe}).text(function(y){return tt(y.values[3]).replace("G","B")}),nt=S.append("path").attr("class","pbinadtimelineSvgPath").style("fill","none").style("stroke","#bbb").style("stroke-width","1px").attr("d",function(y){return De.get(this)(y.values)}),K=g.append("div").attr("class","pbinadtimelinesArrowDiv").append("div"),U=K.append("span").attr("class","pbinadtimelineArrow").style("font-size","16px").style("color",function(y){return y.values[3]>=y.values[0]?ye:me}).html(function(y){return y.values[3]>=y.values[0]?"\u25B2":"\u25BC"}),Y=K.append("span").attr("class","pbinadtimelinePercentage").html(function(y){return y.values[0]&&y.values[3]?it(Math.abs(y.values[3]/y.values[0]-1)):"n/a"});u=i.merge(u),u.sort(function(y,q){return q.values[3]-y.values[3]}),u.select("svg").each(function(y){let q=le.set(this,d3.scaleLinear().range([Ke-$t[2],$t[0]]).domain(d3.extent(y.values)));De.set(this,d3.line().x(function(X,J){return Tn(J)}).y(function(X){return q(X)}))}),u.select(".pbinadtimelineSvgInitialValue").transition().duration(P).attr("y",function(y){return le.get(this)(y.values[0])+Fe}).tween("text",function(y){let q=this,X=d3.interpolate(je(q.textContent)||0,y.values[0]);return function(J){q.textContent=tt(X(J)).replace("G","B")}}),u.select(".pbinadtimelineSvgFinalValue").transition().duration(P).attr("y",function(y){return le.get(this)(y.values[3])+Fe}).tween("text",function(y){let q=this,X=d3.interpolate(je(q.textContent)||0,y.values[3]);return function(J){q.textContent=tt(X(J)).replace("G","B")}}),u.select(".pbinadtimelineSvgPath").transition().duration(P).attr("d",function(y){return De.get(this)(y.values)}),u.select(".pbinadtimelineArrow").html(function(y){return y.values[3]>=y.values[0]?"\u25B2":"\u25BC"}).style("color",function(y){return y.values[3]>=y.values[0]?ye:me}),u.select(".pbinadtimelinePercentage").html(function(y){return y.values[0]&&y.values[3]?it(Math.abs(y.values[3]/y.values[0]-1)):"n/a"});let Ct=Ye.selectAll(".pbinadtimelinesDisclaimer").data(c.filter(function(y){return y.partner==="NGO"}));Ct.exit().remove(),Ct.enter().append("div").attr("class","pbinadtimelinesDisclaimer").append("span").style("color",bt).html("*").append("span").style("color","#666").html("National Partners includes funding to National NGOs, Government/Others and Private Contractors.")}function wa(n,c){n.forEach(function(a){j.indexOf(+a.year)===-1&&j.push(+a.year),Pt[a.fund]||(Pt[a.fund]=Ot[a.fund]),a.fund==="999"&&(An=!0)}),j.sort(function(a,s){return a-s})}function Ia(n,c,a){return a===0?{underApprovalPercent:0,underPlusApprovedPercent:0}:{underApprovalPercent:n/a*100,underPlusApprovedPercent:(n+c)/a*100}}function en(n,c){let a={nodes:[],links:[]};for(let i in _t)delete _t[i];let s={};ce.launched=0,ce.underApproval=0,oe.length=0,l.cbpfsInData.length=0;let p=l.selectedCbpfs.length===d3.keys(Pt).length;c.forEach(function(i){l.selectedYear.includes(i.AllocationYear)&&(p||l.selectedCbpfs.includes(i.PooledFundId+""))&&(s[i.AllocationYear]={underApproval:(s[i.AllocationYear]?s[i.AllocationYear].underApproval:0)+i.TotalUnderApprovalBudget,approved:(s[i.AllocationYear]?s[i.AllocationYear].approved:0)+i.TotalApprovedBudget,launched:(s[i.AllocationYear]?s[i.AllocationYear].launched:0)+i.TotalUSDPlanned},ce.launched+=i.TotalUSDPlanned,ce.underApproval+=i.TotalUnderApprovalBudget)});for(let i in s){let{underApprovalPercent:T,underPlusApprovedPercent:g}=Ia(s[i].underApproval,s[i].approved,s[i].launched);_t[i]=T>kn||g<kn}n.forEach(function(i){if(l.selectedYear.indexOf(+i.year)>-1&&Re.indexOf(i.source)>-1&&l.cbpfsInData.indexOf(i.source)===-1&&l.cbpfsInData.push(i.source),l.selectedYear.indexOf(+i.year)>-1&&l.selectedCbpfs.indexOf(i.fund)>-1)if(Re.indexOf(i.source)>-1){let T=a.nodes.find(function(f){return f.level===1&&f.codeId===i.source}),g=a.nodes.find(function(f){return f.level===2&&f.codeId===i.target});T?T.amount+=+i.value:a.nodes.push({codeId:i.source,level:1,name:Ot[i.source],amount:+i.value,id:"fund#"+i.source}),g?g.amount+=+i.value:a.nodes.push({codeId:i.target,level:2,name:ae[i.target],amount:+i.value,id:"partner#"+i.target+"@level2"});let S=a.links.find(function(f){return f.source==="fund#"+i.source&&f.target==="partner#"+i.target+"@level2"});S?S.value+=+i.value:a.links.push({source:"fund#"+i.source,target:"partner#"+i.target+"@level2",value:+i.value,fund:i.fund,sourceLevel:1})}else{let T=a.nodes.find(function(f){return f.level===3&&f.codeId===i.target});T?T.amount+=+i.value:a.nodes.push({codeId:i.target,level:3,name:vt[i.target],aggregatedName:Ve[i.target],amount:+i.value,id:"subpartner#"+i.target});let g=a.links.find(function(f){return f.source==="partner#"+i.source+"@level2"&&f.target==="subpartner#"+i.target&&f.fund===i.fund});g?g.value+=+i.value:a.links.push({source:"partner#"+i.source+"@level2",target:"subpartner#"+i.target,value:+i.value,fund:i.fund,sourceLevel:2});let S=oe.find(function(f){return f.partner===i.target});S?S.amount+=+i.value:oe.push({partner:i.target,amount:+i.value})}});let u=a.links.filter(function(i){return i.sourceLevel===1}),h=a.links.filter(function(i){return i.sourceLevel===2});return u.forEach(function(i){let T=i.value,g=h.filter(function(R){return R.source===i.target&&R.fund===i.fund}),S=d3.sum(g,function(R){return R.value}),f=T-S;if(f){let R=i.target.split(/[#@]+/)[1],nt=a.nodes.find(function(K){return K.id==="partner#"+R+"@level3"});nt?nt.amount+=f:a.nodes.push({codeId:R,level:3,name:ae[R],aggregatedName:Ve[R],amount:f,id:"partner#"+R+"@level3"}),a.links.push({source:"partner#"+R+"@level2",target:"partner#"+R+"@level3",value:f,fund:i.fund,sourceLevel:2});let k=oe.find(function(K){return K.partner===R});k?k.amount+=f:oe.push({partner:R,amount:f})}}),oe.sort(function(i,T){return i.amount-T.amount}),a}function Ba(n){let c=[];return n.forEach(function(a){if(l.selectedCbpfs.indexOf(a.fund)>-1){let s=c.find(function(u){return u.partner===a.source&&a.targetType==="2"}),p=c.find(function(u){return ie.indexOf(a.target)===-1?u.partner==="NGO":u.partner===a.target});if(+a.year<Ft&&+a.year>=Ft-4){if(s)s.values[+a.year-(Ft-4)]-=+a.value;else if(!s&&a.targetType==="2"){let u={partner:a.source,values:[0,0,0,0]};u.values[+a.year-(Ft-4)]=-a.value,c.push(u)}if(p)p.values[+a.year-(Ft-4)]+=+a.value;else{let u={partner:ie.indexOf(a.target)===-1?"NGO":a.target,values:[0,0,0,0]};u.values[+a.year-(Ft-4)]=+a.value,c.push(u)}}}}),c.sort(function(a,s){return s.values[3]-a.values[3]}),c}function Da(n){let c=[];return l.selectedYear.forEach(function(s){l.selectedCbpfs.forEach(function(p){for(let u in vt)c.push({Year:s,Fund:Ot[p],"Partner type":vt[u],"Direct funding":0,"Net funding":0})})}),n.forEach(function(s){if(l.selectedYear.indexOf(+s.year)>-1&&l.selectedCbpfs.indexOf(s.fund)>-1){let p=c.find(function(u){return u.Year===+s.year&&u.Fund===Ot[s.fund]&&u["Partner type"]===vt[s.target]});if(p){if(Re.indexOf(s.source)>-1)p["Direct funding"]+=+s.value,p["Net funding"]+=+s.value;else if(s.source!==s.target){p["Net funding"]+=+s.value;let u=c.find(function(h){return h.Year===+s.year&&h.Fund===Ot[s.fund]&&h["Partner type"]===vt[s.source]});u&&(u["Net funding"]-=+s.value)}}else console.warn("partner not found:"),console.warn(s),console.warn("------------")}}),d3.csvFormat(c)}function Fa(n){n.forEach(function(c){Ot[c.PFId+""]=c.PFName,Re.push(c.PFId+"")})}function Oa(n){n.forEach(function(c){ae[c.OrgTypeCode]=c.OrgTypeNm,ie.push(c.OrgTypeCode)})}function Va(n){n.forEach(function(c){vt[c.PublicSubIPCode]=c.PublicSubIPName,ga.push(c.PublicSubIPCode),Ve[c.PublicSubIPCode]=ae[c.PublicSubIPCode]||c.PublicSubIPName})}function Ra(n){n.split(",").map(function(a){return+a.trim()}).sort(function(a,s){return a-s}).forEach(function(a){a&&j.indexOf(a)>-1&&l.selectedYear.push(a)}),l.selectedYear.length||l.selectedYear.push(j[j.length-1])}function Bn(n){if(j.indexOf(n)>-1)return n;for(;j.indexOf(n)===-1;)n=n>=Ft?n-1:n+1;return n}function Ne(n){let c=document.createElementNS("http://www.w3.org/2000/svg","g");c.setAttributeNS(null,"transform",n);let a=c.transform.baseVal.consolidate().matrix;return[a.e,a.f]}function Ga(n){let c=[],a=n.split(",").map(function(p){return p.trim().toLowerCase()});return a.some(function(p){return Ma(d3.values(Pt)).indexOf(p)===-1})?d3.keys(Pt):(a.forEach(function(p){for(var u in Pt)Pt[u].toLowerCase()===p&&c.push(u)}),c)}function Ma(n){let c=[];for(let a in n)c.push(n[a].toLowerCase());return c}function Ya(n){return n[0].toUpperCase()+n.substring(1)}function tt(n){let c=(~~Math.log10(n)+1)%3,a=c===1?2:c===2?1:0,s=d3.formatPrefix("."+a+"~",n)(n);if(parseInt(s)===1e3){let p=s[s.length-1],u={k:"M",M:"B"};return 1+(isNaN(p)?u[p]:"")}return s}function Dn(){ka.html(function(){return l.selectedYear.length===1?null:"*Selected years: "+l.selectedYear.sort(function(c,a){return c-a}).reduce(function(c,a,s){return c+(s>=l.selectedYear.length-2?s>l.selectedYear.length-2?a:a+" and ":a+", ")},"")})}function He(n,c,a,s){let p=c-n,u=p*s,h=d3.path();return h.moveTo(0,n),h.quadraticCurveTo(a/2,n,a/2,n+u),h.lineTo(a/2,n+p/2-u),h.quadraticCurveTo(a/2,n+p/2,a,n+p/2),h.quadraticCurveTo(a/2,n+p/2,a/2,n+p/2+u),h.lineTo(a/2,n+p-u),h.quadraticCurveTo(a/2,n+p,0,n+p),h.toString()}function rt(n,c){let a=!1;n.sort(function(s,p){return s.y0-p.y0}).style("display",null).each(function(s,p,u){d3.select(this).style("display",a?"none":null),ft.set(this,a),u[p+1]&&d3.select(u[p+1]).datum().y1-s.y0<c&&(a=!0)})}function Fn(n,c,a){n.forEach(function(h,i,T){if(i<T.length-1&&T[i+1].y0>h.y1+fe){let g=T[i+1].y0-h.y1;T[i+1].y0-=g-fe,T[i+1].y1-=g-fe}});let s=n.reduce(function(h,i){return h+=i.y1-i.y0+fe,h},0),u=(B.height-B.padding[2]-B.padding[0]-s)/(c?a.length+1:n.length+1);c?a.reverse().forEach(function(h,i){n.filter(function(g){return g.codeId===h}).forEach(function(g){g.y0+=u*(i+1),g.y1+=u*(i+1)})}):n.forEach(function(h,i){h.y0+=u*(i+1),h.y1+=u*(i+1)})}function On(){Mt.style("opacity",0).style("pointer-events","none");let n=M.append("div").attr("class","pbinadOverDivHelp"),c=Qe.node().getBoundingClientRect(),a=window.getComputedStyle(Qe.node()),s=Me.node().getBoundingClientRect(),p=be.node().getBoundingClientRect(),u=Mt.node().getBoundingClientRect(),h=p.height*(O/p.width),i=(c.height+s.height+parseInt(a["margin-top"])+parseInt(a["margin-bottom"]))*(O/p.width),T=n.append("svg").attr("viewBox","0 0 "+O+" "+(pe+h+i)),g=[{text:"CLOSE",width:90},{text:"GO TO HELP PORTAL",width:180}],S=T.selectAll(null).data(g).enter().append("g");S.append("rect").attr("rx",4).attr("ry",4).style("stroke","rgba(0, 0, 0, 0.3)").style("stroke-width","1px").style("fill",Xn).style("cursor","pointer").attr("y",6).attr("height",22).attr("width",function(U){return U.width}).attr("x",function(U,Y){return O-V[1]-U.width-(Y?g[0].width+8:0)}).on("click",function(U,Y){Mt.style("opacity",1).style("pointer-events","all"),n.remove(),Y&&window.open(oa,"help_portal")}),S.append("text").attr("class","pbinadAnnotationMainText").attr("text-anchor","middle").attr("x",function(U,Y){return O-V[1]-U.width/2-(Y?g[0].width+8:0)}).attr("y",22).text(function(U){return U.text}),[{x:4,y:h+(i-s.height)*(p.width/O),width:O-8,height:s.height*(O/p.width),xTooltip:300*(p.width/O),yTooltip:(h+i+8)*(p.width/O),text:"Use these checkboxes to select the CBPFs. A disabled checkbox means that the correspondent CBPF has no data for that year."},{x:4,y:68+h+i,width:416,height:30,xTooltip:78*(p.width/O),yTooltip:(h+i+104)*(p.width/O),text:"Use these buttons to select the year. Double click or press ALT when clicking to select multiple years"},{x:456,y:68+h+i,width:325,height:30,xTooltip:456*(p.width/O),yTooltip:(h+i+104)*(p.width/O),text:"Click here to select how the partners depicted in the right-hand side column are aggregated: by partner type or by level (direct or sub-implementing partners)."},{x:80,y:134+h+i,width:34,height:416,xTooltip:120*(p.width/O),yTooltip:(h+i+242)*(p.width/O),text:"This first column represents all the funds. You can hover over each rectangle for additional information."},{x:436,y:134+h+i,width:34,height:416,xTooltip:476*(p.width/O),yTooltip:(h+i+242)*(p.width/O),text:"This second column represents all the direct partners. You can hover over each rectangle for additional information."},{x:792,y:134+h+i,width:34,height:416,xTooltip:466*(p.width/O),yTooltip:(h+i+242)*(p.width/O),text:"This final column represents both the direct partners and the sub-implementing partners. Note: the direct partners represented here are the same of the second column, minus the amount transferred to any sub-implementing partner. You can hover over each rectangle for additional information."}].forEach(function(U){T.append("rect").attr("rx",4).attr("ry",4).attr("x",U.x).attr("y",U.y).attr("width",U.width).attr("height",U.height).style("stroke",ne).style("stroke-width","3px").style("fill","none").style("opacity",.5).attr("class","pbinadHelpRectangle").attr("pointer-events","all").on("mouseover",function(){let Y=this;k(U.xTooltip,U.yTooltip,U.text,Y)}).on("mouseout",K)});let R=T.append("rect").attr("x",O/2-180).attr("y",180+h+i).attr("width",360).attr("height",50).attr("pointer-events","none").style("fill","white").style("stroke","#888"),nt=T.append("text").attr("class","pbinadAnnotationExplanationText").attr("font-family","Roboto").attr("font-size","18px").style("fill","#222").attr("text-anchor","middle").attr("x",O/2).attr("y",200+h+i).attr("pointer-events","none").text("Hover over the elements surrounded by a blue rectangle to get additional information").call(Vn,350);function k(U,Y,Ct,y){nt.style("opacity",0),R.style("opacity",0),T.selectAll(".pbinadHelpRectangle").style("opacity",.1),d3.select(y).style("opacity",1);let q=M.node().getBoundingClientRect();F.style("top",Y+"px").style("left",U+"px").style("display","block").html(null).append("div").style("width","300px").html(Ct)}function K(){F.style("display","none"),nt.style("opacity",1),R.style("opacity",1),T.selectAll(".pbinadHelpRectangle").style("opacity",.5)}}function Ea(){let n="\xA9 OCHA CBPF Section "+Ft;ya&&(n+=" | For more information, please visit <a href='https://cbpf.data.unocha.org'>cbpf.data.unocha.org</a>"),Ca.append("div").attr("class","d3chartFooterText").html(n)}function za(n,c){n.each(function(){let a=d3.select(this),s=a.text().split(/\s+/).reverse(),p,u=[],h=1.1,i=a.attr("x"),T=0,g=a.text(null).append("tspan").attr("x",i).attr("dy",T+"em");for(;p=s.pop();)u.push(p),g.text(u.join(" ")),g.node().getComputedTextLength()>c&&(u.pop(),g.text(u.join(" ")),u=[p],g=a.append("tspan").attr("x",i).attr("dy",h+T+"em").text(p))})}function Vn(n,c){n.each(function(){let a=d3.select(this),s=a.text().split(/\s+/).reverse(),p,u=[],h=0,i=1.1,T=a.attr("y"),g=a.attr("x"),S=0,f=a.text(null).append("tspan").attr("x",g).attr("y",T).attr("dy",S+"em");for(;p=s.pop();)u.push(p),f.text(u.join(" ")),f.node().getComputedTextLength()>c&&(u.pop(),f.text(u.join(" ")),u=[p],f=a.append("tspan").attr("x",g).attr("y",T).attr("dy",++h*i+S+"em").text(p))})}function Rt(n){return d3.formatPrefix(".0",n)(n)}function je(n){if(+n==0)return 0;let c,a={Y:Math.pow(10,24),Z:Math.pow(10,21),E:Math.pow(10,18),P:Math.pow(10,15),T:Math.pow(10,12),G:Math.pow(10,9),B:Math.pow(10,9),M:Math.pow(10,6),k:Math.pow(10,3),h:Math.pow(10,2),da:Math.pow(10,1),d:Math.pow(10,-1),c:Math.pow(10,-2),m:Math.pow(10,-3),\u03BC:Math.pow(10,-6),n:Math.pow(10,-9),p:Math.pow(10,-12),f:Math.pow(10,-15),a:Math.pow(10,-18),z:Math.pow(10,-21),y:Math.pow(10,-24)};return Object.keys(a).some(function(s){if(n.indexOf(s)>0)return c=parseFloat(n.split(s)[0])*a[s],!0}),c}function Ue(n,c){if(sn){alert("This functionality is not supported by Internet Explorer");return}let s=d3.select("body").append("div").style("position","fixed").attr("id","pbinadDownloadingDiv").style("left",window.innerWidth/2-100+"px").style("top",window.innerHeight/2-100+"px").append("svg").attr("class","pbinadDownloadingDivSvg").attr("width",200).attr("height",100),p="Downloading "+n.toUpperCase();Rn(s,200,175,p);let u=ut.node().getBoundingClientRect();ut.attr("width",u.width).attr("height",u.height);let h=["font-size","font-family","font-weight","fill","stroke","stroke-dasharray","stroke-width","opacity","text-anchor","text-transform","shape-rendering","letter-spacing","white-space"],i=M.node();T(ut.node()),c&&Vt&&F.select("svg").size()&&T(F.select("svg").node()),M.selectAll(".pbinadtimelinesChartDiv svg").each(function(){T(this)}),n==="png"?Mt.style("opacity",0):be.style("opacity",0),de.style("display","none"),html2canvas(i).then(function(g){ut.attr("width",null).attr("height",null),n==="png"?Mt.style("opacity",1):be.style("opacity",1),n==="png"?Na(g):Ha(g),c&&Vt&&d3.select(Vt).dispatch("mouseout")});function T(g){if(!g.style)return;let S=getComputedStyle(g);for(let f=0;f<h.length;f++)g.style[h[f]]=S[h[f]];for(let f=0;f<g.childNodes.length;f++)T(g.childNodes[f])}}function Na(n){let a="AllocationFlow_"+Je(new Date)+".png";n.toBlob(function(s){let p=URL.createObjectURL(s),u=document.createElement("a");u.download!==void 0?(u.setAttribute("href",p),u.setAttribute("download",a),u.style="visibility:hidden",document.body.appendChild(u),u.click(),document.body.removeChild(u)):window.location.href=p}),nn(),d3.select("#pbinadDownloadingDiv").remove()}function Ha(n){let c={top:10,bottom:16,left:20,right:30};d3.image("https://raw.githubusercontent.com/CBPFGMS/cbpfgms.github.io/master/img/assets/bilogo.png").then(function(a){let s,u=M.node().getBoundingClientRect(),h=210-c.left*2,i=h*(u.height/u.width),T=180,g;i>T?(g=297+i-T,s=new jsPDF({format:[210*2.834646,g*2.834646],unit:"mm"})):(g=297,s=new jsPDF);let S;Y();let f=s.splitTextToSize("",210-c.left-c.right,{fontSize:12}),R=d3.timeFormat("%A, %d %B %Y")(new Date);s.setTextColor(60),s.setFont("helvetica"),s.setFontType("normal"),s.setFontSize(12),s.text(c.left,48,f),s.setTextColor(65,143,222),s.setFont("helvetica"),s.setFontType("bold"),s.setFontSize(16),s.text(Cn,c.left,65),s.setFontSize(12);let nt=l.selectedYear.sort(function(y,q){return y-q}).reduce(function(y,q,X){return y+(X>=l.selectedYear.length-2?X>l.selectedYear.length-2?q:q+" and ":q+", ")},""),k=l.selectedYear.length>1?"Selected years: ":"Selected year: ",K=Ct();s.fromHTML("<div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>Date: <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+R+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+k+"<span style='color: rgb(65, 143, 222); font-weight: 700;'>"+nt+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+K.split("-")[0]+": <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+K.split("-")[1]+"</span></div>",c.left,70,{width:210-c.left-c.right},function(y){S=y}),s.addImage(n,"PNG",c.left,S.y+2,h,i);let U=new Date;s.save("AllocationFlow_"+Je(U)+".pdf"),nn(),d3.select("#pbinadDownloadingDiv").remove();function Y(){let y="\xA9 OCHA CBPF Section "+Ft+" | For more information, please visit cbpf.data.unocha.org";s.setFillColor(65,143,222),s.rect(0,c.top,210,15,"F"),s.setFillColor(236,161,84),s.rect(0,c.top+15,210,2,"F"),s.setFillColor(255,255,255),s.rect(c.left,c.top-1,94,20,"F"),s.ellipse(c.left,c.top+9,5,9,"F"),s.ellipse(c.left+94,c.top+9,5,9,"F"),s.addImage(a,"PNG",c.left+2,c.top,90,18),s.setFillColor(236,161,84),s.rect(0,g-c.bottom,210,2,"F"),s.setTextColor(60),s.setFont("arial"),s.setFontType("normal"),s.setFontSize(10),s.text(y,c.left,g-c.bottom+10)}function Ct(){let y=l.selectedCbpfs.length===1?"":"s",q=l.selectedCbpfs.map(function(X){return Ot[X]}).sort(function(X,J){return X.localeCompare(J)}).reduce(function(X,J,gt){return X+(gt>=l.selectedCbpfs.length-2?gt>l.selectedCbpfs.length-2?J:J+" and ":J+", ")},"");return"Selected CBPF"+y+"-"+q}})}function Rn(n,c,a,s){let p=n.append("g").attr("class","pbinadd3chartwheelGroup").attr("transform","translate("+c/2+","+a/4+")"),u=p.append("text").attr("text-anchor","middle").style("font-family","Roboto").style("font-weight","bold").style("font-size","11px").attr("y",50).attr("class","contributionColorFill").text(s),h=d3.arc().outerRadius(25).innerRadius(20),i=p.append("path").datum({startAngle:0,endAngle:0}).classed("contributionColorFill",!0).attr("d",h);T();function T(){i.transition().duration(1e3).attrTween("d",function(S){let f=d3.interpolate(0,Math.PI*2);return function(R){return S.endAngle=f(R),h(S)}}).on("end",g)}function g(){i.transition().duration(1e3).attrTween("d",function(S){let f=d3.interpolate(0,Math.PI*2);return function(R){return S.startAngle=f(R),h(S)}}).on("end",function(S){S.startAngle=0,T()})}}function nn(){let n=d3.select(".pbinadd3chartwheelGroup");n.select("path").interrupt(),n.remove()}}})();})();
