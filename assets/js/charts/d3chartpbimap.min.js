(()=>{(function(){let Lt=window.navigator.userAgent.indexOf("MSIE")>-1||window.navigator.userAgent.indexOf("Trident")>-1,Ot=window.fetch,Mt=window.URLSearchParams,Ct=window.matchMedia("(pointer: coarse)").matches&&!window.matchMedia("(any-pointer: fine)").matches,ce=window.location.hostname==="cbpf.data.unocha.org",_e=window.location.hostname+window.location.pathname==="cbpf.data.unocha.org/bookmark.html",pe="https://use.fontawesome.com/releases/v5.6.3/css/all.css",We="https://cbpfgms.github.io/libraries/leaflet.css",$e=["https://cbpfgms.github.io/css/d3chartstyles.css","https://cbpfgms.github.io/css/d3chartstylespbimap.css",pe,We],Ft="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js",gt="https://cbpfgms.github.io/libraries/leaflet.js",de="https://cbpfgms.github.io/libraries/html2canvasrc3.min.js",ue="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js",jt="https://cdn.jsdelivr.net/npm/@ungap/url-search-params@0.1.2/min.min.js",fe="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js",me="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.4/fetch.min.js";$e.forEach(function(T){if(!Je(T)){let j=document.createElement("link");j.setAttribute("rel","stylesheet"),j.setAttribute("type","text/css"),j.setAttribute("href",T),T===pe&&(j.setAttribute("integrity","sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"),j.setAttribute("crossorigin","anonymous")),document.getElementsByTagName("head")[0].appendChild(j)}}),Xt(Ft)?Ot&&Mt?E(gt,ht):Ot&&!Mt?E(jt,function(){E(gt,ht)}):E(fe,function(){E(me,function(){E(jt,function(){E(gt,ht)})})}):Ot&&Mt?E(gt,function(){E(Ft,ht)}):Ot&&!Mt?E(jt,function(){E(gt,function(){E(Ft,ht)})}):E(fe,function(){E(me,function(){E(jt,function(){E(gt,function(){E(Ft,ht)})})})});function E(T,j){let O=document.getElementsByTagName("head")[0],lt=document.createElement("script");lt.type="text/javascript",lt.src=T,lt.onreadystatechange=j,lt.onload=j,O.appendChild(lt)}function Je(T){let j=document.getElementsByTagName("link");for(let O=j.length;O--;)if(j[O].href==T)return!0;return!1}function Xt(T){let j=document.getElementsByTagName("script");for(let O=j.length;O--;)if(j[O].src==T)return!0;return!1}function ht(){Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(t){if(this==null)throw new TypeError('"this" is null or not defined');var e=Object(this),r=e.length>>>0;if(typeof t!="function")throw new TypeError("predicate must be a function");for(var f=arguments[1],u=0;u<r;){var a=e[u];if(t.call(f,a,u,e))return a;u++}},configurable:!0,writable:!0}),typeof Object.assign!="function"&&Object.defineProperty(Object,"assign",{value:function(e,r){"use strict";if(e==null)throw new TypeError("Cannot convert undefined or null to object");for(var f=Object(e),u=1;u<arguments.length;u++){var a=arguments[u];if(a!=null)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(f[c]=a[c])}return f},writable:!0,configurable:!0}),Math.log10=Math.log10||function(t){return Math.log(t)*Math.LOG10E},HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,r){var f=this.toDataURL(e,r).split(",")[1];setTimeout(function(){for(var u=atob(f),a=u.length,c=new Uint8Array(a),i=0;i<a;i++)c[i]=u.charCodeAt(i);t(new Blob([c],{type:e||"image/png"}))})}});let T=1110,j=420,O=60,lt=[0,10,0,10],$=[.18,.38,.58,.76],at=12,yt=2,Ze=110,ge=134,S=[4,4,4,12],Qe=58,Xe=j-ge,he=12,Et=42,Ke=20,_=1e3,tn=250,Kt=2,en=j+O,Tt=300,nn=window.innerHeight,ye=.3,Pt=new Date().getFullYear(),Nt=d3.utcFormat("_%Y%m%d_%H%M%S_UTC"),It=6,N=["Men","Women","Boys","Girls"],ve=["CBPF","Partner","Cluster"],be="&$format=csv",Ae="AllocationYear=",on=2015,Z=d3.range(on,Pt+1,1).map(function(t){return t.toString()}),ln="Allocations Overview",an="allocations-overview",sn="https://cbpf.data.unocha.org/bookmark.html?",rn="https://gms.unocha.org/content/allocations-overview",St=d3.format(",.0f"),cn=.25,pn=.5,xe=12,dn=20,un=10,fn=1.75,mn=.5,wt=20,zt="#E56A54",Rt="#418FDE",gn="#CD3A1F",hn="#1F69B3",yn="#1F69B3",vn="#F79A3B",bn="#555",An="#555",xn="M0,0l-8.8-17.7C-12.1-24.3-7.4-32,0-32h0c7.4,0,12.1,7.7,8.8,14.3L0,0z",Bo=j/2,Le="#eee",Ln=d3.interpolateRgb(Le,gn),Cn=d3.interpolateRgb(Le,hn),te=270,Gt=80,q=[6,36,14,45],Ce=2,Te=3,Tn=d3.format("~s"),Yt=.4,Pe=.5,Pn="https://github.com/CBPFGMS/cbpfgms.github.io/raw/master/img/assets/partnerslogo.png",Sn="https://github.com/CBPFGMS/cbpfgms.github.io/raw/master/img/assets/projectslogo.png",wn="https://github.com/CBPFGMS/cbpfgms.github.io/raw/master/img/assets/pbimaptooltip.png",Bn="https://raw.githubusercontent.com/CBPFGMS/cbpfgms.github.io/master/img/assets/pbimaptooltip.png",Dn="https://raw.githubusercontent.com/CBPFGMS/cbpfgms.github.io/master/img/assets/partnerslogo.png",kn="https://raw.githubusercontent.com/CBPFGMS/cbpfgms.github.io/master/img/assets/projectslogo.png",it=50,Se=["https://cbpfapi.unocha.org/vo2/odata/ProjectSummaryV2?","https://cbpfapi.unocha.org/vo2/odata/ProjectSummaryAggV2?"],On="https://cbpfapi.unocha.org/vo2/odata/MstPooledFund?$format=csv",Mn="https://cbpfapi.unocha.org/vo2/odata/MstClusters?$format=csv",Fn="https://cbpfapi.unocha.org/vo2/odata/MstOrgType?$format=csv",jn="https://cbpfapi.unocha.org/vo2/odata/MstAllocationSource?$format=csv",En="https://cbpfapi.unocha.org/vo2/odata/AllocationTypes?PoolfundCodeAbbrv=&$format=csv",dt=[],we=["Year","CBPF","Partner Type","Cluster","Allocation Type","Location Level"],Be=["#E8F5D6","#F1E9DA","#E4D8F3","#E6E6E6","#F8D8D3","#D4E5F7"],ee=["Project Code","Project Title","Partner","Allocation Type","Targeted People","Allocations"],Nn=["18%","32%","20%","12%","9%","9%"],In=["18%","32.5%","20%","12.5%","8.5%","8.5%"],n={selectedYear:[],selectedPartner:[],selectedCBPF:[],selectedModality:["all"],selectedCluster:[],selectedAdminLevel:null,displayMode:"size"},vt=[],Y={},De={},ut={},J={},ke={},ne=[],Ht={},Oe=[],oe={},le=[],ft={},Ut=[],Me,ae,Vt,Do,bt=!1,qt;Z.forEach(function(t){Ht[t]=[]});let B=new URLSearchParams(location.search);B.has("viz")||B.append("viz",an);let P=d3.select("#d3chartcontainerpbimap"),zn=P.node().getAttribute("data-responsive")==="true",Rn=P.node().getAttribute("data-lazyload")==="true",Gn=P.node().getAttribute("data-title")||ln,Yn=P.node().getAttribute("data-showhelp")==="true",Hn=P.node().getAttribute("data-showlink")==="true",_t=+P.node().getAttribute("data-minpercentage")||0,Un=B.has("year")?B.get("year"):P.node().getAttribute("data-year");n.selectedYear.push(vo(Un));let Fe=B.has("modality")?B.get("modality"):null;Fe&&(n.selectedModality=Fe.split("|")),zn==="false"&&P.style("width",T+"px");let Bt=P.append("div").attr("class","pbimapTopDiv"),je=Bt.append("div").attr("class","pbimapTitleDiv"),Q=Bt.append("div").attr("class","pbimapIconsDiv d3chartIconsDiv"),I=P.append("svg").attr("viewBox","0 0 "+T+" "+O);Lt&&I.attr("height",O);let mt=P.append("div").attr("class","pbimapFiltersDiv"),Ee=P.append("div").attr("id","pbimapContainerDiv").style("height",j+"px"),ie=P.append("div").style("min-height","30px").attr("class","pbimapBreadcrumbDivContainer"),Vn=ie.append("div").style("pointer-events","none").style("position","absolute").attr("class","pbimapBreadcrumbDiv"),qn=ie.append("div").style("position","absolute").style("display","flex").style("width","99%").style("min-height","30px").style("align-items","center").style("justify-content","flex-end").attr("class","pbimapshowAllDiv"),_n=ce?null:P.append("div").attr("class","pbimapFooterDiv"),H=P.append("div").attr("class","pbimapListContainerDiv"),{rectProgress:Wn,progressText:ko,bytesText:$n}=Po(T,en),G=L.map("pbimapContainerDiv",{zoomSnap:cn,zoomDelta:pn});G.setView([dn,un],fn),L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{attribution:'&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',subdomains:"abcd",maxZoom:xe}).addTo(G);let At=P.append("div").attr("id","pbimapSnapshotTooltip").attr("class","pbimapSnapshotContent").style("display","none").on("mouseleave",function(){bt=!1,At.style("display","none"),z.style("display","none")});At.append("p").attr("id","pbimapSnapshotTooltipPdfText").html("Download PDF").on("click",function(){bt=!1,Qt("pdf",!0)}),At.append("p").attr("id","pbimapSnapshotTooltipPngText").html("Download Image (PNG)").on("click",function(){bt=!1,Qt("png",!0)});let Ne=!Ct&&(window.safari||window.navigator.userAgent.indexOf("Edge")>-1);Ne&&At.append("p").attr("id","pbimapTooltipBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default");let z=P.append("div").attr("id","pbimaptooltipdiv").style("display","none");P.on("contextmenu",function(){d3.event.preventDefault();let t=d3.mouse(this);bt=!0,At.style("display","block").style("top",t[1]-4+"px").style("left",t[0]-4+"px")}),L.svg().addTo(G);let U=d3.select(".leaflet-overlay-pane g").attr("class","pbimapD3MapSvg"),V=Ee.append("div").attr("class","pbimapLegendDiv").style("top",Xe+"px").append("svg").attr("class","pbimapLegendSvg").attr("width",Ze).attr("height",ge),Wt=d3.scaleOrdinal().domain(we).range(Be),Jn=d3.scaleOrdinal().domain(ve).range([Y,J,ut]),M=d3.scaleSqrt().range([mn,wt]),Zn=d3.range(10).map(function(t){return Ln(t/9)}),Qn=d3.range(10).map(function(t){return Cn(t/9)}),xt=d3.scaleQuantile(),Dt=d3.scalePoint().range([q[0],Gt-q[2]]).domain(N).padding(.5),kt=d3.scaleLinear().range([q[3],te-q[1]]),Xn=d3.axisLeft(Dt).tickSize(0).tickPadding(5),Kn=d3.axisBottom(kt).tickSizeOuter(0).tickSizeInner(-(Gt-q[0]-q[2])).ticks(2).tickPadding(4).tickFormat(function(t){return"$"+Tn(t).replace("G","B")}),to=d3.scaleOrdinal().domain(ee).range(["PrjCode","PrjTitle","OrgNm","AllNm","AdmLocBenClustAgg","AdmLocClustBdg"]);Lt||se(Bn,"tooltipThumbnail"),Lt||se(Dn,"partnersLogo"),Lt||se(kn,"projectsLogo"),Se.forEach(function(t){dt.push(t+Ae+n.selectedYear[0]+be)}),dt.push(On),dt.push(Mn),dt.push(Fn),dt.push(jn),dt.push(En),Xt(de)||E(de,null),Xt(ue)||E(ue,null);function eo(t,e){return new Promise((r,f)=>{let u=new XMLHttpRequest;u.open("GET",t,!0),u.responseType="arraybuffer",u.onprogress=a=>{e(a.loaded,!1)},u.onload=function(){if(this.status>=200&&this.status<300){let c=new TextDecoder("utf-8").decode(this.response);try{let i=d3.csvParse(c);e(0,!0),r(i)}catch(i){f(new Error("CSV Parsing Error: "+i.message))}}else f(new Error(u.statusText))},u.onerror=()=>{e(0),f(new Error("Network Error"))},u.send()})}function no(t,e){let r=t.length,f=0,u=0,a=t.map(c=>eo(c,(i,o)=>{o&&(f+=1),u+=i,e(f,r,u)}));return Promise.all(a)}async function oo(){try{let t=await no(dt,(e,r,f)=>{Wn.transition().duration(500).attr("width",Tt*(e/r)),$n.text(`${(~~(f/1e3)).toLocaleString()} kB loaded`)});lo(t)}catch(t){console.error("Error loading data:",t)}}oo();function Ie(t,e,r){return r===0?{underApprovalPercent:0,underPlusApprovedPercent:0}:{underApprovalPercent:t/r*100,underPlusApprovedPercent:(t+e)/r*100}}function lo(t){re();let e={};t[6].forEach(function(c){e[c.AllocationYear]={underApproval:(e[c.AllocationYear]?e[c.AllocationYear].underApproval:0)+ +c.TotalUnderApprovalBudget,approved:(e[c.AllocationYear]?e[c.AllocationYear].approved:0)+ +c.TotalApprovedBudget,launched:(e[c.AllocationYear]?e[c.AllocationYear].launched:0)+ +c.TotalUSDPlanned},le.push(c)});for(let c in e){let{underApprovalPercent:i,underPlusApprovedPercent:o}=Ie(e[c].underApproval,e[c].approved,e[c].launched);ft[c]=i>_t||o<_t}po(t[2]),uo(t[2]),fo(t[3]),mo(t[4]),go(t[5]),ho(t[2]),He(t[0],t[1]),vt.push.apply(vt,n.selectedYear),yo(),Rn?(d3.select(window).on("scroll.pbimap",r),r()):ze();function r(){let c=P.node().getBoundingClientRect();c.bottom<0||c.top-nn>0||(d3.select(window).on("scroll.pbimap",null),ze())}let f=Z.filter(function(c){return n.selectedYear.indexOf(+c)===-1}).sort(function(c,i){return+i-+c});function u(c){let i=Se.map(function(o){return d3.csv(o+Ae+c+be)});return Promise.all(i).then(function(o){!o[0].length||!o[1].length?(Z.splice(Z.indexOf(c.toString()),1),so()):(He(o[0],o[1]),vt.push(+c),Re())})}async function a(c){for(let i of c)await u(i)}a(f)}function ze(){let t=tt();ao(),io(t),Re(),ce||co(),st(t.topSvgObject),X(t.map),K(t.map),rt(),ct(t.map),G.on("zoom",Ge),Yn&&Ue()}function ao(){let t=je.append("p").attr("class","pbimapTitle contributionColorHTMLcolor").html(Gn);Vt=je.append("p").attr("class","pbimaplaunchedValue");let e=Q.append("button").attr("id","pbimapHelpButton");e.html("HELP  ").append("span").attr("class","fas fa-info");let r=Q.append("button").attr("id","pbimapDownloadButton");r.html(".CSV  ").append("span").attr("class","fas fa-download");let f=Q.append("div").attr("class","pbimapSnapshotDiv");f.append("button").attr("id","pbimapSnapshotButton").html("IMAGE ").append("span").attr("class","fas fa-camera");let a=f.append("div").attr("class","pbimapSnapshotContent"),c=a.append("p").attr("id","pbimapSnapshotPdfText").html("Download PDF").on("click",function(){Qt("pdf",!1)}),i=a.append("p").attr("id","pbimapSnapshotPngText").html("Download Image (PNG)").on("click",function(){Qt("png",!1)});if(!_e){let o=Q.append("button").attr("id","pbimapShareButton");o.html("SHARE  ").append("span").attr("class","fas fa-share");let p=P.append("div").attr("class","d3chartShareDiv").style("display","none");o.on("mouseover",function(){p.html("Click to copy").style("display","block");let s=this.getBoundingClientRect(),m=P.node().getBoundingClientRect(),x=p.node().getBoundingClientRect(),l=s.top-m.top-(x.height-s.height)/2,h=s.left-m.left-x.width-12;p.style("top",l+"px").style("left",h+"20px")}).on("mouseout",function(){p.style("display","none")}).on("click",function(){let s=sn+B.toString();p.append("input").attr("type","text").attr("readonly",!0).attr("spellcheck","false").property("value",s).node().select(),document.execCommand("copy"),p.html("Copied!");let x=this.getBoundingClientRect(),l=P.node().getBoundingClientRect(),h=p.node().getBoundingClientRect(),g=x.left-l.left-h.width-12;p.style("left",g+"20px")})}if(Ne){let o=a.append("p").attr("id","pbimapBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default")}f.on("mouseover",function(){a.style("display","block")}).on("mouseout",function(){a.style("display","none")}),e.on("click",Ue),r.on("click",function(){let o=tt(),p=bo(o.map),m="AllocationsOverview_"+Nt(new Date)+".csv",x=new Blob([p],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(x,filename);else{let l=document.createElement("a");if(l.download!==void 0){let h=URL.createObjectURL(x);l.setAttribute("href",h),l.setAttribute("download",m),l.style="visibility:hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l)}}})}function st(t){let e=n.selectedYear.sort(function(v,d){return v-d}).filter(function(v){return ft[v]}),r=e.reduce(function(v,d,y){return v+(y>=e.length-2?y>e.length-2?d:d+" and ":d+", ")},"");Vt.style("opacity",n.selectedYear.some(v=>ft[v])?1:0).html("Launched Allocations in "+r+": "),Vt.append("span").classed("contributionColorHTMLcolor",!0).html("$"+pt(t.launchedAllocations).replace("k"," Thousand").replace("M"," Million").replace("G"," Billion"));let f=d3.select(".pbimapTopSvgAllocations").size()?d3.select(".pbimapTopSvgAllocations").datum():0,u=d3.select(".pbimapTopSvgBeneficiaries").size()?d3.select(".pbimapTopSvgBeneficiaries").datum():0,a=d3.select(".pbimapTopSvgProjects").size()?d3.select(".pbimapTopSvgProjects").datum():0,c=d3.select(".pbimapTopSvgPartners").size()?d3.select(".pbimapTopSvgPartners").datum():0,i=I.selectAll(".pbimapTopSvgAllocations").data([t.totalAllocations]);i=i.enter().append("text").attr("class","pbimapTopSvgAllocations contributionColorFill").attr("text-anchor","end").attr("y",O-at).attr("x",T*$[0]-yt).merge(i),i.transition().duration(_).tween("text",function(v){let d=this,y=d3.interpolate(f,v),b=pt(v),C=b[b.length-1];return function(D){let R=pt(y(D));d.textContent="$"+(+C!=+C?R.substring(0,R.length-1):R)}}).on("end",function(){let v=this.getBoundingClientRect(),d=P.node().getBoundingClientRect(),y=v.left-d.left;Vt.style("padding-left",y+"px","important")});let o=I.selectAll(".pbimapTopSvgAllocationsText").data([t.totalAllocations]);o=o.enter().append("text").attr("class","pbimapTopSvgAllocationsText").attr("text-anchor","start").attr("y",O-at*2.7).attr("x",T*$[0]+yt).merge(o),o.text(function(v){let d=pt(v),y=d[d.length-1];return y==="k"?"Thousand":y==="M"?"Million":y==="G"?"Billion":""});let p=I.selectAll(".pbimapTopSvgAllocationsSubtitle").data([!0]).enter().append("text").attr("class","pbimapTopSvgAllocationsSubtitle").attr("y",O-at*1.1).attr("x",T*$[0]+yt).text("Allocated"),s=I.selectAll(".pbimapTopSvgBeneficiaries").data([t.totalBeneficiaries]);s=s.enter().append("text").attr("class","pbimapTopSvgBeneficiaries contributionColorFill").attr("text-anchor","end").attr("y",O-at).attr("x",T*$[1]-yt).merge(s),s.transition().duration(_).tween("text",function(v){let d=this,y=d3.interpolate(u,v),b=pt(v),C=b[b.length-1];return function(D){let R=pt(y(D));d3.select(d).text(+C!=+C?R.substring(0,R.length-1):R)}});let m=I.selectAll(".pbimapTopSvgBeneficiariesText").data([t.totalBeneficiaries]);m=m.enter().append("text").attr("class","pbimapTopSvgBeneficiariesText").attr("text-anchor","start").attr("y",O-at*2.7).attr("x",T*$[1]+yt).merge(m),m.text(function(v){let d=pt(v),y=d[d.length-1];return y==="k"?"Thousand":y==="M"?"Million":y==="G"?"Billion":""});let x=I.selectAll(".pbimapTopSvgBeneficiariesSubtitle").data([!0]).enter().append("text").attr("class","pbimapTopSvgBeneficiariesSubtitle").attr("y",O-at*1.1).attr("x",T*$[1]+yt).text("Targeted People"),l=I.selectAll(".pbimapTopSvgPartnersLogo").data([!0]).enter().append("image").attr("class","pbimapTopSvgPartnersLogo").attr("width",it+"px").attr("height",it+"px").attr("y",(O-it)/2).attr("x",T*$[2]).attr("xlink:href",localStorage.getItem("storedImagepartnersLogo")?localStorage.getItem("storedImagepartnersLogo"):Pn),h=I.selectAll(".pbimapTopSvgPartners").data([t.totalPartners]);h=h.enter().append("text").attr("class","pbimapTopSvgPartners contributionColorFill").attr("y",O-at*1.6).attr("x",T*$[2]+it).merge(h),h.transition().duration(_).tween("text",function(v){let d=this,y=d3.interpolate(c,v);return function(b){let C=y(b);d3.select(d).text(~~C).append("tspan").attr("dy","-0.2em").attr("class","pbimapTopSvgPartnersText").text(" Partners")}});let g=I.selectAll(".pbimapTopSvgProjectsLogo").data([!0]).enter().append("image").attr("class","pbimapTopSvgProjectsLogo").attr("width",it+"px").attr("height",it+"px").attr("y",(O-it)/2).attr("x",T*$[3]).attr("xlink:href",localStorage.getItem("storedImageprojectsLogo")?localStorage.getItem("storedImageprojectsLogo"):Sn),A=I.selectAll(".pbimapTopSvgProjects").data([t.totalProjects]);A=A.enter().append("text").attr("class","pbimapTopSvgProjects contributionColorFill").attr("y",O-at*1.6).attr("x",T*$[3]+it).merge(A),A.transition().duration(_).tween("text",function(v){let d=this,y=d3.interpolate(a,v);return function(b){let C=y(b);d3.select(d).text(~~C).append("tspan").attr("dy","-0.2em").attr("class","pbimapTopSvgProjectsText").text(" Projects")}})}function io(t){let e=d3.max(t.map,function(d){return d.maxLevel}),r=mt.selectAll(null).data(we).enter().append("div").attr("class","pbimapFilterContainerDiv").style("background-color",function(d){return Wt(d)}).style("opacity",0),f=r.append("div").attr("class","pbimapFilterContainerDivTitles").html(function(d){return d==="Cluster"?"Sector":d});Ct?(r.on("touchstart",function(){d3.event.stopPropagation(),z.style("display","none"),n.displayMode==="color"?U.selectAll(".pbimapColorMarkers").style("opacity",1):U.selectAll(".pbimapSizeMarkers").style("opacity",1),r.select(".pbimapDropdownContainer").style("display","none"),d3.select(this).select(".pbimapDropdownContainer").style("display","block")}),d3.select(window).on("touchstart.pbimapFilterContainers",function(){r.select(".pbimapDropdownContainer").style("display","none")})):r.on("mouseover",function(){d3.select(this).select(".pbimapDropdownContainer").style("display","block")}).on("mouseout",function(){d3.select(this).select(".pbimapDropdownContainer").style("display","none")});let u=r.append("div").attr("class","pbimapDropdownPaddingDiv"),a=r.append("div").attr("class","pbimapDropdownContainer").style("background-color",function(d){return d3.color(Wt(d)).brighter(ye)}).append("ul").attr("class","pbimapDropdownUl"),c=a.filter(function(d){return d==="Year"});c.call(w,Z,n.selectedYear);let i=a.filter(function(d){return d==="CBPF"});i.call(w,["All"].concat(d3.values(Y).sort(function(d,y){return d.toLowerCase().localeCompare(y.toLowerCase())})),n.selectedCBPF),A();let o=a.filter(function(d){return d==="Partner Type"});o.call(w,["All"].concat(d3.values(J).sort()),n.selectedPartner);let p=a.filter(function(d){return d==="Cluster"});p.call(w,["All"].concat(d3.values(ut).sort()),n.selectedCluster);let s=a.filter(function(d){return d==="Allocation Type"});s.call(w,["All"].concat(ne.sort()),n.selectedModality);let m=a.filter(function(d){return d==="Location Level"});m.call(w,d3.range(0,e+1,1),n.selectedAdminLevel),r.transition().duration(_/10).delay(function(d,y){return y*(_/10)}).style("opacity",1),c.selectAll("li").on("click",function(d){if(n.selectedYear.indexOf(+d)===-1)n.selectedYear.push(+d);else{if(n.selectedYear.length===1)return;let C=n.selectedYear.indexOf(+d);n.selectedYear.splice(C,1)}et("year",n.selectedYear.length===1?n.selectedYear[0]:Pt),c.call(w,Z.map(function(C){return+C}),n.selectedYear);let y=tt();s.call(w,["All"].concat(y.allocationsTypeList.sort()),n.selectedModality),s.selectAll("li").on("click",function(C){g(C)});let b=d3.max(y.map,function(C){return C.maxLevel})||0;n.selectedAdminLevel=Math.min(b,n.selectedAdminLevel),st(y.topSvgObject),X(y.map),K(y.map),rt(),ct(y.map),m.call(w,d3.range(0,b+1,1),n.selectedAdminLevel),m.selectAll("li").on("click",function(C){n.selectedAdminLevel=C,n.selectedAdminLevel?et("adminlevel",C):B.delete("adminlevel"),m.call(w,d3.range(0,b+1,1),n.selectedAdminLevel);let D=tt();st(D.topSvgObject),X(D.map),K(D.map),rt(),ct(D.map)}),A(),o.call(v,y,"partnersTypeList"),p.call(v,y,"clustersList")}),i.selectAll("li").on("click",function(d){n.selectedCBPF.indexOf(d.toLowerCase())>-1&&n.selectedCBPF.length===1||(n.selectedModality=["all"],x(d,n.selectedCBPF),n.selectedCBPF[0]==="all"?B.delete("fund"):et("fund",n.selectedCBPF.join("|")),i.call(w,["All"].concat(d3.values(Y).sort()),n.selectedCBPF),A())}),o.selectAll("li").on("click",function(d){n.selectedPartner.indexOf(d.toLowerCase())>-1&&n.selectedPartner.length===1||(x(d,n.selectedPartner),n.selectedPartner[0]==="all"?B.delete("partner"):et("partner",n.selectedPartner.join("|")),o.call(w,["All"].concat(d3.values(J).sort()),n.selectedPartner))}),p.selectAll("li").on("click",function(d){n.selectedCluster.indexOf(d.toLowerCase())>-1&&n.selectedCluster.length===1||(x(d,n.selectedCluster),n.selectedCluster[0]==="all"?B.delete("cluster"):et("cluster",n.selectedCluster.join("|")),p.call(w,["All"].concat(d3.values(ut).sort()),n.selectedCluster))}),s.selectAll("li").on("click",function(d){g(d)}),m.selectAll("li").on("click",function(d){n.selectedAdminLevel=d,n.selectedAdminLevel?et("adminlevel",d):B.delete("adminlevel"),m.call(w,d3.range(0,e+1,1),n.selectedAdminLevel);let y=tt();st(y.topSvgObject),X(y.map),K(y.map),rt(),ct(y.map),o.call(v,y,"partnersTypeList"),p.call(v,y,"clustersList")}),o.call(v,t,"partnersTypeList"),p.call(v,t,"clustersList");function x(d,y){if(d==="All")y.length=0,y.push("all");else if(y.length===1&&y[0]==="all"&&(y.length=0),y.indexOf(d.toLowerCase())===-1)y.push(d.toLowerCase());else{let D=y.indexOf(d.toLowerCase());y.splice(D,1)}let b=tt();s.call(w,["All"].concat(b.allocationsTypeList.sort()),n.selectedModality),s.selectAll("li").on("click",function(D){g(D)}),st(b.topSvgObject),X(b.map),K(b.map);let C=d3.max(b.map,function(D){return D.maxLevel})||0;n.selectedAdminLevel=Math.min(C,n.selectedAdminLevel),rt(),ct(b.map),m.call(w,d3.range(0,C+1,1),n.selectedAdminLevel),m.selectAll("li").on("click",function(D){n.selectedAdminLevel=D,n.selectedAdminLevel?et("adminlevel",D):B.delete("adminlevel"),m.call(w,d3.range(0,C+1,1),n.selectedAdminLevel);let R=tt();st(R.topSvgObject),X(R.map),K(R.map),rt(),ct(R.map)}),o.call(v,b,"partnersTypeList"),p.call(v,b,"clustersList")}let h=mt.append("div").attr("class","pbimapResetDiv").append("button").html("Reset").on("click",function(){for(var d in n)n[d]=JSON.parse(JSON.stringify(Me[d]));c.call(w,Z,n.selectedYear),i.call(w,["All"].concat(d3.values(Y).sort(function(b,C){return b.toLowerCase().localeCompare(C.toLowerCase())})),n.selectedCBPF),A(),o.call(w,["All"].concat(d3.values(J).sort()),n.selectedPartner),p.call(w,["All"].concat(d3.values(ut).sort()),n.selectedCluster),m.call(w,d3.range(0,e+1,1),n.selectedAdminLevel),s.selectAll("li").on("click",function(b){g(b)}),m.selectAll("li").on("click",function(b){n.selectedAdminLevel=b,n.selectedAdminLevel?et("adminlevel",b):B.delete("adminlevel"),m.call(w,d3.range(0,e+1,1),n.selectedAdminLevel);let C=tt();st(C.topSvgObject),X(C.map),K(C.map),rt(),ct(C.map)});let y=tt();s.call(w,["All"].concat(y.allocationsTypeList.sort()),n.selectedModality),st(y.topSvgObject),X(y.map),K(y.map),rt(),ct(y.map),H.html(""),o.call(v,y,"partnersTypeList"),p.call(v,y,"clustersList")});function g(d){n.selectedModality.indexOf(d.toLowerCase())>-1&&n.selectedModality.length===1||(x(d,n.selectedModality),n.selectedModality[0]==="all"?B.delete("modality"):et("modality",n.selectedModality.join("|")))}function A(){let d=[];n.selectedYear.forEach(function(b){d.push.apply(d,Ht[b+""])});let y=d.filter(function(b,C,D){return D.indexOf(b)===C});i.selectAll("li").filter(function(b){return b!=="All"}).each(function(b){d3.select(this).style("display",function(){return y.indexOf(b)===-1?"none":null})})}function v(d,y,b){d.selectAll("li").filter(function(C){return C!=="All"}).each(function(C){d3.select(this).style("opacity",y[b].indexOf(C)===-1?Pe:1).style("pointer-events",y[b].indexOf(C)===-1?"none":"all")})}}function so(){mt.selectAll(".pbimapDropdownUl").filter(function(t){return t==="Year"}).selectAll("li").filter(function(t){return Z.indexOf(t)===-1}).remove()}function Re(){mt.selectAll(".pbimapDropdownUl").filter(function(e){return e==="Year"}).selectAll("li").each(function(e){d3.select(this).style("opacity",vt.indexOf(+e)>-1?1:Pe).style("pointer-events",vt.indexOf(+e)>-1?"all":"none"),d3.select(this).select("span:nth-child(2)").html(vt.indexOf(+e)>-1?e:e+" (loading)")})}function X(t,e){if(t.length===0){let p=G.getCenter();U.select(".pbimapColorMapGroup").remove(),U.select(".pbimapSizeMapGroup").remove();let s=U.append("text").attr("class","pbimapNoDataTextBack").attr("y",G.latLngToLayerPoint(p).y).attr("x",G.latLngToLayerPoint(p).x).attr("text-anchor","middle").text("No data for the current selection"),m=U.append("text").attr("class","pbimapNoDataText").attr("y",G.latLngToLayerPoint(p).y).attr("x",G.latLngToLayerPoint(p).x).attr("text-anchor","middle").text("No data for the current selection");return}else{let p=U.selectAll(".pbimapNoDataText, .pbimapNoDataTextBack");p&&p.remove()}t=t.sort(function(p,s){return s.totalAllocation-p.totalAllocation});let r=d3.max(t,function(p){return p.totalAllocation});M.domain([0,r]);let f=t.map(function(p){return p.totalAllocation}).sort(function(p,s){return p-s});xt.domain(f).range(n.selectedAdminLevel?Zn:Qn);let u=n.selectedAdminLevel===0&&t.length===1?[Zt[c(t[0].locationName)].sw.lat,Zt[c(t[0].locationName)].ne.lat]:d3.extent(t,function(p){return+p.latitude}),a=n.selectedAdminLevel===0&&t.length===1?[Zt[c(t[0].locationName)].sw.lng,Zt[c(t[0].locationName)].ne.lng]:d3.extent(t,function(p){return+p.longitude});function c(p){return p.split("(")[0].trim()}n.displayMode==="size"?i():o(),e===void 0&&ro(u,a),Ge();function i(){U.select(".pbimapColorMapGroup").remove();let p=U.selectAll(".pbimapSizeMapGroup").data([!0]);p=p.enter().append("g").attr("class","pbimapSizeMapGroup").merge(p);let s=p.selectAll(".pbimapSizeMarkers").data(t,function(l){return l.key}),m=s.exit().remove();s=s.enter().append("circle").attr("class","pbimapSizeMarkers").style("stroke",bn).merge(s),s.attr("r",function(l){return M(l.totalAllocation)}).style("fill",n.selectedAdminLevel?zt:Rt),Ct?(s.on("touchstart",function(l){d3.event.stopPropagation(),mt.selectAll(".pbimapDropdownContainer").style("display","none");let h=this;s.style("opacity",Yt),d3.select(this).style("opacity",1),$t(l,h)}),n.displayMode==="size"&&d3.select(window).on("touchstart.pbimapSizeMarkers",function(){s.style("opacity",1),Jt()})):s.on("mouseover",function(l){qt=this;let h=this;s.style("opacity",Yt),d3.select(this).style("opacity",1),$t(l,h)}).on("mouseout",function(){bt||(currentHoveredRect=null,s.style("opacity",1),Jt())})}function o(){U.select(".pbimapSizeMapGroup").remove();let p=U.selectAll(".pbimapColorMapGroup").data([!0]);p=p.enter().append("g").attr("class","pbimapColorMapGroup").merge(p);let s=p.selectAll(".pbimapColorMarkers").data(t,function(l){return l.key}),m=s.exit().remove();s=s.enter().append("path").attr("class","pbimapColorMarkers").attr("d",xn).style("pointer-events","all").style("stroke",An).merge(s),s.style("fill",function(l){return xt(l.totalAllocation)}),Ct?(s.on("touchstart",function(l){d3.event.stopPropagation(),mt.selectAll(".pbimapDropdownContainer").style("display","none");let h=this;s.style("opacity",Yt),d3.select(this).style("opacity",1),$t(l,h)}),n.displayMode==="color"&&d3.select(window).on("touchstart.pbimapColorMarkers",function(){s.style("opacity",1),Jt()})):s.on("mouseover",function(l){qt=this;let h=this;s.style("opacity",Yt),d3.select(this).style("opacity",1),$t(l,h)}).on("mouseout",function(){bt||(currentHoveredRect=null,s.style("opacity",1),Jt())})}}function Ge(){let t=n.displayMode==="size"?".pbimapSizeMarkers":".pbimapColorMarkers",e=n.displayMode==="size"?1:.75;U.selectAll(t).attr("transform",function(u){return"translate("+G.latLngToLayerPoint(u.coordinates).x+","+G.latLngToLayerPoint(u.coordinates).y+") scale("+e+")"});let f=U.selectAll(".pbimapNoDataText, .pbimapNoDataTextBack");if(f){let u=G.getCenter();f.attr("y",G.latLngToLayerPoint(u).y).attr("x",G.latLngToLayerPoint(u).x)}}function ro(t,e){let r=[t[1],e[0]],f=[t[0],e[1]],u=L.latLngBounds(r,f);G.flyToBounds(u,{paddingTopLeft:[wt,wt],paddingBottomRight:[wt,wt],maxZoom:xe})}function K(t){let e=M.domain()[1],r=[0,e/4,e/2,e],f=V.selectAll(".pbimapButtonsTitle").data([!0]).enter().append("text").attr("class","pbimapButtonsTitle").attr("x",S[3]).attr("y",S[0]+he).text("Show values by:"),u=V.selectAll(".pbimapLegendButtonsGroup").data(["size","color"]).enter().append("g").attr("class","pbimapLegendButtonsGroup").attr("transform","translate(0,"+(S[0]+he)+")");u.append("rect").attr("class","pbimapLegendButtonsRect").attr("x",function(s,m){return S[3]+m*(Et+6)}).attr("y",6).attr("width",Et).attr("height",Ke).attr("rx",8).attr("ry",8).style("cursor","pointer"),u.append("text").attr("class","pbimapLegendButtonsText").attr("x",function(s,m){return S[3]+m*(Et+6)+Et/2}).attr("y",20).attr("text-anchor","middle").attr("pointer-events","none").text(function(s){return s.toUpperCase()}),V.selectAll(".pbimapLegendButtonsRect").style("fill",function(s){return n.displayMode===s?"#444":"#ccc"}),V.selectAll(".pbimapLegendButtonsText").style("fill",function(s){return n.displayMode!==s?"#444":"#ccc"}),V.selectAll(".pbimapLegendButtonsGroup").on("click",function(s){n.displayMode=s,X(t,!0),K(t)});let a=V.selectAll(".pbimapLegendTitle").data([!0]).enter().append("text").attr("class","pbimapLegendTitle").attr("x",S[3]).attr("y",S[0]+Qe).text("Legend"),c=V.selectAll(".pbimapLegendSubLegendSquare").data([!0]);c.enter().append("text").attr("class","pbimapLegendSubLegendSquare").attr("x",S[3]).attr("y",S[0]+124).style("font-size","12px").text("\u25A0").merge(c).style("fill",n.selectedAdminLevel?zt:Rt);let i=V.selectAll(".pbimapLegendSubLegendText").data([!0]);i.enter().append("text").attr("class","pbimapLegendSubLegendText").attr("x",S[3]+10).attr("y",S[0]+124).merge(i).text(n.selectedAdminLevel?"Admin Level "+n.selectedAdminLevel:"Global Level"),n.displayMode==="size"?o():p();function o(){V.select(".pbimapLegendColorGroup").remove();let s=V.selectAll(".pbimapLegendSizeGroups").data([!0]);s=s.enter().append("g").attr("class","pbimapLegendSizeGroups").merge(s);let m=s.selectAll(".pbimapLegendSizeGroup").data(r),x=m.enter().append("g").attr("class","pbimapLegendSizeGroup"),l=x.append("line").attr("x1",S[3]+M.range()[1]).attr("x2",S[3]+M.range()[1]+30).attr("y1",function(A){return A?S[0]+70+M.range()[1]*2-M(A)*2:S[0]+70+M.range()[1]*2}).attr("y2",function(A){return A?S[0]+70+M.range()[1]*2-M(A)*2:S[0]+70+M.range()[1]*2}).style("stroke","#666").style("stroke-dasharray","2,2").style("stroke-width","1px"),h=x.append("circle").attr("cx",S[3]+M.range()[1]).attr("cy",function(A){return S[0]+70+M.range()[1]*2-M(A)}).attr("r",function(A){return A?M(A):0}).style("fill","none").style("stroke","darkslategray"),g=x.append("text").attr("class","pbimapLegendCirclesText").attr("x",S[3]+M.range()[1]+34).attr("y",function(A,v){return v===1?S[0]+75+M.range()[1]*2-M(A)*2:v?S[0]+73+M.range()[1]*2-M(A)*2:S[0]+73+M.range()[1]*2-2}).text(function(A){return A?d3.formatPrefix(".0",A)(A):"0"});m=m.merge(x),m.select(".pbimapLegendCirclesText").text(function(A){return A?d3.formatPrefix(".0",A)(A):"0"})}function p(){V.select(".pbimapLegendSizeGroups").remove();let s=V.selectAll(".pbimapLegendColorGroup").data([!0]);s=s.enter().append("g").attr("class","pbimapLegendColorGroup").merge(s);let m=s.selectAll(".pbimapLegendRects").data([xt.domain()[0]].concat(xt.quantiles()));m=m.enter().append("rect").attr("class","pbimapLegendRects").attr("y",S[0]+70).attr("x",function(h,g){return S[3]+g*9}).style("stroke","#444").attr("width",7).attr("height",9).merge(m).style("fill",function(h){return xt(h)});let x=s.selectAll(".pbimapLegendColorLines").data(d3.range(2)).enter().append("line").attr("class","pbimapLegendColorLines").attr("y1",S[0]+80).attr("y2",S[0]+90).attr("x1",function(h){return h?S[3]+88:S[3]}).attr("x2",function(h){return h?S[3]+88:S[3]}).style("stroke-width","1px").style("shape-rendering","crispEdges").style("stroke","#444"),l=s.selectAll(".pbimapLegendColorTexts").data(d3.extent(xt.domain()));l=l.enter().append("text").attr("class","pbimapLegendColorTexts").attr("y",104).attr("x",function(h,g){return g?S[3]+88:S[3]}).attr("text-anchor",function(h,g){return g?"end":"start"}).merge(l).text(function(h){return h?d3.formatPrefix(".0",h)(h):"0"})}}function rt(){let t=JSON.parse(JSON.stringify(Be)),e;n.selectedAdminLevel===0?e=["Global Level"]:e=d3.range(1,n.selectedAdminLevel+1).map(function(c){return"Admin Level "+c});let r=[n.selectedYear,n.selectedCBPF,n.selectedPartner,n.selectedCluster,n.selectedModality];for(r=r.map(function(c,i){if(c.length>1)return"Several";if(i!==2)return i?Ve(c[0]):c[0];{let p;for(var o in J)J[o].toLowerCase()===c[0]&&(p=J[o]);return p||Ve(c[0])}}),r[1]==="All"&&(r[1]="All CBPFs"),r[2]==="All"&&(r[2]="All Partners"),r[3]==="All"&&(r[3]="All Clusters"),r[4]==="All"&&(r[4]="All Allocations"),r=r.concat(e);t.length<r.length;){let c=d3.color(t[t.length-1]);c.b+=12,t.push(c.darker(.1))}let f=Vn.selectAll(".pbimapBreadcrumbs").data(r),u=f.exit().remove(),a=f.enter().append("div").attr("class","pbimapBreadcrumbs").style("background-color",function(c,i){return t[i]}).style("padding-left",function(c,i){return i?"6px":"10px"});a.each(function(c,i){i&&d3.select(this).append("span").attr("class","pbimapBeforeSpan"),d3.select(this).append("span").attr("class","pbimapContentSpan").html(c),d3.select(this).append("span").attr("class","pbimapAfterSpan").style("border-left","10px solid "+t[i])}),f=a.merge(f),f.select(".pbimapContentSpan").html(function(c){return c}),f.style("opacity",0).transition().duration(_/10).delay(function(c,i){return i*(_/10)}).style("opacity",1)}function ct(t){let e=qn.selectAll(".pbimapshowAllButton").data(n.selectedAdminLevel?[]:[!0]),r=e.exit().remove();e=e.enter().append("button").attr("class","pbimapshowAllButton").html("Show All Projects").merge(e).on("click",function(){let f=t.reduce(function(u,a){return a.values.forEach(function(c){let i=u.find(function(o){return o.PrjCode===c.PrjCode});i?(N.forEach(function(o){i["AdmLocBenClustAgg1"+o]+=c["AdmLocBenClustAgg1"+o]}),i.AdmLocClustBdg1+=c.AdmLocClustBdg1):u.push(JSON.parse(JSON.stringify(c)))}),u},[]);f.sort(function(u,a){return Y[u.PFId].localeCompare(Y[a.PFId])||a.AdmLocClustBdg1-u.AdmLocClustBdg1}),Ye(f,!0),z.style("display","none"),H.node().scrollIntoView({behavior:"smooth"})})}function co(){let t="\xA9 OCHA CBPF Section "+Pt;Hn&&(t+=" | For more information, please visit <a href='https://cbpf.data.unocha.org'>cbpf.data.unocha.org</a>"),_n.append("div").attr("class","d3chartFooterText").html(t)}function $t(t,e){clearTimeout(ae);let r="<div class='pbimapDivSpacer'><br></div>",f=n.selectedAdminLevel?"(admin level "+Math.min(n.selectedAdminLevel,t.maxLevel)+")":"(country)",u=n.selectedAdminLevel?"CBPF: "+t.CBPFName+r:"";z.style("display","block").html("<div class='pbimapTooltipTitle contributionColorHTMLcolor' style='margin-bottom: -16px;'>"+t.locationName+"</div><br><div class='pbimapTooltipSubTitle' style='margin-top: 0px'>"+f+"</div>"+r+u+"<div style='margin:0px;display:flex;flex-wrap:wrap;width:"+te+"px;'><div style='display:flex;flex:0 54%;'>Total allocations:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorHTMLcolor pbimapTooltipTitle2'>$"+St(t.totalAllocation)+"</span></div><div style='display:flex;flex:0 54%;'>Number of partners:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorHTMLcolor pbimapTooltipTitle2'>"+t.numberOfPartners+"</span></div><div style='display:flex;flex:0 54%;'>Number of projects:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorHTMLcolor pbimapTooltipTitle2'>"+t.numberOfProjects+"</span></div></div>"+r+"<span class='pbimapTooltipTitle2'>"+St(t.beneficiaries)+" Targeted People:</span><div id='pbimapTooltipSvgDiv'></div><div class='pbimapTooltipButtonDiv'><button>Show Projects</button></div>"),s();let a=e.getBoundingClientRect(),c=P.node().getBoundingClientRect(),i=z.node().getBoundingClientRect(),o=(a.bottom+a.top)/2-c.top-i.height/2,p=c.right-a.right>i.width+2*Kt?a.right-c.left+Kt:a.left-c.left-i.width-Kt;z.style("top",o+"px").style("left",p+"px"),z.select("button").on("click",function(){let m=t.values.reduce(function(x,l){let h=x.find(function(g){return g.PrjCode===l.PrjCode});return h?(N.forEach(function(g){h["AdmLocBenClustAgg"+(n.selectedAdminLevel||1)+g]+=l["AdmLocBenClustAgg"+(n.selectedAdminLevel||1)+g]}),h["AdmLocClustBdg"+(n.selectedAdminLevel||1)]+=l["AdmLocClustBdg"+(n.selectedAdminLevel||1)]):x.push(JSON.parse(JSON.stringify(l))),x},[]);m.sort(function(x,l){return l["AdmLocClustBdg"+(n.selectedAdminLevel||1)]-x["AdmLocClustBdg"+(n.selectedAdminLevel||1)]}),Ye(m,!1),z.style("display","none"),H.node().scrollIntoView({behavior:"smooth"})});function s(){kt.domain([0,d3.max(N.map(function(v){return t["beneficiaries"+v]}))]);let m=z.select("#pbimapTooltipSvgDiv").append("svg").attr("width",te).attr("height",Gt).attr("class","pbimapTooltipSvg"),x=m.append("g").attr("class","pbimapTooltipSvgYAxisGroup").attr("transform","translate("+q[3]+",0)").call(Xn),l=m.append("g").attr("class","pbimapTooltipSvgXAxisGroup").attr("transform","translate(0,"+(Gt-q[2])+")").call(Kn).selectAll(".tick").filter(function(v){return v===0}).remove(),h=m.selectAll(null).data(N).enter().append("text").attr("class","pbimapTooltipLabels").attr("x",q[3]+2).attr("y",function(v){return Dt(v)+Dt.bandwidth()/2+4}).text(function(v){return pt(t["beneficiaries"+v])}),g=m.selectAll(null).data(N).enter().append("rect").style("fill",n.selectedAdminLevel?zt:Rt).attr("x",q[3]).attr("y",function(v){return Dt(v)-Ce/4}).attr("height",Ce).attr("width",0).transition().duration(_).attr("width",function(v){return kt(t["beneficiaries"+v])-q[3]}),A=m.selectAll(null).data(N).enter().append("circle").style("fill",n.selectedAdminLevel?zt:Rt).attr("cx",q[3]).attr("cy",function(v){return Dt(v)}).attr("r",Te).transition().duration(_).attr("cx",function(v){return kt(t["beneficiaries"+v])});h.transition().duration(_).attr("x",function(v){return kt(t["beneficiaries"+v])+Te+2})}}function Jt(){ae=setTimeout(function(){z.style("display","none")},tn),z.on("mouseover",function(){clearTimeout(ae)}).on("mouseleave",function(){z.style("display","none")})}function Ye(t,e){H.html("");let r=H.append("div").attr("class","pbimapListTitleDivContainer"),f=r.append("div").attr("class","pbimapListTitleDiv"),u=r.append("div").attr("class","pbimapListButtonDiv");if(!e){let g=H.append("div").attr("class","pbimapListBreadcrumbDivContainer").append("p").attr("class","pbimapListBreadcrumbs contributionColorHTMLcolor").html(function(){let A=[Y[t[0].PFId]];for(let v=1;v<=n.selectedAdminLevel;v++)A.indexOf(t[0]["AdmLoc"+v])===-1&&A.push(t[0]["AdmLoc"+v]);return A.join(" \u2192 ")})}let a=f.append("p").attr("class","pbimapListTitle contributionColorHTMLcolor").html("List of Projects"),c=u.append("button").html("Remove this list").on("click",function(){H.html("")});u.append("button").html(".CSV  ").on("click",function(){let h=Ao(t),g=new Date,A;e?A="Global":A=n.selectedAdminLevel?t[0]["AdmLoc"+n.selectedAdminLevel]:Y[t[0].PFId];let v="ProjectsList_"+A+"_"+Nt(g)+".csv",d=new Blob(["\uFEFF"+h],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(d,filename);else{let y=document.createElement("a");if(y.download!==void 0){let b=URL.createObjectURL(d);y.setAttribute("href",b),y.setAttribute("download",v),y.style="visibility:hidden",document.body.appendChild(y),y.click(),document.body.removeChild(y)}}}).append("span").attr("class","fas fa-download contributionColorHTMLcolor"),H.append("div").attr("class","pbimapListHeaderContainerDiv").selectAll(null).data(ee).enter().append("div").style("width",function(h,g){return Nn[g]}).style("text-align",function(h,g){return g===4||g===5?"center":"left"}).append("span").html(function(h){return h}),H.append("div").attr("class","pbimapListRowsContainer").selectAll(null).data(t).enter().append("div").attr("class","pbimapListRows").selectAll(null).data(ee).enter().append("div").attr("class","pbimapListRowDivs").style("width",function(h,g){return In[g]}).style("padding-right",function(h,g){return g===4||g===5?null:"8px"}).style("text-align",function(h,g){return g===4||g===5?"right":"left"}).append("span").html(function(h){let g=d3.select(this.parentNode.parentNode).datum();if(h==="Targeted People"){let A=0;return N.forEach(function(v){A+=g["AdmLocBenClustAgg"+(n.selectedAdminLevel||1)+v]}),St(A)}else return h==="Allocations"?"$"+St(g["AdmLocClustBdg"+(n.selectedAdminLevel||1)]):g[to(h)]})}function w(t,e,r){let f=t.selectAll(".pbimapDropdownLi").data(e,function(o){return o}),u=f.exit().remove(),a=f.enter().append("li").attr("class","pbimapDropdownLi"),c=a.append("span").attr("class","pcimapDropdownBox").append("span").attr("class",function(o){return r===n.selectedAdminLevel?r===o?"far fa-check-square":"far fa-square":r.length===1&&r[0]==="all"||r.indexOf(+o==+o?+o:o.toLowerCase())>-1?"far fa-check-square":"far fa-square"}),i=a.append("span").html(function(o){return r===n.selectedAdminLevel?o?"Admin Level "+o:"Global Level":o});f=a.merge(f),f.select(".pcimapDropdownBox").select("span").attr("class",function(o){return r===n.selectedAdminLevel?r===o?"far fa-check-square":"far fa-square":r.length===1&&r[0]==="all"||r.indexOf(+o==+o?+o:o.toLowerCase())>-1?"far fa-check-square":"far fa-square"}),f.on("mouseover",function(){let o=d3.select(this.parentNode).datum();d3.select(this).style("background-color",Wt(o))}).on("mouseout",function(){let o=d3.select(this.parentNode).datum();d3.select(this).style("background-color",d3.color(Wt(o)).brighter(ye))})}function He(t,e){let r;for(let i=e.length;i--;){let o=e[i],p=[];for(let s in o)o[s].indexOf("|||")>-1&&p.push(o[s].split("|||").length);if(!p.every((s,m,x)=>s===x[0])){console.warn("Data row with mismatching pipes:",o);continue}(e[i-1]||e.length===1)&&(i===e.length-1||o.PrjCode!==e[i+1].PrjCode)&&(r=t.find(function(s){return s.PrjCode===o.PrjCode})),o.cbpfName=Y[o.PFId],o.OrgTypeId=r.OrgTypeId,o.OrgNm=r.OrgNm,o.AllNm="("+De[o.PFId]+") "+r.AllNm,o.AllSrc=r.AllSrc,o.PrjTitle=r.PrjTitle,o.AStrDt=r.AStrDt,o.AEndDt=r.AEndDt,o.PartCode=r.PartCode,Oe.indexOf(o.AllNm.toLowerCase())===-1&&(Oe.push(o.AllNm.toLowerCase()),ne.push(o.AllNm)),Ht[o.AYr].indexOf(Y[o.PFId])===-1&&Ht[o.AYr].push(Y[o.PFId]),u(o),f(o);for(let s in o)if(o[s].indexOf("|||")>-1){a(o,s);break}c(o),Ut.push(o)}t.length=0;function f(i){let o=It+1;for(;--o;)i["uniqueValue"+o]=i["AdmLoc"+o].split(",").join("")+","+i["AdmLocCord"+o]}function u(i){let o=It+1;for(;--o;){if(i["AdmLoc"+o]==="")continue;d3.range(o+1,It+1,1).forEach(function(s){i["AdmLoc"+s]=i["AdmLoc"+o],i["AdmLocBenClustAgg"+s]=i["AdmLocBenClustAgg"+o],i["AdmLocCord"+s]=i["AdmLocCord"+o],i["AdmLocClustBdg"+s]=i["AdmLocClustBdg"+o]}),i.maxLevel=o+"";break}}function a(i,o){let p=i[o].split("|||").length;for(let s=1;s<p;s++){let m=Object.assign({},i);for(let x in m)m[x].indexOf("|||")>-1&&(m[x]=m[x].split("|||")[s]);c(m),Ut.push(m)}for(let s in i)i[s].indexOf("|||")>-1&&(i[s]=i[s].split("|||")[0])}function c(i){for(let o in i)i[o].indexOf("##")>-1&&i[o].split("##").forEach(function(s,m){i[o+N[m]]=+s});i.partnerType=J[i.OrgTypeId],i.cluster=ut[i.ClstAgg],i.modality=ke[i.AllSrc];for(let o in i)o.indexOf("AdmLocClustBdg")>-1&&(i[o]=+i[o]);i.maxLevel=+i.maxLevel,delete i.AdmLocBenClustAgg1,delete i.AdmLocBenClustAgg2,delete i.AdmLocBenClustAgg3,delete i.AdmLocBenClustAgg4,delete i.AdmLocBenClustAgg5,delete i.AdmLocBenClustAgg6}}function tt(){let t={totalAllocations:0,totalBeneficiaries:0,totalProjects:0,totalPartners:0,launchedAllocations:0,underApprovalAllocations:0},e,r=[],f=[],u=[],a=[];Ut.forEach(function(l){o(l.AYr)&&p(l.cbpfName)&&s(l.partnerType)&&x(l.cluster)&&f.indexOf(l.AllNm.toLowerCase())===-1&&(f.push(l.AllNm.toLowerCase()),r.push(l.AllNm)),o(l.AYr)&&p(l.cbpfName)&&m(l.AllNm)&&x(l.cluster)&&u.indexOf(l.partnerType)===-1&&u.push(l.partnerType),o(l.AYr)&&p(l.cbpfName)&&s(l.partnerType)&&m(l.AllNm)&&a.indexOf(l.cluster)===-1&&a.push(l.cluster)}),f.length=0,n.selectedModality=n.selectedModality.filter(function(l){return r.map(function(h){return h.toLowerCase()}).concat(["all"]).indexOf(l)>-1}),n.selectedModality.length===0&&(n.selectedModality=["all"]);let c=Ut.filter(function(l){return o(l.AYr)&&p(l.cbpfName)&&s(l.partnerType)&&m(l.AllNm)&&x(l.cluster)});if(c=c.filter(function(l){return d3.range(1,It+1,1).every(function(h){return l["uniqueValue"+h].split(",").length===3})}),n.selectedAdminLevel===0)e=d3.nest().key(function(l){return l.cbpfName}).entries(c),e.forEach(function(l){let h=[],g=[],A={};N.forEach(function(d){A[d]=0}),A.total=0;let v=0;l.latitude=oe[l.key].split(",")[0],l.longitude=oe[l.key].split(",")[1],l.coordinates=new L.LatLng(l.latitude,l.longitude),l.locationName=l.key,l.maxLevel=d3.max(l.values.map(function(d){return d.maxLevel})),l.values.forEach(function(d){v+=d.AdmLocClustBdg1,N.forEach(function(y){A[y]+=d["AdmLocBenClustAgg1"+y],A.total+=d["AdmLocBenClustAgg1"+y]}),h.indexOf(d.PartCode)===-1&&h.push(d.PartCode),g.indexOf(d.PrjCode)===-1&&g.push(d.PrjCode)}),l.totalAllocation=v,l.numberOfPartners=h.length,l.numberOfProjects=g.length,l.beneficiaries=A.total,N.forEach(function(d){l["beneficiaries"+d]=A[d]}),t.totalAllocations+=l.totalAllocation,t.totalBeneficiaries+=l.beneficiaries,t.totalPartners+=h.length,t.totalProjects+=g.length});else{let l=[],h=[];e=d3.nest().key(function(g){return g["uniqueValue"+n.selectedAdminLevel]}).entries(c),e.forEach(function(g){let A=[],v=[],d={};N.forEach(function(b){d[b]=0}),d.total=0;let y=0;g.latitude=g.key.split(",")[1],g.longitude=g.key.split(",")[2],g.coordinates=new L.LatLng(g.latitude,g.longitude),g.locationName=g.key.split(",")[0],g.CBPFName=g.values[0].cbpfName,g.maxLevel=d3.max(g.values.map(function(b){return b.maxLevel})),g.values.forEach(function(b){y+=b["AdmLocClustBdg"+n.selectedAdminLevel],N.forEach(function(C){d[C]+=b["AdmLocBenClustAgg"+n.selectedAdminLevel+C],d.total+=b["AdmLocBenClustAgg"+n.selectedAdminLevel+C]}),A.indexOf(b.PartCode)===-1&&A.push(b.PartCode),v.indexOf(b.PrjCode)===-1&&v.push(b.PrjCode),l.indexOf(b.PartCode)===-1&&l.push(b.PartCode),h.indexOf(b.PrjCode)===-1&&h.push(b.PrjCode)}),g.totalAllocation=y,g.numberOfPartners=A.length,g.numberOfProjects=v.length,g.beneficiaries=d.total,N.forEach(function(b){g["beneficiaries"+b]=d[b]}),t.totalAllocations+=g.totalAllocation,t.totalBeneficiaries+=g.beneficiaries}),t.totalPartners+=l.length,t.totalProjects+=h.length}for(let l in ft)delete ft[l];let i={};le.forEach(function(l){o(l.AllocationYear)&&p(l.PooledFundName)&&(i[l.AllocationYear]={underApproval:(i[l.AllocationYear]?i[l.AllocationYear].underApproval:0)+ +l.TotalUnderApprovalBudget,approved:(i[l.AllocationYear]?i[l.AllocationYear].approved:0)+ +l.TotalApprovedBudget,launched:(i[l.AllocationYear]?i[l.AllocationYear].launched:0)+ +l.TotalUSDPlanned})});for(let l in i){let{underApprovalPercent:h,underPlusApprovedPercent:g}=Ie(i[l].underApproval,i[l].approved,i[l].launched);ft[l]=h>_t||g<_t}return le.forEach(function(l){o(l.AllocationYear)&&p(l.PooledFundName)&&ft[l.AllocationYear]&&(t.launchedAllocations+=+l.TotalUSDPlanned,t.underApprovalAllocations+=+l.TotalUnderApprovalBudget)}),{topSvgObject:t,map:e,allocationsTypeList:r,partnersTypeList:u,clustersList:a};function o(l){return n.selectedYear.indexOf(+l)>-1}function p(l){return n.selectedCBPF[0]==="all"?!0:l?n.selectedCBPF.indexOf(l.toLowerCase())>-1:!1}function s(l){return n.selectedPartner[0]==="all"?!0:l?n.selectedPartner.indexOf(l.toLowerCase())>-1:!1}function m(l){return n.selectedModality[0]==="all"?!0:l?n.selectedModality.indexOf(l.toLowerCase())>-1:!1}function x(l){return n.selectedCluster[0]==="all"?!0:l?n.selectedCluster.indexOf(l.toLowerCase())>-1:!1}}function po(t){t.forEach(function(e){Y[e.PFId+""]=e.PFName})}function uo(t){t.forEach(function(e){De[e.PFId+""]=e.PFAbbrv.substring(0,3)})}function fo(t){t.forEach(function(e){ut[e.ClustId+""]=e.ClustNm})}function mo(t){t.forEach(function(e){J[e.OrgTypeId+""]=e.OrgTypeNm})}function go(t){t.forEach(function(e){ke[e.AllSrcId+""]=e.AllNm})}function ho(t){t.forEach(function(e){oe[e.PFName+""]=e.PFLat+","+e.PFLong})}function yo(){ve.forEach(function(t){let e=t==="CBPF"?"fund":t.toLowerCase();(B.has(e)?B.get(e).replace(/\|/g,",").split(",").map(function(u){return u.trim().toLowerCase()}):P.node().getAttribute("data-"+t.toLowerCase()).split(",").map(function(u){return u.trim().toLowerCase()})).forEach(function(u){n["selected"+t].push(u)}),n["selected"+t].some(function(u){return xo(Jn(t)).indexOf(u)===-1})&&(n["selected"+t]=["all"])}),n.selectedAdminLevel=B.has("adminlevel")?~~B.get("adminlevel")<7?~~B.get("adminlevel"):0:~~P.node().getAttribute("data-adminlevel")<7?~~P.node().getAttribute("data-adminlevel"):0,Me=JSON.parse(JSON.stringify(n))}function vo(t){return+t==+t&&Z.indexOf(t)>-1?+t:Pt}function Ue(){Q.style("opacity",0).style("pointer-events","none");let t=P.append("div").attr("class","pbimapOverDivHelp"),e=Bt.node().getBoundingClientRect(),r=Q.node().getBoundingClientRect(),f=e.height*(T/e.width),u=I.node().getBoundingClientRect(),a=mt.node().getBoundingClientRect(),c=Ee.node().getBoundingClientRect(),i=ie.node().getBoundingClientRect(),o=u.height*(T/u.width),p=a.height*(T/a.width),s=c.height*(T/c.width),m=i.height*(T/i.width),l=f+o+p+s+m+40,h=e.height+u.height+a.height+c.height+i.height,g=t.append("svg").attr("viewBox","0 0 "+T+" "+l),A=[{text:"CLOSE",width:90},{text:"GO TO HELP PORTAL",width:180}],v=g.selectAll(null).data(A).enter().append("g");v.append("rect").attr("rx",4).attr("ry",4).style("stroke","rgba(0, 0, 0, 0.3)").style("stroke-width","1px").style("fill",vn).style("cursor","pointer").attr("y",6).attr("height",22).attr("width",function(k){return k.width}).attr("x",function(k,F){return T-lt[1]-k.width-(F?A[0].width+8:0)}).on("click",function(k,F){Q.style("opacity",1).style("pointer-events","all"),t.remove(),F&&window.open(rn,"help_portal")}),v.append("text").attr("class","pbimapAnnotationMainText").attr("text-anchor","middle").attr("x",function(k,F){return T-lt[1]-k.width/2-(F?A[0].width+8:0)}).attr("y",22).text(function(k){return k.text});let d=[{x:950,y:22+f+o+p+s,width:148,height:30,xTooltip:800*(e.width/T),yTooltip:h*.885,text:"Click here to generate a list of projects (below the map) for all selected funds."},{x:6,y:f+o+10,width:130,height:p+10,xTooltip:6*(e.width/T),yTooltip:h*.25,text:"Use this menu to select one or more years. Greyed-out years were not downloaded yet (please wait some time)."},{x:138,y:f+o+10,width:658,height:p+10,xTooltip:350*(e.width/T),yTooltip:h*.25,text:"Use these menus to select (one or more) other filters. When \u201CAll\u201D is selected, clicking an option will select that given option only. The options in the \u201CAllocation Type\u201D menu change according to the selected options in the other menus."},{x:1028,y:f+o+10,width:68,height:p+10,xTooltip:900*(e.width/T),yTooltip:h*.25,text:"This button resets all menus (and the map) to the initial values."},{x:130,y:100+f+o+p,width:410,height:300,xTooltip:180*(e.width/T),yTooltip:h*.245,text:"In the map area, hover over a marker to get additional information. You can zoom and pan the map."},{x:6,y:325+f+o+p,width:100,height:30,xTooltip:6*(e.width/T),yTooltip:h*.615,text:"Click here to encode allocations by \u201Csize\u201D (larger markers indicate bigger allocations) or by \u201Ccolor\u201D (darker markers indicate bigger allocations)."},{x:680,y:330+f+o+p,width:160,height:30,xTooltip:600*(e.width/T),yTooltip:h*.625,text:"When you hover over a marker a tooltip like this shows up. Click \u201CShow Projects\u201D to create a table below the map, with all the projects for that marker."},{x:6,y:25+f+o+p+s,width:574,height:30,xTooltip:6*(e.width/T),yTooltip:h*.89,text:"This sequence indicates the current selection for all menus."}],y=g.append("image").attr("xlink:href",localStorage.getItem("storedImagetooltipThumbnail")?localStorage.getItem("storedImagetooltipThumbnail"):wn).attr("width",260).attr("height",241).attr("x",630).attr("y",240).style("opacity",.6);d.forEach(function(k){g.append("rect").attr("rx",4).attr("ry",4).attr("x",k.x).attr("y",k.y).attr("width",k.width).attr("height",k.height).style("stroke",yn).style("stroke-width","3px").style("fill","none").style("opacity",.5).attr("class","pbimapHelpRectangle").attr("pointer-events","all").on("mouseover",function(){let F=this;D(k.xTooltip,k.yTooltip,k.text,F)}).on("mouseout",R)});let b=g.append("rect").attr("x",T/2-180).attr("y",152).attr("width",360).attr("height",50).attr("pointer-events","none").style("fill","white").style("stroke","#888"),C=g.append("text").attr("class","pbimapAnnotationExplanationText").attr("font-family","Roboto").attr("font-size","18px").style("fill","#222").attr("text-anchor","middle").attr("x",T/2).attr("y",172).attr("pointer-events","none").text("Hover over the elements surrounded by a blue rectangle to get additional information").call(Lo,350);function D(k,F,nt,W){C.style("opacity",0),b.style("opacity",0),g.selectAll(".pbimapHelpRectangle").style("opacity",.1),d3.select(W).style("opacity",1);let ot=P.node().getBoundingClientRect();z.style("top",F+"px").style("left",k+"px").style("display","block").html(nt)}function R(){z.style("display","none"),C.style("opacity",1),b.style("opacity",1),g.selectAll(".pbimapHelpRectangle").style("opacity",.5)}}function bo(t){let e=[];t.forEach(function(a){let c=n.selectedAdminLevel?a.CBPFName:a.locationName;e.push({"CBPF Name":c,Location:a.locationName,Latitude:a.latitude,Longitude:a.longitude,"# of Partners":a.numberOfPartners,"# of Approved Projects":a.numberOfProjects,"Total Allocations":Math.floor(a.totalAllocation*100)/100,"Total Targeted People":a.beneficiaries,"Boys (Targeted)":a.beneficiariesBoys,"Girls (Targeted)":a.beneficiariesGirls,"Men (Targeted)":a.beneficiariesMen,"Women (Targeted)":a.beneficiariesWomen})});let r=Object.keys(e[0]),f=function(a,c){return c===null?"":c},u=e.map(function(a){return r.map(function(c){return JSON.stringify(a[c],f)}).join(",")});return u.unshift(r.join(",")),u.join(`\r
`)}function Ao(t){let e=[];return t.forEach(function(r){let f=0;N.forEach(function(u){f+=r["AdmLocBenClustAgg"+(n.selectedAdminLevel||1)+u]}),f=St(f),e.push({CBPF:r.cbpfName,"Project Code":r.PrjCode,"Project Title":r.PrjTitle,Partner:r.OrgNm,"Partner Type":r.partnerType,"Allocation Type":r.AllNm,Allocations:Math.floor(r["AdmLocClustBdg"+(n.selectedAdminLevel||1)]),"Targeted People":f})}),d3.csvFormat(e)}function xo(t){let e=[];for(let r in t)e.push(t[r].toLowerCase());return e}function pt(t){let e=(~~Math.log10(t)+1)%3,r=e===1?2:e===2?1:0,f=d3.formatPrefix("."+r+"~",t)(t);if(parseInt(f)===1e3){let u=f[f.length-1],a={k:"M",M:"B"};return 1+(isNaN(u)?a[u]:"")}return f}function Ve(t){return t.split(" ").map(function(r){return r[0].toUpperCase()+r.substr(1).toLowerCase()}).join(" ")}function et(t,e){B.has(t)?B.set(t,e):B.append(t,e)}let Zt={Afghanistan:{sw:{lat:29.3772,lng:60.5176034},ne:{lat:38.4910682,lng:74.889862}},"Burkina Faso":{sw:{lat:9.410691,lng:-5.523891},ne:{lat:15.082,lng:2.405}},CAR:{sw:{lat:2.2156553,lng:14.4155426},ne:{lat:11.001389,lng:27.4540764}},Colombia:{sw:{lat:-4.2316872,lng:-82.1243666},ne:{lat:16.0571269,lng:-66.8511907}},DRC:{sw:{lat:-13.459035,lng:12.039074},ne:{lat:5.3920026,lng:31.3056758}},Ethiopia:{sw:{lat:3.397448,lng:32.9975838},ne:{lat:14.8940537,lng:47.9823797}},Haiti:{sw:{lat:17.9099291,lng:-75.2384618},ne:{lat:20.2181368,lng:-71.6217461}},Iraq:{sw:{lat:29.0585661,lng:38.7936719},ne:{lat:37.380932,lng:48.8412702}},Jordan:{sw:{lat:29.183401,lng:34.8844372},ne:{lat:33.3750617,lng:39.3012981}},Lebanon:{sw:{lat:33.0479858,lng:34.8825667},ne:{lat:34.6923543,lng:36.625}},Mali:{sw:{lat:10.147811,lng:-12.240283},ne:{lat:25.000002,lng:4.244825}},Myanmar:{sw:{lat:9.4399432,lng:92.1719423},ne:{lat:28.547835,lng:101.1700796}},Nigeria:{sw:{lat:4.0690959,lng:2.676932},ne:{lat:13.885645,lng:14.678014}},Niger:{sw:{lat:11.693,lng:.166},ne:{lat:23.517,lng:16}},Pakistan:{sw:{lat:23.5393916,lng:60.872855},ne:{lat:37.084107,lng:77.1203914}},Somalia:{sw:{lat:-1.8031969,lng:40.98918},ne:{lat:12.1889121,lng:51.6177696}},"South Sudan":{sw:{lat:3.285278,lng:21.8145046},ne:{lat:12.224918,lng:39.0576252}},Sudan:{sw:{lat:8.685278,lng:21.8145046},ne:{lat:22.224918,lng:39.0576252}},Syria:{sw:{lat:32.311354,lng:35.4714427},ne:{lat:37.3184589,lng:42.3745687}},"Syria Cross border":{sw:{lat:35.8076804,lng:25.6212891},ne:{lat:42.297,lng:44.8176638}},Venezuela:{sw:{lat:.724452,lng:-73.352963},ne:{lat:12.201903,lng:-59.80378}},Yemen:{sw:{lat:11.9084802,lng:41.60825},ne:{lat:19,lng:54.7389375}},oPt:{sw:{lat:31.2201289,lng:34.0689732},ne:{lat:32.5521479,lng:35.5739235}},Ukraine:{sw:{lat:44.184598,lng:22.137059},ne:{lat:52.3791473,lng:40.2275801}}};function Lo(t,e){t.each(function(){let r=d3.select(this),f=r.text().split(/\s+/).reverse(),u,a=[],c=0,i=1.1,o=r.attr("y"),p=r.attr("x"),s=0,m=r.text(null).append("tspan").attr("x",p).attr("y",o).attr("dy",s+"em");for(;u=f.pop();)a.push(u),m.text(a.join(" ")),m.node().getComputedTextLength()>e&&(a.pop(),m.text(a.join(" ")),a=[u],m=r.append("tspan").attr("x",p).attr("y",o).attr("dy",++c*i+s+"em").text(u))})}function se(t,e){localStorage.getItem("storedImage"+e)||r(t,f,null,e);function r(u,a,c,i){let o=new XMLHttpRequest;o.responseType="arraybuffer",o.open("GET",u),o.onload=function(){let p,s,m,x;m=new Uint8Array(o.response),s=[].map.call(m,function(l){return String.fromCharCode(l)}).join(""),x=o.getResponseHeader("content-type"),p=["data:",x?x+";":"","base64,",btoa(s)].join(""),a(i,p)},o.onerror=c,o.send()}function f(u,a){localStorage.setItem("storedImage"+u,a)}}function Qt(t,e){if(Lt){alert("This functionality is not supported by Internet Explorer");return}d3.select("pbimapTopSvgPartnersLogo").attr("xlink:href",localStorage.getItem("storedImagepartnersLogo")),d3.select("pbimapTopSvgProjectsLogo").attr("xlink:href",localStorage.getItem("storedImageprojectsLogo"));let f=d3.select("body").append("div").style("position","fixed").attr("id","pbimapDownloadingDiv").style("left",window.innerWidth/2-100+"px").style("top",window.innerHeight/2-100+"px").append("svg").attr("class","pbimapDownloadingDivSvg").attr("width",200).attr("height",100),u="Downloading "+t.toUpperCase();So(f,200,175,u);let a=["font-size","font-family","font-weight","fill","stroke","stroke-dasharray","stroke-width","opacity","text-anchor","text-transform","shape-rendering","letter-spacing","white-space"],c=P.node();o(I.node()),o(V.node()),z.style("display")==="block"&&o(z.select("svg").node()),t==="png"?Q.style("opacity",0):Bt.style("opacity",0);let i=I.node().getBoundingClientRect();I.attr("width",i.width).attr("height",i.height),P.selectAll(".pbimapBeforeSpan, .pbimapAfterSpan, .pbimapResetDiv").style("opacity",0),H.html()&&H.style("opacity",0),At.style("display","none"),Ct&&window.scrollTo({top:0}),html2canvas(c,{scrollX:0,scrollY:-window.scrollY,useCORS:!0}).then(function(p){P.selectAll(".pbimapBeforeSpan, .pbimapAfterSpan, .pbimapResetDiv").style("opacity",1),I.attr("width",null).attr("height",null),H.html()&&H.style("opacity",1),t==="png"?Q.style("opacity",1):Bt.style("opacity",1),t==="png"?Co(p):To(p),e&&qt&&d3.select(qt).dispatch("mouseout")});function o(p){if(!p.style)return;let s=getComputedStyle(p);for(let m=0;m<a.length;m++)p.style[a[m]]=s[a[m]];for(let m=0;m<p.childNodes.length;m++)o(p.childNodes[m])}}function Co(t){let r="AllocationsOverview_"+Nt(new Date)+".png";t.toBlob(function(f){let u=URL.createObjectURL(f),a=document.createElement("a");a.download!==void 0?(a.setAttribute("href",u),a.setAttribute("download",r),a.style="visibility:hidden",document.body.appendChild(a),a.click(),document.body.removeChild(a)):window.location.href=u}),re(),d3.select("#pbimapDownloadingDiv").remove()}function To(t){let e={top:10,bottom:16,left:20,right:30};d3.image("https://raw.githubusercontent.com/CBPFGMS/cbpfgms.github.io/master/img/assets/bilogo.png").then(function(r){let f,a=new jsPDF,c=a.splitTextToSize("Funding from CBPFs is directly available to UN agencies, national and international non-governmental organizations (NGOs) and Red Cross/ Red Crescent organizations. In 2018, CBPFs allocated more than $836 million to 685 partners in 18 countries to support 1,453 critical humanitarian projects. These projects targeted millions of people with healthcare, food aid, clean water, shelter and other life-saving assistance.",210-e.left-e.right,{fontSize:12}),i=d3.timeFormat("%A, %d %B %Y")(new Date);a.setTextColor(60),a.setFont("helvetica"),a.setFontType("normal"),a.setFontSize(12),a.text(e.left,48,c),a.setTextColor(65,143,222),a.setFont("helvetica"),a.setFontType("bold"),a.setFontSize(16),a.text("Allocations Overview",e.left,88),a.setFontSize(12);let o=n.selectedYear.sort(function(F,nt){return F-nt}).reduce(function(F,nt,W){return F+(W>=n.selectedYear.length-2?W>n.selectedYear.length-2?nt:nt+" and ":nt+", ")},""),p=n.selectedYear.length>1?"Selected Years: ":"Selected Year: ",s=n.selectedCBPF[0]==="all"?"All CBPFs":k(n.selectedCBPF,d3.values(Y)),m=n.selectedCBPF.length===1&&n.selectedCBPF[0]!=="all"?"Selected CBPF: ":"Selected CBPFs: ",x=n.selectedPartner[0]==="all"?"All Partners":k(n.selectedPartner,d3.values(J)),l=n.selectedPartner.length===1&&n.selectedPartner[0]!=="all"?"Selected Partner: ":"Selected Partners: ",h=n.selectedCluster[0]==="all"?"All Clusters":k(n.selectedCluster,d3.values(ut)),g=n.selectedCluster.length===1&&n.selectedCluster[0]!=="all"?"Selected Cluster: ":"Selected Clusters: ",A=n.selectedModality[0]==="all"?"All Allocations":k(n.selectedModality,ne),v=n.selectedModality.length===1&&n.selectedModality[0]!=="all"?"Selected Allocation: ":"Selected Allocations: ",d=n.selectedAdminLevel?"Admin Level "+n.selectedAdminLevel:"Global Level";a.fromHTML("<div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>Date: <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+i+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+p+"<span style='color: rgb(65, 143, 222); font-weight: 700;'>"+o+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+m+"<span style='color: rgb(65, 143, 222); font-weight: 700;'>"+s+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+l+"<span style='color: rgb(65, 143, 222); font-weight: 700;'>"+x+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+g+"<span style='color: rgb(65, 143, 222); font-weight: 700;'>"+h+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+v+"<span style='color: rgb(65, 143, 222); font-weight: 700;'>"+A+"</span></div><div style='font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+"Selected Location: "+"<span style='color: rgb(65, 143, 222); font-weight: 700;'>"+d+"</span></div>",e.left,94,{width:210-e.left-e.right},function(F){f=F});let b=P.node().getBoundingClientRect(),C=210-e.left*2;a.addImage(t,"PNG",e.left,f.y+2,C,C*(b.height/b.width)),R();let D=new Date;a.save("AllocationsOverview_"+Nt(D)+".pdf"),re(),d3.select("#pbimapDownloadingDiv").remove();function R(){let F="\xA9 OCHA CBPF Section "+Pt+" | For more information, please visit cbpf.data.unocha.org";a.setFillColor(65,143,222),a.rect(0,e.top,210,15,"F"),a.setFillColor(236,161,84),a.rect(0,e.top+15,210,2,"F"),a.setFillColor(255,255,255),a.rect(e.left,e.top-1,94,20,"F"),a.ellipse(e.left,e.top+9,5,9,"F"),a.ellipse(e.left+94,e.top+9,5,9,"F"),a.addImage(r,"PNG",e.left+2,e.top,90,18),a.setFillColor(236,161,84),a.rect(0,297-e.bottom,210,2,"F"),a.setTextColor(60),a.setFont("arial"),a.setFontType("normal"),a.setFontSize(10),a.text(F,e.left,297-e.bottom+10)}function k(F,nt){return F.map(function(W){return nt.find(function(ot){return ot.toLowerCase()===W})}).sort(function(W,ot){return W.toLowerCase()<ot.toLowerCase()?-1:W.toLowerCase()>ot.toLowerCase()?1:0}).reduce(function(W,ot,qe){return W+(qe>=F.length-2?qe>F.length-2?ot:ot+" and ":ot+", ")},"")}})}function Po(t,e){let f=P.append("div").attr("class","pbimapOverDiv").append("svg").attr("viewBox","0 0 "+t+" "+e);wheelGroup=f.append("g").attr("class","pbimapd3chartwheelGroup").attr("transform","translate("+t/2+","+e/4+")");let u=wheelGroup.append("text").attr("text-anchor","middle").style("font-family","Roboto").style("font-weight","bold").style("font-size","18px").attr("y",50).attr("class","contributionColorFill").text("Loading data..."),a=wheelGroup.append("rect").attr("width",Tt+4).attr("height",24).attr("x",-Tt/2-2).attr("y",78).attr("rx",3).attr("ry",3).style("fill","none").style("stroke","#888").style("stroke-width","1px"),c=wheelGroup.append("rect").attr("width",0).attr("height",20).attr("x",-Tt/2).attr("y",80).attr("rx",2).attr("ry",2).style("fill","#bbb"),i=wheelGroup.append("text").style("font-family","Roboto").style("dominant-baseline","middle").style("font-size","12px").attr("x",Tt/2+10).attr("y",90),o=wheelGroup.append("text").style("font-family","Roboto").style("text-anchor","middle").style("font-size","14px").attr("y",128).text("0 kB loaded"),p=d3.arc().outerRadius(20).innerRadius(15),s=wheelGroup.append("path").datum({startAngle:0,endAngle:0}).classed("contributionColorFill",!0).attr("d",p);m();function m(){s.transition().duration(1e3).attrTween("d",function(l){let h=d3.interpolate(0,Math.PI*2);return function(g){return l.endAngle=h(g),p(l)}}).on("end",x)}function x(){s.transition().duration(1e3).attrTween("d",function(l){let h=d3.interpolate(0,Math.PI*2);return function(g){return l.startAngle=h(g),p(l)}}).on("end",function(l){l.startAngle=0,m()})}return{rectProgress:c,progressText:i,bytesText:o}}function So(t,e,r,f){let u;t===null?u=P.append("div").attr("class","pbimapOverDiv").append("svg").attr("viewBox","0 0 "+e+" "+r).append("g").attr("class","pbimapd3chartwheelGroup").attr("transform","translate("+e/2+","+r/4+")"):u=t.append("g").attr("class","pbimapd3chartwheelGroup").attr("transform","translate("+e/2+","+r/4+")");let a=u.append("text").attr("text-anchor","middle").style("font-family","Roboto").style("font-weight","bold").style("font-size","11px").attr("y",40).attr("class","contributionColorFill").text(f),c=d3.arc().outerRadius(25).innerRadius(20),i=u.append("path").datum({startAngle:0,endAngle:0}).classed("contributionColorFill",!0).attr("d",c);o();function o(){i.transition().duration(1e3).attrTween("d",function(s){let m=d3.interpolate(0,Math.PI*2);return function(x){return s.endAngle=m(x),c(s)}}).on("end",p)}function p(){i.transition().duration(1e3).attrTween("d",function(s){let m=d3.interpolate(0,Math.PI*2);return function(x){return s.startAngle=m(x),c(s)}}).on("end",function(s){s.startAngle=0,o()})}}function re(){let t=d3.select(".pbimapd3chartwheelGroup");t.select("path").interrupt(),t.remove(),d3.select(".pbimapOverDiv").remove()}}})();})();
