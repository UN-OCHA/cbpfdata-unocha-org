(()=>{(function(){let Nt=window.navigator.userAgent.indexOf("MSIE")>-1||window.navigator.userAgent.indexOf("Trident")>-1,Bt=window.fetch,Mt=window.URLSearchParams,Ne=window.matchMedia("(pointer: coarse)").matches&&!window.matchMedia("(any-pointer: fine)").matches,Ut=window.location.hostname==="cbpf.data.unocha.org",re=window.location.hostname+window.location.pathname==="cbpf.data.unocha.org/bookmark.html",se="https://use.fontawesome.com/releases/v5.6.3/css/all.css",Ue=["https://cbpfgms.github.io/css/d3chartstyles.css","https://cbpfgms.github.io/css/d3chartstylespbiuac.css",se],mt="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js",ce="https://cbpfgms.github.io/libraries/html2canvas.min.js",de="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js",kt="https://cdn.jsdelivr.net/npm/@ungap/url-search-params@0.1.2/min.min.js",pe="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js",ue="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.4/fetch.min.js";if(Ue.forEach(function(x){if(!ze(x)){let c=document.createElement("link");c.setAttribute("rel","stylesheet"),c.setAttribute("type","text/css"),c.setAttribute("href",x),x===se&&(c.setAttribute("integrity","sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"),c.setAttribute("crossorigin","anonymous")),document.getElementsByTagName("head")[0].appendChild(c)}}),!zt(mt))Bt&&Mt?U(mt,ot):Bt&&!Mt?U(kt,function(){U(mt,ot)}):U(pe,function(){U(ue,function(){U(kt,function(){U(mt,ot)})})});else if(typeof d3<"u")Bt&&Mt?ot():Bt&&!Mt?U(kt,ot):U(pe,function(){U(ue,function(){U(kt,ot)})});else{let x,c=document.getElementsByTagName("script");for(let z=c.length;z--;)c[z].src==mt&&(x=c[z]);x.addEventListener("load",ot)}function U(x,c){let z=document.getElementsByTagName("head")[0],lt=document.createElement("script");lt.type="text/javascript",lt.src=x,lt.onreadystatechange=c,lt.onload=c,z.appendChild(lt)}function ze(x){let c=document.getElementsByTagName("link");for(let z=c.length;z--;)if(c[z].href==x)return!0;return!1}function zt(x){let c=document.getElementsByTagName("script");for(let z=c.length;z--;)if(c[z].src==x)return!0;return!1}function ot(){Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(t){if(this==null)throw new TypeError('"this" is null or not defined');var n=Object(this),a=n.length>>>0;if(typeof t!="function")throw new TypeError("predicate must be a function");for(var e=arguments[1],i=0;i<a;){var l=n[i];if(t.call(e,l,i,n))return l;i++}},configurable:!0,writable:!0}),HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,n,a){var e=this.toDataURL(n,a).split(",")[1];setTimeout(function(){for(var i=atob(e),l=i.length,f=new Uint8Array(l),d=0;d<l;d++)f[d]=i.charCodeAt(d);t(new Blob([f],{type:n||"image/png"}))})}});let x=900,c=[4,16,4,4],z=60,lt=44,Gt=4,jt=2,Et=6,Wt=0,_t=0,Rt=1.5,nt=24,ct=6,dt=420,$t=30,L=12,Xt=4,he=10080*60*1e3,S=[],V="All",Ge=window.innerHeight,H=new Date,qt=H.getFullYear(),je=6e5,Zt=d3.utcFormat("_%Y%m%d_%H%M%S_UTC"),ge=d3.timeParse("%m/%d/%Y %H:%M:%S %p"),Lt=d3.timeFormat("%d %b %Y"),We=d3.format(".3s"),yt=d3.local(),_e="Allocations Timeline",$e="allocations-timeline",Xe="https://cbpf.data.unocha.org/bookmark.html?",qe="https://gms.unocha.org/content/allocations-timeline",N=12,K=1e3,fe="#E56A54",Ze=["#f2f2f2","white"],xt=["#418fde","#eca154"],Ot="#9063CD",Yt="#1F69B3",Je="#F79A3B",Mn=10,me=1,ye=1,at=d3.format(",.0f"),Qe=d3.interpolateRgb(d3.color(xt[0]).brighter(1.2),d3.color(xt[0]).darker(1.2)),Ke=d3.interpolateRgb(d3.color(xt[1]).brighter(1.2),d3.color(xt[1]).darker(1.2)),xe=["standard","reserve"],be=["planned","ongoing","past"],tn=["M83.277,10.493l-13.132,12.22H22.821L9.689,10.493c0,0,6.54-9.154,17.311-10.352c10.547-1.172,14.206,5.293,19.493,5.56 c5.273-0.267,8.945-6.731,19.479-5.56C76.754,1.339,83.277,10.493,83.277,10.493z","M48.297,69.165v9.226c1.399-0.228,2.545-0.768,3.418-1.646c0.885-0.879,1.321-1.908,1.321-3.08 c0-1.055-0.371-1.966-1.113-2.728C51.193,70.168,49.977,69.582,48.297,69.165z","M40.614,57.349c0,0.84,0.299,1.615,0.898,2.324c0.599,0.729,1.504,1.303,2.718,1.745v-8.177 c-1.104,0.306-1.979,0.846-2.633,1.602C40.939,55.61,40.614,56.431,40.614,57.349z","M73.693,30.584H19.276c0,0-26.133,20.567-17.542,58.477c0,0,2.855,10.938,15.996,10.938h57.54 c13.125,0,15.97-10.938,15.97-10.938C99.827,51.151,73.693,30.584,73.693,30.584z M56.832,80.019 c-2.045,1.953-4.89,3.151-8.535,3.594v4.421H44.23v-4.311c-3.232-0.318-5.853-1.334-7.875-3.047 c-2.018-1.699-3.307-4.102-3.864-7.207l7.314-0.651c0.3,1.25,0.856,2.338,1.677,3.256c0.823,0.911,1.741,1.575,2.747,1.979v-9.903 c-3.659-0.879-6.348-2.22-8.053-3.997c-1.716-1.804-2.565-3.958-2.565-6.523c0-2.578,0.96-4.753,2.897-6.511 c1.937-1.751,4.508-2.767,7.721-3.034v-2.344h4.066v2.344c2.969,0.306,5.338,1.159,7.09,2.565c1.758,1.406,2.877,3.3,3.372,5.658 l-7.097,0.774c-0.43-1.849-1.549-3.118-3.365-3.776v9.238c4.485,1.035,7.539,2.357,9.16,3.984c1.634,1.635,2.441,3.725,2.441,6.289 C59.898,75.656,58.876,78.072,56.832,80.019z"],q={},Z={},m={selectedYear:[]},$=500,Jt=320,Qt=54,Kt=maxDate=H,bt,Pt,wt,vt,Tt,Pe,we,ve,Te,te,tt,rt,E,pt=!1,Vt,it=new URLSearchParams(location.search);it.has("viz")||it.append("viz",$e);let C=d3.select("#d3chartcontainerpbiuac"),kn=C.node().getAttribute("data-showhelp")==="true",en=C.node().getAttribute("data-showlink")==="true",De=C.node().getAttribute("data-title")?C.node().getAttribute("data-title"):_e,nn=it.has("year")?it.get("year").replace(/\|/g,","):C.node().getAttribute("data-year"),Se=C.node().getAttribute("data-responsive")==="true",an=C.node().getAttribute("data-lazyload")==="true";Se===!1&&C.style("width",x+"px").style("height",$+"px");let Dt=C.append("div").attr("class","pbiuacTopDiv"),on=Dt.append("div").attr("class","pbiuacTitleDiv"),J=Dt.append("div").attr("class","pbiuacIconsDiv d3chartIconsDiv"),G=C.append("svg").attr("viewBox","0 0 "+x+" "+$).style("background-color","white");Nt&&G.attr("height",$);let ln=C.append("div").attr("class","pbiuacYearsDescriptionDiv"),F=C.append("div").attr("class","pbiuacListContainerDiv");F.style("display","none");let rn=Ut?null:C.append("div").attr("class","pbiuacFooterDiv");Ye(G,x,$,"Loading visualisation...");let ut=C.append("div").attr("id","pbiuacSnapshotTooltip").attr("class","pbiuacSnapshotContent").style("display","none").on("mouseleave",function(){pt=!1,ut.style("display","none"),B.style("display","none")});ut.append("p").attr("id","pbiuacSnapshotTooltipPdfText").html("Download PDF").on("click",function(){pt=!1,It("pdf",!0)}),ut.append("p").attr("id","pbiuacSnapshotTooltipPngText").html("Download Image (PNG)").on("click",function(){pt=!1,It("png",!0)});let Ae=!Ne&&(window.safari||window.navigator.userAgent.indexOf("Edge")>-1);Ae&&ut.append("p").attr("id","pbiuacTooltipBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default");let B=C.append("div").attr("id","pbiuactooltipdiv").style("display","none");C.on("contextmenu",function(){d3.event.preventDefault();let t=d3.mouse(this);pt=!0,ut.style("display","block").style("top",t[1]-4+"px").style("left",t[0]-4+"px")});let r={main:G.append("g").attr("class","pbiuacTopPanel").attr("transform","translate("+c[3]+","+c[0]+")"),width:x-c[1]-c[3],height:z,padding:[0,0,0,0],moneyBagPadding:32,leftPadding:[182,424,562,740],mainValueVerPadding:10,mainValueHorPadding:2},g={main:G.append("g").attr("class","pbiuacbuttonsPanel").attr("transform","translate("+c[3]+","+(c[0]+r.height+N)+")"),width:x-c[1]-c[3],height:$t,padding:[0,0,0,102],buttonWidth:52,buttonAggregationWidth:158,buttonsMargin:4,buttonVerticalPadding:4,arrowPadding:18},h={main:G.append("g").attr("class","pbiuacBrushPanel").attr("transform","translate("+c[3]+","+(c[0]+r.height+g.height+2*N)+")"),width:x-c[1]-c[3],height:Qt,padding:[14,0,10,130]},s={main:G.append("g").attr("class","pbiuacMainPanel").attr("transform","translate("+c[3]+","+(c[0]+r.height+g.height+h.height+3*N)+")"),width:x-c[1]-c[3],height:Jt,padding:[14,0,0,130]},O={main:G.append("g").attr("class","pbiuacLegendPanel").attr("transform","translate("+c[3]+","+(c[0]+r.height+g.height+h.height+s.height+4*N)+")"),width:x-c[1]-c[3],height:lt,padding:[0,0,0,102]},Q=d3.scaleOrdinal(),Ce=d3.scaleOrdinal(),T=d3.scaleTime().range([s.padding[3],s.width-s.padding[1]]),I=d3.scaleTime().range([h.padding[3],h.width-h.padding[1]]),ee=d3.range(0,1.25,.25).map(function(t){return Qe(t)}),ne=d3.range(0,1.25,.25).map(function(t){return Ke(t)}),ht=d3.scaleQuantile().range(ee),gt=d3.scaleQuantile().range(ne),st=d3.scalePoint().domain(xe).range([O.padding[0],O.height-O.padding[2]]).padding(.75),sn=d3.axisLeft(Q).tickSize(3),St=d3.axisTop(T),ae=d3.axisTop(I).tickPadding(2).tickSize(2).tickSizeOuter(0),cn=s.main.append("defs").append("clipPath").attr("id","pbiuacclip").append("rect").attr("x",s.padding[3]).attr("y",0).attr("width",s.width-s.padding[3]-s.padding[1]),ft=d3.brushX().on("brush",ke).on("end",function(){d3.event.selection||(ke(),h.main.select(".pbiuacBrushGroup").call(ft.move,I.range()))}),At=d3.zoom().scaleExtent([1,1/0]).on("zoom",fn);if(zt(ce)||U(ce,null),zt(de)||U(de,null),Ut&&!re)window.cbpfbiDataObject.launchedAllocationsData.then(t=>{let n=t.reduce((a,e)=>{if(e.PlannedStartDate&&e.PlannedEndDate){let i=oe(e);i&&a.push(i)}return a},[]);ie(n)});else if(localStorage.getItem("launchedAllocationsData")&&JSON.parse(localStorage.getItem("launchedAllocationsData")).timestamp>H.getTime()-je){let t=d3.csvParse(JSON.parse(localStorage.getItem("launchedAllocationsData")).data,oe);console.info("pbiuac: data from local storage"),ie(t)}else d3.csv("https://cbpfapi.unocha.org/vo2/odata/AllocationTypes?$format=csv&ShowAllPooledFunds=1",oe).then(function(t){try{localStorage.setItem("launchedAllocationsData",JSON.stringify({data:d3.csvFormat(t),timestamp:H.getTime()}))}catch(n){console.info("D3 chart pbiuac, "+n)}console.info("pbiuac: data from API"),ie(t)});function ie(t){mn(t),le();let n=yn(t);bn(),Cn(nn),Q.domain(bt).range(Le(s,Et,Gt,jt)),Ce.domain(bt).range(Le(h,Rt,Wt,_t)),T.domain([Pt,wt]),I.domain([Pt,wt]),At.scaleExtent([1,(T.domain()[1]-T.domain()[0])/he]),an?(d3.select(window).on("scroll.pbiuac",a),d3.select("body").on("d3ChartsYear.pbiuac",function(){m.selectedYear=[Fe(+d3.event.detail)]}),a()):Be(n);function a(){let e=C.node().getBoundingClientRect();e.bottom<0||e.top-Ge>0||(d3.select(window).on("scroll.pbiuac",null),Be(n))}}function Be(t){te=t,Ee(t),gn(),Re(t),dn(t),Ft(t),pn(t),un(t),hn(t),Me(),Ie(),Ut||Tn()}function dn(t){let n=on.append("p").attr("id","pbiuacd3chartTitle").html(De),a=J.append("button").attr("id","pbiuacHelpButton");a.html("HELP  ").append("span").attr("class","fas fa-info");let e=J.append("button").attr("id","pbiuacDownloadButton");e.html(".CSV  ").append("span").attr("class","fas fa-download");let i=J.append("div").attr("class","pbiuacSnapshotDiv");i.append("button").attr("id","pbiuacSnapshotButton").html("IMAGE ").append("span").attr("class","fas fa-camera");let f=i.append("div").attr("class","pbiuacSnapshotContent"),d=f.append("p").attr("id","pbiuacSnapshotPdfText").html("Download PDF").on("click",function(){It("pdf",!1)}),D=f.append("p").attr("id","pbiuacSnapshotPngText").html("Download Image (PNG)").on("click",function(){It("png",!1)}),w=J.append("button").datum({clicked:!1}).attr("id","pbiuacPlayButton");if(w.html("PLAY  ").append("span").attr("class","fas fa-play"),w.on("click",function(p){p.clicked=!p.clicked,w.html(p.clicked?"PAUSE ":"PLAY  ").append("span").attr("class",p.clicked?"fas fa-pause":"fas fa-play"),p.clicked?(m.selectedYear.length=1,u(),timer=d3.interval(u,3*K)):timer.stop();function u(){let A=S.indexOf(m.selectedYear[0]);m.selectedYear[0]=S[(A+1)%S.length],d3.selectAll(".pbiuacbuttonsRects").filter(function(P){return P===m.selectedYear[0]}).dispatch("click");let y=m.selectedYear[0]<S[L/2]?0:m.selectedYear[0]>S[S.length-L/2]||m.selectedYear[0]===V?S.length-L:S.indexOf(m.selectedYear[0])-L/2}}),!re){let p=J.append("button").attr("id","pbiuacShareButton");p.html("SHARE  ").append("span").attr("class","fas fa-share");let u=C.append("div").attr("class","d3chartShareDiv").style("display","none");p.on("mouseover",function(){u.html("Click to copy").style("display","block");let A=this.getBoundingClientRect(),o=C.node().getBoundingClientRect(),y=u.node().getBoundingClientRect(),P=A.top-o.top-(y.height-A.height)/2,Y=A.left-o.left-y.width-12;u.style("top",P+"px").style("left",Y+"20px")}).on("mouseout",function(){u.style("display","none")}).on("click",function(){let A=Xe+it.toString();u.append("input").attr("type","text").attr("readonly",!0).attr("spellcheck","false").property("value",A).node().select(),document.execCommand("copy"),u.html("Copied!");let y=this.getBoundingClientRect(),P=C.node().getBoundingClientRect(),Y=u.node().getBoundingClientRect(),X=y.left-P.left-Y.width-12;u.style("left",X+"20px")})}if(Ae){let p=f.append("p").attr("id","pbiuacBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default")}i.on("mouseover",function(){f.style("display","block")}).on("mouseout",function(){f.style("display","none")}),a.on("click",vn),e.on("click",function(){let p=wn(t),A="AllocationsTimeline_"+Zt(new Date)+".csv",o=new Blob([p],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(o,filename);else{let y=document.createElement("a");if(y.download!==void 0){let P=URL.createObjectURL(o);y.setAttribute("href",P),y.setAttribute("download",A),y.style="visibility:hidden",document.body.appendChild(y),y.click(),document.body.removeChild(y)}}})}function Ft(t){let n=t.filter(function(M){return M.PlannedStartDateTimestamp<T.domain()[1].getTime()&&M.PlannedEndDateTimestamp>T.domain()[0].getTime()&&(m.selectedYear[0]===V?!0:m.selectedYear.indexOf(+M.AllocationYear)>-1)}),a=d3.sum(n,function(M){return M.TotalUSDPlanned}),e=n.filter(function(M){return M.timeLine==="planned"}).length,i=n.filter(function(M){return M.timeLine==="ongoing"}).length,l=n.filter(function(M){return M.timeLine==="past"}).length,f=r.main.selectAll(".pbiuactopPanelMoneyBag").data([!0]).enter().append("g").attr("class","pbiuactopPanelMoneyBag contributionColorFill").attr("transform","translate("+r.moneyBagPadding+",6) scale(0.5)").each(function(M,_,j){tn.forEach(function(et){d3.select(j[_]).append("path").attr("d",et)})}),d=d3.select(".pbiuactopPanelMainValue").size()!==0?d3.select(".pbiuactopPanelMainValue").datum():0,D=d3.select(".pbiuactopPanelUpcomingNumber").size()!==0?d3.select(".pbiuactopPanelUpcomingNumber").datum():0,w=d3.select(".pbiuactopPanelOngoingNumber").size()!==0?d3.select(".pbiuactopPanelOngoingNumber").datum():0,p=d3.select(".pbiuactopPanelPastNumber").size()!==0?d3.select(".pbiuactopPanelPastNumber").datum():0,u=r.main.selectAll(".pbiuacmainValueGroup").data([!0]);u=u.enter().append("g").attr("class","pbiuacmainValueGroup").merge(u);let A=u.selectAll(".pbiuactopPanelMainValue").data([a]);A=A.enter().append("text").attr("class","pbiuactopPanelMainValue contributionColorFill").attr("text-anchor","end").merge(A).attr("y",r.height-r.mainValueVerPadding).attr("x",r.moneyBagPadding+r.leftPadding[0]-r.mainValueHorPadding),A.transition().duration(K).tween("text",function(M){let _=this,j=d3.interpolate(d,M);return function(et){let He=Ve(j(et));_.textContent="$"+(M<1e3?M:He.substring(0,He.length-1))}});let o=u.selectAll(".pbiuactopPanelMainText").data([a]);o=o.enter().append("text").attr("class","pbiuactopPanelMainText").style("opacity",0).attr("text-anchor","start").merge(o).attr("y",r.height-r.mainValueVerPadding*3).attr("x",r.moneyBagPadding+r.leftPadding[0]+r.mainValueHorPadding),o.transition().duration(K).style("opacity",1).text(function(M){let _=Ve(M),j=_[_.length-1];return(j==="k"?"Thousand":j==="M"?"Million":j==="G"?"Billion":"")+" in launched"});let y=u.selectAll(".pbiuactopPanelSubText").data([!0]);y=y.enter().append("text").attr("class","pbiuactopPanelSubText").style("opacity",0).attr("text-anchor","start").merge(y).attr("y",r.height-r.mainValueVerPadding*1.2).attr("x",r.moneyBagPadding+r.leftPadding[0]+r.mainValueHorPadding),y.transition().duration(K).style("opacity",1).text("Allocations for "+(m.selectedYear.length===1?m.selectedYear[0]===V?"all years":m.selectedYear[0]:"years*"));let P=u.selectAll(".pbiuactopPanelUpcomingNumber").data([e]);P=P.enter().append("text").attr("class","pbiuactopPanelUpcomingNumber contributionColorFill").attr("text-anchor","end").merge(P).attr("y",r.height-r.mainValueVerPadding).attr("x",r.moneyBagPadding+r.leftPadding[1]-r.mainValueHorPadding),P.transition().duration(K).tween("text",function(M){let _=this,j=d3.interpolate(D,M);return function(et){_.textContent=~~j(et)}});let Y=u.selectAll(".pbiuactopPanelUpcomingText").data([!0]);Y=Y.enter().append("text").attr("class","pbiuactopPanelUpcomingText").attr("x",r.moneyBagPadding+r.leftPadding[1]+r.mainValueHorPadding).attr("text-anchor","start").merge(Y).attr("y",r.height-r.mainValueVerPadding*3).text("Planned");let X=u.selectAll(".pbiuactopPanelUpcomingTextSubText").data([!0]);X=X.enter().append("text").attr("class","pbiuactopPanelUpcomingTextSubText").attr("y",r.height-r.mainValueVerPadding*1.2).attr("x",r.moneyBagPadding+r.leftPadding[1]+r.mainValueHorPadding).attr("text-anchor","start").merge(X).text(e>1?"Allocations":"Allocation");let W=u.selectAll(".pbiuactopPanelOngoingNumber").data([i]);W=W.enter().append("text").attr("class","pbiuactopPanelOngoingNumber contributionColorFill").attr("text-anchor","end").merge(W).attr("y",r.height-r.mainValueVerPadding).attr("x",r.moneyBagPadding+r.leftPadding[2]-r.mainValueHorPadding),W.transition().duration(K).tween("text",function(M){let _=this,j=d3.interpolate(w,M);return function(et){_.textContent=~~j(et)}});let b=u.selectAll(".pbiuactopPanelOngoingText").data([!0]);b=b.enter().append("text").attr("class","pbiuactopPanelOngoingText").attr("x",r.moneyBagPadding+r.leftPadding[2]+r.mainValueHorPadding).attr("text-anchor","start").merge(b).attr("y",r.height-r.mainValueVerPadding*3).text("Ongoing");let k=u.selectAll(".pbiuactopPanelOngoingTextSubText").data([!0]);k=k.enter().append("text").attr("class","pbiuactopPanelOngoingTextSubText").attr("y",r.height-r.mainValueVerPadding*1.2).attr("x",r.moneyBagPadding+r.leftPadding[2]+r.mainValueHorPadding).attr("text-anchor","start").merge(k).text(i>1?"Allocations":"Allocation");let R=u.selectAll(".pbiuactopPanelPastNumber").data([l]);R=R.enter().append("text").attr("class","pbiuactopPanelPastNumber contributionColorFill").attr("text-anchor","end").merge(R).attr("y",r.height-r.mainValueVerPadding).attr("x",r.moneyBagPadding+r.leftPadding[3]-r.mainValueHorPadding),R.transition().duration(K).tween("text",function(M){let _=this,j=d3.interpolate(p,M);return function(et){_.textContent=~~j(et)}});let v=u.selectAll(".pbiuactopPanelPastText").data([!0]);v=v.enter().append("text").attr("class","pbiuactopPanelPastText").attr("x",r.moneyBagPadding+r.leftPadding[3]+r.mainValueHorPadding).attr("text-anchor","start").merge(v).attr("y",r.height-r.mainValueVerPadding*3).text("Closed");let Ct=u.selectAll(".pbiuactopPanelPastTextSubText").data([!0]);Ct=Ct.enter().append("text").attr("class","pbiuactopPanelPastTextSubText").attr("y",r.height-r.mainValueVerPadding*1.2).attr("x",r.moneyBagPadding+r.leftPadding[3]+r.mainValueHorPadding).attr("text-anchor","start").merge(Ct).text(l>1?"Allocations":"Allocation")}function pn(t){let n=g.main.append("clipPath").attr("id","pbiuacclipButtons").append("rect").attr("width",L*g.buttonWidth).attr("height",g.height),a=S.length>L?g.arrowPadding:-2,i=g.main.append("g").attr("class","pbiuacClipPathGroup").attr("transform","translate("+(g.padding[3]+a)+",0)").attr("clip-path","url(#pbiuacclipButtons)").append("g").attr("class","pbiuacbuttonsGroup").attr("transform","translate(0,0)").style("cursor","pointer"),l=i.selectAll(null).data(S).enter().append("rect").attr("rx","2px").attr("ry","2px").attr("class","pbiuacbuttonsRects").attr("width",g.buttonWidth-g.buttonsMargin).attr("height",g.height-g.buttonVerticalPadding*2).attr("y",g.buttonVerticalPadding).attr("x",function(b,k){return k*g.buttonWidth+g.buttonsMargin/2}).style("fill",function(b){return m.selectedYear.indexOf(b)>-1?Yt:"#eaeaea"}),f=i.selectAll(null).data(S).enter().append("text").attr("text-anchor","middle").attr("class","pbiuacbuttonsText").attr("y",g.height/1.6).attr("x",function(b,k){return k*g.buttonWidth+g.buttonWidth/2}).style("fill",function(b){return m.selectedYear.indexOf(b)>-1?"white":"#444"}).text(function(b){return b}),d=g.main.append("g").attr("class","pbiuacLeftArrowGroup").style("opacity",0).attr("pointer-events","none").style("cursor","pointer").attr("transform","translate("+g.padding[3]+",0)"),D=d.append("rect").style("fill","white").attr("width",g.arrowPadding).attr("height",g.height),w=d.append("text").attr("class","pbiuacleftArrowText").attr("x",0).attr("y",g.height-g.buttonVerticalPadding*2.1).style("fill","#666").text("\u25C4"),p=g.main.append("g").attr("class","pbiuacRightArrowGroup").style("opacity",0).attr("pointer-events","none").style("cursor","pointer").attr("transform","translate("+(g.padding[3]+g.arrowPadding+L*g.buttonWidth)+",0)"),u=p.append("rect").style("fill","white").attr("width",g.arrowPadding).attr("height",g.height),A=p.append("text").attr("class","pbiuacrightArrowText").attr("x",-1).attr("y",g.height-g.buttonVerticalPadding*2.1).style("fill","#666").text("\u25BA");l.on("mouseover",Y).on("mouseout",X).on("click",function(b){let k=this;if(d3.event.altKey){W(b,!1);return}yt.get(this)!=="clicked"?(yt.set(this,"clicked"),setTimeout(function(){yt.get(k)==="clicked"&&W(b,!0),yt.set(k,null)},250)):(W(b,!1),yt.set(this,null))}),d3.select("body").on("d3ChartsYear.pbiuac",function(){W(Fe(+d3.event.detail),!0),S.length>L&&(P(),o())}),S.length>L&&(p.style("opacity",1).attr("pointer-events","all"),d.style("opacity",1).attr("pointer-events","all"),P(),y(),d.on("click",function(){d.attr("pointer-events","none");let b=Ht(i.attr("transform"))[0];p.select("text").style("fill","#666"),p.attr("pointer-events","all"),i.transition().duration(K).attr("transform","translate("+Math.min(0,b+L*g.buttonWidth)+",0)").on("end",o)}),p.on("click",function(){p.attr("pointer-events","none");let b=Ht(i.attr("transform"))[0];d.select("text").style("fill","#666"),d.attr("pointer-events","all"),i.transition().duration(K).attr("transform","translate("+Math.max(-((S.length-L)*g.buttonWidth),-(Math.abs(b)+L*g.buttonWidth))+",0)").on("end",o)}));function o(){let b=Ht(i.attr("transform"))[0];b===0?(d.select("text").style("fill","#ccc"),d.attr("pointer-events","none")):(d.select("text").style("fill","#666"),d.attr("pointer-events","all")),Math.abs(b)>=(S.length-L)*g.buttonWidth?(p.select("text").style("fill","#ccc"),p.attr("pointer-events","none")):(p.select("text").style("fill","#666"),p.attr("pointer-events","all"))}function y(){let b=Ht(i.attr("transform"))[0];b===0&&(d.select("text").style("fill","#ccc"),d.attr("pointer-events","none")),Math.abs(b)>=(S.length-L)*g.buttonWidth&&(p.select("text").style("fill","#ccc"),p.attr("pointer-events","none"))}function P(){let b=S.indexOf(m.selectedYear[0])<L/2?0:S.indexOf(m.selectedYear[0])>S.length-L/2?Math.max(S.length-L,0):S.indexOf(S.indexOf(m.selectedYear[0]))-L/2;i.attr("transform","translate("+-(g.buttonWidth*b)+",0)")}function Y(b){B.style("display","block").html(null),B.append("div").style("max-width","200px").attr("id","pbiuacInnerTooltipDiv").html("Click for selecting a single year. Double-click or ALT + click for selecting multiple years.");let R=C.node().getBoundingClientRect(),v=this.getBoundingClientRect();E=B.node().getBoundingClientRect(),B.style("left",v.left+v.width/2-R.left>R.width-E.width/2-c[1]?R.width-E.width-c[1]+"px":v.left+v.width/2-R.left<E.width/2+c[0]?c[0]+"px":v.left+v.width/2-R.left-E.width/2+"px").style("top",v.top+v.height/2-R.top<E.height?v.top-R.top+v.height+2+"px":v.top-R.top-E.height-4+"px"),d3.select(this).style("fill",Yt),f.filter(function(Ct){return Ct===b}).style("fill","white")}function X(b){B.style("display","none"),!(m.selectedYear.indexOf(b)>-1)&&(d3.select(this).style("fill","#eaeaea"),f.filter(function(k){return k===b}).style("fill","#444"))}function W(b,k){if(B.style("display","none"),k||b===V||m.selectedYear[0]===V)m.selectedYear=[b];else{let v=m.selectedYear.indexOf(b);if(v>-1){if(m.selectedYear.length===1)return;m.selectedYear.splice(v,1)}else m.selectedYear.push(b)}let R=m.selectedYear[0]===V?V:m.selectedYear.map(function(v){return v}).join("|");it.has("year")?it.set("year",R):it.append("year",R),d3.selectAll(".pbiuacbuttonsRects").style("fill",function(v){return m.selectedYear.indexOf(v)>-1?Yt:"#eaeaea"}),d3.selectAll(".pbiuacbuttonsText").style("fill",function(v){return m.selectedYear.indexOf(v)>-1?"white":"#444"}),Ie(),Ee(t),Ft(t),Re(t),Me(),T.domain([vt,Tt]),At.scaleExtent([1,(T.domain()[1]-T.domain()[0])/he]),h.main.select(".pbiuacBrushGroup").call(ft.move,[I(vt),I(Tt)])}}function un(t){let n=s.main.selectAll(null).data(bt).enter().append("rect").attr("x",s.padding[3]).attr("width",s.width-s.padding[1]-s.padding[3]).attr("y",function(o){return Q(o)}).attr("height",function(o,y){return Q.range()[y+1]-Q(o)}).style("fill",function(o,y){return Ze[y%2]}),a=s.main.append("g").attr("class","pbiuacYAxisGroup").attr("transform","translate("+s.padding[3]+",0)").call(sn);a.selectAll("text").each(function(o,y){d3.select(this).attr("transform","translate(0,"+(Q.range()[y+1]-Q(o))/2+")")}),a.selectAll("line").each(function(o,y){d3.select(this).attr("transform","translate(0,"+(Q.range()[y+1]-Q(o))/2+")")});let e=s.main.append("g").attr("class","pbiuacXAxisMainGroup").attr("transform","translate(0,"+s.padding[0]+")").call(St),l=s.main.append("g").attr("clip-path","url(#pbiuacclip)").append("g").attr("class","pbiuacTodayGroup").attr("transform","translate("+T(H)+",0)"),f=l.append("line").attr("y1",s.padding[0]).attr("y2",s.height-s.padding[2]).style("stroke",Ot).style("stroke-width","1px").style("opacity",.75),d=l.append("text").attr("class","pbiuacTodayText").attr("text-anchor","middle").attr("font-family","Arial").attr("font-size","11px").style("font-weight",700).style("fill",Ot).attr("y",s.padding[0]-St.tickPadding()).text("Today"),D=s.main.append("rect").attr("class","pbiuacZoomRect").style("fill","none").attr("cursor","move").attr("pointer-events","all").attr("x",s.padding[3]-1).attr("y",s.padding[0]).attr("width",s.width-s.padding[3]-s.padding[1]+2).attr("height",s.height).call(At),w=s.main.selectAll(null).data(t).enter().append("rect").attr("class","pbiuacAllocationsMain").attr("rx",2).attr("ry",2).attr("x",function(o){return T(o.PlannedStartDate)}).attr("width",function(o){return Math.max(Xt,T(o.PlannedEndDate)-T(o.PlannedStartDate))}).attr("y",function(o){return Q(o.PooledFundName)+Gt/2+o.row*Et+(o.row+1)*jt}).attr("height",Et).style("fill",function(o){return o.allocationType==="standard"?ht(o.TotalUSDPlanned):gt(o.TotalUSDPlanned)}).style("stroke","#666").style("stroke-width","1px").attr("clip-path","url(#pbiuacclip)").on("mouseover",function(o){p(o,this)}).on("mousemove",function(o){u(o,this)});D.on("mouseover",A);function p(o,y){B.html(null),tt=C.node().getBoundingClientRect(),rt=y.getBoundingClientRect();let P=d3.mouse(s.main.node()),Y=B.append("div").attr("id","pbiuacInnerTooltipDiv"),X=o.allocationType==="standard"?"contributionColorHTMLcolor":"allocationColorHTMLcolor";Y.html("<div class='pbiuactooltipTitleDiv'><div class='"+X+"'><b>"+o.AllocationTitle+"</b></div><div class='pbiuaccloseDiv'><span class='fas fa-times'></span></div></div><div class='pbiuacSpacer'></div>CBPF: <b>"+o.PooledFundName+"</b><br>Amount: $<b>"+at(o.TotalUSDPlanned)+"</b><div class='pbiuacSpacer'></div>Start Date: "+Lt(o.PlannedStartDate)+"<br>End Date: "+Lt(o.PlannedEndDate)+"<div class='pbiuacSpacer'></div><div class='pbiuacTooltipButtonDiv' style='height:30px;display:flex;justify-content:center;align-items:center;'><button>Display Details</button></div>"),B.select("button").on("click",function(){B.style("display","none"),Pn(o)}),B.select(".pbiuaccloseDiv").on("click",function(){B.html(null).style("display","none")}),B.style("display","block"),E=B.node().getBoundingClientRect(),B.style("left",P[0]>tt.width-E.width/2-c[1]?tt.width-E.width-c[1]+"px":P[0]<E.width/2+s.padding[3]+c[0]?s.padding[3]+c[0]+"px":P[0]-E.width/2+"px").style("top",P[1]<E.height?rt.top-tt.top+rt.height+1+"px":rt.top-tt.top-E.height+"px")}function u(o,y){let P=d3.mouse(s.main.node());B.style("left",P[0]>tt.width-E.width/2-c[1]?tt.width-E.width-c[1]+"px":P[0]<E.width/2+s.padding[3]+c[0]?s.padding[3]+c[0]+"px":P[0]-E.width/2+"px").style("top",P[1]<E.height?rt.top-tt.top+rt.height+1+"px":rt.top-tt.top-E.height+"px")}function A(){pt||B.style("display","none")}}function hn(t){let n=h.main.append("g").attr("class","pbiuacXAxisBrushGroup").attr("transform","translate(0,"+h.padding[0]+")").call(ae),a=h.main.append("g").attr("transform","translate("+I(H)+",0)"),e=a.append("line").attr("y1",h.padding[0]).attr("y2",h.height-h.padding[2]).style("stroke",Ot).style("stroke-width","1px"),l=a.append("text").attr("text-anchor","middle").attr("font-family","Arial").attr("font-size","11px").style("font-weight",700).style("fill",Ot).attr("y",h.padding[0]-ae.tickPadding()-ae.tickSizeInner()).text("Today").node().getBoundingClientRect();n.selectAll("text").each(function(){let p=this.getBoundingClientRect();if(p.left<l.right&&p.right>l.left){d3.select(this.parentNode).remove();return}let u=this.textContent;+u==+u&&d3.select(this).style("fill",fe).style("font-weight",700)});let f=h.main.selectAll(null).data(t).enter().append("rect").attr("class","pbiuacAllocationsBrush").attr("rx",1).attr("ry",1).attr("x",function(p){return I(p.PlannedStartDate)}).attr("width",function(p){return I(p.PlannedEndDate)-I(p.PlannedStartDate)}).attr("y",function(p){return Ce(p.PooledFundName)+Wt/2+p.row*Rt+(p.row+1)*_t}).attr("height",Rt).style("fill",function(p){return p.allocationType==="standard"?ht(p.TotalUSDPlanned):gt(p.TotalUSDPlanned)});h.main.append("g").attr("class","pbiuacBrushGroup").call(ft).call(ft.move,[Math.max(I.range()[0],T(vt)),Math.min(I.range()[1],T(Tt))]).selectAll(".handle").attr("fill","whitesmoke").attr("stroke","#222").attr("stroke-width",1).attr("rx",2).attr("ry",2).style("y",h.padding[0]+(h.height-h.padding[2]-h.padding[0])*.2).style("height",(h.height-h.padding[2]-h.padding[0])*.6);let D=h.main.append("text").attr("text-anchor","end").attr("class","pbiuacBrushText").attr("x",h.padding[3]-26).attr("y",h.padding[0]+21).text("Select").append("tspan").attr("dy","0.5em").attr("x",h.padding[3]-10).text("\u2192").append("tspan").attr("x",h.padding[3]-26).attr("dy","0.5em").text("period"),w=h.main.append("line").attr("x1",h.padding[3]).attr("x2",h.width-h.padding[1]).attr("y1",h.height).attr("y2",h.height).style("stroke","#aaa").style("stroke-width","2px").style("stroke-linecap","round")}function Me(t){s.main.selectAll(".pbiuacAllocationsMain").style("fill",function(n){return n.allocationType==="standard"?ht(n.TotalUSDPlanned):gt(n.TotalUSDPlanned)}).style("display",function(n){return m.selectedYear.indexOf(+n.AllocationYear)>-1||m.selectedYear[0]===V?null:"none"}),h.main.selectAll(".pbiuacAllocationsBrush").style("fill",function(n){return n.allocationType==="standard"?ht(n.TotalUSDPlanned):gt(n.TotalUSDPlanned)}).style("display",function(n){return m.selectedYear.indexOf(+n.AllocationYear)>-1||m.selectedYear[0]===V?null:"none"})}function gn(){let t=O.main.selectAll(null).data(xe).enter().append("g").attr("class","pbiuacLegendGroups").attr("transform",function(d){return"translate(0,"+st(d)+")"}),n=t.append("rect").attr("x",O.padding[3]).attr("width",nt).attr("y",-ct/2).attr("height",ct).attr("rx",2).attr("ry",2).style("stroke","#666").style("stroke-width","1px").style("fill",function(d,D){return xt[D]}),a=t.append("text").attr("class","pbiuacLegendMainText").attr("x",O.padding[3]+nt+6).attr("y",4).text(function(d,D){return D?"Reserve Allocations \u2192":"Standard Allocations \u2192"}),e=O.main.selectAll(null).data(ee).enter().append("rect").attr("y",st("standard")-ct/2).attr("x",function(d,D){return dt+D*nt}).attr("width",nt).attr("height",ct).attr("rx",2).attr("ry",2).style("stroke","#666").style("stroke-width","1px").style("fill",function(d){return d}).on("mouseover",function(d){l(d,ht,this,"Standard")}).on("mouseout",f),i=O.main.selectAll(null).data(ne).enter().append("rect").attr("y",st("reserve")-ct/2).attr("x",function(d,D){return dt+D*nt}).attr("width",nt).attr("height",ct).attr("rx",2).attr("ry",2).style("stroke","#666").style("stroke-width","1px").style("fill",function(d){return d}).on("mouseover",function(d){l(d,gt,this,"Reserve")}).on("mouseout",f);Pe=O.main.append("text").attr("class","pbiuacLegendMainText2").attr("y",st("standard")+3).attr("x",dt-4).attr("text-anchor","end"),we=O.main.append("text").attr("class","pbiuacLegendMainText2").attr("y",st("standard")+3).attr("x",dt+ee.length*nt+4).attr("text-anchor","start"),ve=O.main.append("text").attr("class","pbiuacLegendMainText2").attr("y",st("reserve")+3).attr("x",dt-4).attr("text-anchor","end"),Te=O.main.append("text").attr("class","pbiuacLegendMainText2").attr("y",st("reserve")+3).attr("x",dt+ne.length*nt+4).attr("text-anchor","start"),t.on("mouseover",function(d){s.main.selectAll(".pbiuacAllocationsMain").style("opacity",function(D){return D.AllocationSource===d[0].toUpperCase()+d.substring(1)?1:.1})}).on("mouseout",function(){s.main.selectAll(".pbiuacAllocationsMain").style("opacity",1)});function l(d,D,w,p){Vt=w,B.html(null);let u=C.node().getBoundingClientRect(),A=w.getBoundingClientRect(),o=D.invertExtent(d);s.main.selectAll(".pbiuacAllocationsMain").style("opacity",function(Y){return Y.TotalUSDPlanned>=o[0]&&Y.TotalUSDPlanned<=o[1]&&Y.AllocationSource===p?1:.1}),B.append("div").attr("id","pbiuacInnerTooltipDiv").html("This color represents values going from:<br><div style='margin-top:8px;text-align:center;'>$<strong>"+at(o[0])+"</strong> to $<strong>"+at(o[1])+"</strong></div>"),B.style("display","block");let P=B.node().getBoundingClientRect();B.style("left",A.left-u.left-P.width/2+A.width/2+"px").style("top",A.y-u.y-P.height-1+"px")}function f(){pt||(Vt=null,s.main.selectAll(".pbiuacAllocationsMain").style("opacity",1),B.style("display","none"))}}function ke(){if(d3.event.sourceEvent&&d3.event.sourceEvent.type==="zoom")return;let t=d3.event.selection||I.range();T.domain(t.map(I.invert,I));let n=d3.timeDay.count(H,T.domain()[0])*-1,a=d3.timeDay.count(H,T.domain()[1]);s.main.selectAll(".pbiuacAllocationsMain").attr("x",function(e){return T(e.PlannedStartDate)}).attr("width",function(e){return Math.max(Xt,T(e.PlannedEndDate)-T(e.PlannedStartDate))}),s.main.select(".pbiuacTodayGroup").attr("transform","translate("+T(H)+",0)"),s.main.select(".pbiuacXAxisMainGroup").call(St),Oe(),Ft(te),s.main.select(".pbiuacZoomRect").call(At.transform,d3.zoomIdentity.scale((s.width-s.padding[3]-s.padding[1])/(t[1]-t[0])).translate(-t[0],0))}function fn(){if(d3.event.sourceEvent&&d3.event.sourceEvent.type==="brush")return;let t=d3.event.transform;T.domain(t.rescaleX(I).domain());let n=d3.timeDay.count(H,T.domain()[0])*-1,a=d3.timeDay.count(H,T.domain()[1]);s.main.selectAll(".pbiuacAllocationsMain").attr("x",function(e){return T(e.PlannedStartDate)}).attr("width",function(e){return Math.max(Xt,T(e.PlannedEndDate)-T(e.PlannedStartDate))}),s.main.select(".pbiuacTodayGroup").attr("transform","translate("+T(H)+",0)"),s.main.select(".pbiuacXAxisMainGroup").call(St),Oe(),Ft(te),h.main.select(".pbiuacBrushGroup").call(ft.move,T.range().map(t.invertX,t))}function mn(t){t.forEach(function(n){S.indexOf(+n.AllocationYear)===-1&&S.push(+n.AllocationYear)}),S.sort(function(n,a){return n-a}),S.push(V)}function Ee(t){if(m.selectedYear[0]===V)vt=Pt,Tt=wt;else{let n=wt,a=Pt;t.forEach(function(e){m.selectedYear.indexOf(+e.AllocationYear)>-1&&(n.getTime()>e.PlannedStartDateTimestamp&&(n=e.PlannedStartDate),a.getTime()<e.PlannedEndDateTimestamp&&(a=e.PlannedEndDate))}),vt=d3.timeMonth.offset(n,-me),Tt=d3.timeMonth.offset(a,ye)}}function Re(t){let n=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,e=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,l=t.reduce(function(f,d){return(m.selectedYear[0]===V||m.selectedYear.indexOf(+d.AllocationYear)>-1)&&(f[d.AllocationSource.toLowerCase()].push(+d.TotalUSDPlanned),d.allocationType==="standard"?(+d.TotalUSDPlanned<n&&(n=+d.TotalUSDPlanned),+d.TotalUSDPlanned>a&&(a=+d.TotalUSDPlanned)):(+d.TotalUSDPlanned<e&&(e=+d.TotalUSDPlanned),+d.TotalUSDPlanned>i&&(i=+d.TotalUSDPlanned))),f},{standard:[],reserve:[]});l.standard.sort(function(f,d){return f-d}),l.reserve.sort(function(f,d){return f-d}),ht.domain(l.standard),gt.domain(l.reserve),Pe.text("Minimum Amount: $"+at(n)),we.text("Maximum Amount: $"+at(a)),ve.text("Minimum Amount: $"+at(e)),Te.text("Maximum Amount: $"+at(i))}function yn(t){t.forEach(function(i){let l=i.PlannedEndDateTimestamp<H.getTime()?"past":i.PlannedStartDateTimestamp>H.getTime()?"planned":"ongoing";i.timeLine=l,i.allocationType=i.AllocationSource.toLowerCase(),(q[i.PooledFundName]===void 0||be.indexOf(q[i.PooledFundName])>be.indexOf(l))&&(q[i.PooledFundName]=l),Kt.getTime()>i.PlannedStartDateTimestamp&&(Kt=i.PlannedStartDate),maxDate.getTime()<i.PlannedEndDateTimestamp&&(maxDate=i.PlannedEndDate)});let n=Object.keys(q).filter(function(i){return q[i]==="planned"}).sort(function(i,l){return i.toLowerCase()<l.toLowerCase()?-1:i.toLowerCase()>l.toLowerCase()?1:0}),a=Object.keys(q).filter(function(i){return q[i]==="ongoing"}).sort(function(i,l){return i.toLowerCase()<l.toLowerCase()?-1:i.toLowerCase()>l.toLowerCase()?1:0}),e=Object.keys(q).filter(function(i){return q[i]==="past"}).sort(function(i,l){return i.toLowerCase()<l.toLowerCase()?-1:i.toLowerCase()>l.toLowerCase()?1:0});return bt=n.concat(a).concat(e),bt.forEach(function(i){let l=t.filter(function(f){return f.PooledFundName===i});xn(l,i)}),Pt=d3.timeMonth.offset(Kt,-me),wt=d3.timeMonth.offset(maxDate,ye),t}function xn(t,n){t=t.sort(function(e,i){return e.PlannedStartDateTimestamp-i.PlannedStartDateTimestamp});let a={0:t[0].PlannedEndDateTimestamp};t[0].row=0,t.forEach(function(e,i){if(!i)return;for(let f in a)if(e.PlannedStartDateTimestamp>a[f]){e.row=+f,a[f]=e.PlannedEndDateTimestamp;return}let l=d3.max(Object.keys(a).map(function(f){return+f}));a[(l+1).toString()]=e.PlannedEndDateTimestamp,e.row=l+1}),Z[n]=d3.max(t,function(e){return e.row})}function bn(){Jt=Object.keys(Z).reduce(function(a,e){return a+=2*Gt+Z[e]*jt+(Z[e]+1)*Et,a},0)+s.padding[0]+s.padding[2],s.height=Jt,Qt=Object.keys(Z).reduce(function(a,e){return a+=2*Wt+Z[e]*_t+(Z[e]+1)*Rt,a},0)+h.padding[0]+h.padding[2],h.height=Qt,$=c[0]+c[2]+r.height+g.height+h.height+s.height+O.height+4*N,Se===!1&&C.style("height",$+"px"),G.attr("viewBox","0 0 "+x+" "+$),Nt&&G.attr("height",$),s.main.attr("transform","translate("+c[3]+","+(c[0]+r.height+g.height+h.height+3*N)+")"),O.main.attr("transform","translate("+c[3]+","+(c[0]+r.height+g.height+h.height+s.height+4*N)+")"),St.tickSizeInner(-(s.height-s.padding[0]-s.padding[2])),cn.attr("height",s.height),At.translateExtent([[s.padding[3],0],[s.width,s.height]]).extent([[s.padding[3],0],[s.width,s.height]]),ft.extent([[h.padding[3],h.padding[0]],[h.width,h.height-h.padding[2]]])}function Le(t,n,a,e){let i=Object.keys(Z).map(function(l){return this.current+=2*a+Z[l]*e+(Z[l]+1)*n},{current:t.padding[0]});return i.unshift(t.padding[0]),i}function Oe(){let t=s.main.select(".pbiuacTodayText").node().getBoundingClientRect();s.main.select(".pbiuacXAxisMainGroup").selectAll("text").each(function(){let n=this.getBoundingClientRect();if(n.left<t.right&&n.right>t.left){d3.select(this.parentNode).remove();return}let a=this.textContent;+a==+a&&d3.select(this).style("fill",fe).style("font-weight",700)})}function oe(t){if(t.TotalUSDPlanned=+t.TotalUSDPlanned,t.PlannedStartDate=ge(t.PlannedStartDate)||new Date(t.PlannedStartDate),t.PlannedEndDate=ge(t.PlannedEndDate)||new Date(t.PlannedEndDate),!(!t.PlannedStartDate&&!t.PlannedEndDate)&&(t.PlannedStartDate||(t.PlannedStartDate=t.AllocationSource==="Standard"?d3.timeMonth.offset(t.PlannedEndDate,-1):d3.timeDay.offset(t.PlannedEndDate,-15)),t.PlannedEndDate||(t.PlannedEndDate=t.AllocationSource==="Standard"?d3.timeMonth.offset(t.PlannedStartDate,1):d3.timeDay.offset(t.PlannedStartDate,15)),t.PlannedStartDateTimestamp=t.PlannedStartDate.getTime(),t.PlannedEndDateTimestamp=t.PlannedEndDate.getTime(),t.PlannedStartDateTimestamp<=t.PlannedEndDateTimestamp))return t}function Pn(t){F.html("").style("display","block");let n="contributionColorHTMLcolor",a=F.append("div").attr("class","pbiuacListTitleDivContainer"),e=a.append("div").attr("class","pbiuacListTitleDiv"),i=a.append("div").attr("class","pbiuacListButtonDiv"),l=e.append("p").attr("class","pbiuacListTitle contributionColorHTMLcolor").html("Allocation Details"),f=i.append("button").html("Remove this list").on("click",function(){F.html("").style("display","none")}),d=F.append("div").attr("class","pbiuacNameAndYearDiv").append("p").html(t.PooledFundName+", "+t.AllocationYear),D=F.append("div").attr("class","pbiuacAllocationTitle").append("p").html(t.AllocationTitle),w=F.append("div").attr("class","pbiuacAllocationSource").append("p").html("("+t.AllocationSource+")"),p=F.append("div").attr("class","pbiuacAllocationStart").append("p").html("<span class='"+n+"'>Allocation value: </span>$"+at(t.TotalUSDPlanned)),u=F.append("div").attr("class","pbiuacAllocationStart").append("p").html("<span class='"+n+"'>Allocation strategy launch date: </span>"+Lt(t.PlannedStartDate)),A=F.append("div").attr("class","pbiuacAllocationEnd").append("p").html("<span class='"+n+"'>Expected completion date of HC approvals: </span>"+Lt(t.PlannedEndDate)),o=t.AllocationSummary?t.AllocationSummary:"n/a",y=F.append("div").attr("class","pbiuacAllocationEnd").append("p").html("<span class='"+n+"'>Allocation Statement: </span>"+o),P=t.HRPPlans?t.HRPPlans.split("##").join("; ")+".":"n/a.",Y=F.append("div").attr("class","pbiuacAllocationHR").append("p").html("<span class='"+n+"'>Target HRPs: </span>"+P),X=F.append("div").attr("class","pbiuacDocumentsDiv").append("p").html("<b>Related Documents:</b>"),W=t.Documents?t.Documents.split("|||").map(function(k){return{documentTitle:k.split("##")[0],size:k.split("##")[1],type:k.split("##")[2],url:k.split("##")[3],documentComment:k.split("##")[4]}}):null,b=F.append("div").attr("class","pbiuacDocumentsList");if(W){let R=b.append("ol").selectAll(null).data(W).enter().append("li");R.append("span").html(function(v){return v.documentComment?v.documentComment+", ":""}),R.append("a").attr("href",function(v){return v.url}).attr("target","_blank").html(function(v){return v.documentTitle}),R.append("span").html(function(v){return" ("+We(v.size)+"B, "+v.type+")"})}else b.append("p").html("Unavailable");F.node().scrollIntoView({behavior:"smooth"})}function wn(t){let n=JSON.parse(JSON.stringify(t)).filter(function(e){return e.PlannedStartDateTimestamp<T.domain()[1].getTime()&&e.PlannedEndDateTimestamp>T.domain()[0].getTime()});return n.forEach(function(e){e.CBPF=e.PooledFundName,e["Allocation Title"]=e.AllocationTitle,e["Allocation Summary"]=e.AllocationSummary,e.Total=e.TotalUSDPlanned,e["Start Date"]=e.PlannedStartDate,e["End Date"]=e.PlannedEndDate,delete e.AllocationTitle,delete e.AllocationSummary,delete e.TotalUSDPlanned,delete e.PooledFundName,delete e.PlannedStartDate,delete e.PlannedStartDateTimestamp,delete e.PlannedEndDate,delete e.PlannedEndDateTimestamp,delete e.Documents,delete e.PooledFundId,delete e.AllocationYear,delete e.HRPPlans,delete e.timeLine,delete e.allocationType,delete e.row}),d3.csvFormat(n)}function vn(){J.style("opacity",0).style("pointer-events","none");let t=C.append("div").attr("class","pbiuacOverDivHelp");B.html(null);let n=B.append("div").attr("id","pbiuacInnerTooltipDiv"),a=Dt.node().getBoundingClientRect(),e=J.node().getBoundingClientRect(),i=a.height*(x/a.width),l=t.append("svg").attr("viewBox","0 0 "+x+" "+($+i)),f=[{text:"CLOSE",width:90},{text:"GO TO HELP PORTAL",width:180}],d=l.selectAll(null).data(f).enter().append("g");d.append("rect").attr("rx",4).attr("ry",4).style("stroke","rgba(0, 0, 0, 0.3)").style("stroke-width","1px").style("fill",Je).style("cursor","pointer").attr("y",6).attr("height",22).attr("width",function(o){return o.width}).attr("x",function(o,y){return x-c[1]-o.width-(y?f[0].width+8:0)}).on("click",function(o,y){J.style("opacity",1).style("pointer-events","all"),t.remove(),y&&window.open(qe,"help_portal")}),d.append("text").attr("class","pbiuacAnnotationMainText").attr("text-anchor","middle").attr("x",function(o,y){return x-c[1]-o.width/2-(y?f[0].width+8:0)}).attr("y",22).text(function(o){return o.text}),[{x:c[3]+g.padding[3]-4,y:c[0]+r.height+N+i,width:S.length*g.buttonWidth+4,height:$t+8,xTooltip:(c[3]+g.padding[3]-4)*(a.width/x),yTooltip:c[0]+r.height+N+i+$t+8,text:"Use these buttons to select (filter by) year. Double click or press ALT when clicking to select multiple years. If you want to see all allocations, click 'All'."},{x:c[3]+h.padding[3]-4,y:c[0]+r.height+g.height+2*N+i,width:h.width-h.padding[3]+8,height:h.height,xTooltip:(x/2-150)*(a.width/x),yTooltip:(c[0]+r.height+g.height+2*N+i+h.height)*(a.width/x),text:"The brush area shows the data for the entire period. Use the two handles to move the selection or click + pan to move the selection. Click outside the selection to select the entire period."},{x:c[3]+s.padding[3]-4,y:c[0]+r.height+g.height+h.height+3*N+i,width:s.width-s.padding[3]+8,height:s.height,xTooltip:(x/2-150)*(a.width/x),yTooltip:(i+50)*(a.width/x),text:"This area shows the allocations for the selected period. You can pan left/right or zoom (using the mousewheel or the trackpad) to move this area. Hover over the allocations to get more information, and click on \u201CDisplay Details\u201D to generate the details (below the chart) for the allocation."},{x:x/2-100,y:c[0]+r.height+g.height+h.height+s.height+4*N+i,width:200,height:44,xTooltip:(x/2-150)*(a.width/x),yTooltip:(i+$-O.height-c[2]-90)*(a.width/x),text:"The legend shows the color encoding according to the allocation amount. Hover over the colors to see the corresponding amount."},{x:c[3]+O.padding[3]-4,y:c[0]+r.height+g.height+h.height+s.height+4*N+i,width:36,height:44,xTooltip:(c[3]+O.padding[3]-4)*(a.width/x),yTooltip:(i+$-O.height-c[2]-70)*(a.width/x),text:"Hover for showing only Standard or Reserve allocations."}].forEach(function(o){l.append("rect").attr("rx",4).attr("ry",4).attr("x",o.x).attr("y",o.y).attr("width",o.width).attr("height",o.height).style("stroke",Yt).style("stroke-width","3px").style("fill","none").style("opacity",.5).attr("class","pbiuacHelpRectangle").attr("pointer-events","all").on("mouseover",function(){let y=this;u(o.xTooltip,o.yTooltip,o.text,y)}).on("mouseout",A)});let w=l.append("rect").attr("x",x/2-180).attr("y",244).attr("width",360).attr("height",50).attr("pointer-events","none").style("fill","white").style("stroke","#888"),p=l.append("text").attr("class","pbiuacAnnotationExplanationText").attr("font-family","Roboto").attr("font-size","18px").style("fill","#222").attr("text-anchor","middle").attr("x",x/2).attr("y",264).attr("pointer-events","none").text("Hover over the elements surrounded by a blue rectangle to get additional information").call(Dn,350);function u(o,y,P,Y){p.style("opacity",0),w.style("opacity",0),l.selectAll(".pbiuacHelpRectangle").style("opacity",.1),d3.select(Y).style("opacity",1);let X=C.node().getBoundingClientRect();B.style("top",y+"px").style("left",o+"px").style("display","block"),n.html(P)}function A(){B.style("display","none"),p.style("opacity",1),w.style("opacity",1),l.selectAll(".pbiuacHelpRectangle").style("opacity",.5)}}function Tn(){let t="\xA9 OCHA CBPF Section "+qt;en&&(t+=" | For more information, please visit <a href='https://cbpf.data.unocha.org'>cbpf.data.unocha.org</a>"),rn.append("div").attr("class","d3chartFooterText").html(t)}function Dn(t,n){t.each(function(){let a=d3.select(this),e=a.text().split(/\s+/).reverse(),i,l=[],f=0,d=1.1,D=a.attr("y"),w=a.attr("x"),p=0,u=a.text(null).append("tspan").attr("x",w).attr("y",D).attr("dy",p+"em");for(;i=e.pop();)l.push(i),u.text(l.join(" ")),u.node().getComputedTextLength()>n&&(l.pop(),u.text(l.join(" ")),l=[i],u=a.append("tspan").attr("x",w).attr("y",D).attr("dy",++f*d+p+"em").text(i))})}function It(t,n){if(Nt){alert("This functionality is not supported by Internet Explorer");return}let e=d3.select("body").append("div").style("position","fixed").attr("id","pbiuacDownloadingDiv").style("left",window.innerWidth/2-100+"px").style("top",window.innerHeight/2-100+"px").append("svg").attr("class","pbiuacDownloadingDivSvg").attr("width",200).attr("height",100),i="Downloading "+t.toUpperCase();Ye(e,200,175,i);let l=G.node().getBoundingClientRect();G.attr("width",l.width).attr("height",l.height);let f=["font-size","font-family","font-weight","fill","stroke","stroke-dasharray","stroke-width","opacity","text-anchor","text-transform","shape-rendering","letter-spacing","white-space"],d=C.node();D(G.node()),t==="png"?J.style("opacity",0):Dt.style("opacity",0),ut.style("display","none"),html2canvas(d).then(function(w){G.attr("width",null).attr("height",null),t==="png"?J.style("opacity",1):Dt.style("opacity",1),t==="png"?Sn(w):An(w),n&&Vt&&d3.select(Vt).dispatch("mouseout")});function D(w){if(!w.style)return;let p=getComputedStyle(w);for(let u=0;u<f.length;u++)w.style[f[u]]=p[f[u]];for(let u=0;u<w.childNodes.length;u++)D(w.childNodes[u])}}function Sn(t){let a="AllocationsTimeline_"+Zt(new Date)+".png";t.toBlob(function(e){let i=URL.createObjectURL(e),l=document.createElement("a");l.download!==void 0?(l.setAttribute("href",i),l.setAttribute("download",a),l.style="visibility:hidden",document.body.appendChild(l),l.click(),document.body.removeChild(l)):window.location.href=i}),le(),d3.select("#pbiuacDownloadingDiv").remove()}function An(t){let n={top:10,bottom:16,left:20,right:30};d3.image("https://raw.githubusercontent.com/CBPFGMS/cbpfgms.github.io/master/img/assets/bilogo.png").then(function(a){let e,l=C.node().getBoundingClientRect(),f=210-n.left*2,d=f*(l.height/l.width),D=190,w;d>D?(w=297+d-D,e=new jsPDF({format:[210*2.834646,w*2.834646],unit:"mm"})):(w=297,e=new jsPDF);let p;y();let u=e.splitTextToSize("In 2018, CBPFs allocated more than $836 million to 685 partners in 18 countries to support 1,453 critical humanitarian projects. These projects targeted millions of people with healthcare, food aid, clean water, shelter and other life-saving assistance.",210-n.left-n.right,{fontSize:12}),A=d3.timeFormat("%A, %d %B %Y")(new Date);e.setTextColor(60),e.setFont("helvetica"),e.setFontType("normal"),e.setFontSize(12),e.text(n.left,48,u),e.setTextColor(65,143,222),e.setFont("helvetica"),e.setFontType("bold"),e.setFontSize(16),e.text(De,n.left,71),e.setFontSize(12),e.fromHTML("<div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>Date: <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+A+"</span></div>",n.left,77,{width:210-n.left-n.right},function(P){p=P}),e.addImage(t,"PNG",n.left,p.y+2,f,d);let o=new Date;e.save("AllocationsTimeline_"+Zt(o)+".pdf"),le(),d3.select("#pbiuacDownloadingDiv").remove();function y(){let P="\xA9 OCHA CBPF Section "+qt+" | For more information, please visit cbpf.data.unocha.org";e.setFillColor(65,143,222),e.rect(0,n.top,210,15,"F"),e.setFillColor(236,161,84),e.rect(0,n.top+15,210,2,"F"),e.setFillColor(255,255,255),e.rect(n.left,n.top-1,94,20,"F"),e.ellipse(n.left,n.top+9,5,9,"F"),e.ellipse(n.left+94,n.top+9,5,9,"F"),e.addImage(a,"PNG",n.left+2,n.top,90,18),e.setFillColor(236,161,84),e.rect(0,w-n.bottom,210,2,"F"),e.setTextColor(60),e.setFont("arial"),e.setFontType("normal"),e.setFontSize(10),e.text(P,n.left,w-n.bottom+10)}})}function Ye(t,n,a,e){let i=t.append("g").attr("class","pbiuacd3chartwheelGroup").attr("transform","translate("+n/2+","+a/4+")"),l=i.append("text").attr("text-anchor","middle").style("font-family","Roboto").style("font-weight","bold").style("font-size","11px").attr("y",50).attr("class","contributionColorFill").text(e),f=d3.arc().outerRadius(25).innerRadius(20),d=i.append("path").datum({startAngle:0,endAngle:0}).classed("contributionColorFill",!0).attr("d",f);D();function D(){d.transition().duration(1e3).attrTween("d",function(p){let u=d3.interpolate(0,Math.PI*2);return function(A){return p.endAngle=u(A),f(p)}}).on("end",w)}function w(){d.transition().duration(1e3).attrTween("d",function(p){let u=d3.interpolate(0,Math.PI*2);return function(A){return p.startAngle=u(A),f(p)}}).on("end",function(p){p.startAngle=0,D()})}}function le(){let t=d3.select(".pbiuacd3chartwheelGroup");t.select("path").interrupt(),t.remove()}function Ve(t){let n=(~~Math.log10(t)+1)%3,a=n===1?2:n===2?1:0,e=d3.formatPrefix("."+a+"~",t)(t);if(parseInt(e)===1e3){let i=e[e.length-1],l={k:"M",M:"B"};return 1+(isNaN(i)?l[i]:"")}return e}function Cn(t){if(t.toLowerCase()===V||t===V){m.selectedYear.push(V);return}t.split(",").map(function(a){return+a.trim()}).sort(function(a,e){return a-e}).forEach(function(a){a&&S.indexOf(a)>-1&&m.selectedYear.push(a)}),m.selectedYear.length||m.selectedYear.push(new Date().getFullYear())}function Fe(t){if(S.indexOf(t)>-1)return t;for(;S.indexOf(t)===-1;)t=t>=qt?t-1:t+1;return t}function Ie(){ln.html(function(){return m.selectedYear.length===1?null:"*Selected years: "+m.selectedYear.sort(function(n,a){return n-a}).reduce(function(n,a,e){return n+(e>=m.selectedYear.length-2?e>m.selectedYear.length-2?a:a+" and ":a+", ")},"")})}function En(t){if(+t==0)return 0;let n,a={Y:Math.pow(10,24),Z:Math.pow(10,21),E:Math.pow(10,18),P:Math.pow(10,15),T:Math.pow(10,12),G:Math.pow(10,9),B:Math.pow(10,9),M:Math.pow(10,6),k:Math.pow(10,3),h:Math.pow(10,2),da:Math.pow(10,1),d:Math.pow(10,-1),c:Math.pow(10,-2),m:Math.pow(10,-3),\u03BC:Math.pow(10,-6),n:Math.pow(10,-9),p:Math.pow(10,-12),f:Math.pow(10,-15),a:Math.pow(10,-18),z:Math.pow(10,-21),y:Math.pow(10,-24)};return Object.keys(a).some(function(e){if(t.indexOf(e)>0)return n=parseFloat(t.split(e)[0])*a[e],!0}),n}function Ht(t){let n=document.createElementNS("http://www.w3.org/2000/svg","g");n.setAttributeNS(null,"transform",t);let a=n.transform.baseVal.consolidate().matrix;return[a.e,a.f]}}})();})();
