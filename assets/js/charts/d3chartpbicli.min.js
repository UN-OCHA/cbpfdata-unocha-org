(()=>{(function(){let be=window.navigator.userAgent.indexOf("MSIE")>-1||window.navigator.userAgent.indexOf("Trident")>-1,jt=window.fetch,zt=window.URLSearchParams,Xe=window.matchMedia("(pointer: coarse)").matches&&!window.matchMedia("(any-pointer: fine)").matches,Jt=window.location.hostname==="cbpf.data.unocha.org",ge=window.location.hostname+window.location.pathname==="cbpf.data.unocha.org/bookmark.html",Ce="https://use.fontawesome.com/releases/v5.6.3/css/all.css",qe=["https://cbpfgms.github.io/css/d3chartstyles.css","https://cbpfgms.github.io/css/d3chartstylespbicli.css",Ce],Rt="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js",Ae="https://cbpfgms.github.io/libraries/html2canvas.min.js",De="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js",Wt="https://cdn.jsdelivr.net/npm/@ungap/url-search-params@0.1.2/min.min.js",ve="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js",xe="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.4/fetch.min.js";if(qe.forEach(function(rt){if(!$e(rt)){let L=document.createElement("link");L.setAttribute("rel","stylesheet"),L.setAttribute("type","text/css"),L.setAttribute("href",rt),rt===Ce&&(L.setAttribute("integrity","sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"),L.setAttribute("crossorigin","anonymous")),document.getElementsByTagName("head")[0].appendChild(L)}}),!oe(Rt))jt&&zt?lt(Rt,Ot):jt&&!zt?lt(Wt,function(){lt(Rt,Ot)}):lt(ve,function(){lt(xe,function(){lt(Wt,function(){lt(Rt,Ot)})})});else if(typeof d3<"u")jt&&zt?Ot():jt&&!zt?lt(Wt,Ot):lt(ve,function(){lt(xe,function(){lt(Wt,Ot)})});else{let rt,L=document.getElementsByTagName("script");for(let U=L.length;U--;)L[U].src==Rt&&(rt=L[U]);rt.addEventListener("load",Ot)}function lt(rt,L){let U=document.getElementsByTagName("head")[0],ut=document.createElement("script");ut.type="text/javascript",ut.src=rt,ut.onreadystatechange=L,ut.onload=L,U.appendChild(ut)}function $e(rt){let L=document.getElementsByTagName("link");for(let U=L.length;U--;)if(L[U].href==rt)return!0;return!1}function oe(rt){let L=document.getElementsByTagName("script");for(let U=L.length;U--;)if(L[U].src==rt)return!0;return!1}function Ot(){Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(o){if(this==null)throw new TypeError('"this" is null or not defined');var n=Object(this),p=n.length>>>0;if(typeof o!="function")throw new TypeError("predicate must be a function");for(var c=arguments[1],l=0;l<p;){var t=n[l];if(o.call(c,t,l,n))return t;l++}},configurable:!0,writable:!0}),HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(o,n,p){var c=this.toDataURL(n,p).split(",")[1];setTimeout(function(){for(var l=atob(c),t=l.length,i=new Uint8Array(t),u=0;u<t;u++)i[u]=l.charCodeAt(u);o(new Blob([i],{type:n||"image/png"}))})}});let rt={alldonors:"All",AF:"AFG",AX:"ALA",AL:"ALB",DZ:"DZA",AS:"ASM",AD:"AND",AO:"AGO",AI:"AIA",AQ:"ATA",AG:"ATG",AR:"ARG",AM:"ARM",AW:"ABW",AU:"AUS",AT:"AUT",AZ:"AZE",BS:"BHS",BH:"BHR",BD:"BGD",BB:"BRB",BY:"BLR",BE:"BEL",BZ:"BLZ",BJ:"BEN",BM:"BMU",BT:"BTN",BO:"BOL",BA:"BIH",BW:"BWA",BV:"BVT",BR:"BRA",VG:"VGB",IO:"IOT",BN:"BRN",BG:"BGR",BF:"BFA",BI:"BDI",KH:"KHM",CM:"CMR",CA:"CAN",CV:"CPV",KY:"CYM",CF:"CAF",TD:"TCD",CL:"CHL",CN:"CHN",HK:"HKG",MO:"MAC",CX:"CXR",CC:"CCK",CO:"COL",KM:"COM",CG:"COG",CD:"COD",CK:"COK",CR:"CRI",CI:"CIV",HR:"HRV",CU:"CUB",CY:"CYP",CZ:"CZE",DK:"DNK",DJ:"DJI",DM:"DMA",DO:"DOM",EC:"ECU",EG:"EGY",SV:"SLV",GQ:"GNQ",ER:"ERI",EE:"EST",ET:"ETH",FK:"FLK",FO:"FRO",FJ:"FJI",FI:"FIN",FR:"FRA",GF:"GUF",PF:"PYF",TF:"ATF",GA:"GAB",GM:"GMB",GE:"GEO",DE:"DEU",GH:"GHA",GI:"GIB",GR:"GRC",GL:"GRL",GD:"GRD",GP:"GLP",GU:"GUM",GT:"GTM",GG:"GGY",GN:"GIN",GW:"GNB",GY:"GUY",HT:"HTI",HM:"HMD",VA:"VAT",HN:"HND",HU:"HUN",IS:"ISL",IN:"IND",ID:"IDN",IR:"IRN",IQ:"IRQ",IE:"IRL",IM:"IMN",IL:"ISR",IT:"ITA",JM:"JAM",JP:"JPN",JE:"JEY",JO:"JOR",KZ:"KAZ",KE:"KEN",KI:"KIR",KP:"PRK",KR:"KOR",KW:"KWT",KG:"KGZ",LA:"LAO",LV:"LVA",LB:"LBN",LS:"LSO",LR:"LBR",LY:"LBY",LI:"LIE",LT:"LTU",LU:"LUX",MK:"MKD",MG:"MDG",MW:"MWI",MY:"MYS",MV:"MDV",ML:"MLI",MT:"MLT",MH:"MHL",MQ:"MTQ",MR:"MRT",MU:"MUS",YT:"MYT",MX:"MEX",FM:"FSM",MD:"MDA",MC:"MCO",MN:"MNG",ME:"MNE",MS:"MSR",MA:"MAR",MZ:"MOZ",MM:"MMR",NA:"NAM",NR:"NRU",NP:"NPL",NL:"NLD",AN:"ANT",NC:"NCL",NZ:"NZL",NI:"NIC",NE:"NER",NG:"NGA",NU:"NIU",NF:"NFK",MP:"MNP",NO:"NOR",OM:"OMN",PK:"PAK",PW:"PLW",PS:"PSE",PA:"PAN",PG:"PNG",PY:"PRY",PE:"PER",PH:"PHL",PN:"PCN",PL:"POL",PT:"PRT",PR:"PRI",QA:"QAT",RE:"REU",RO:"ROU",RU:"RUS",RW:"RWA",BL:"BLM",SH:"SHN",KN:"KNA",LC:"LCA",MF:"MAF",PM:"SPM",VC:"VCT",WS:"WSM",SM:"SMR",ST:"STP",SA:"SAU",SN:"SEN",RS:"SRB",SC:"SYC",SL:"SLE",SG:"SGP",SK:"SVK",SI:"SVN",SB:"SLB",SO:"SOM",ZA:"ZAF",GS:"SGS",SS:"SSD",ES:"ESP",LK:"LKA",SD:"SDN",SR:"SUR",SJ:"SJM",SZ:"SWZ",SE:"SWE",CH:"CHE",SY:"SYR",TW:"TWN",TJ:"TJK",TZ:"TZA",TH:"THA",TL:"TLS",TG:"TGO",TK:"TKL",TO:"TON",TT:"TTO",TN:"TUN",TR:"TUR",TM:"TKM",TC:"TCA",TV:"TUV",UG:"UGA",UA:"UKR",AE:"ARE",GB:"GBR",US:"USA",UM:"UMI",UY:"URY",UZ:"UZB",VU:"VUT",VE:"VEN",VN:"VNM",VI:"VIR",WF:"WLF",EH:"ESH",YE:"YEM",ZM:"ZMB",ZW:"ZWE",XX:"SCB"},L=900,U=[4,4,4,4],ut="pbicli",Gt=360,ne=12,Ft=16,Vo=2,vt=2.5,ht=d3.local(),re=new Date,v=re.getFullYear(),to=6e5,ie=d3.utcFormat("_%Y%m%d_%H%M%S_UTC"),b=d3.timeParse("%Y"),le=d3.format("~s"),eo=d3.format(",.0f"),oo=window.innerHeight,Pe=2,J=10,se=2,ae=14,Le=.1,Ko=.5,Zt=1e8,no="Contribution Trends",ce=8,k=1e3,jo=20,Se=20,xt="#418FDE",ro="#F79A3B",io="contribution-trends",lo="https://cbpf.data.unocha.org/bookmark.html?",so="https://gms.unocha.org/content/contribution-trends",Te=["#A4D65E","#E56A54","#E2E868","#999999","#ECA154","#71DBD4","#9063CD","#D3BC8D","#a6cee3","#b2df8a","#33a02c","#fb9a99","#e31a1c","#fdbf6f","#ff7f00","#cab2d6","#6a3d9a","#b15928"],_t="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",ao="https://cbpfgms.github.io/img/assets/flags24.json",co="https://cbpfapi.unocha.org/vo2/odata/ContributionTotal?$format=csv&ShowAllPooledFunds=1",r={selectedDonors:[],selectedCbpfs:[],controlledBy:"donor",showLocal:!1,selectedLocalCurrency:null},zo={GBP:"\xA3",EUR:"\u20AC"},G={alldonors:"All Donors"},_={alldonors:!0},W={},kt={},It={donor:"All Donors",isoCode:"alldonors",localCurrency:null,total:0,values:[]},Be,yt=!1,ft,tt=new URLSearchParams(location.search);tt.has("viz")||tt.append("viz",io);let S=d3.select("#d3chartcontainerpbicli"),po=S.node().getAttribute("data-responsive")==="true",uo=S.node().getAttribute("data-showhelp")==="true",fo=S.node().getAttribute("data-showlink")==="true",Oe=S.node().getAttribute("data-title")||no,ho=S.node().getAttribute("data-lazyload")==="true",yo=tt.has("country")?tt.get("country").replace(/\|/g,","):S.node().getAttribute("data-selectedcountry");po===!1&&S.style("width",L+"px");let Mt=S.append("div").attr("class","pbicliOuterDiv"),Ut=Mt.append("div").attr("class","pbicliTopDiv"),mo=Ut.append("div").attr("class","pbicliTitleDiv"),mt=Ut.append("div").attr("class","pbicliIconsDiv d3chartIconsDiv"),ke=Mt.append("div").attr("class","pbicliTopSelectionDiv"),Ge=ke.append("div").attr("class","pbicliDonorsContainerSelectionDiv"),bo=ke.append("div").attr("class","pbicliCbpfsContainerSelectionDiv"),de=Ge.append("div").attr("class","pbicliDonorsSelectionDiv"),Fe=Ge.append("div").attr("class","pbicliCurrencySelectionDiv"),Me=bo.append("div").attr("class","pbicliCbpfsSelectionDiv"),Et=Mt.append("div").attr("class","pbicliFiltersDiv"),go=Mt.append("div").attr("class","pbicliBorderDiv"),Ee=Mt.append("div").attr("class","pbicliLegendDiv"),we=Ee.append("div").attr("class","pbicliDonorsLegendDiv"),Co=we.append("div").attr("class","pbicliDonorsLegendDivTop"),Qt=we.append("div").attr("class","pbicliDonorsLegendDivBottom"),Ne=Ee.append("div").attr("class","pbicliCbpfsLegendDiv"),Ao=Ne.append("div").attr("class","pbicliCbpfsLegendDivTop"),Xt=Ne.append("div").attr("class","pbicliCbpfsLegendDivBottom"),bt=S.append("svg").attr("viewBox","0 0 "+L+" "+Gt);be&&bt.attr("height",Gt);let Do=Jt?null:S.append("div").attr("class","pbicliFooterDiv"),Jo=bt.append("filter").attr("id","pbicliGrayFilter").append("feColorMatrix").attr("in","SourceGraphic").attr("type","saturate").attr("values","0");We(bt,L,Gt,"Loading visualisation...");let wt=S.append("div").attr("id","pbicliSnapshotTooltip").attr("class","pbicliSnapshotContent").style("display","none").on("mouseleave",function(){yt=!1,wt.style("display","none"),Pt.style("display","none")});wt.append("p").attr("id","pbicliSnapshotTooltipPdfText").html("Download PDF").on("click",function(){yt=!1,te("pdf",!0)}),wt.append("p").attr("id","pbicliSnapshotTooltipPngText").html("Download Image (PNG)").on("click",function(){yt=!1,te("png",!0)});let Re=!Xe&&(window.safari||window.navigator.userAgent.indexOf("Edge")>-1);Re&&wt.append("p").attr("id","pbicliTooltipBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default");let Pt=S.append("div").attr("id","pbiclitooltipdiv").style("display","none");S.on("contextmenu",function(){d3.event.preventDefault();let o=d3.mouse(this);yt=!0,wt.style("display","block").style("top",o[1]-4+"px").style("left",o[0]-4+"px")});let f={main:bt.append("g").attr("class","pbicliDonorsLinesPanel").attr("transform","translate("+U[3]+","+U[0]+")"),width:(L-U[1]-U[3]-ne)/2,height:Gt-U[0]-U[2],padding:[16,40,16,32]},g={main:bt.append("g").attr("class","pbicliCbpfsLinesPanel").attr("transform","translate("+(U[3]+f.width+ne)+","+U[0]+")"),width:(L-U[1]-U[3]-ne)/2,height:Gt-U[0]-U[2],padding:[16,40,16,32]},E=d3.scaleTime().range([f.padding[3],f.width-f.padding[1]]),H=d3.scaleTime().range([g.padding[3],g.width-g.padding[1]]),V=d3.scaleLinear().range([f.height-f.padding[2],f.padding[0]]),Q=d3.scaleLinear().range([g.height-g.padding[2],g.padding[0]]),X=d3.scaleLinear().range([f.height-f.padding[2],f.padding[0]]),Lt=d3.scaleOrdinal().range(Te),St=d3.scaleOrdinal().range(Te),qt=d3.line().x(function(o){return E(b(o.year))}).y(function(o){return V(o.total)}).curve(d3.curveCatmullRom),Ie=d3.line().x(function(o){return H(b(o.year))}).y(function(o){return Q(o.total)}).curve(d3.curveCatmullRom),Ue=d3.line().x(function(o){return E(b(o.year))}).y(function(o){return X(o.localTotal)}).curve(d3.curveCatmullRom),vo=d3.axisBottom(E).tickSizeInner(4).tickSizeOuter(0).ticks(8),xo=d3.axisBottom(H).tickSizeInner(4).tickSizeOuter(0).ticks(8),Ye=d3.axisLeft(V).tickSizeInner(-(f.width-f.padding[3]-f.padding[1])).tickSizeOuter(0).ticks(5).tickFormat(function(o){return le(o).replace("G","B")}),He=d3.axisLeft(Q).tickSizeInner(-(g.width-g.padding[3]-g.padding[1])).tickSizeOuter(0).ticks(5).tickFormat(function(o){return le(o).replace("G","B")}),Ve=d3.axisRight(X).tickSizeInner(3).tickSizeOuter(0).ticks(5).tickFormat(function(o){return le(o).replace("G","B")});oe(Ae)||lt(Ae,null),oe(De)||lt(De,null),Jt&&!ge?Promise.all([window.cbpfbiDataObject.contributionsTotalData,window.cbpfbiDataObject.flags]).then(o=>je(o)):Promise.all([Ke(ut+"data",co,"contributions data","csv"),Ke("flags",ao,"flags data","json")]).then(o=>je(o));function Ke(o,n,p,c){if(localStorage.getItem(o)&&JSON.parse(localStorage.getItem(o)).timestamp>re.getTime()-to){let l=c==="csv"?d3.csvParse(JSON.parse(localStorage.getItem(o)).data):JSON.parse(localStorage.getItem(o)).data;return console.info(ut+" chart info: "+p+" from local storage"),Promise.resolve(l)}else return(c==="csv"?d3.csv:d3.json)(n).then(t=>{try{localStorage.setItem(o,JSON.stringify({data:c==="csv"?d3.csvFormat(t):t,timestamp:re.getTime()}))}catch(i){console.info(ut+" chart, "+i)}return console.info(ut+" chart info: "+p+" from API"),t})}function je([o,n]){fe(),o.sort(function(l,t){return+l.FiscalYear-+t.FiscalYear}),o=o.filter(function(l){return l.GMSDonorName!==""&&l.GMSDonorISO2Code!==""});let p=Oo(o);Be=d3.extent(p.yearsArray),Lt.domain(p.donorsArray),St.domain(p.cbpfsArray),Fo(yo,p.donorsArray,p.cbpfsArray),r.selectedCbpfs.length?(r.selectedDonors=[],r.controlledBy="cbpf"):r.selectedDonors.length||r.selectedDonors.push("alldonors"),ho?(d3.select(window).on("scroll.pbicli",c),c()):ze(o,p,n);function c(){let l=S.node().getBoundingClientRect();l.bottom<0||l.top-oo>0||(d3.select(window).on("scroll.pbicli",null),ze(o,p,n))}}function ze(o,n,p){Nt(),Po(n.donorsArray),Lo(n.currenciesArray),So(n.cbpfsArray),To(),Jt||Bo();let c=Go(n.yearsArray);E.domain(c),H.domain(c),V.domain([0,Zt]),X.domain([0,Zt]),Q.domain([0,Zt]);let l=f.main.append("text").attr("class","pbicliYAxisLabel").attr("text-anchor","end").attr("x",f.padding[3]-2).attr("y",f.padding[0]-ce).text("USD"),t=f.main.append("text").attr("class","pbicliYAxisLabelLocalCurrency").attr("text-anchor","start").attr("x",f.padding[3]+2).attr("y",f.padding[0]-ce),i=g.main.append("text").attr("class","pbicliYAxisLabel").attr("text-anchor","end").attr("x",g.padding[3]-2).attr("y",g.padding[0]-ce).text("USD"),u=f.main.append("g").attr("class","pbicliCurrentYearGroupDonors");u.attr("transform","translate("+E(b(v-1))+",0)");let m=u.append("rect").attr("x",0).attr("y",f.padding[0]).attr("width",E(b(v))-E(b(v-1))).attr("height",f.height-f.padding[2]-f.padding[0]).style("fill","#f2f2f2"),O=u.append("text").attr("class","pbicliFutureDonationsText").attr("y",4).attr("x",(E(b(v))-E(b(v-1)))/2).attr("text-anchor","middle").text("Current").append("tspan").attr("dy","0.9em").attr("x",(E(b(v))-E(b(v-1)))/2).text("year"),R=g.main.append("g").attr("class","pbicliCurrentYearGroupCbpfs");R.attr("transform","translate("+H(b(v-1))+",0)");let I=R.append("rect").attr("x",0).attr("y",g.padding[0]).attr("width",H(b(v))-H(b(v-1))).attr("height",g.height-g.padding[2]-g.padding[0]).style("fill","#f2f2f2"),d=R.append("text").attr("class","pbicliFutureDonationsText").attr("y",4).attr("x",(H(b(v))-H(b(v-1)))/2).attr("text-anchor","middle").text("Current").append("tspan").attr("dy","0.9em").attr("x",(H(b(v))-H(b(v-1)))/2).text("year"),N=f.main.append("g").attr("class","pbicligroupXAxisDonors").attr("transform","translate(0,"+(f.height-f.padding[2])+")"),st=f.main.append("g").attr("class","pbicligroupYAxisDonors").attr("transform","translate("+f.padding[3]+",0)"),Ct=f.main.append("g").attr("class","pbicligroupYAxisDonorsLocalCurrency").attr("transform","translate("+f.padding[3]+",0)");N.call(vo),st.call(Ye),Ct.call(Ve),st.selectAll(".tick").filter(function(C){return C===0}).remove(),Ct.selectAll(".tick").filter(function(C){return C===0}).remove(),Ct.style("opacity",r.showLocal?1:0),st.select(".domain").raise();let z=g.main.append("g").attr("class","pbicligroupXAxisCbpfs").attr("transform","translate(0,"+(g.height-g.padding[2])+")"),K=g.main.append("g").attr("class","pbicligroupYAxisCbpfs").attr("transform","translate("+g.padding[3]+",0)");z.call(xo),K.call(He),K.selectAll(".tick").filter(function(C){return C===0}).remove(),K.select(".domain").raise();let $=pt(o);V.domain(q($.donors,$.cbpfs)),Q.domain(q($.donors,$.cbpfs)),X.domain(gt($.donors)),$t(),r.selectedCbpfs.length?(Ze(),he($.donors)):(Yt(),Ht($.cbpfs)),At($.donors),Tt($.cbpfs),uo&&Je(),S.select("#pbicliDonorsDropdown").on("change",function(){let C;for(let y in G)G[y]===this.value&&(C=y);if(r.showLocal&&kt[C]!==r.selectedLocalCurrency&&r.selectedLocalCurrency!==null){Eo(),S.select("#pbicliDonorsDropdown").select("option").property("selected",!0);return}else{if(r.showLocal&&r.selectedLocalCurrency===null&&(r.selectedLocalCurrency=kt[C]),r.selectedCbpfs=[],r.controlledBy!=="donor"){Et.selectAll(".pbicliRadioButtons input").property("disabled",!1);for(let A in _)_[A]=!0;for(let A in W)W[A]=!0}r.controlledBy="donor";let y=this.value,D;if(y==="Top 5 donors")D=n.donorsArray.slice(0,5),r.selectedDonors=D;else if(y==="All Donors")if(r.selectedDonors.indexOf("alldonors")===-1)r.selectedDonors.push("alldonors");else return;else if(d3.select(this).selectAll("option").each(function(A){G[A]===y&&(D=A)}),r.selectedDonors.indexOf(D)===-1)r.selectedDonors.push(D);else return;let h=r.selectedDonors.map(function(A){return n.cbpfsArray.indexOf(A)>-1?G[A]+"@donor":G[A]}).join("|");tt.has("country")?tt.set("country",h):tt.append("country",h),S.select("#pbicliCbpfsDropdown").select("option").property("selected",!0),S.select("#pbicliCbpfsDropdown").selectAll("option").property("disabled",function(A,F){return!F||r.selectedCbpfs.indexOf(A)>-1}),S.select("#pbicliDonorsDropdown").selectAll("option").property("disabled",function(A,F){return!F||(A==="All Donors"?r.selectedDonors.indexOf("alldonors")>-1:r.selectedDonors.indexOf(A)>-1)});let T=pt(o);V.domain(q(T.donors,T.cbpfs)),Q.domain(q(T.donors,T.cbpfs)),X.domain(gt(T.donors)),$t(),Yt(),Ht(T.cbpfs),At(T.donors),Tt(T.cbpfs)}}),S.select("#pbicliCbpfsDropdown").on("change",function(){if(r.selectedDonors=[],r.controlledBy!=="cbpf"){Et.selectAll(".pbicliRadioButtons input").property("disabled",!0),Et.select(".pbicliRadioButtons input").property("checked",!0),r.selectedLocalCurrency=null,pe(n.donorsArray,!0),S.select("#pbicliCurrencyDropdown").selectAll("option").property("selected",function(T,A){return!A}),r.showLocal=!1;for(let T in _)_[T]=!0;for(let T in W)W[T]=!0}r.controlledBy="cbpf";let C=this.value,y;if(C==="Top 5 CBPFs")y=n.cbpfsArray.slice(0,5),r.selectedCbpfs=y;else if(d3.select(this).selectAll("option").each(function(T){G[T]===C&&(y=T)}),r.selectedCbpfs.indexOf(y)===-1)r.selectedCbpfs.push(y);else return;let D=r.selectedCbpfs.map(function(T){return n.donorsArray.indexOf(T)>-1?G[T]+"@fund":G[T]}).join("|");tt.has("country")?tt.set("country",D):tt.append("country",D),S.select("#pbicliDonorsDropdown").select("option").property("selected",!0),S.select("#pbicliDonorsDropdown").selectAll("option").property("disabled",function(T,A){return!A||r.selectedDonors.indexOf(T)>-1}),S.select("#pbicliCbpfsDropdown").selectAll("option").property("disabled",function(T,A){return!A||r.selectedCbpfs.indexOf(T)>-1});let h=pt(o);V.domain(q(h.donors,h.cbpfs)),Q.domain(q(h.donors,h.cbpfs)),X.domain(gt(h.donors)),$t(),Ze(),he(h.donors),At(h.donors),Tt(h.cbpfs)}),S.select("#pbicliCurrencyDropdown").on("change",function(){if(r.selectedCbpfs=[],r.controlledBy==="cbpf"){for(let h in _)_[h]=!0;for(let h in W)W[h]=!0}r.controlledBy="donor";let C=this.value,y=[];if(C==="USD (all donors)")r.selectedDonors=[],r.selectedLocalCurrency=null,pe(n.donorsArray,!0);else{for(let h in kt)kt[h]===C&&y.push(h);r.selectedDonors=y,r.selectedLocalCurrency=C,pe(r.selectedDonors,!1)}S.select("#pbicliCbpfsDropdown").select("option").property("selected",!0);let D=pt(o);V.domain(q(D.donors,D.cbpfs)),Q.domain(q(D.donors,D.cbpfs)),X.domain(gt(D.donors)),$t(),Yt(),Ht(D.cbpfs),At(D.donors),Tt(D.cbpfs)}),Et.selectAll(".pbicliRadioButtons input").on("change",function(){let C=this.value,y=r.selectedDonors.map(function(D){return kt[D]}).filter(function(D,h,T){return T.indexOf(D)===h});if(C==="local"&&y.length>1)Mo(),d3.selectAll(".pbiclialertyesorno").on("click",function(D){if(D==="YES"){d3.select(".pbicliOverDiv").remove(),r.showLocal=C==="local",r.selectedDonors=[],S.select("#pbicliDonorsDropdown").select("option").property("selected",!0),S.select("#pbicliDonorsDropdown").selectAll("option").property("disabled",function(T,A){return!A||r.selectedDonors.indexOf(T)>-1});let h=pt(o);V.domain(q(h.donors,h.cbpfs)),Q.domain(q(h.donors,h.cbpfs)),X.domain(gt(h.donors)),Yt(),Ht(h.cbpfs),At(h.donors),Tt(h.cbpfs)}else d3.select(".pbicliOverDiv").remove(),r.showLocal=!1,Et.select(".pbicliRadioButtons input").property("checked",!0)});else{r.showLocal=C==="local",r.selectedLocalCurrency=C==="local"&&y.length?y[0]:null;let D=pt(o);V.domain(q(D.donors,D.cbpfs)),Q.domain(q(D.donors,D.cbpfs)),X.domain(gt(D.donors)),At(D.donors)}});function Nt(){go.style("border-bottom","1px solid lightgray");let C=mo.append("p").attr("class","pbicliTitle contributionColorHTMLcolor").html(Oe),y=mt.append("button").attr("id","pbicliHelpButton");y.html("HELP  ").append("span").attr("class","fas fa-info");let D=mt.append("button").attr("id","pbicliDownloadButton");D.html(".CSV  ").append("span").attr("class","fas fa-download");let h=mt.append("div").attr("class","pbicliSnapshotDiv");h.append("button").attr("id","pbicliSnapshotButton").html("IMAGE ").append("span").attr("class","fas fa-camera");let A=h.append("div").attr("class","pbicliSnapshotContent"),F=A.append("p").attr("id","pbicliSnapshotPdfText").html("Download PDF").on("click",function(){te("pdf",!1)}),ot=A.append("p").attr("id","pbicliSnapshotPngText").html("Download Image (PNG)").on("click",function(){te("png",!1)});if(!ge){let w=mt.append("button").attr("id","pbicliShareButton");w.html("SHARE  ").append("span").attr("class","fas fa-share");let B=S.append("div").attr("class","d3chartShareDiv").style("display","none");w.on("mouseover",function(){B.html("Click to copy").style("display","block");let s=this.getBoundingClientRect(),M=S.node().getBoundingClientRect(),x=B.node().getBoundingClientRect(),j=s.top-M.top-(x.height-s.height)/2,nt=s.left-M.left-x.width-12;B.style("top",j+"px").style("left",nt+"20px")}).on("mouseout",function(){B.style("display","none")}).on("click",function(){let s=lo+tt.toString();B.append("input").attr("type","text").attr("readonly",!0).attr("spellcheck","false").property("value",s).node().select(),document.execCommand("copy"),B.html("Copied!");let x=this.getBoundingClientRect(),j=S.node().getBoundingClientRect(),nt=B.node().getBoundingClientRect(),at=x.left-j.left-nt.width-12;B.style("left",at+"20px")})}if(Re){let w=A.append("p").attr("id","pbicliBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default")}h.on("mouseover",function(){A.style("display","block")}).on("mouseout",function(){A.style("display","none")}),y.on("click",Je),D.on("click",function(){if(r.controlledBy===null)return;let w=pt(o);wo(w,o)})}function Yt(){Qt.selectAll(".pbicliCheckboxDonorsDiv").remove();let C=Qt.selectAll(".pbicliSelectedDonorsDiv").data(r.selectedDonors,function(F){return F}),y=C.enter().append("div").attr("class","pbicliSelectedDonorsDiv"),D=C.exit().remove(),h=y.append("div").attr("class","pbicliSelectedDonorsDivText").html(function(F){return"<span style='color:"+(F==="alldonors"?xt:Lt(F))+";'>&#9679; </span>"+(F==="alldonors"?"All Donors&nbsp;":G[F])}),T=y.filter(function(F){return F!=="alldonors"}).append("div").attr("class","pbicliSelectedDonorsFlagDiv").append("img").attr("width",Ft).attr("height",Ft).attr("src",function(F){return F?(F&&!p[F.toLowerCase()]&&!Jt&&console.warn("Missing flag: "+F.name,F),p[F.toLowerCase()]||_t):_t}),A=y.append("div").attr("class","pbicliSelectedDonorsCloseDiv");A.append("span").attr("class","fas fa-times"),A.on("click",function(F){r.selectedDonors=r.selectedDonors.filter(function(s){return s!==F}),d3.select(this.parentNode).remove(),(d3.select("#pbicliDonorsDropdown").node().value===G[F]||!r.selectedDonors.length)&&S.select("#pbicliDonorsDropdown").select("option").property("selected",!0),S.select("#pbicliDonorsDropdown").selectAll("option").property("disabled",function(s,M){return!M||r.selectedDonors.indexOf(s)>-1}),r.selectedDonors.length||(r.selectedLocalCurrency=null);let w=r.selectedDonors.map(function(s){return n.cbpfsArray.indexOf(s)>-1?G[s]+"@donor":G[s]}).join("|");tt.has("country")?tt.set("country",w):tt.append("country",w);let B=pt(o);V.domain(q(B.donors,B.cbpfs)),Q.domain(q(B.donors,B.cbpfs)),X.domain(gt(B.donors)),Ht(B.cbpfs),At(B.donors),Tt(B.cbpfs)})}function Ze(){Xt.selectAll(".pbicliCheckboxCbpfsDiv").remove();let C=Xt.selectAll(".pbicliSelectedCbpfsDiv").data(r.selectedCbpfs,function(A){return A}),y=C.enter().append("div").attr("class","pbicliSelectedCbpfsDiv"),D=C.exit().remove(),h=y.append("div").attr("class","pbicliSelectedCbpfsDivText").html(function(A){return"<span style='color:"+St(A)+";'>&#9679; </span>"+G[A]}),T=y.append("div").attr("class","pbicliSelectedCbpfsCloseDiv");T.append("span").attr("class","fas fa-times"),T.on("click",function(A){r.selectedCbpfs=r.selectedCbpfs.filter(function(B){return B!==A}),d3.select(this.parentNode).remove(),d3.select("#pbicliCbpfsDropdown").node().value===G[A]&&S.select("#pbicliCbpfsDropdown").select("option").property("selected",!0),S.select("#pbicliCbpfsDropdown").selectAll("option").property("disabled",function(B,s){return!s||r.selectedCbpfs.indexOf(B)>-1});let ot=r.selectedCbpfs.map(function(B){return n.donorsArray.indexOf(B)>-1?G[B]+"@fund":G[B]}).join("|");tt.has("country")?tt.set("country",ot):tt.append("country",ot);let w=pt(o);V.domain(q(w.donors,w.cbpfs)),Q.domain(q(w.donors,w.cbpfs)),X.domain(gt(w.donors)),he(w.donors),At(w.donors),Tt(w.cbpfs)})}function he(C){C.sort(function(s,M){return M.total-s.total});let y=C.map(function(s){return s.isoCode});y.forEach(function(s,M){M>Se&&(_[s]=!1)});let D=d3.values(_);y.unshift("Show All"),Qt.selectAll(".pbicliSelectedDonorsDiv").remove();let h=Qt.selectAll(".pbicliCheckboxDonorsDiv").data(y,function(s){return s}),T=h.exit().remove(),A=h.enter().append("div").attr("class","pbicliCheckboxDonorsDiv"),F=A.append("label"),ot=F.append("input").attr("type","checkbox").attr("value",function(s){return s}),w=F.append("span").attr("class","pbicliCheckboxText").html(function(s){return G[s]?"<span style='color:"+Lt(s)+";'>&#9679; </span>"+G[s]:s});h=A.merge(h),h=h.sort(function(s,M){return y.indexOf(s)-y.indexOf(M)}),h.select("input").property("checked",function(s,M){return!D.every(function(x){return x})&&_[s]});let B=h.filter(function(s){return s==="Show All"}).select("input");d3.select(B.node().nextSibling).classed("pbicliCheckboxTextShowAll",!0),B.property("checked",function(){return D.every(function(s){return s})}),h.selectAll("input").on("change",function(){if(this.value==="Show All"){for(let M in _)_[M]=this.checked;h.selectAll("input").filter(function(M){return M!=="Show All"}).property("checked",!1)}else d3.values(_).every(function(x){return x})&&y.forEach(function(x){_[x]=!1}),_[this.value]=this.checked,B.property("checked",!1);let s=pt(o);V.domain(q(s.donors,s.cbpfs)),X.domain(gt(s.donors)),At(s.donors)})}function Ht(C){C.sort(function(s,M){return M.total-s.total});let y=C.map(function(s){return s.isoCode});y.forEach(function(s,M){M>Se&&(W[s]=!1)});let D=d3.values(W);y.unshift("Show All"),Xt.selectAll(".pbicliSelectedCbpfsDiv").remove();let h=Xt.selectAll(".pbicliCheckboxCbpfsDiv").data(y,function(s){return s}),T=h.exit().remove(),A=h.enter().append("div").attr("class","pbicliCheckboxCbpfsDiv"),F=A.append("label"),ot=F.append("input").attr("type","checkbox").attr("value",function(s){return s}),w=F.append("span").attr("class","pbicliCheckboxText").html(function(s){return G[s]?"<span style='color:"+St(s)+";'>&#9679; </span>"+G[s]:s});h=A.merge(h),h=h.sort(function(s,M){return y.indexOf(s)-y.indexOf(M)}),h.select("input").property("checked",function(s,M){return!D.every(function(x){return x})&&W[s]});let B=h.filter(function(s){return s==="Show All"}).select("input");d3.select(B.node().nextSibling).classed("pbicliCheckboxTextShowAll",!0),B.property("checked",function(){return D.every(function(s){return s})}),h.selectAll("input").on("change",function(){if(this.value==="Show All"){for(let M in W)W[M]=this.checked;h.selectAll("input").filter(function(M){return M!=="Show All"}).property("checked",!1)}else{d3.values(W).every(function(j){return j})&&y.forEach(function(j){W[j]=!1}),W[this.value]=this.checked;let x=d3.values(W);B.property("checked",!1)}let s=pt(o);Q.domain(q(s.donors,s.cbpfs)),Tt(s.cbpfs)})}function At(C){let y=C.filter(function(e){return _[e.isoCode]}),D=JSON.parse(JSON.stringify(y));D.forEach(function(e){e.values=e.values.filter(function(P){return+P.year<=v})});let h=D.filter(function(e){return e.isoCode===It.isoCode}).map(function(e){return e.values.find(function(P){return+P.year===v})});u.transition().duration(k).attr("transform","translate("+E(b(v-1))+",0)"),m.transition().duration(k).attr("width",E(b(v))-E(b(v-1))),u.selectAll("text, tspan").transition().duration(k).attr("x",(E(b(v))-E(b(v-1)))/2);let T=f.main.selectAll(".pbiclilastAllDonorsCircle").data(h),A=T.exit().interrupt("pulseTransition").transition().duration(k).style("opacity",0).remove(),F=T.enter().append("circle").attr("class","pbiclilastAllDonorsCircle").attr("r",0).attr("cx",function(e){return E(b(e.year))}).attr("cy",function(e){return V(e.total)}).style("fill","none").style("stroke-width","1.5px").style("stroke",xt).each(function(){let e=d3.select(this);P();function P(){e.attr("r",0).style("opacity",1).transition("pulseTransition").duration(k*2).ease(d3.easeSin).attr("r",vt*4).style("opacity",0).on("end",P)}});T.transition("positionTransition").duration(k).attr("cx",function(e){return E(b(e.year))}).attr("cy",function(e){return V(e.total)});let ot=f.main.selectAll(".pbicliDonorsGroup").data(D,function(e){return e.isoCode}),w=ot.exit().remove(),B=ot.enter().append("g").attr("class","pbicliDonorsGroup");B.append("path").attr("class","pbicliDonorsPath").style("stroke",function(e){return e.isoCode==="alldonors"?xt:Lt(e.isoCode)}).attr("d",function(e){return qt(e.values.filter(function(P){return+P.year<v}))}).each(function(){ht.set(this,this.getTotalLength())}).style("stroke-dasharray",function(){let e=ht.get(this);return e+" "+e}).style("stroke-dashoffset",function(){return ht.get(this)}).transition().duration(k).style("stroke-dashoffset","0");let M=B.selectAll(null).data(function(e){return e.values}).enter().append("circle").attr("class","pbicliDonorsCircles").attr("r",0).attr("cx",function(e){return E(b(e.year))}).attr("cy",function(e){return V(e.total)}).each(function(e){e.donor=d3.select(this.parentNode).datum().donor,e.isoCode=d3.select(this.parentNode).datum().isoCode}).style("fill",function(e){return e.isoCode==="alldonors"?xt:Lt(e.isoCode)}).transition().delay(function(e,P,et){return P*(k/et.length)}).duration(k/4).attr("r",vt);ot.select("path.pbicliDonorsPath").transition().duration(k).style("stroke-dasharray",null).attr("d",function(e){return qt(e.values.filter(function(P){return+P.year<v}))});let x=ot.selectAll("circle").data(function(e){return e.values}),j=x.exit().remove(),nt=x.enter().append("circle").attr("class","pbicliDonorsCircles").attr("r",0).attr("cx",function(e){return E(b(e.year))}).attr("cy",function(e){return V(e.total)}).each(function(e){e.donor=d3.select(this.parentNode).datum().donor,e.isoCode=d3.select(this.parentNode).datum().isoCode}).style("fill",function(e){return e.isoCode==="alldonors"?xt:Lt(e.isoCode)}).transition().delay(function(e,P,et){return P*(k/et.length)}).duration(k/4).attr("r",vt);x.transition().duration(k).attr("cx",function(e){return E(b(e.year))}).attr("cy",function(e){return V(e.total)});let at=JSON.parse(JSON.stringify(y)).filter(function(e){return e.localCurrency&&e.localCurrency!=="USD"});at.forEach(function(e){e.localData=!0});let ct=JSON.parse(JSON.stringify(at));ct.forEach(function(e){e.values=e.values.filter(function(P){return+P.year<=v})});let a=f.main.selectAll(".pbicliDonorsGroupLocal").data(ct,function(e){return e.isoCode}),Z=a.exit().remove(),it=a.enter().append("g").attr("class","pbicliDonorsGroupLocal").style("opacity",r.showLocal?1:0);it.append("path").attr("class","pbicliDonorsPathLocal").attr("d",function(e){return r.showLocal?Ue(e.values.filter(function(P){return+P.year<v})):qt(e.values.filter(function(P){return+P.year<v}))}).each(function(){ht.set(this,this.getTotalLength())}).style("stroke-dasharray",function(){let e=ht.get(this);return e+" "+e}).style("stroke-dashoffset",function(){return ht.get(this)}).transition().duration(k).style("stroke-dashoffset","0");let Y=it.selectAll(null).data(function(e){return e.values}).enter().append("circle").attr("class","pbicliDonorsCirclesLocal").attr("r",0).attr("cx",function(e){return E(b(e.year))}).attr("cy",function(e){return r.showLocal?X(e.localTotal):V(e.total)}).each(function(e){e.donor=d3.select(this.parentNode).datum().donor}).transition().delay(function(e,P,et){return P*(k/et.length)}).duration(k/4).attr("r",vt);a.transition().duration(k).style("opacity",r.showLocal?1:0),a.select("path.pbicliDonorsPathLocal").transition().duration(k).style("stroke-dasharray",null).attr("d",function(e){return r.showLocal?Ue(e.values.filter(function(P){return+P.year<v})):qt(e.values.filter(function(P){return+P.year<v}))});let Vt=a.selectAll("circle").data(function(e){return e.values}),Qe=Vt.exit().remove(),Wo=Vt.enter().append("circle").attr("class","pbicliDonorsCirclesLocal").attr("r",0).attr("cx",function(e){return E(b(e.year))}).attr("cy",function(e){return r.showLocal?X(e.localTotal):V(e.total)}).each(function(e){e.donor=d3.select(this.parentNode).datum().donor}).transition().delay(function(e,P,et){return P*(k/et.length)}).duration(k/4).attr("r",vt);Vt.transition().duration(k).attr("cx",function(e){return E(b(e.year))}).attr("cy",function(e){return r.showLocal?X(e.localTotal):V(e.total)});let me=y.map(function(e){let P=e.values.filter(function(Bt){return Bt.year<=v.toString()}),et=P[P.length-1];return{name:rt[e.isoCode.toUpperCase()],datum:et,yPos:V(et.total),isoCode:e.isoCode,currency:"USD"}}),Yo=at.map(function(e){let P=e.values.filter(function(Bt){return Bt.year<=v.toString()}),et=P[P.length-1];return{datum:et,yPos:X(et.localTotal),isoCode:e.isoCode,currency:e.localCurrency}});r.showLocal&&(me=me.concat(Yo));let dt=f.main.selectAll(".pbicliLabelsGroupDonors").data(me,function(e){return e.isoCode+e.currency}),Zo=dt.exit().remove(),Kt=dt.enter().append("g").attr("class","pbicliLabelsGroupDonors").style("opacity",0);Kt.attr("transform",function(e){return"translate("+(f.width-f.padding[1]+J)+","+e.yPos+")"}),Kt.append("image").attr("width",Ft).attr("height",Ft).attr("y",-Ft/2).attr("x",0).attr("href",function(e){return e.isoCode&&p[e.isoCode.toLowerCase()]||_t});let _o=Kt.append("polyline").style("stroke-width","1px").style("stroke","#e2e2e2").style("fill","none").attr("points",function(e){return E(b(e.datum.year))-(f.width-f.padding[1]+J)+5+",0 "+(E(b(e.datum.year))-(f.width-f.padding[1]+J)+5)+",0 "+(E(b(e.datum.year))-(f.width-f.padding[1]+J)+5)+",0 "+(E(b(e.datum.year))-(f.width-f.padding[1]+J)+5)+",0"}),Qo=Kt.append("text").attr("class","pbicliLabelTextSmall").attr("x",function(e){return e.isoCode==="alldonors"?2:2+Ft}).attr("y",2).style("fill",function(e){return e.currency==="USD"?"#666":"darkslategray"}).text(function(e){return e.isoCode==="alldonors"?"ALL":"("+e.currency+")"});dt=Kt.merge(dt),dt.select("text").style("opacity",function(e){return e.isoCode==="alldonors"||r.showLocal?1:0}),dt.filter(function(e){return e.isoCode==="alldonors"}).select("text").style("font-size","10px"),dt.raise(),ue(dt.data(),f.height-f.padding[2]),dt=dt.sort(function(e,P){return P.yPos-e.yPos}),dt.transition().duration(k).style("opacity",1).attr("transform",function(e){return"translate("+(f.width-f.padding[1]+J)+","+e.yPos+")"}),dt.select("polyline").style("opacity",0).transition().duration(0).attr("points",function(e,P,et){let Bt=(f.width-f.padding[1]-E(b(e.datum.year)))/et.length;return e.currency==="USD"?E(b(e.datum.year))-(f.width-f.padding[1]+J/2)+","+(V(e.datum.total)-e.yPos)+" "+-(P*Bt+J/2)+","+(V(e.datum.total)-e.yPos)+" "+-(P*Bt+J/2)+",0 "+-se+",0":E(b(e.datum.year))-(f.width-f.padding[1]+J/2)+","+(X(e.datum.localTotal)-e.yPos)+" "+-(P*Bt+J/2)+","+(X(e.datum.localTotal)-e.yPos)+" "+-(P*Bt+J/2)+",0 "+-se+",0"}).on("end",function(){d3.select(this).style("opacity",1)}),dt.on("mouseover",function(e){ft=this;let P=r.showLocal?".pbicliDonorsGroup, .pbicliDonorsGroupLocal, .pbicliLabelsGroupDonors":".pbicliDonorsGroup, .pbicliLabelsGroupDonors";f.main.selectAll(P).filter(function(et){return e.isoCode!==et.isoCode}).style("opacity",Le).attr("filter","url(#pbicliGrayFilter)"),d3.select(this).select("polyline").style("stroke","#888")}).on("mouseout",function(){if(yt)return;ft=null;let e=r.showLocal?".pbicliDonorsGroup, .pbicliDonorsGroupLocal, .pbicliLabelsGroupDonors":".pbicliDonorsGroup, .pbicliLabelsGroupDonors";f.main.selectAll(e).style("opacity",1).attr("filter",null),d3.select(this).select("polyline").style("stroke","#e2e2e2")}),st.transition().duration(k).call(Ye),st.select(".domain").raise(),Ct.transition().duration(k).style("opacity",r.showLocal?1:0).call(Ve),t.text(r.showLocal?r.selectedLocalCurrency:""),st.selectAll(".tick").filter(function(e){return e===0}).remove(),Ct.selectAll(".tick").filter(function(e){return e===0}).remove();let ee=f.main.selectAll(".pbicliRectOverlayDonors").data([!0]);ee=ee.enter().append("rect").attr("class","pbicliRectOverlayDonors").attr("x",f.padding[3]).attr("y",f.padding[0]).attr("height",f.height-f.padding[0]-f.padding[2]).attr("width",f.width-f.padding[1]-f.padding[3]).style("fill","none").attr("pointer-events","all").merge(ee).on("mousemove",function(){ft=this,r.showLocal?ye("donor",f,y.concat(at),E,V):ye("donor",f,y,E,V)}).on("mouseout",function(){yt||(ft=null,_e(f))}),ee.raise()}function Tt(C){let y=C.filter(function(a){return W[a.isoCode]}),D=JSON.parse(JSON.stringify(y));D.forEach(function(a){a.values=a.values.filter(function(Z){return+Z.year<=v})}),R.transition().duration(k).attr("transform","translate("+H(b(v-1))+",0)"),I.transition().duration(k).attr("width",H(b(v))-H(b(v-1))),R.selectAll("text, tspan").transition().duration(k).attr("x",(H(b(v))-H(b(v-1)))/2);let h=g.main.selectAll(".pbicliCbpfsGroup").data(D,function(a){return a.isoCode}),T=h.exit().remove(),A=h.enter().append("g").attr("class","pbicliCbpfsGroup");A.append("path").attr("class","pbicliCbpfsPath").style("stroke",function(a){return St(a.isoCode)}).attr("d",function(a){return Ie(a.values.filter(function(Z){return+Z.year<v}))}).each(function(){ht.set(this,this.getTotalLength())}).style("stroke-dasharray",function(){let a=ht.get(this);return a+" "+a}).style("stroke-dashoffset",function(){return ht.get(this)}).transition().duration(k).style("stroke-dashoffset","0");let ot=A.selectAll(null).data(function(a){return a.values}).enter().append("circle").attr("class","pbicliCbpfsCircles").attr("r",0).attr("cx",function(a){return H(b(a.year))}).attr("cy",function(a){return Q(a.total)}).each(function(a){a.donor=d3.select(this.parentNode).datum().donor,a.isoCode=d3.select(this.parentNode).datum().isoCode}).style("fill",function(a){return St(a.isoCode)}).transition().delay(function(a,Z,it){return Z*(k/it.length)}).duration(k/4).attr("r",vt);h.select("path.pbicliCbpfsPath").transition().duration(k).style("stroke-dasharray",null).attr("d",function(a){return Ie(a.values.filter(function(Z){return+Z.year<v}))});let w=h.selectAll("circle").data(function(a){return a.values}),B=w.exit().remove(),s=w.enter().append("circle").attr("class","pbicliCbpfsCircles").attr("r",0).attr("cx",function(a){return H(b(a.year))}).attr("cy",function(a){return Q(a.total)}).each(function(a){a.donor=d3.select(this.parentNode).datum().donor,a.isoCode=d3.select(this.parentNode).datum().isoCode}).style("fill",function(a){return St(a.isoCode)}).transition().delay(function(a,Z,it){return Z*(k/it.length)}).duration(k/4).attr("r",vt);w.transition().duration(k).attr("cx",function(a){return H(b(a.year))}).attr("cy",function(a){return Q(a.total)});let M=y.map(function(a){let Z=a.values.filter(function(Dt){return Dt.year<=v.toString()}),it=Z[Z.length-1];return{name:rt[a.isoCode.substring(0,2).toUpperCase()],datum:it,yPos:Q(it.total),isoCode:a.isoCode}}),x=g.main.selectAll(".pbicliLabelsGroupCbpfs").data(M,function(a){return a.name}),j=x.exit().remove(),nt=x.enter().append("g").attr("class","pbicliLabelsGroupCbpfs").style("opacity",0);nt.attr("transform",function(a){return"translate("+(g.width-g.padding[1]+J)+","+a.yPos+")"}),nt.append("text").attr("class","pbicliLabelText").attr("y",4).text(function(a){return a.name});let at=nt.append("polyline").style("stroke-width","1px").style("stroke","#e2e2e2").style("fill","none").attr("points",function(a){return H(b(a.datum.year))-(g.width-g.padding[1]+J)+5+",0 "+(H(b(a.datum.year))-(g.width-g.padding[1]+J)+5)+",0 "+(H(b(a.datum.year))-(g.width-g.padding[1]+J)+5)+",0 "+(H(b(a.datum.year))-(g.width-g.padding[1]+J)+5)+",0"});x=nt.merge(x),ue(x.data(),g.height-g.padding[2]),x.raise(),x=x.sort(function(a,Z){return Z.yPos-a.yPos}),x.transition().duration(k).style("opacity",1).attr("transform",function(a){return"translate("+(g.width-g.padding[1]+J)+","+a.yPos+")"}),x.select("polyline").style("opacity",0).transition().duration(0).attr("points",function(a,Z,it){let Dt=(g.width-g.padding[1]-H(b(a.datum.year)))/it.length;return H(b(a.datum.year))-(g.width-g.padding[1]+J/2)+","+(Q(a.datum.total)-a.yPos)+" "+-(Z*Dt+J/2)+","+(Q(a.datum.total)-a.yPos)+" "+-(Z*Dt+J/2)+",0 "+-se+",0"}).on("end",function(){d3.select(this).style("opacity",1)}),x.on("mouseover",function(a,Z){ft=this,g.main.selectAll(".pbicliCbpfsGroup, .pbicliLabelsGroupCbpfs").filter(function(it){return a.isoCode!==it.isoCode}).style("opacity",Le).attr("filter","url(#pbicliGrayFilter)"),d3.select(this).select("polyline").style("stroke","#888")}).on("mouseout",function(){yt||(ft=null,g.main.selectAll(".pbicliCbpfsGroup, .pbicliLabelsGroupCbpfs").style("opacity",1).attr("filter",null),d3.select(this).select("polyline").style("stroke","#e2e2e2"))}),K.transition().duration(k).call(He),K.select(".domain").raise(),K.selectAll(".tick").filter(function(a){return a===0}).remove();let ct=g.main.selectAll(".pbicliRectOverlayCbpfs").data([!0]);ct=ct.enter().append("rect").attr("class","pbicliRectOverlayCbpfs").attr("x",g.padding[3]).attr("y",g.padding[0]).attr("height",g.height-g.padding[0]-g.padding[2]).attr("width",g.width-g.padding[1]-g.padding[3]).style("fill","none").attr("pointer-events","all").merge(ct).on("mousemove",function(){ft=this,ye("cbpf",g,y,H,Q)}).on("mouseout",function(){yt||(ft=null,_e(g))}),ct.raise()}function ye(C,y,D,h,T){if(!D.length)return;let A=C==="donor"?"contributionColorHTMLcolor":"allocationColorHTMLcolor",F=d3.mouse(y.main.node()),ot=d3.mouse(S.node()),w=d3.timeMonth.offset(h.invert(F[0]),6).getFullYear().toString(),B=C==="donor"?260:220;r.showLocal&&C==="donor"&&(B+=50);let s=[],M=C==="donor"?Lt:St;if(D.forEach(function(x){let j=x.localCurrency===void 0?!1:x.localData?x.localCurrency:"USD",nt=!!x.localData,at=x.values.find(function(ct){return ct.year===w});at&&at.total>0&&s.push({name:x.isoCode,total:nt?at.localTotal:at.total,year:w,type:C,local:nt,localCurrency:j})}),s.sort(function(x,j){if(+x.total&&+j.total)return j.total-x.total;if(+x.total!=+x.total&&+j.total==+j.total)return 1;if(+j.total!=+j.total&&+x.total==+x.total)return-1}),s.length){let x=s.length>1?C.charAt(0).toUpperCase()+C.slice(1)+"s":C.charAt(0).toUpperCase()+C.slice(1),j;j="<div style='margin:0px;display:flex;flex-wrap:wrap;align-items:flex-end;width:"+B+"px;'><div style='display:flex;flex:0 100%;'><span>"+x+" in <strong>"+w+"</strong>:</span></div><div style='height:8px;display:flex;flex:0 100%;'></div>";for(let Y=0;Y<s.length;Y++){let Vt=C==="donor"&&r.showLocal?" ("+s[Y].localCurrency+")":"",Qe=C==="donor"&&s[Y].localCurrency!=="USD"?"darkslategray":s[Y].name==="alldonors"?xt:M(s[Y].name);j+="<div style='display:flex;flex:0 60%;'><span style='color:"+Qe+";'>&#9679;&nbsp;</span>"+G[s[Y].name]+Vt+":</div><div style='display:flex;flex:0 40%;justify-content:flex-end;'><span class='"+A+"'>"+eo(s[Y].total)+"</span></div>"}j+="</div>";let nt=y.main.selectAll(".pbicliTooltipGroup").data([!0]),at=nt.enter().insert("g",C==="donor"?":nth-child(4)":":nth-child(3)").attr("class","pbicliTooltipGroup").attr("pointer-events","none"),ct=nt.selectAll(".pbicliTooltipLines").data([!0]);ct=ct.enter().append("line").attr("class","pbicliTooltipLines").style("stroke-width","1px").style("stroke","#ccc").merge(ct).attr("x1",function(Y){return h(b(w))}).attr("x2",function(Y){return h(b(w))}).attr("y1",y.padding[0]).attr("y2",y.height-y.padding[2]);let a=nt.selectAll(".pbicliTooltipCircles").data(s.filter(function(Y){return Y.total!=="n/a"}),function(Y){return Y.name}),Z=a.exit().remove(),it=a.enter().append("circle").attr("class","pbicliTooltipCircles").attr("r",vt+2).style("fill","none").style("stroke",function(Y){return C==="cbpf"?St(Y.name):Y.local?"darkslategray":Y.name==="alldonors"?xt:Lt(Y.name)}).merge(a).attr("cx",function(Y){return h(b(Y.year))}).attr("cy",function(Y){return Y.local?X(Y.total):T(Y.total)});Pt.style("display","block");let Dt=Pt.node().getBoundingClientRect();Pt.html(j).style("top",ot[1]-Dt.height/2+"px").style("left",F[0]>y.width-16-Dt.width&&C==="cbpf"?ot[0]-Dt.width-16+"px":ot[0]+16+"px")}else Pt.style("display","none"),y.main.select(".pbicliTooltipGroup").remove()}function _e(C){yt||(Pt.style("display","none"),C.main.select(".pbicliTooltipGroup").remove())}}function Po(o){let n=["Select an option","All Donors","Top 5 donors"].concat(o),p=de.append("p").attr("class","pbicliDropdownLabel").html("Donor:"),l=de.append("select").attr("id","pbicliDonorsDropdown").selectAll(null).data(n).enter().append("option").property("disabled",function(t,i){return!i||r.selectedDonors.indexOf(t)>-1}).property("selected",function(t,i){return r.selectedDonors.length?t===r.selectedDonors[r.selectedDonors.length-1]:!i}).html(function(t,i){return i<3?t:G[t]})}function pe(o,n){let p=n?["Select an option","All Donors","Top 5 donors"].concat(o):["Select an option"].concat(o),c=de.select("select");c.selectAll("option").remove();let l=c.selectAll(null).data(p).enter().append("option").property("disabled",function(t,i){return!i||(t==="All Donors"?r.selectedDonors.indexOf("alldonors")>-1:r.selectedDonors.indexOf(t)>-1)}).property("selected",function(t,i){return!i}).html(function(t,i){return n?i<3?t:G[t]:i?G[t]:t})}function Lo(o){let n=Fe.append("p").attr("class","pbicliDropdownLabel").html("Currency:"),c=Fe.append("select").attr("id","pbicliCurrencyDropdown").selectAll(null).data(o).enter().append("option").property("selected",function(l,t){return!t}).html(function(l){return l==="USD"?"USD (all donors)":l})}function So(o){let n=["Select an option","Top 5 CBPFs"].concat(o),p=Me.append("p").attr("class","pbicliDropdownLabel").html("CBPF:"),l=Me.append("select").attr("id","pbicliCbpfsDropdown").selectAll(null).data(n).enter().append("option").property("disabled",function(t,i){return!i||r.selectedCbpfs.indexOf(t)>-1}).property("selected",function(t,i){return r.selectedCbpfs.length?t===r.selectedCbpfs[r.selectedCbpfs.length-1]:!i}).html(function(t,i){return i<2?t:G[t]})}function To(){let o=["USD","Local Currency"],n=Et.selectAll(null).data(o).enter().append("label").attr("class","pbicliRadioButtons").style("cursor","pointer");n.append("input").attr("type","radio").attr("name","pbicliradiobutton").attr("value",function(p,c){return c?"local":"usd"}).property("checked",function(p,c){return!c}),n.append("span").attr("class","pbicliRadioLabel").text(function(p){return p})}function $t(){let o=r.selectedDonors.length>1?"donors":"donor",n=r.selectedCbpfs.length>1?"CBPFs":"CBPF",p=Co.selectAll(".pbicliDonorsTopLegend").data([!0]);p=p.enter().append("p").attr("class","pbicliDonorsTopLegend").merge(p).html(r.controlledBy!=="cbpf"?"Selected "+o+":":"Donors "),r.controlledBy==="cbpf"&&p.append("span").attr("class","pbicliDonorsTopLegendSubtext").html("&rarr; shows donors that donated to the selected "+n+". Click to show/hide:");let c=Ao.selectAll(".pbicliCbpfsTopLegend").data([!0]);c=c.enter().append("p").attr("class","pbicliCbpfsTopLegend").merge(c).html(r.controlledBy!=="donor"?"Selected "+n+":":"CBPFs "),r.controlledBy==="donor"&&c.append("span").attr("class","pbicliCbpfsTopLegendSubtext").html("&rarr; shows CBPFs that received from the selected "+o+". Click to show/hide:")}function Bo(){let o="\xA9 OCHA CBPF Section "+v;fo&&(o+=" | For more information, please visit <a href='https://cbpf.data.unocha.org'>cbpf.data.unocha.org</a>"),Do.append("div").attr("class","d3chartFooterText").html(o)}function Oo(o){let n={yearsArray:[],currenciesArray:[],donorsArray:[],cbpfsArray:[]},p={yearsArray:"FiscalYear",currenciesArray:"PaidAmtLocalCurrency",donorsArray:"GMSDonorISO2Code",cbpfsArray:"PooledFundISO2Code"},c={donorsTotals:{},cbpfsTotals:{}},l=Object.keys(n);o.forEach(function(i){ko(i),i.GMSDonorISO2Code=i.GMSDonorISO2Code.toLowerCase(),i.PooledFundISO2Code=i.PooledFundName.includes("Closed")?i.PooledFundISO2Code.toLowerCase()+"closed":i.PooledFundISO2Code.toLowerCase(),l.forEach(function(u){n[u].indexOf(i[p[u]].trim())===-1&&i[p[u]]!==""&&n[u].push(i[p[u]].trim())}),(!kt[i.GMSDonorISO2Code]||i.PaidAmtLocalCurrency.trim()!=="USD")&&(kt[i.GMSDonorISO2Code]=i.PaidAmtLocalCurrency.trim()),G[i.GMSDonorISO2Code]||(G[i.GMSDonorISO2Code]=i.GMSDonorName),G[i.PooledFundISO2Code]||(G[i.PooledFundISO2Code]=i.PooledFundName),_[i.GMSDonorISO2Code]||(_[i.GMSDonorISO2Code]=!0),W[i.PooledFundISO2Code]||(W[i.PooledFundISO2Code]=!0),c.donorsTotals[i.GMSDonorISO2Code]===void 0?c.donorsTotals[i.GMSDonorISO2Code]=+i.PaidAmt:c.donorsTotals[i.GMSDonorISO2Code]+=+i.PaidAmt,c.cbpfsTotals[i.PooledFundISO2Code]===void 0?c.cbpfsTotals[i.PooledFundISO2Code]=+i.PaidAmt:c.cbpfsTotals[i.PooledFundISO2Code]+=+i.PaidAmt}),G.mk="Macedonia",n.yearsArray.sort(function(i,u){return+i-+u}),n.currenciesArray.sort();let t=n.currenciesArray.indexOf("USD");return n.currenciesArray.splice(t,1),n.currenciesArray.unshift("USD"),n.donorsArray.sort(function(i,u){return c.donorsTotals[u]-c.donorsTotals[i]}),n.cbpfsArray.sort(function(i,u){return c.cbpfsTotals[u]-c.cbpfsTotals[i]}),n}function pt(o){let n={donors:[],cbpfs:[]},p=r.controlledBy==="donor"?"GMSDonorISO2Code":"PooledFundISO2Code",c=r.controlledBy==="donor"?r.selectedDonors:r.selectedCbpfs;o.forEach(function(t){if(c.indexOf(t[p])>-1){let i=n.donors.find(function(m){return m.donor===t.GMSDonorName}),u=n.cbpfs.find(function(m){return m.cbpf===t.PooledFundName});if(i){let m=i.values.find(function(O){return O.year===t.FiscalYear});m?(m.paid+=+t.PaidAmt,m.pledge+=+t.PledgeAmt,m.total+=+t.PaidAmt+ +t.PledgeAmt,m.localPaid+=+t.PaidAmtLocal,m.localPledge+=+t.PledgeAmtLocal,m.localTotal+=+t.PaidAmtLocal+ +t.PledgeAmtLocal):i.values.push({year:t.FiscalYear,paid:+t.PaidAmt,pledge:+t.PledgeAmt,total:+t.PaidAmt+ +t.PledgeAmt,localPaid:+t.PaidAmtLocal,localPledge:+t.PledgeAmtLocal,localTotal:+t.PaidAmtLocal+ +t.PledgeAmtLocal}),i.total+=+t.PaidAmt+ +t.PledgeAmt}else n.donors.push({donor:t.GMSDonorName,isoCode:t.GMSDonorISO2Code,localCurrency:t.PaidAmtLocalCurrency.trim(),total:+t.PaidAmt+ +t.PledgeAmt,values:[{year:t.FiscalYear,paid:+t.PaidAmt,pledge:+t.PledgeAmt,total:+t.PaidAmt+ +t.PledgeAmt,localPaid:+t.PaidAmtLocal,localPledge:+t.PledgeAmtLocal,localTotal:+t.PaidAmtLocal+ +t.PledgeAmtLocal}]});if(u){let m=u.values.find(function(O){return O.year===t.FiscalYear});m?(m.paid+=+t.PaidAmt,m.pledge+=+t.PledgeAmt,m.total+=+t.PaidAmt+ +t.PledgeAmt,m.localPaid+=+t.PaidAmtLocal,m.localPledge+=+t.PledgeAmtLocal,m.localTotal+=+t.PaidAmtLocal+ +t.PledgeAmtLocal):u.values.push({year:t.FiscalYear,paid:+t.PaidAmt,pledge:+t.PledgeAmt,total:+t.PaidAmt+ +t.PledgeAmt,localPaid:+t.PaidAmtLocal,localPledge:+t.PledgeAmtLocal,localTotal:+t.PaidAmtLocal+ +t.PledgeAmtLocal}),u.total+=+t.PaidAmt+ +t.PledgeAmt}else n.cbpfs.push({cbpf:t.PooledFundName,isoCode:t.PooledFundISO2Code.toLowerCase(),total:+t.PaidAmt+ +t.PledgeAmt,values:[{year:t.FiscalYear,paid:+t.PaidAmt,pledge:+t.PledgeAmt,total:+t.PaidAmt+ +t.PledgeAmt,localPaid:+t.PaidAmtLocal,localPledge:+t.PledgeAmtLocal,localTotal:+t.PaidAmtLocal+ +t.PledgeAmtLocal}]})}}),c.indexOf("alldonors")>-1&&(n.donors.push(It),n.cbpfs.length=0,n.cbpfs=[],o.forEach(function(t){let i=n.cbpfs.find(function(u){return u.cbpf===t.PooledFundName});if(i){let u=i.values.find(function(m){return m.year===t.FiscalYear});u?(u.paid+=+t.PaidAmt,u.pledge+=+t.PledgeAmt,u.total+=+t.PaidAmt+ +t.PledgeAmt,u.localPaid+=+t.PaidAmtLocal,u.localPledge+=+t.PledgeAmtLocal,u.localTotal+=+t.PaidAmtLocal+ +t.PledgeAmtLocal):i.values.push({year:t.FiscalYear,paid:+t.PaidAmt,pledge:+t.PledgeAmt,total:+t.PaidAmt+ +t.PledgeAmt,localPaid:+t.PaidAmtLocal,localPledge:+t.PledgeAmtLocal,localTotal:+t.PaidAmtLocal+ +t.PledgeAmtLocal}),i.total+=+t.PaidAmt+ +t.PledgeAmt}else n.cbpfs.push({cbpf:t.PooledFundName,isoCode:t.PooledFundISO2Code.toLowerCase(),total:+t.PaidAmt+ +t.PledgeAmt,values:[{year:t.FiscalYear,paid:+t.PaidAmt,pledge:+t.PledgeAmt,total:+t.PaidAmt+ +t.PledgeAmt,localPaid:+t.PaidAmtLocal,localPledge:+t.PledgeAmtLocal,localTotal:+t.PaidAmtLocal+ +t.PledgeAmtLocal}]})})),n.donors.forEach(function(t){l(t.values)}),n.cbpfs.forEach(function(t){l(t.values)});function l(t){if(t.length===1){let i=+t[0].year;[i-1,i+1].forEach(function(u){t.push({year:u.toString(),paid:0,pledge:0,total:0,localPaid:0,localPledge:0,localTotal:0})}),t.sort(function(u,m){return+u.year-+m.year})}else{let i=t[0].year,u=t[t.length-1].year;d3.range(+i,+u,1).forEach(function(O){t.find(function(I){return I.year===O.toString()})||t.push({year:O.toString(),paid:0,pledge:0,total:0,localPaid:0,localPledge:0,localTotal:0})}),t.sort(function(O,R){return+O.year-+R.year})}}return n}function ko(o){It.total+=+o.PaidAmt+ +o.PledgeAmt;let n=It.values.find(function(p){return p.year===o.FiscalYear});n?(n.paid+=+o.PaidAmt,n.pledge+=+o.PledgeAmt,n.total+=+o.PaidAmt+ +o.PledgeAmt):It.values.push({year:o.FiscalYear,paid:+o.PaidAmt,pledge:+o.PledgeAmt,total:+o.PaidAmt+ +o.PledgeAmt})}function ue(o,n,p){if(o.length<2)return;o.sort(function(l,t){return t.yPos-l.yPos});for(let l=0;l<o.length-1;l++)if(c(o[l],o[l+1]))for(;c(o[l],o[l+1]);)l===0&&(o[l].yPos=Math.min(n,o[l].yPos+1)),o[l+1].yPos-=1;o.forEach(function(l,t,i){i[t+1]&&i[t+1].yPos>i[t].yPos-ae&&ue(o,n,p)});function c(l,t){return!(l.yPos+ae<t.yPos||l.yPos>t.yPos+ae)}}function Go(o){o=o.filter(function(p){return p<=v});let n=d3.extent(o.map(function(p){return b(p)}));return n[0]=d3.timeMonth.offset(n[0],-Pe),n[1]=d3.timeMonth.offset(n[1],Pe),n}function q(o,n){let p=d3.max(o,function(l){return d3.max(l.values,function(t){return+t.year>+v?0:t.total})}),c=d3.max(n,function(l){return d3.max(l.values,function(t){return+t.year>+v?0:t.total})});return p===void 0&&c===void 0?[0,Zt]:[0,Math.max(p||0,c||0)*1.05]}function gt(o){return[0,d3.max(o,function(p){return d3.max(p.values,function(c){return+c.year>+v?0:c.localTotal})})*1.05]}function Fo(o,n,p){if(!o||o.toLowerCase()==="none")return;let c=o.split(",").map(function(t){return t.trim().toLowerCase()}),l=Object.keys(G);c.forEach(function(t){let i=t.split("@");if(i.length===1){let u=l.find(function(O){return G[O].toLowerCase()===i[0]&&n.indexOf(O)>-1}),m=l.find(function(O){return G[O].toLowerCase()===i[0]&&p.indexOf(O)>-1});i[0]==="all donors"&&r.selectedDonors.push("alldonors"),u&&r.selectedDonors.push(u),m&&r.selectedCbpfs.push(m)}else if(i[1]==="donor"){let u=l.find(function(m){return G[m].toLowerCase()===i[0]&&n.indexOf(m)>-1});u&&r.selectedDonors.push(u)}else if(i[1]==="fund"){let u=l.find(function(m){return G[m].toLowerCase()===i[0]&&p.indexOf(m)>-1});u&&r.selectedCbpfs.push(u)}}),r.selectedDonors.length&&r.selectedCbpfs.length&&(r.selectedDonors.length=0,r.selectedCbpfs.length=0)}function Mo(){let n=S.append("div").attr("class","pbicliOverDiv").append("div").attr("id","pbiclialertdiv");n.append("div").html("All donor countries must have the same currency for choosing \u201Clocal currency\u201D. Do you wish to clear the current selection?");let c=n.append("div").attr("class","pbiclialertdivcontainer").selectAll(null).data(["YES","NO"]).enter().append("div").attr("class","pbiclialertyesorno").html(function(l){return l})}function Eo(){let o=S.append("div").attr("class","pbicliOverDiv");o.append("div").attr("id","pbiclialertdiv").append("div").html("Please select a donor with the same local currency of the previously selected donors<br><br>(click anywhere to close)"),o.on("click",function(){o.remove()})}function Je(){mt.style("opacity",0).style("pointer-events","none");let o=S.append("div").attr("class","pbicliOverDivHelp"),n=Mt.node().getBoundingClientRect(),p=n.height*(L/n.width),c=Ut.node().getBoundingClientRect(),l=mt.node().getBoundingClientRect(),t=c.height*(L/c.width),i=o.append("svg").attr("viewBox","0 0 "+L+" "+(Gt+p)),u=[{text:"CLOSE",width:90},{text:"GO TO HELP PORTAL",width:180}],m=i.selectAll(null).data(u).enter().append("g");m.append("rect").attr("rx",4).attr("ry",4).style("stroke","rgba(0, 0, 0, 0.3)").style("stroke-width","1px").style("fill",ro).style("cursor","pointer").attr("y",6).attr("height",22).attr("width",function(z){return z.width}).attr("x",function(z,K){return L-U[1]-z.width-(K?u[0].width+8:0)}).on("click",function(z,K){mt.style("opacity",1).style("pointer-events","all"),o.remove(),K&&window.open(so,"help_portal")}),m.append("text").attr("class","pbicliAnnotationMainText").attr("text-anchor","middle").attr("x",function(z,K){return L-U[1]-z.width/2-(K?u[0].width+8:0)}).attr("y",22).text(function(z){return z.text});let O="Click on the \u201Cx\u201D to deselect a donor or CBPF. This affects the total value.",R="Click on the checkbox to deselect a donor or CBPF. This does not affects the total value.";[{x:31,y:10+t,width:146,height:46,xTooltip:31*(c.width/L),yTooltip:(t+68)*(c.width/L),text:"Use this menu to select one or more donors. When donors are selected here the values of all displayed CBPFs correspond to donations made only by those selected donors."},{x:182,y:10+t,width:146,height:46,xTooltip:182*(c.width/L),yTooltip:(t+68)*(c.width/L),text:"Use this menu to select donors by their currencies. This is useful before selecting \u201Clocal currency\u201D in the radio buttons below."},{x:478,y:10+t,width:146,height:46,xTooltip:478*(c.width/L),yTooltip:(t+68)*(c.width/L),text:"Use this menu to select one or more CBPFs. When CBPFs are selected the values of all donors correspond to donations made only to those CBPFs."},{x:31,y:60+t,width:150,height:20,xTooltip:31*(c.width/L),yTooltip:(t+92)*(c.width/L),text:"Use these radio buttons to show the donations in USD or in the donor's local currency. This option is not available when CBPFs are selected, and also not available when the selected donors have different local currencies."},{x:31,y:86+t,width:430,height:p-t-86,xTooltip:31*(c.width/L),yTooltip:p+12,text:r.controlledBy==="donor"?O:R},{x:466,y:86+t,width:430,height:p-t-86,xTooltip:466*(c.width/L),yTooltip:p+12,text:r.controlledBy==="donor"?R:O}].forEach(function(z){i.append("rect").attr("rx",4).attr("ry",4).attr("x",z.x).attr("y",z.y).attr("width",z.width).attr("height",z.height).style("stroke",xt).style("stroke-width","3px").style("fill","none").style("opacity",.5).attr("class","pbicliHelpRectangle").attr("pointer-events","all").on("mouseover",function(){let K=this;st(z.xTooltip,z.yTooltip,z.text,K)}).on("mouseout",Ct)});let d=i.append("rect").attr("x",L/2-180).attr("y",p+40).attr("width",360).attr("height",50).attr("pointer-events","none").style("fill","white").style("stroke","#888"),N=i.append("text").attr("class","pbicliAnnotationExplanationText").attr("font-family","Roboto").attr("font-size","18px").style("fill","#222").attr("text-anchor","middle").attr("x",L/2).attr("y",p+60).attr("pointer-events","none").text("Hover over the elements surrounded by a blue rectangle to get additional information").call(Ro,350);function st(z,K,$,Nt){N.style("opacity",0),d.style("opacity",0),i.selectAll(".pbicliHelpRectangle").style("opacity",.1),d3.select(Nt).style("opacity",1);let Yt=S.node().getBoundingClientRect();Pt.style("top",K+"px").style("left",z+"px").style("display","block").html($)}function Ct(){Pt.style("display","none"),N.style("opacity",1),d.style("opacity",1),i.selectAll(".pbicliHelpRectangle").style("opacity",.5)}}function wo(o,n){if(!r.selectedDonors.length&&!r.selectedCbpfs.length)return;let p=No(o,n),l="ContributionTrends_"+ie(new Date)+".csv",t=new Blob([p],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(t,filename);else{let i=document.createElement("a");if(i.download!==void 0){let u=URL.createObjectURL(t);i.setAttribute("href",u),i.setAttribute("download",l),i.style="visibility:hidden",document.body.appendChild(i),i.click(),document.body.removeChild(i)}}}function No(o,n){let p=[],c=[];for(let d in _)_[d]&&p.push(d);for(let d in W)W[d]&&c.push(d);let l=r.controlledBy==="donor"?o.donors.map(function(d){return d.isoCode}):p,t=r.controlledBy==="cbpf"?o.cbpfs.map(function(d){return d.isoCode}):c,i=[];l.indexOf("alldonors")>-1&&n.forEach(function(d){let N=i.find(function(st){return st["CBPF Name"]===d.PooledFundName&&st.Year===+d.FiscalYear});N?(N["Paid Amount"]+=Math.round(+d.PaidAmt*100)/100,N["Pledged Amount"]+=Math.round(+d.PledgeAmt*100)/100,N["Total Contributions"]+=Math.round((+d.PledgeAmt+ +d.PaidAmt)*100)/100):i.push({Year:+d.FiscalYear,"Donor Name":"All Donors","CBPF Name":d.PooledFundName,"Paid Amount":Math.round(+d.PaidAmt*100)/100,"Pledged Amount":Math.round(+d.PledgeAmt*100)/100,"Total Contributions":Math.round((+d.PledgeAmt+ +d.PaidAmt)*100)/100,"Paid Amount (Local Currency)":"n/a","Pledged Amount (Local Currency)":"n/a","Total Contributions (Local Currency)":"n/a","Exchange Rate":"n/a","Local Currency":"n/a"})});let u=n.filter(function(d){return l.indexOf(d.GMSDonorISO2Code.toLowerCase())>-1&&t.indexOf(d.PooledFundISO2Code.toLowerCase())>-1}),m=JSON.parse(JSON.stringify(u));m.forEach(function(d){d.Year=+d.FiscalYear,d["Donor Name"]=d.GMSDonorName,d["CBPF Name"]=d.PooledFundName,d["Paid Amount"]=Math.round(+d.PaidAmt*100)/100,d["Pledged Amount"]=Math.round(+d.PledgeAmt*100)/100,d["Total Contributions"]=Math.round((+d.PledgeAmt+ +d.PaidAmt)*100)/100,d["Paid Amount (Local Currency)"]=Math.round(+d.PaidAmtLocal*100)/100,d["Pledged Amount (Local Currency)"]=Math.round(+d.PledgeAmtLocal*100)/100,d["Total Contributions (Local Currency)"]=Math.round((+d.PledgeAmtLocal+ +d.PaidAmtLocal)*100)/100,d["Exchange Rate"]=+d.PaidAmtCurrencyExchangeRate,d["Local Currency"]=d.PaidAmtLocalCurrency,delete d.FiscalYear,delete d.GMSDonorName,delete d.PooledFundName,delete d.PaidAmt,delete d.PledgeAmt,delete d.PaidAmtLocal,delete d.PledgeAmtLocal,delete d.PaidAmtCurrencyExchangeRate,delete d.PaidAmtLocalCurrency,delete d.PledgeAmtCurrencyExchangeRate,delete d.PledgeAmtLocalCurrency,delete d.GMSDonorISO2Code,delete d.PooledFundISO2Code}),l.indexOf("alldonors")>-1&&(m=i.concat(m)),m.sort(function(d,N){return+N.Year-+d.Year||(d["Donor Name"].toLowerCase()<N["Donor Name"].toLowerCase()?-1:d["Donor Name"].toLowerCase()>N["Donor Name"].toLowerCase()?1:0)||(d["CBPF Name"].toLowerCase()<N["CBPF Name"].toLowerCase()?-1:d["CBPF Name"].toLowerCase()>N["CBPF Name"].toLowerCase()?1:0)});let O=Object.keys(m[0]),R=function(d,N){return N===null?"":N},I=m.map(function(d){return O.map(function(N){return JSON.stringify(d[N],R)}).join(",")});return I.unshift(O.join(",")),I.join(`\r
`)}function Ro(o,n){o.each(function(){let p=d3.select(this),c=p.text().split(/\s+/).reverse(),l,t=[],i=0,u=1.1,m=p.attr("y"),O=p.attr("x"),R=0,I=p.text(null).append("tspan").attr("x",O).attr("y",m).attr("dy",R+"em");for(;l=c.pop();)t.push(l),I.text(t.join(" ")),I.node().getComputedTextLength()>n&&(t.pop(),I.text(t.join(" ")),t=[l],I=p.append("tspan").attr("x",O).attr("y",m).attr("dy",++i*u+R+"em").text(l))})}function te(o,n){if(be){alert("This functionality is not supported by Internet Explorer");return}let c=d3.select("body").append("div").style("position","fixed").attr("id","pbicliDownloadingDiv").style("left",window.innerWidth/2-100+"px").style("top",window.innerHeight/2-100+"px").append("svg").attr("class","pbicliDownloadingDivSvg").attr("width",200).attr("height",100),l="Downloading "+o.toUpperCase();We(c,200,175,l);let t=bt.node().getBoundingClientRect();bt.attr("width",t.width).attr("height",t.height);let i=["font-size","font-family","font-weight","fill","stroke","stroke-dasharray","stroke-width","opacity","text-anchor","text-transform","shape-rendering","letter-spacing","white-space"],u=S.node();m(bt.node()),o==="png"?mt.style("opacity",0):Ut.style("opacity",0),wt.style("display","none"),html2canvas(u).then(function(O){bt.attr("width",null).attr("height",null),o==="png"?mt.style("opacity",1):Ut.style("opacity",1),o==="png"?Io(O):Uo(O),n&&ft&&d3.select(ft).dispatch("mouseout")});function m(O){if(!O.style)return;let R=getComputedStyle(O);for(let I=0;I<i.length;I++)O.style[i[I]]=R[i[I]];for(let I=0;I<O.childNodes.length;I++)m(O.childNodes[I])}}function Io(o){let p="ContributionTrends_"+ie(new Date)+".png";o.toBlob(function(c){let l=URL.createObjectURL(c),t=document.createElement("a");t.download!==void 0?(t.setAttribute("href",l),t.setAttribute("download",p),t.style="visibility:hidden",document.body.appendChild(t),t.click(),document.body.removeChild(t)):window.location.href=l}),fe(),d3.select("#pbicliDownloadingDiv").remove()}function Uo(o){let n={top:10,bottom:16,left:20,right:30};d3.image("https://raw.githubusercontent.com/CBPFGMS/cbpfgms.github.io/master/img/assets/bilogo.png").then(function(p){let c,l=new jsPDF;I();let t=l.splitTextToSize("Since the first CBPF was opened in Angola in 1997, donors have contributed more than $6 billion to 27 funds operating in the most severe and complex emergencies around the world. In 2018, donors contributed a record $882 million to CBPFs in 18 countries.",210-n.left-n.right,{fontSize:12}),i=d3.timeFormat("%A, %d %B %Y")(new Date);l.setTextColor(60),l.setFont("helvetica"),l.setFontType("normal"),l.setFontSize(12),l.text(n.left,48,t),l.setTextColor(65,143,222),l.setFont("helvetica"),l.setFontType("bold"),l.setFontSize(16),l.text(Oe,n.left,71),l.setFontSize(12);let u=d();l.fromHTML("<div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>Date: <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+i+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+u.split("-")[0]+": <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+u.split("-")[1]+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>Currency : <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+(r.selectedLocalCurrency?r.selectedLocalCurrency:"USD")+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>Period : <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+Be[0]+" to "+v+"</span></div>",n.left,77,{width:210-n.left-n.right},function(N){c=N});let m=S.node().getBoundingClientRect(),O=210-n.left*2;l.addImage(o,"PNG",n.left,c.y+2,O,O*(m.height/m.width));let R=new Date;l.save("ContributionTrends_"+ie(R)+".pdf"),fe(),d3.select("#pbicliDownloadingDiv").remove();function I(){let N="\xA9 OCHA CBPF Section "+v+" | For more information, please visit cbpf.data.unocha.org";l.setFillColor(65,143,222),l.rect(0,n.top,210,15,"F"),l.setFillColor(236,161,84),l.rect(0,n.top+15,210,2,"F"),l.setFillColor(255,255,255),l.rect(n.left,n.top-1,94,20,"F"),l.ellipse(n.left,n.top+9,5,9,"F"),l.ellipse(n.left+94,n.top+9,5,9,"F"),l.addImage(p,"PNG",n.left+2,n.top,90,18),l.setFillColor(236,161,84),l.rect(0,297-n.bottom,210,2,"F"),l.setTextColor(60),l.setFont("arial"),l.setFontType("normal"),l.setFontSize(10),l.text(N,n.left,297-n.bottom+10)}function d(){let N=r.controlledBy==="donor"?"selectedDonors":"selectedCbpfs",st=r.controlledBy==="donor"?"Donor":"CBPF",Ct=r[N].length===1?"":"s",z=r[N].map(function(K){return G[K]}).sort(function(K,$){return K.toLowerCase()<$.toLowerCase()?-1:K.toLowerCase()>$.toLowerCase()?1:0}).reduce(function(K,$,Nt){return K+(Nt>=r[N].length-2?Nt>r[N].length-2?$:$+" and ":$+", ")},"");return"Selected "+st+Ct+"-"+z}})}function We(o,n,p,c){let l=o.append("g").attr("class","pbiclid3chartwheelGroup").attr("transform","translate("+n/2+","+p/4+")"),t=l.append("text").attr("text-anchor","middle").style("font-family","Roboto").style("font-weight","bold").style("font-size","11px").attr("y",50).attr("class","contributionColorFill").text(c),i=d3.arc().outerRadius(25).innerRadius(20),u=l.append("path").datum({startAngle:0,endAngle:0}).classed("contributionColorFill",!0).attr("d",i);m();function m(){u.transition().duration(1e3).attrTween("d",function(R){let I=d3.interpolate(0,Math.PI*2);return function(d){return R.endAngle=I(d),i(R)}}).on("end",O)}function O(){u.transition().duration(1e3).attrTween("d",function(R){let I=d3.interpolate(0,Math.PI*2);return function(d){return R.startAngle=I(d),i(R)}}).on("end",function(R){R.startAngle=0,m()})}}function fe(){let o=d3.select(".pbiclid3chartwheelGroup");o.select("path").interrupt(),o.remove()}}})();})();
