(()=>{(function(){let $t=window.navigator.userAgent.indexOf("MSIE")>-1||window.navigator.userAgent.indexOf("Trident")>-1,Ht=window.fetch,Vt=window.URLSearchParams,je=window.matchMedia("(pointer: coarse)").matches&&!window.matchMedia("(any-pointer: fine)").matches,Ut=window.location.hostname==="cbpf.data.unocha.org",de=window.location.hostname+window.location.pathname==="cbpf.data.unocha.org/bookmark.html",pe="https://use.fontawesome.com/releases/v5.6.3/css/all.css",We=["https://cbpfgms.github.io/css/d3chartstyles.css","https://cbpfgms.github.io/css/d3chartstylespbiclc.css",pe],Ft="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js",ue="https://cbpfgms.github.io/libraries/html2canvas.min.js",fe="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js",zt="https://cdn.jsdelivr.net/npm/@ungap/url-search-params@0.1.2/min.min.js",he="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js",ge="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.4/fetch.min.js";if(We.forEach(function(Z){if(!Ke(Z)){let m=document.createElement("link");m.setAttribute("rel","stylesheet"),m.setAttribute("type","text/css"),m.setAttribute("href",Z),Z===pe&&(m.setAttribute("integrity","sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"),m.setAttribute("crossorigin","anonymous")),document.getElementsByTagName("head")[0].appendChild(m)}}),!Xt(Ft))Ht&&Vt?it(Ft,yt):Ht&&!Vt?it(zt,function(){it(Ft,yt)}):it(he,function(){it(ge,function(){it(zt,function(){it(Ft,yt)})})});else if(typeof d3<"u")Ht&&Vt?yt():Ht&&!Vt?it(zt,yt):it(he,function(){it(ge,function(){it(zt,yt)})});else{let Z,m=document.getElementsByTagName("script");for(let v=m.length;v--;)m[v].src==Ft&&(Z=m[v]);Z.addEventListener("load",yt)}function it(Z,m){let v=document.getElementsByTagName("head")[0],rt=document.createElement("script");rt.type="text/javascript",rt.src=Z,rt.onreadystatechange=m,rt.onload=m,v.appendChild(rt)}function Ke(Z){let m=document.getElementsByTagName("link");for(let v=m.length;v--;)if(m[v].href==Z)return!0;return!1}function Xt(Z){let m=document.getElementsByTagName("script");for(let v=m.length;v--;)if(m[v].src==Z)return!0;return!1}function yt(){Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(n){if(this==null)throw new TypeError('"this" is null or not defined');var s=Object(this),d=s.length>>>0;if(typeof n!="function")throw new TypeError("predicate must be a function");for(var l=arguments[1],i=0;i<d;){var c=s[i];if(n.call(l,c,i,s))return c;i++}},configurable:!0,writable:!0}),Math.log10=Math.log10||function(n){return Math.log(n)*Math.LOG10E},HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(n,s,d){var l=this.toDataURL(s,d).split(",")[1];setTimeout(function(){for(var i=atob(l),c=i.length,a=new Uint8Array(c),o=0;o<c;o++)a[o]=i.charCodeAt(o);n(new Blob([a],{type:s||"image/png"}))})}});let Z={AF:"AFG",AX:"ALA",AL:"ALB",DZ:"DZA",AS:"ASM",AD:"AND",AO:"AGO",AI:"AIA",AQ:"ATA",AG:"ATG",AR:"ARG",AM:"ARM",AW:"ABW",AU:"AUS",AT:"AUT",AZ:"AZE",BS:"BHS",BH:"BHR",BD:"BGD",BB:"BRB",BY:"BLR",BE:"BEL",BZ:"BLZ",BJ:"BEN",BM:"BMU",BT:"BTN",BO:"BOL",BA:"BIH",BW:"BWA",BV:"BVT",BR:"BRA",VG:"VGB",IO:"IOT",BN:"BRN",BG:"BGR",BF:"BFA",BI:"BDI",KH:"KHM",CM:"CMR",CA:"CAN",CV:"CPV",KY:"CYM",CF:"CAF",TD:"TCD",CL:"CHL",CN:"CHN",HK:"HKG",MO:"MAC",CX:"CXR",CC:"CCK",CO:"COL",KM:"COM",CG:"COG",CD:"COD",CK:"COK",CR:"CRI",CI:"CIV",HR:"HRV",CU:"CUB",CY:"CYP",CZ:"CZE",DK:"DNK",DJ:"DJI",DM:"DMA",DO:"DOM",EC:"ECU",EG:"EGY",SV:"SLV",GQ:"GNQ",ER:"ERI",EE:"EST",ET:"ETH",FK:"FLK",FO:"FRO",FJ:"FJI",FI:"FIN",FR:"FRA",GF:"GUF",PF:"PYF",TF:"ATF",GA:"GAB",GM:"GMB",GE:"GEO",DE:"DEU",GH:"GHA",GI:"GIB",GR:"GRC",GL:"GRL",GD:"GRD",GP:"GLP",GU:"GUM",GT:"GTM",GG:"GGY",GN:"GIN",GW:"GNB",GY:"GUY",HT:"HTI",HM:"HMD",VA:"VAT",HN:"HND",HU:"HUN",IS:"ISL",IN:"IND",ID:"IDN",IR:"IRN",IQ:"IRQ",IE:"IRL",IM:"IMN",IL:"ISR",IT:"ITA",JM:"JAM",JP:"JPN",JE:"JEY",JO:"JOR",KZ:"KAZ",KE:"KEN",KI:"KIR",KP:"PRK",KR:"KOR",KW:"KWT",KG:"KGZ",LA:"LAO",LV:"LVA",LB:"LBN",LS:"LSO",LR:"LBR",LY:"LBY",LI:"LIE",LT:"LTU",LU:"LUX",MK:"MKD",MG:"MDG",MW:"MWI",MY:"MYS",MV:"MDV",ML:"MLI",MT:"MLT",MH:"MHL",MQ:"MTQ",MR:"MRT",MU:"MUS",YT:"MYT",MX:"MEX",FM:"FSM",MD:"MDA",MC:"MCO",MN:"MNG",ME:"MNE",MS:"MSR",MA:"MAR",MZ:"MOZ",MM:"MMR",NA:"NAM",NR:"NRU",NP:"NPL",NL:"NLD",AN:"ANT",NC:"NCL",NZ:"NZL",NI:"NIC",NE:"NER",NG:"NGA",NU:"NIU",NF:"NFK",MP:"MNP",NO:"NOR",OM:"OMN",PK:"PAK",PW:"PLW",PS:"PSE",PA:"PAN",PG:"PNG",PY:"PRY",PE:"PER",PH:"PHL",PN:"PCN",PL:"POL",PT:"PRT",PR:"PRI",QA:"QAT",RE:"REU",RO:"ROU",RU:"RUS",RW:"RWA",BL:"BLM",SH:"SHN",KN:"KNA",LC:"LCA",MF:"MAF",PM:"SPM",VC:"VCT",WS:"WSM",SM:"SMR",ST:"STP",SA:"SAU",SN:"SEN",RS:"SRB",SC:"SYC",SL:"SLE",SG:"SGP",SK:"SVK",SI:"SVN",SB:"SLB",SO:"SOM",ZA:"ZAF",GS:"SGS",SS:"SSD",ES:"ESP",LK:"LKA",SD:"SDN",SR:"SUR",SJ:"SJM",SZ:"SWZ",SE:"SWE",CH:"CHE",SY:"SYR",TW:"TWN",TJ:"TJK",TZ:"TZA",TH:"THA",TL:"TLS",TG:"TGO",TK:"TKL",TO:"TON",TT:"TTO",TN:"TUN",TR:"TUR",TM:"TKM",TC:"TCA",TV:"TUV",UG:"UGA",UA:"UKR",AE:"ARE",GB:"GBR",US:"USA",UM:"UMI",UY:"URY",UZ:"UZB",VU:"VUT",VE:"VEN",VN:"VNM",VI:"VIR",WF:"WLF",EH:"ESH",YE:"YEM",ZM:"ZMB",ZW:"ZWE",XX:"SCB"},m=900,v=[4,10,24,10],rt="pbiclc",Ze=60,Je=30,jt=4,_t=12,$e=window.innerHeight,Qt=new Date,Wt=Qt.getFullYear(),Xe=6e5,qt=d3.utcFormat("_%Y%m%d_%H%M%S_UTC"),ct=18,nt=2,Ct=4,gt=.3,kt=["pledge","paid","total"],be=d3.format("~s"),pt=d3.format(",.0f"),_e=d3.format(".0%"),me=d3.format(".3s"),te=22,ee=16,Gt=16,Nt=d3.local(),ye=6,St="#5091CD",ne="#9AB9E1",xt="#1F69B3",Qe="#F79A3B",lt=8,Ce=4,qe=12,q="all",tn="CBPF Contributions",bt={},I={},Tt=21,en="contributions",nn="https://cbpf.data.unocha.org/bookmark.html?",on="https://gms.unocha.org/content/contributions",xe="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",ln="https://cbpfapi.unocha.org/vo2/odata/ContributionTotal?$format=csv&ShowAllPooledFunds=1",an="https://cbpfgms.github.io/img/assets/flags24.json",sn="https://cbpfgms.github.io/pfbi-data/mst/MstRhpf.json",rn=["M83.277,10.493l-13.132,12.22H22.821L9.689,10.493c0,0,6.54-9.154,17.311-10.352c10.547-1.172,14.206,5.293,19.493,5.56 c5.273-0.267,8.945-6.731,19.479-5.56C76.754,1.339,83.277,10.493,83.277,10.493z","M48.297,69.165v9.226c1.399-0.228,2.545-0.768,3.418-1.646c0.885-0.879,1.321-1.908,1.321-3.08 c0-1.055-0.371-1.966-1.113-2.728C51.193,70.168,49.977,69.582,48.297,69.165z","M40.614,57.349c0,0.84,0.299,1.615,0.898,2.324c0.599,0.729,1.504,1.303,2.718,1.745v-8.177 c-1.104,0.306-1.979,0.846-2.633,1.602C40.939,55.61,40.614,56.431,40.614,57.349z","M73.693,30.584H19.276c0,0-26.133,20.567-17.542,58.477c0,0,2.855,10.938,15.996,10.938h57.54 c13.125,0,15.97-10.938,15.97-10.938C99.827,51.151,73.693,30.584,73.693,30.584z M56.832,80.019 c-2.045,1.953-4.89,3.151-8.535,3.594v4.421H44.23v-4.311c-3.232-0.318-5.853-1.334-7.875-3.047 c-2.018-1.699-3.307-4.102-3.864-7.207l7.314-0.651c0.3,1.25,0.856,2.338,1.677,3.256c0.823,0.911,1.741,1.575,2.747,1.979v-9.903 c-3.659-0.879-6.348-2.22-8.053-3.997c-1.716-1.804-2.565-3.958-2.565-6.523c0-2.578,0.96-4.753,2.897-6.511 c1.937-1.751,4.508-2.767,7.721-3.034v-2.344h4.066v2.344c2.969,0.306,5.338,1.159,7.09,2.565c1.758,1.406,2.877,3.3,3.372,5.658 l-7.097,0.774c-0.43-1.849-1.549-3.118-3.365-3.776v9.238c4.485,1.035,7.539,2.357,9.16,3.984c1.634,1.635,2.441,3.725,2.441,6.289 C59.898,75.656,58.876,78.072,56.832,80.019z"],O=1e3,Pe=500,we=24,t={selectedYear:[],selectedContribution:null,selectedDonors:[],selectedCbpfs:[]},at=500,U,Pt=!1,mt,Ae,W=new URLSearchParams(location.search);W.has("viz")||W.append("viz",en);let M=d3.select("#d3chartcontainerpbiclc"),cn=M.node().getAttribute("data-showhelp")==="true",dn=M.node().getAttribute("data-showlink")==="true",ve=M.node().getAttribute("data-title")?M.node().getAttribute("data-title"):tn,De=M.node().getAttribute("data-responsive")==="true",pn=W.has("country")?W.get("country").replace(/\|/g,","):M.node().getAttribute("data-selectedcountry"),un=W.has("year")?W.get("year").replace(/\|/g,","):M.node().getAttribute("data-year"),fn=W.has("contribution")&&kt.indexOf(W.get("contribution"))>-1?W.get("contribution"):kt.indexOf(M.node().getAttribute("data-contribution"))>-1?M.node().getAttribute("data-contribution"):"total",hn=M.node().getAttribute("data-lazyload")==="true";De===!1&&M.style("width",m+"px").style("height",at+"px");let Et=M.append("div").attr("class","pbiclcTopDiv"),gn=Et.append("div").attr("class","pbiclcTitleDiv"),dt=Et.append("div").attr("class","pbiclcIconsDiv d3chartIconsDiv"),z=M.append("svg").attr("viewBox","0 0 "+m+" "+at).style("background-color","white");$t&&z.attr("height",at);let bn=M.append("div").attr("class","pbiclcYearsDescriptionDiv"),Se=M.append("div").attr("class","pbiclcSelectionDescriptionDiv"),mn=Ut?null:M.append("div").attr("class","pbiclcFooterDiv");Ye(z,m,at,"Loading visualisation...");let Lt=M.append("div").attr("id","pbiclcSnapshotTooltip").attr("class","pbiclcSnapshotContent").style("display","none").on("mouseleave",function(){Pt=!1,Lt.style("display","none"),Y.style("display","none"),mt&&d3.select(mt).dispatch("mouseout")});Lt.append("p").attr("id","pbiclcSnapshotTooltipPdfText").html("Download PDF").on("click",function(){Pt=!1,Zt("pdf",!0)}),Lt.append("p").attr("id","pbiclcSnapshotTooltipPngText").html("Download Image (PNG)").on("click",function(){Pt=!1,Zt("png",!0)});let Te=!je&&(window.safari||window.navigator.userAgent.indexOf("Edge")>-1);Te&&Lt.append("p").attr("id","pbiclcTooltipBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default");let Y=M.append("div").attr("id","pbiclctooltipdiv").style("display","none");M.on("contextmenu",function(){d3.event.preventDefault();let n=d3.mouse(this);Pt=!0,Lt.style("display","block").style("top",n[1]-4+"px").style("left",n[0]-4+"px")});let h={main:z.append("g").attr("class","pbiclcTopPanel").attr("transform","translate("+v[3]+","+v[0]+")"),width:m-v[1]-v[3],height:Ze,moneyBagPadding:94,leftPadding:[176,484,632],mainValueVerPadding:12,mainValueHorPadding:4},g={main:z.append("g").attr("class","pbiclcButtonPanel").attr("transform","translate("+v[3]+","+(v[0]+h.height+jt)+")"),width:m-v[1]-v[3],height:Je,padding:[0,0,0,90],buttonWidth:54,buttonPadding:4,buttonVerticalPadding:4,arrowPadding:18,buttonContributionsWidth:70,buttonContributionsPadding:590},A={main:z.append("g").attr("class","pbiclcDonorsPanel").attr("transform","translate("+v[3]+","+(v[0]+h.height+g.height+2*jt)+")"),width:(m-v[1]-v[3]-_t)/2,padding:[44,42,4,0],labelPadding:6},T={main:z.append("g").attr("class","pbiclcCbpfsPanel").attr("transform","translate("+(v[3]+A.width+_t)+","+(v[0]+h.height+g.height+2*jt)+")"),width:(m-v[1]-v[3]-_t)/2,padding:[44,42,4,0],labelPadding:6},yn=A.main.append("clipPath").attr("id","pbiclcDonorsPanelClip").append("rect").attr("width",A.width).attr("transform","translate(0,"+-A.padding[0]+")"),Cn=T.main.append("clipPath").attr("id","pbiclcCbpfsPanelClip").append("rect").attr("width",T.width).attr("transform","translate(0,"+-T.padding[0]+")"),ut=d3.scaleLinear(),ft=d3.scaleLinear(),wt=d3.scalePoint().padding(.5),At=d3.scalePoint().padding(.5),Le=d3.axisTop(ut).tickSizeOuter(0).ticks(3).tickFormat(function(n){return"$"+be(n).replace("G","B")}),Me=d3.axisTop(ft).tickSizeOuter(0).ticks(3).tickFormat(function(n){return"$"+be(n).replace("G","B")}),oe=d3.axisLeft(wt).tickSizeInner(2).tickSizeOuter(0).tickPadding(te).tickFormat(function(n){return n.length>Tt?n.substring(0,Tt-3)+"...":n}),ie=d3.axisLeft(At).tickSizeInner(0).tickSizeOuter(0).tickPadding(6+Ct).tickFormat(function(n){return n.length>Tt?n.substring(0,Tt-3)+"...":n}),Re=A.main.append("g").attr("class","pbiclcgroupXAxisDonors").attr("clip-path","url(#pbiclcDonorsPanelClip)").attr("transform","translate(0,"+A.padding[0]+")"),Be=T.main.append("g").attr("class","pbiclcgroupXAxisCbpfs").attr("clip-path","url(#pbiclcCbpfsPanelClip)").attr("transform","translate(0,"+T.padding[0]+")"),Mt=A.main.append("g").attr("class","pbiclcgroupYAxisDonors"),Rt=T.main.append("g").attr("class","pbiclcgroupYAxisCbpfs"),Oe=d3.symbol().type(d3.symbolTriangle).size(Gt);Xt(ue)||it(ue,null),Xt(fe)||it(fe,null),Ut&&!de?Promise.all([window.cbpfbiDataObject.contributionsTotalData,window.cbpfbiDataObject.flags,window.cbpfbiDataObject.masterRegionalFunds]).then(n=>Fe(n)):Promise.all([le(rt+"data",ln,"contributions data","csv"),le("flags",an,"flags data","json"),le("masterRegionalFunds",sn,"master regional funds data","json")]).then(n=>Fe(n));function le(n,s,d,l){if(localStorage.getItem(n)&&JSON.parse(localStorage.getItem(n)).timestamp>Qt.getTime()-Xe){let i=l==="csv"?d3.csvParse(JSON.parse(localStorage.getItem(n)).data):JSON.parse(localStorage.getItem(n)).data;return console.info(rt+" chart info: "+d+" from local storage"),Promise.resolve(i)}else return(l==="csv"?d3.csv:d3.json)(s).then(c=>{try{localStorage.setItem(n,JSON.stringify({data:l==="csv"?d3.csvFormat(c):c,timestamp:Qt.getTime()}))}catch(a){console.info(rt+" chart, "+a)}return console.info(rt+" chart info: "+d+" from API"),c})}function Fe([n,s,d]){se(),U=n.map(function(c){return c.GMSDonorISO2Code&&!I[c.GMSDonorISO2Code.toLowerCase()]&&(I[c.GMSDonorISO2Code.toLowerCase()]=c.GMSDonorName),c.PooledFundISO2Code&&!c.PooledFundName.toLowerCase().includes("closed")&&!I[c.PooledFundISO2Code.toLowerCase()]&&(I[c.PooledFundISO2Code.toLowerCase()]=c.PooledFundName),c.PaidAmt<0&&(c.PaidAmt=0),c.PledgeAmt<0&&(c.PledgeAmt=0),+c.FiscalYear}).filter(function(c,a,o){return o.indexOf(c)===a}).sort(),Mn(un),t.selectedContribution=fn;let l=n.map(function(c){return c.GMSDonorISO2Code||(c.GMSDonorISO2Code="UN"),c.GMSDonorISO2Code.toLowerCase()}).filter(function(c,a,o){return o.indexOf(c)===a});hn?(d3.select(window).on("scroll.pbiclc",i),d3.select("body").on("d3ChartsYear.pbiclc",function(){t.selectedYear=[He(+d3.event.detail)],t.selectedYear[0]>Wt&&(t.selectedContribution="total")}),i()):ke([n,s,d]);function i(){let c=M.node().getBoundingClientRect();c.bottom<0||c.top-$e>0||(d3.select(window).on("scroll.pbiclc",null),ke([n,s,d]))}}function ke([n,s,d]){let l=Ge(n),i={dataDonors:l[0],dataCbpfs:l[1]},c=i.dataDonors.map(function(u){return u.isoCode}),a=i.dataCbpfs.map(function(u){return u.isoCode});Rn(pn,c,a),t.selectedDonors.length&&i.dataDonors.forEach(function(u){t.selectedDonors.indexOf(u.isoCode)>-1&&(u.clicked=!0)}),t.selectedCbpfs.length&&i.dataCbpfs.forEach(function(u){t.selectedCbpfs.indexOf(u.isoCode)>-1&&(u.clicked=!0)}),k(),Ut||Dn(),vt(),vn(),C(),G(),E(),J(),st(),Ee(),cn&&Ie();function o(u,x){if(x||u===q||t.selectedYear[0]===q)t.selectedYear=[u];else{let w=t.selectedYear.indexOf(u);if(w>-1){if(t.selectedYear.length===1)return;t.selectedYear.splice(w,1)}else t.selectedYear.push(u)}let b=t.selectedYear[0]===q?q.toLowerCase():t.selectedYear.map(function(w){return w}).join("|");W.has("year")?W.set("year",b):W.append("year",b),d3.selectAll(".pbiclcbuttonsRects").style("fill",function(w){return t.selectedYear.indexOf(w)>-1?xt:"#eaeaea"}),d3.selectAll(".pbiclcbuttonsText").style("fill",function(w){return t.selectedYear.indexOf(w)>-1?"white":"#444"}),Ee();let f=Ge(n);i.dataDonors=f[0],i.dataCbpfs=f[1];let _=i.dataDonors.map(function(w){return w.isoCode}),B=i.dataCbpfs.map(function(w){return w.isoCode});t.selectedDonors=t.selectedDonors.filter(function(w){return _.indexOf(w)>-1}),t.selectedCbpfs=t.selectedCbpfs.filter(function(w){return B.indexOf(w)>-1}),i.dataDonors.forEach(function(w){t.selectedDonors.indexOf(w.isoCode)>-1&&(w.clicked=!0)}),i.dataCbpfs.forEach(function(w){t.selectedCbpfs.indexOf(w.isoCode)>-1&&(w.clicked=!0)}),vt(),C(),G(),J(),st(),ae()}function D(u){t.selectedContribution=u,W.has("contribution")?W.set("contribution",u):W.append("contribution",u),d3.selectAll(".pbiclcbuttonsContributionsRects").style("fill",function(x){return x===t.selectedContribution?xt:"#eaeaea"}),d3.selectAll(".pbiclcbuttonsContributionsText").style("fill",function(x){return x===t.selectedContribution?"white":"#444"}),d3.select(".pbiclcSvgLegend").style("opacity",t.selectedContribution==="total"?1:0),G(),J(),st()}function C(){let u=z.selectAll(".pbiclcSvgLegend").data([!0]),x=u.enter().append("text").attr("class","pbiclcSvgLegend").attr("y",at-ye).attr("x",v[3]+2).text("Figures represent: ").append("tspan").style("font-weight","bold").style("fill","#666").text("Total ").append("tspan").style("font-weight","normal").text("(").append("tspan").style("font-weight","bold").style("fill",St).text("Paid").append("tspan").style("fill","#666").style("font-weight","normal").text("/").append("tspan").style("font-weight","bold").style("fill",ne).text("Pledged").append("tspan").style("font-weight","normal").style("fill","#666").text(")").append("tspan").style("font-weight","normal").style("fill","#666").text(". The arrow (").append("tspan").style("fill",St).text("\u25B2").append("tspan").style("fill","#666").text(") indicates the paid amount.");u.transition().duration(O).attr("y",at-ye)}function k(){let u=gn.append("p").attr("id","pbiclcd3chartTitle").html(ve),x=dt.append("button").attr("id","pbiclcHelpButton");x.html("HELP  ").append("span").attr("class","fas fa-info");let b=dt.append("button").attr("id","pbiclcDownloadButton");b.html(".CSV  ").append("span").attr("class","fas fa-download");let f=dt.append("div").attr("class","pbiclcSnapshotDiv");f.append("button").attr("id","pbiclcSnapshotButton").html("IMAGE ").append("span").attr("class","fas fa-camera");let B=f.append("div").attr("class","pbiclcSnapshotContent"),w=B.append("p").attr("id","pbiclcSnapshotPdfText").html("Download PDF").on("click",function(){Zt("pdf",!1)}),Dt=B.append("p").attr("id","pbiclcSnapshotPngText").html("Download Image (PNG)").on("click",function(){Zt("png",!1)}),H=dt.append("button").datum({clicked:!1}).attr("id","pbiclcPlayButton");if(H.html("PLAY  ").append("span").attr("class","fas fa-play"),H.on("click",function($){$.clicked=!$.clicked,H.html($.clicked?"PAUSE ":"PLAY  ").append("span").attr("class",$.clicked?"fas fa-pause":"fas fa-play"),$.clicked?(t.selectedYear.length=1,K(),Ae=d3.interval(K,3*O)):Ae.stop();function K(){let S=U.indexOf(t.selectedYear[0]);t.selectedYear[0]=U[(S+1)%U.length],d3.selectAll(".pbiclcbuttonsRects").filter(function(Q){return Q===t.selectedYear[0]}).dispatch("click");let j=t.selectedYear[0]<U[lt/2]?0:t.selectedYear[0]>U[U.length-lt/2]||t.selectedYear[0]===q?U.length-lt:U.indexOf(t.selectedYear[0])-lt/2,X=-(g.buttonWidth*j);X===0?(z.select(".pbiclcLeftArrowGroup").select("text").style("fill","#ccc"),z.select(".pbiclcLeftArrowGroup").attr("pointer-events","none")):(z.select(".pbiclcLeftArrowGroup").select("text").style("fill","#666"),z.select(".pbiclcLeftArrowGroup").attr("pointer-events","all")),Math.abs(X)>=(U.length-lt)*g.buttonWidth?(z.select(".pbiclcRightArrowGroup").select("text").style("fill","#ccc"),z.select(".pbiclcRightArrowGroup").attr("pointer-events","none")):(z.select(".pbiclcRightArrowGroup").select("text").style("fill","#666"),z.select(".pbiclcRightArrowGroup").attr("pointer-events","all")),z.select(".pbiclcbuttonsGroup").transition().duration(O).attrTween("transform",function(){return d3.interpolateString(this.getAttribute("transform"),"translate("+X+",0)")})}}),!de){let $=dt.append("button").attr("id","pbiclcShareButton");$.html("SHARE  ").append("span").attr("class","fas fa-share");let K=M.append("div").attr("class","d3chartShareDiv").style("display","none");$.on("mouseover",function(){K.html("Click to copy").style("display","block");let S=this.getBoundingClientRect(),tt=M.node().getBoundingClientRect(),j=K.node().getBoundingClientRect(),X=S.top-tt.top-(j.height-S.height)/2,Q=S.left-tt.left-j.width-12;K.style("top",X+"px").style("left",Q+"20px")}).on("mouseout",function(){K.style("display","none")}).on("click",function(){let S=nn+W.toString();K.append("input").attr("type","text").attr("readonly",!0).attr("spellcheck","false").property("value",S).node().select(),document.execCommand("copy"),K.html("Copied!");let j=this.getBoundingClientRect(),X=M.node().getBoundingClientRect(),Q=K.node().getBoundingClientRect(),r=j.left-X.left-Q.width-12;K.style("left",r+"20px")})}if(Te){let $=B.append("p").attr("id","pbiclcBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default")}f.on("mouseover",function(){B.style("display","block")}).on("mouseout",function(){B.style("display","none")}),x.on("click",Ie),b.on("click",function(){let $=xn(n),S="CBPFcontributions_"+qt(new Date)+".csv",tt=new Blob([$],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(tt,filename);else{let j=document.createElement("a");if(j.download!==void 0){let X=URL.createObjectURL(tt);j.setAttribute("href",X),j.setAttribute("download",S),j.style="visibility:hidden",document.body.appendChild(j),j.click(),document.body.removeChild(j)}}})}function G(){let u=!t.selectedDonors.length&&!t.selectedCbpfs.length?i.dataDonors:t.selectedDonors.length?i.dataDonors.filter(function(P){return t.selectedDonors.indexOf(P.isoCode)>-1}):i.dataDonors.reduce(function(P,N){return N.donations.forEach(function(R){if(t.selectedCbpfs.indexOf(R.isoCode)>-1){let V=P.find(function(Ot){return Ot.donor===N.donor});V?(V.paid+=R.paid,V.pledge+=R.pledge,V.total+=R.total):P.push({donor:N.donor,paid:R.paid,pledge:R.pledge,total:R.total})}}),P},[]),x=!t.selectedDonors.length&&!t.selectedCbpfs.length?i.dataCbpfs:t.selectedCbpfs.length?i.dataCbpfs.filter(function(P){return t.selectedCbpfs.indexOf(P.isoCode)>-1}):i.dataCbpfs.reduce(function(P,N){return N.donors.forEach(function(R){if(t.selectedDonors.indexOf(R.isoCode)>-1){let V=P.find(function(Ot){return Ot.cbpf===N.cbpf});V?(V.paid+=R.paid,V.pledge+=R.pledge,V.total+=R.total):P.push({cbpf:N.cbpf,paid:R.paid,pledge:R.pledge,total:R.total})}}),P},[]),b=x.filter(function(P){return!P.cbpf.includes("RhPF")}),f=new Set;x.forEach(function(P){if(P.cbpf.includes("RhPF")){let N=P.cbpf.split("(RhPF")[0].trim(),R=d.find(function(V){return V.RFundName.includes(N)});R&&f.add(R.RFundAbbrv)}});let _=Array.from(f);kt.forEach(function(P){bt[P]=d3.sum(u,function(N){return N[P]})});let B=d3.sum(u,function(P){return P[t.selectedContribution]}),w=h.main.selectAll(".pbiclctopPanelMoneyBag").data([!0]).enter().append("g").attr("class","pbiclctopPanelMoneyBag contributionColorFill").attr("transform","translate("+h.moneyBagPadding+",6) scale(0.5)").each(function(P,N,R){rn.forEach(function(V){d3.select(R[N]).append("path").attr("d",V)})}),Dt=d3.select(".pbiclctopPanelMainValue").size()!==0?d3.select(".pbiclctopPanelMainValue").datum():0,H=d3.select(".pbiclctopPanelDonorsNumber").size()!==0?d3.select(".pbiclctopPanelDonorsNumber").datum():0,$=d3.select(".pbiclctopPanelCbpfsNumber").size()!==0?d3.select(".pbiclctopPanelCbpfsNumber").datum():0,K=d3.select(".pbiclctopPanelRfNumber").size()!==0?d3.select(".pbiclctopPanelRfNumber").datum():0,S=h.main.selectAll(".pbiclcmainValueGroup").data([!0]);S=S.enter().append("g").attr("class","pbiclcmainValueGroup").merge(S);let tt=S.selectAll(".pbiclctopPanelMainValue").data([B]);tt=tt.enter().append("text").attr("class","pbiclctopPanelMainValue contributionColorFill").attr("text-anchor","end").merge(tt).attr("y",h.height-h.mainValueVerPadding).attr("x",h.moneyBagPadding+h.leftPadding[0]-h.mainValueHorPadding),tt.transition().duration(O).tween("text",function(P){let N=this,R=d3.interpolate(Dt,P);return function(V){let Ot=Ue(R(V));N.textContent="$"+(P<1e3?P:Ot.substring(0,Ot.length-1))}});let j=S.selectAll(".pbiclctopPanelMainText").data([B]);j=j.enter().append("text").attr("class","pbiclctopPanelMainText").style("opacity",0).attr("text-anchor","start").merge(j).attr("y",h.height-h.mainValueVerPadding*2.7).attr("x",h.moneyBagPadding+h.leftPadding[0]+h.mainValueHorPadding);let X=t.selectedDonors.length?" donated in ":" received in ";j.transition().duration(O).style("opacity",1).text(function(P){let N=t.selectedYear.length===1?t.selectedYear[0]===q?"all years":t.selectedYear[0]:"years*",R=Ue(P),V=R[R.length-1];return(V==="k"?"Thousand":V==="M"?"Million":V==="G"?"Billion":"")+X+N});let Q=S.selectAll(".pbiclctopPanelSubText").data([!0]);Q=Q.enter().append("text").attr("class","pbiclctopPanelSubText").style("opacity",0).attr("text-anchor","start").merge(Q).attr("y",h.height-h.mainValueVerPadding*1.2).attr("x",h.moneyBagPadding+h.leftPadding[0]+h.mainValueHorPadding),Q.transition().duration(O).style("opacity",1).text(function(P){return"(Total "+(t.selectedContribution==="total"?"Contributions":t.selectedContribution==="pledge"?"Pledged":"Paid")+")"});let r=S.selectAll(".pbiclctopPanelDonorsNumber").data([u.length]);r=r.enter().append("text").attr("class","pbiclctopPanelDonorsNumber contributionColorFill").attr("text-anchor","end").merge(r).attr("y",h.height-h.mainValueVerPadding).attr("x",h.moneyBagPadding+h.leftPadding[1]-h.mainValueHorPadding),r.transition().duration(O).tween("text",function(P){let N=this,R=d3.interpolate(H,P);return function(V){N.textContent=~~R(V)}});let e=S.selectAll(".pbiclctopPanelDonorsText").data([!0]);e=e.enter().append("text").attr("class","pbiclctopPanelDonorsText").attr("x",h.moneyBagPadding+h.leftPadding[1]+h.mainValueHorPadding).attr("text-anchor","start").merge(e).attr("y",h.height-h.mainValueVerPadding*(t.selectedDonors.length?2.5:1.9)).text(u.length>1?"Donors":"Donor");let p=S.selectAll(".pbiclctopPanelCbpfsNumber").data(b.length?[b.length]:[]);p.exit().remove(),p=p.enter().append("text").attr("class","pbiclctopPanelCbpfsNumber allocationColorFill").attr("text-anchor","end").merge(p).style("font-size",_.length?"22px":"48px").attr("y",h.height-h.mainValueVerPadding*(_.length?2.7:1)).attr("x",h.moneyBagPadding+h.leftPadding[2]-h.mainValueHorPadding),p.transition().duration(O).tween("text",function(P){let N=this,R=d3.interpolate($,P);return function(V){N.textContent=~~R(V)}});let y=S.selectAll(".pbiclctopPanelCbpfsText").data(b.length?[b.length]:[]);y.exit().remove(),y=y.enter().append("text").attr("class","pbiclctopPanelCbpfsText").attr("x",h.moneyBagPadding+h.leftPadding[2]+h.mainValueHorPadding).attr("text-anchor","start").merge(y).style("font-size",_.length?"15px":"22px").attr("y",h.height-h.mainValueVerPadding*(_.length?2.85:1.9)).text(b.length>1?"CBPFs":"CBPF");let L=S.selectAll(".pbiclctopPanelRfNumber").data(_.length?[_.length]:[]);L.exit().remove(),L=L.enter().append("text").attr("class","pbiclctopPanelRfNumber allocationColorFill").attr("text-anchor","end").merge(L).style("font-size",b.length?"22px":"48px").attr("y",h.height-h.mainValueVerPadding*(b.length?.8:1)).attr("x",h.moneyBagPadding+h.leftPadding[2]-h.mainValueHorPadding),L.transition().duration(O).tween("text",function(P){let N=this,R=d3.interpolate(K,P);return function(V){N.textContent=~~R(V)}});let F=S.selectAll(".pbiclctopPanelRfText").data(_.length?[_.length]:[]);F.exit().remove(),F=F.enter().append("text").attr("class","pbiclctopPanelRfText").attr("x",h.moneyBagPadding+h.leftPadding[2]+h.mainValueHorPadding).attr("text-anchor","start").style("cursor","default").merge(F).style("font-size",b.length?"15px":"20px").attr("y",h.height-h.mainValueVerPadding*(b.length?1:1.9)).text(_.length>1?"Regional funds":"Regional fund"),F.append("tspan").attr("class","pbiclcinfoIcon contributionColorFill").text(" \uF05A"),h.main.selectAll(".pbiclctopPanelOverRectangle").data([!0]).enter().append("rect").attr("class","pbiclctopPanelOverRectangle").attr("width",h.leftPadding[1]).attr("height",h.height).style("opacity",0).on("mouseover",It).on("mouseout",Jt),F.on("mouseover",Yt).on("mouseout",Jt)}function E(){U.push(q);let u=g.main.append("clipPath").attr("id","pbiclcclip").append("rect").attr("width",lt*g.buttonWidth).attr("height",g.height),b=g.main.append("g").attr("class","pbiclcClipPathGroup").attr("transform","translate("+(g.padding[3]+g.arrowPadding)+",0)").attr("clip-path","url(#pbiclcclip)").append("g").attr("class","pbiclcbuttonsGroup").attr("transform","translate(0,0)").style("cursor","pointer"),f=b.selectAll(null).data(U).enter().append("rect").attr("rx","2px").attr("ry","2px").attr("class","pbiclcbuttonsRects").attr("width",g.buttonWidth-g.buttonPadding).attr("height",g.height-g.buttonVerticalPadding*2).attr("y",g.buttonVerticalPadding).attr("x",function(e,p){return p*g.buttonWidth+g.buttonPadding/2}).style("fill",function(e){return t.selectedYear.indexOf(e)>-1?xt:"#eaeaea"}),_=b.selectAll(null).data(U).enter().append("text").attr("text-anchor","middle").attr("class","pbiclcbuttonsText").attr("y",g.height/1.6).attr("x",function(e,p){return p*g.buttonWidth+g.buttonWidth/2}).style("fill",function(e){return t.selectedYear.indexOf(e)>-1?"white":"#444"}).text(function(e){return e===q?Ve(q):e}),B=g.main.append("g").attr("class","pbiclcbuttonsContributionsGroup").attr("transform","translate("+g.buttonContributionsPadding+",0)").style("cursor","pointer"),w=B.selectAll(null).data(kt).enter().append("rect").attr("rx","2px").attr("ry","2px").attr("class","pbiclcbuttonsContributionsRects").attr("width",g.buttonContributionsWidth-g.buttonPadding).attr("height",g.height-g.buttonVerticalPadding*2).attr("y",g.buttonVerticalPadding).attr("x",function(e,p){return p*g.buttonContributionsWidth+g.buttonPadding/2}).style("fill",function(e){return e===t.selectedContribution?xt:"#eaeaea"}),Dt=B.selectAll(null).data(kt).enter().append("text").attr("text-anchor","middle").attr("class","pbiclcbuttonsContributionsText").attr("y",g.height/1.6).attr("x",function(e,p){return p*g.buttonContributionsWidth+g.buttonContributionsWidth/2}).style("fill",function(e){return e===t.selectedContribution?"white":"#444"}).text(function(e){return e==="pledge"?"Pledged":Ve(e)}),H=g.main.append("g").attr("class","pbiclcLeftArrowGroup").style("cursor","pointer").attr("transform","translate("+g.padding[3]+",0)"),$=H.append("rect").style("fill","white").attr("width",g.arrowPadding).attr("height",g.height),K=H.append("text").attr("class","pbiclcleftArrowText").attr("x",0).attr("y",g.height-g.buttonVerticalPadding*2.1).style("fill","#666").text("\u25C4"),S=g.main.append("g").attr("class","pbiclcRightArrowGroup").style("cursor","pointer").attr("transform","translate("+(g.padding[3]+g.arrowPadding+lt*g.buttonWidth)+",0)"),tt=S.append("rect").style("fill","white").attr("width",g.arrowPadding).attr("height",g.height),j=S.append("text").attr("class","pbiclcrightArrowText").attr("x",-1).attr("y",g.height-g.buttonVerticalPadding*2.1).style("fill","#666").text("\u25BA");f.on("mouseover",re).on("mouseout",ce).on("click",function(e){let p=this;if(d3.event.altKey){o(e,!1);return}Nt.get(this)!=="clicked"?(Nt.set(this,"clicked"),setTimeout(function(){Nt.get(p)==="clicked"&&o(e,!0),Nt.set(p,null)},250)):(o(e,!1),Nt.set(this,null))}),d3.select("body").on("d3ChartsYear.pbiclc",function(){o(He(+d3.event.detail),!0),r(),X()}),w.on("mouseover",ot).on("mouseout",ht).on("click",D),r(),Q(),H.on("click",function(){H.attr("pointer-events","none");let e=Kt(b.attr("transform"))[0];S.select("text").style("fill","#666"),S.attr("pointer-events","all"),b.transition().duration(O).attr("transform","translate("+Math.min(0,e+lt*g.buttonWidth)+",0)").on("end",X)}),S.on("click",function(){S.attr("pointer-events","none");let e=Kt(b.attr("transform"))[0];H.select("text").style("fill","#666"),H.attr("pointer-events","all"),b.transition().duration(O).attr("transform","translate("+Math.max(-((U.length-lt)*g.buttonWidth),-(Math.abs(e)+lt*g.buttonWidth))+",0)").on("end",X)});function X(){let e=Kt(b.attr("transform"))[0];e===0?(H.select("text").style("fill","#ccc"),H.attr("pointer-events","none")):(H.select("text").style("fill","#666"),H.attr("pointer-events","all")),Math.abs(e)>=(U.length-lt)*g.buttonWidth?(S.select("text").style("fill","#ccc"),S.attr("pointer-events","none")):(S.select("text").style("fill","#666"),S.attr("pointer-events","all"))}function Q(){let e=Kt(b.attr("transform"))[0];e===0&&(H.select("text").style("fill","#ccc"),H.attr("pointer-events","none")),Math.abs(e)>=(U.length-lt)*g.buttonWidth&&(S.select("text").style("fill","#ccc"),S.attr("pointer-events","none"))}function r(){let e=t.selectedYear[0]<U[5]?0:t.selectedYear[0]>U[U.length-4]?U.length-8:U.indexOf(t.selectedYear[0])-4;b.attr("transform","translate("+-(g.buttonWidth*e)+",0)")}}function J(){let u;if(t.selectedCbpfs.length===0)u=i.dataDonors;else{let e=i.dataCbpfs.filter(function(y){return t.selectedCbpfs.indexOf(y.isoCode)>-1}).map(function(y){return y.donors}),p=JSON.parse(JSON.stringify(e)).reduce(function(y,L){return L.forEach(function(F){let et=y.find(function(P){return P.isoCode===F.isoCode});et?(et.paid+=F.paid,et.pledge+=F.pledge,et.total+=F.total):y.push(F)}),y});p.forEach(function(y){y.clicked=i.dataDonors.find(function(L){return L.isoCode===y.isoCode}).clicked}),u=p}let x;t.selectedCbpfs.length?t.selectedCbpfs.length===1?x=I[t.selectedCbpfs[0]]:t.selectedCbpfs.length<4?x=t.selectedCbpfs.sort(function(e,p){return e.toLowerCase()<p.toLowerCase()?-1:e.toLowerCase()>p.toLowerCase()?1:0}).reduce(function(e,p,y){return e+(y>=t.selectedCbpfs.length-2?y>t.selectedCbpfs.length-2?Z[p.toUpperCase()]:Z[p.toUpperCase()]+" and ":Z[p.toUpperCase()]+", ")},""):x="selected CBPFs\u207A":x=null,u.sort(function(e,p){return p[t.selectedContribution]-e[t.selectedContribution]||(e.donor.toLowerCase()<p.donor.toLowerCase()?-1:e.donor.toLowerCase()>p.donor.toLowerCase()?1:0)}),wt.domain(u.map(function(e){return e.donor})),wt.range([A.padding[0],u.length*ct+A.padding[0]]);let b=A.main.selectAll(".pbiclcDonorsPanelTitle").data([!0]);b=b.enter().append("text").attr("class","pbiclcDonorsPanelTitle").attr("x",A.padding[3]).attr("y",A.padding[0]-we).merge(b).text("Donors"),b.transition().duration(O).attr("x",A.padding[3]);let f=A.main.selectAll(".pbiclcDonorGroup").data(u,function(e){return e.isoCode}),_=f.exit().remove(),B=f.enter().append("g").attr("class","pbiclcDonorGroup").attr("transform",function(e){return"translate(0,"+wt(e.donor)+")"}),w=B.append("rect").attr("class","pbiclcDonorStick").attr("x",A.padding[3]).attr("y",-(nt/2-nt/4)).attr("height",nt).attr("width",0).classed("contributionColorFill",!0),Dt=B.append("circle").attr("class","pbiclcDonorLollipop").attr("cx",A.padding[3]).attr("cy",nt/4).attr("r",Ct).classed("contributionColorFill",!0),H=B.append("image").attr("class","pbiclcDonorFlag").attr("width",ee).attr("height",ee).attr("x",A.padding[3]-te).attr("y",-ee/2+1).attr("href",e=>e.isoCode?(e.isoCode&&!s[e.isoCode.toLowerCase()]&&!Ut&&console.warn("Missing flag: "+e.name,e),s[e.isoCode.toLowerCase()]||xe):xe),$=B.append("path").attr("class","pbiclcDonorPaidIndicator").attr("d",Oe).style("fill",St).style("opacity",t.selectedContribution==="total"?1:0).attr("transform","translate("+A.padding[3]+","+(Math.sqrt(4*Gt/Math.sqrt(3))/2+nt)+")"),K=B.append("text").attr("class","pbiclcDonorLabel").attr("x",A.padding[3]+A.labelPadding).attr("y",Ce).text(me(0)),S=B.append("rect").attr("class","pbiclcDonorTooltipRectangle").attr("y",-ct/2).attr("height",ct).attr("width",A.width).style("fill","none").attr("pointer-events","all").attr("cursor","pointer");f=B.merge(f),f.transition().duration(O).attr("transform",function(e){return"translate(0,"+wt(e.donor)+")"}),f.select(".pbiclcDonorStick").transition().duration(O).attr("x",A.padding[3]).attr("width",function(e){return ut(e[t.selectedContribution])-A.padding[3]}),f.select(".pbiclcDonorLollipop").transition().duration(O).attr("cx",function(e){return ut(e[t.selectedContribution])}),f.select(".pbiclcDonorFlag").transition().duration(O).attr("x",A.padding[3]-te),f.select(".pbiclcDonorPaidIndicator").transition().duration(O).style("opacity",function(e){return t.selectedContribution==="total"&&e.pledge?1:0}).attr("transform",function(e){let p=ut(e.total)-ut(e.paid)<Ct?Ct-nt/2:0;return"translate("+ut(e.paid)+","+(Math.sqrt(4*Gt/Math.sqrt(3))/2+nt+p)+")"}),f.select(".pbiclcDonorLabel").transition().duration(O).attr("x",function(e){return ut(e[t.selectedContribution])+A.labelPadding}).tween("text",function(e){let p=this,y=d3.interpolate(ze(p.textContent)||0,e[t.selectedContribution]);function L(F){F.append("tspan").attr("class","pbiclcDonorLabelPercentage").attr("dy","-0.5px").text(" (").append("tspan").style("fill",St).text(d3.formatPrefix(".0",e.paid)(e.paid).replace("G","B")).append("tspan").style("fill","#aaa").text("/").append("tspan").style("fill",ne).text(d3.formatPrefix(".0",e.pledge)(e.pledge).replace("G","B")).append("tspan").style("fill","#aaa").text(")")}return function(F){let et=d3.select(p).text(d3.formatPrefix(".0",e[t.selectedContribution])(y(F)).replace("G","B"));t.selectedContribution==="total"&&e.pledge?et.call(L):et.append("tspan").text(null)}}).on("end",function(e){e[t.selectedContribution]>0&&e[t.selectedContribution]<1e3&&d3.select(this).text("<1k")}),f.selectAll("rect, circle").classed("contributionColorFill",function(e){return!e.clicked}).classed("contributionColorDarkerFill",function(e){return e.clicked}),f.select(".pbiclcDonorTooltipRectangle").on("mouseover",j).on("mouseout",X).on("click",Q),Le.tickSizeInner(-(ct*u.length)),Mt.selectAll(".tick").filter(function(e){return wt.domain().indexOf(e)===-1}).remove(),Mt.transition().duration(O).attr("transform","translate("+A.padding[3]+",0)").call(oe),Re.transition().duration(O).call(Le),Re.selectAll(".tick").filter(function(e){return e===0}).remove(),r();function j(e){mt=this,e.clicked||t.selectedDonors.push(e.isoCode),f.style("opacity",function(P){return t.selectedDonors.indexOf(P.isoCode)>-1?1:gt}),Mt.selectAll(".tick").style("opacity",function(P){let N=Object.keys(I).find(function(R){return I[R]===P});return t.selectedDonors.indexOf(N)>-1?1:gt}),Y.style("display","block").html("Donor: <strong>"+e.donor+"</strong><br><br><div style='margin:0px;display:flex;flex-wrap:wrap;width:262px;'><div style='display:flex;flex:0 54%;'>Total contributions:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorHTMLcolor'>$"+pt(e.total)+"</span></div><div style='display:flex;flex:0 54%;white-space:pre;'>Total paid <span style='color: #888;'>("+Bt(e.paid,e.total)+")</span>:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorHTMLcolor'>$"+pt(e.paid)+"</span></div><div style='display:flex;flex:0 54%;white-space:pre;'>Total pledged <span style='color: #888;'>("+Bt(e.pledge,e.total)+")</span>:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorHTMLcolor'>$"+pt(e.pledge)+"</span></div></div>");let p=this.getBoundingClientRect(),y=M.node().getBoundingClientRect(),L=Y.node().getBoundingClientRect(),F=p.top-y.top,et=p.left-y.left+(p.width-L.width)/2;Y.style("top",F+22+"px").style("left",et+"px"),st()}function X(e){if(!Pt){if(mt=null,!e.clicked){let p=t.selectedDonors.indexOf(e.isoCode);p>-1&&t.selectedDonors.splice(p,1)}r(),Y.style("display","none"),st()}}function Q(e){if(t.selectedCbpfs.length=0,i.dataCbpfs.forEach(function(L){L.clicked=!1}),e.clicked=!e.clicked,e.clicked)t.selectedDonors.indexOf(e.isoCode)===-1&&t.selectedDonors.push(e.isoCode);else{let L=t.selectedDonors.indexOf(e.isoCode);t.selectedDonors.splice(L,1)}let p=t.selectedDonors.map(function(L){return a.indexOf(L)>-1?I[L]+"@donor":I[L]}).join("|");W.has("country")?W.set("country",p):W.append("country",p);let y=i.dataDonors.find(function(L){return L.isoCode===e.isoCode});y.clicked=e.clicked,Y.style("display","none"),G(),J(),st(),ae()}function r(){t.selectedDonors.length?(f.style("opacity",function(e){return t.selectedDonors.indexOf(e.isoCode)>-1?1:gt}),Mt.selectAll(".tick").style("opacity",function(e){let p=Object.keys(I).find(function(y){return I[y]===e});return t.selectedDonors.indexOf(p)>-1?1:gt})):(f.style("opacity",1),Mt.selectAll(".tick").style("opacity",1))}}function st(){let u;if(t.selectedDonors.length===0)u=i.dataCbpfs;else{let r=i.dataDonors.filter(function(p){return t.selectedDonors.indexOf(p.isoCode)>-1}).map(function(p){return p.donations}),e=JSON.parse(JSON.stringify(r)).reduce(function(p,y){return y.forEach(function(L){let F=p.find(function(et){return et.isoCode===L.isoCode});F?(F.paid+=L.paid,F.pledge+=L.pledge,F.total+=L.total):p.push(L)}),p});e.forEach(function(p){p.clicked=i.dataCbpfs.find(function(y){return y.isoCode===p.isoCode}).clicked}),u=e}let x;t.selectedDonors.length?t.selectedDonors.length===1?x=I[t.selectedDonors[0]]:t.selectedDonors.length<4?x=t.selectedDonors.sort(function(r,e){return r.toLowerCase()<e.toLowerCase()?-1:r.toLowerCase()>e.toLowerCase()?1:0}).reduce(function(r,e,p){return r+(p>=t.selectedDonors.length-2?p>t.selectedDonors.length-2?Z[e.toUpperCase()]:Z[e.toUpperCase()]+" and ":Z[e.toUpperCase()]+", ")},""):x="selected CBPFs\u207A":x=null,u.sort(function(r,e){return e[t.selectedContribution]-r[t.selectedContribution]||(r.cbpf.toLowerCase()<e.cbpf.toLowerCase()?-1:r.cbpf.toLowerCase()>e.cbpf.toLowerCase()?1:0)}),At.domain(u.map(function(r){return r.cbpf})),At.range([T.padding[0],u.length*ct+T.padding[0]]);let b=T.main.selectAll(".pbiclcCbpfsPanelTitle").data([!0]);b=b.enter().append("text").attr("class","pbiclcCbpfsPanelTitle").attr("x",T.padding[3]).attr("y",T.padding[0]-we).merge(b).text("CBPFs"),b.transition().duration(O).attr("x",T.padding[3]);let f=T.main.selectAll(".pbiclcCbpfGroup").data(u,function(r){return r.isoCode}),_=f.exit().remove(),B=f.enter().append("g").attr("class","pbiclcCbpfGroup").attr("transform",function(r){return"translate(0,"+At(r.cbpf)+")"}),w=B.append("rect").attr("class","pbiclcCbpfStick").attr("x",T.padding[3]).attr("y",-(nt/2-nt/4)).attr("height",nt).attr("width",0).classed("allocationColorFill",!0),Dt=B.append("circle").attr("class","pbiclcCbpfLollipop").attr("cx",T.padding[3]).attr("cy",nt/4).attr("r",Ct).classed("allocationColorFill",!0),H=B.append("path").attr("class","pbiclcCbpfPaidIndicator").attr("d",Oe).style("fill",St).style("opacity",t.selectedContribution==="total"?1:0).attr("transform","translate("+T.padding[3]+","+(Math.sqrt(4*Gt/Math.sqrt(3))/2+nt)+")"),$=B.append("text").attr("class","pbiclcCbpfLabel").attr("x",T.padding[3]+T.labelPadding).attr("y",Ce).text(me(0)),K=B.append("rect").attr("class","pbiclcCbpfTooltipRectangle").attr("y",-ct/2).attr("height",ct).attr("width",T.width).style("fill","none").attr("pointer-events","all").attr("cursor","pointer");f=B.merge(f),f.transition().duration(O).attr("transform",function(r){return"translate(0,"+At(r.cbpf)+")"}),f.select(".pbiclcCbpfStick").transition().duration(O).attr("x",T.padding[3]).attr("width",function(r){return ft(r[t.selectedContribution])-T.padding[3]}),f.select(".pbiclcCbpfLollipop").transition().duration(O).attr("cx",function(r){return ft(r[t.selectedContribution])}),f.select(".pbiclcCbpfPaidIndicator").transition().duration(O).style("opacity",function(r){return t.selectedContribution==="total"&&r.pledge?1:0}).attr("transform",function(r){let e=ft(r.total)-ft(r.paid)<Ct?Ct-nt/2:0;return"translate("+ft(r.paid)+","+(Math.sqrt(4*Gt/Math.sqrt(3))/2+nt+e)+")"}),f.select(".pbiclcCbpfLabel").transition().duration(O).attr("x",function(r){return ft(r[t.selectedContribution])+T.labelPadding}).tween("text",function(r){let e=this,p=d3.interpolate(ze(e.textContent)||0,r[t.selectedContribution]);function y(L){L.append("tspan").attr("class","pbiclcDonorLabelPercentage").attr("dy","-0.5px").text(" (").append("tspan").style("fill",St).text(d3.formatPrefix(".0",r.paid)(r.paid).replace("G","B")).append("tspan").style("fill","#aaa").text("/").append("tspan").style("fill",ne).text(d3.formatPrefix(".0",r.pledge)(r.pledge).replace("G","B")).append("tspan").style("fill","#aaa").text(")")}return function(L){let F=d3.select(e).text(d3.formatPrefix(".0",r[t.selectedContribution])(p(L)).replace("G","B"));t.selectedContribution==="total"&&r.pledge?F.call(y):F.append("tspan").text(null)}}),f.selectAll("rect, circle").classed("allocationColorFill",function(r){return!r.clicked}).classed("allocationColorDarkerFill",function(r){return r.clicked}),f.select(".pbiclcCbpfTooltipRectangle").on("mouseover",tt).on("mouseout",j).on("click",X),Me.tickSizeInner(-(ct*u.length)),Rt.selectAll(".tick").filter(function(r){return At.domain().indexOf(r)===-1}).remove(),Rt.transition().duration(O).attr("transform","translate("+T.padding[3]+",0)").call(ie),Be.transition().duration(O).call(Me),Be.selectAll(".tick").filter(function(r){return r===0}).remove(),Q();function tt(r){mt=this,r.clicked||t.selectedCbpfs.push(r.isoCode),f.style("opacity",function(et){return t.selectedCbpfs.indexOf(et.isoCode)>-1?1:gt}),Rt.selectAll(".tick").style("opacity",function(et){let P=Object.keys(I).find(function(N){return I[N]===et});return t.selectedCbpfs.indexOf(P)>-1?1:gt}),Y.style("display","block").html("CBPF: <strong>"+r.cbpf+"</strong><br><br><div style='margin:0px;display:flex;flex-wrap:wrap;width:290px;'><div style='display:flex;flex:0 62%;'>Total contributions:</div><div style='display:flex;flex:0 38%;justify-content:flex-end;'><span class='contributionColorHTMLcolor'>$"+pt(r.total)+"</span></div><div style='display:flex;flex:0 62%;white-space:pre;'>Contribution paid <span style='color: #888;'>("+Bt(r.paid,r.total)+")</span>:</div><div style='display:flex;flex:0 38%;justify-content:flex-end;'><span class='contributionColorHTMLcolor'>$"+pt(r.paid)+"</span></div><div style='display:flex;flex:0 62%;white-space:pre;'>Contribution unpaid <span style='color: #888;'>("+Bt(r.pledge,r.total)+")</span>:</div><div style='display:flex;flex:0 38%;justify-content:flex-end;'><span class='contributionColorHTMLcolor'>$"+pt(r.pledge)+"</span></div></div>");let e=this.getBoundingClientRect(),p=M.node().getBoundingClientRect(),y=Y.node().getBoundingClientRect(),L=e.top-p.top,F=e.left-p.left+(e.width-y.width)/2;Y.style("top",L+22+"px").style("left",F+"px"),J()}function j(r){if(!Pt){if(mt=null,!r.clicked){let e=t.selectedCbpfs.indexOf(r.isoCode);e>-1&&t.selectedCbpfs.splice(e,1)}Q(),Y.style("display","none"),J()}}function X(r){if(t.selectedDonors.length=0,i.dataDonors.forEach(function(y){y.clicked=!1}),r.clicked=!r.clicked,r.clicked)t.selectedCbpfs.indexOf(r.isoCode)===-1&&t.selectedCbpfs.push(r.isoCode);else{let y=t.selectedCbpfs.indexOf(r.isoCode);t.selectedCbpfs.splice(y,1)}let e=t.selectedCbpfs.map(function(y){return c.indexOf(y)>-1?I[y]+"@fund":I[y]}).join("|");W.has("country")?W.set("country",e):W.append("country",e);let p=i.dataCbpfs.find(function(y){return y.isoCode===r.isoCode});p.clicked=r.clicked,Y.style("display","none"),G(),J(),st(),ae()}function Q(){t.selectedCbpfs.length?(f.style("opacity",function(r){return t.selectedCbpfs.indexOf(r.isoCode)>-1?1:gt}),Rt.selectAll(".tick").style("opacity",function(r){let e=Object.keys(I).find(function(p){return I[p]===r});return t.selectedCbpfs.indexOf(e)>-1?1:gt})):(f.style("opacity",1),Rt.selectAll(".tick").style("opacity",1))}}function It(){let u=this.getBoundingClientRect().top-M.node().getBoundingClientRect().top+this.getBoundingClientRect().height;Y.style("display","block").html("<div style='margin:0px;display:flex;flex-wrap:wrap;width:256px;'><div style='display:flex;flex:0 54%;'>Total contributions:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorHTMLcolor'>$"+pt(bt.total)+"</span></div><div style='display:flex;flex:0 54%;white-space:pre;'>Total paid <span style='color: #888;'>("+Bt(bt.paid,bt.total)+")</span>:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorHTMLcolor'>$"+pt(bt.paid)+"</span></div><div style='display:flex;flex:0 54%;white-space:pre;'>Total pledge <span style='color: #888;'>("+Bt(bt.pledge,bt.total)+")</span>:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorHTMLcolor'>$"+pt(bt.pledge)+"</span></div></div>"),Y.style("top",u+"px").style("left",h.moneyBagPadding+"px")}function Yt(){let u=this.getBoundingClientRect().top-M.node().getBoundingClientRect().top+this.getBoundingClientRect().height+qe;Y.style("display","block").html(null);let x=[];i.dataCbpfs.forEach(function(w){if(w.cbpf.includes("RhPF")){let Dt=w.cbpf.split("(RhPF")[0].trim(),H=d.find(function(K){return K.RFundName.includes(Dt)});if(!H)return;let $=x.find(function(K){return K.rfCode===H.RFundAbbrv});$?$.funds.push(w.cbpf):x.push({rfCode:H.RFundAbbrv,rfName:H.RFundTitle,funds:[w.cbpf]})}});let f=Y.append("div").style("max-width","300px").attr("id","pbiclcInnerTooltipDiv").selectAll(null).data(x).enter().append("div").attr("class","pbiclcFundsDiv");f.append("div").attr("class","pbiclcfundsDivTitle").html(function(w){return w.rfName}),f.append("div").html(function(w){return w.funds.length+(w.funds.length>1?" Country envelopes:":" Country envelope:")});let _=f.append("ul").selectAll(null).data(function(w){return w.funds}).enter().append("li").attr("class","pbiclcFundsList").html(function(w){return w}),B=Y.node().getBoundingClientRect();Y.style("top",u+"px").style("left",h.width-B.width+"px")}function Jt(){Pt||Y.style("display","none")}function re(u){Y.style("display","block").html(null),Y.append("div").style("max-width","200px").attr("id","pbiclcInnerTooltipDiv").html(u===q?"Click to show all years":"Click for selecting a single year. Double-click or ALT + click for selecting multiple years.");let b=M.node().getBoundingClientRect(),f=this.getBoundingClientRect();tooltipSize=Y.node().getBoundingClientRect(),Y.style("left",f.left+f.width/2-b.left>b.width-tooltipSize.width/2-v[1]?b.width-tooltipSize.width-v[1]+"px":f.left+f.width/2-b.left<tooltipSize.width/2+g.padding[3]+v[0]?g.padding[3]+v[0]+"px":f.left+f.width/2-b.left-tooltipSize.width/2+"px").style("top",f.top+f.height/2-b.top<tooltipSize.height?f.top-b.top+f.height+2+"px":f.top-b.top-tooltipSize.height-4+"px"),d3.select(this).style("fill",xt),d3.select(this.parentNode).selectAll("text").filter(function(_){return _===u}).style("fill","white")}function ce(u){Y.style("display","none"),!(t.selectedYear.indexOf(u)>-1)&&(d3.select(this).style("fill","#eaeaea"),d3.selectAll(".pbiclcbuttonsText").filter(function(x){return x===u}).style("fill","#444"))}function ot(u){d3.select(this).style("fill",xt),d3.select(this.parentNode).selectAll("text").filter(function(x){return x===u}).style("fill","white")}function ht(u){u!==t.selectedContribution&&(d3.select(this).style("fill","#eaeaea"),d3.selectAll(".pbiclcbuttonsContributionsText").filter(function(x){return x===u}).style("fill","#444"))}function vt(){Pn(i.dataDonors.length,i.dataCbpfs.length);let u=Ne(i.dataDonors,"donor"),x=Ne(i.dataCbpfs,"cbpf");An(u,x),wn(i.dataDonors,i.dataCbpfs,"total")}}function Ge(n){let s=[],d=[],l=[],i=[];(t.selectedYear[0]===q?n.slice():n.filter(function(o){return t.selectedYear.indexOf(+o.FiscalYear)>-1})).forEach(function(o){if(l.indexOf(o.GMSDonorName)>-1){let D=s.filter(function(k){return k.donor===o.GMSDonorName})[0],C=D.donations.filter(function(k){return k.cbpf===o.PooledFundName})[0];C?(C.paid+=+o.PaidAmt,C.pledge+=+o.PledgeAmt,C.total+=+o.PaidAmt+ +o.PledgeAmt):D.donations.push({cbpf:o.PooledFundName,isoCode:o.PooledFundISO2Code.toLowerCase(),paid:+o.PaidAmt,pledge:+o.PledgeAmt,total:+o.PaidAmt+ +o.PledgeAmt}),D.paid+=+o.PaidAmt,D.pledge+=+o.PledgeAmt,D.total+=+o.PaidAmt+ +o.PledgeAmt}else s.push({clicked:!1,donor:o.GMSDonorName,isoCode:o.GMSDonorISO2Code.toLowerCase(),donations:[{cbpf:o.PooledFundName,isoCode:o.PooledFundISO2Code.toLowerCase(),paid:+o.PaidAmt,pledge:+o.PledgeAmt,total:+o.PaidAmt+ +o.PledgeAmt}],paid:+o.PaidAmt,pledge:+o.PledgeAmt,total:+o.PaidAmt+ +o.PledgeAmt}),l.push(o.GMSDonorName);if(i.indexOf(o.PooledFundName)>-1){let D=d.filter(function(k){return k.cbpf===o.PooledFundName})[0],C=D.donors.filter(function(k){return k.donor===o.GMSDonorName})[0];C?(C.paid+=+o.PaidAmt,C.pledge+=+o.PledgeAmt,C.total+=+o.PaidAmt+ +o.PledgeAmt):D.donors.push({donor:o.GMSDonorName,isoCode:o.GMSDonorISO2Code.toLowerCase(),paid:+o.PaidAmt,pledge:+o.PledgeAmt,total:+o.PaidAmt+ +o.PledgeAmt}),D.paid+=+o.PaidAmt,D.pledge+=+o.PledgeAmt,D.total+=+o.PaidAmt+ +o.PledgeAmt}else d.push({clicked:!1,cbpf:o.PooledFundName,isoCode:o.PooledFundISO2Code.toLowerCase(),donors:[{donor:o.GMSDonorName,isoCode:o.GMSDonorISO2Code.toLowerCase(),paid:+o.PaidAmt,pledge:+o.PledgeAmt,total:+o.PaidAmt+ +o.PledgeAmt}],paid:+o.PaidAmt,pledge:+o.PledgeAmt,total:+o.PaidAmt+ +o.PledgeAmt}),i.push(o.PooledFundName)});let a=s.find(function(o){return o.donor.indexOf("Macedonia")>-1});return a&&(a.donor="Macedonia"),l=[],i=[],[s,d]}function xn(n){let s=n.filter(function(a){return!t.selectedDonors.length&&!t.selectedCbpfs.length?t.selectedYear.indexOf(+a.FiscalYear)>-1||t.selectedYear[0]===q:t.selectedDonors.length?(t.selectedYear.indexOf(+a.FiscalYear)>-1||t.selectedYear[0]===q)&&t.selectedDonors.indexOf(a.GMSDonorISO2Code.toLowerCase())>-1:(t.selectedYear.indexOf(+a.FiscalYear)>-1||t.selectedYear[0]===q)&&t.selectedCbpfs.indexOf(a.PooledFundISO2Code.toLowerCase())>-1}).sort(function(a,o){return+o.FiscalYear-+a.FiscalYear||(a.GMSDonorName.toLowerCase()<o.GMSDonorName.toLowerCase()?-1:a.GMSDonorName.toLowerCase()>o.GMSDonorName.toLowerCase()?1:0)||(a.PooledFundName.toLowerCase()<o.PooledFundName.toLowerCase()?-1:a.PooledFundName.toLowerCase()>o.PooledFundName.toLowerCase()?1:0)}),d=JSON.parse(JSON.stringify(s));d.forEach(function(a){a.Year=+a.FiscalYear,a["Donor Name"]=a.GMSDonorName,a["CBPF Name"]=a.PooledFundName,a["Paid Amount"]=+a.PaidAmt,a["Pledged Amount"]=+a.PledgeAmt,a["Total Contributions"]=+a.PaidAmt+ +a.PledgeAmt,a["Local Curency"]=a.PaidAmtLocalCurrency,a["Exchange Rate"]=a.PaidAmtCurrencyExchangeRate,a["Paid Amount (Local Currency)"]=+a.PaidAmtLocal,a["Pledged Amount (Local Currency)"]=+a.PledgeAmtLocal,a["Total Contributions (Local Currency)"]=+a.PaidAmtLocal+ +a.PledgeAmtLocal,delete a.FiscalYear,delete a.GMSDonorName,delete a.PooledFundName,delete a.PaidAmt,delete a.PledgeAmt,delete a.PaidAmtLocal,delete a.PledgeAmtLocal,delete a.GMSDonorISO2Code,delete a.PooledFundISO2Code,delete a.PledgeAmtLocalCurrency,delete a.PledgeAmtCurrencyExchangeRate,delete a.PaidAmtLocalCurrency,delete a.PaidAmtCurrencyExchangeRate});let l=d3.keys(d[0]),i=function(a,o){return o===null?"":o},c=d.map(function(a){return l.map(function(o){return JSON.stringify(a[o],i)}).join(",")});return c.unshift(l.join(",")),c.join(`\r
`)}function Pn(n,s){A.height=n*ct+A.padding[0]+A.padding[2],T.height=s*ct+T.padding[0]+T.padding[2],yn.attr("height",A.height),Cn.attr("height",T.height),at=v[0]+v[2]+h.height+g.height+Math.max(A.height,T.height)+2*jt,De===!1&&M.style("height",at+"px"),$t?z.transition().duration(Pe).attr("viewBox","0 0 "+m+" "+at).attr("height",at):z.transition().duration(Pe).attr("viewBox","0 0 "+m+" "+at)}function Ne(n,s){let d=n.map(function(i){return i[s]}).sort(function(i,c){return c.length-i.length}).slice(0,5),l=[];return d.forEach(function(i){i.length>Tt&&(i=i.slice(0,Tt)+"...");let c=z.append("text").attr("class","pbiclcgroupYAxisDonorsFake").style("opacity",0).text(i),a=Math.ceil(c.node().getComputedTextLength());l.push(a),c.remove()}),d3.max(l)}function wn(n,s,d){let l=Math.max(d3.max(n,function(i){return i[d]}),d3.max(s,function(i){return i[d]}));ut.domain([0,Math.floor(l*1.05)]),ft.domain([0,Math.floor(l*1.05)])}function An(n,s){let d=Math.max(n+oe.tickPadding()+oe.tickSizeInner(),s+ie.tickPadding()+ie.tickSizeInner());A.padding[3]=d,T.padding[3]=d,ut.range([A.padding[3],A.width-A.padding[1]]),ft.range([T.padding[3],T.width-T.padding[1]]),wt.range([A.padding[0],A.height-A.padding[2]]),At.range([T.padding[0],T.height-T.padding[2]])}function vn(){Mt.attr("transform","translate("+A.padding[3]+",0)"),Rt.attr("transform","translate("+T.padding[3]+",0)")}function Kt(n){let s=document.createElementNS("http://www.w3.org/2000/svg","g");s.setAttributeNS(null,"transform",n);let d=s.transform.baseVal.consolidate().matrix;return[d.e,d.f]}function ae(){if(!t.selectedDonors.length&&!t.selectedCbpfs.length){Se.html(null);return}let n=t.selectedDonors.length?"selectedDonors":"selectedCbpfs",s=t.selectedDonors.length?"donor":"CBPF";Se.html(function(){if(t[n].length===0)return null;let d=t[n].length===1?"":"s",l=t[n].map(function(i){return I[i]}).sort(function(i,c){return i.toLowerCase()<c.toLowerCase()?-1:i.toLowerCase()>c.toLowerCase()?1:0}).reduce(function(i,c,a){return i+(a>=t[n].length-2?a>t[n].length-2?c:c+" and ":c+", ")},"");return"\u207ASelected "+s+d+": "+l})}function Ee(){bn.html(function(){return t.selectedYear.length===1?null:"*Selected years: "+t.selectedYear.sort(function(s,d){return s-d}).reduce(function(s,d,l){return s+(l>=t.selectedYear.length-2?l>t.selectedYear.length-2?d:d+" and ":d+", ")},"")})}function Ie(){dt.style("opacity",0).style("pointer-events","none");let n=M.append("div").attr("class","pbiclcOverDivHelp"),s=Et.node().getBoundingClientRect(),d=dt.node().getBoundingClientRect(),l=s.height*(m/s.width),i=n.append("svg").attr("viewBox","0 0 "+m+" "+(at+l)),c=[{text:"CLOSE",width:90},{text:"GO TO HELP PORTAL",width:180}],a=i.selectAll(null).data(c).enter().append("g");a.append("rect").attr("rx",4).attr("ry",4).style("stroke","rgba(0, 0, 0, 0.3)").style("stroke-width","1px").style("fill",Qe).style("cursor","pointer").attr("y",6).attr("height",22).attr("width",function(E){return E.width}).attr("x",function(E,J){return m-v[1]-E.width-(J?c[0].width+8:0)}).on("click",function(E,J){dt.style("opacity",1).style("pointer-events","all"),n.remove(),J&&window.open(on,"help_portal")}),a.append("text").attr("class","pbiclcAnnotationMainText").attr("text-anchor","middle").attr("x",function(E,J){return m-v[1]-E.width/2-(J?c[0].width+8:0)}).attr("y",22).text(function(E){return E.text}),[{x:96,y:72+l,width:480,height:30,xTooltip:180*(s.width/m),yTooltip:(l+112)*(s.width/m),text:"Use these buttons to select the year. Double click or press ALT when clicking to select multiple years. Click the arrows to reveal more years."},{x:592,y:72+l,width:224,height:30,xTooltip:550*(s.width/m),yTooltip:(l+112)*(s.width/m),text:"Use these buttons to select the type of contribution: paid, pledged or total (paid plus pledged)."},{x:96,y:10+l,width:720,height:57,xTooltip:300*(s.width/m),yTooltip:(l+76)*(s.width/m),text:"This banner shows the total amount of contributions received for the selected year (or years). It also shows the number of donors and CBPFs in that period."},{x:6,y:108+l,width:440,height:660,xTooltip:452*(s.width/m),yTooltip:(l+164)*(s.width/m),text:"Hover over the donors to get additional information. Hovering over a donor filters the CBPFs accordingly, so only CBPFs that received from that donor are displayed. When \u201CTotal\u201D is selected, the purple triangle indicates the paid amount, and the values between parentheses correspond to paid and pledged values, respectively."},{x:466,y:108+l,width:398,height:380,xTooltip:136*(s.width/m),yTooltip:(l+164)*(s.width/m),text:"Hover over the CBPFs to get additional information. Hovering over a CBPF filters the donors accordingly, so only donors that donated to that CBPF are displayed. When \u201CTotal\u201D is selected, the purple triangle indicates the paid amount, and the values between parentheses correspond to paid and pledged values, respectively."}].forEach(function(E){i.append("rect").attr("rx",4).attr("ry",4).attr("x",E.x).attr("y",E.y).attr("width",E.width).attr("height",E.height).style("stroke",xt).style("stroke-width","3px").style("fill","none").style("opacity",.5).attr("class","pbiclcHelpRectangle").attr("pointer-events","all").on("mouseover",function(){let J=this;k(E.xTooltip,E.yTooltip,E.text,J)}).on("mouseout",G)});let D=i.append("rect").attr("x",m/2-180).attr("y",244).attr("width",360).attr("height",50).attr("pointer-events","none").style("fill","white").style("stroke","#888"),C=i.append("text").attr("class","pbiclcAnnotationExplanationText").attr("font-family","Roboto").attr("font-size","18px").style("fill","#222").attr("text-anchor","middle").attr("x",m/2).attr("y",264).attr("pointer-events","none").text("Hover over the elements surrounded by a blue rectangle to get additional information").call(Sn,350);function k(E,J,st,It){C.style("opacity",0),D.style("opacity",0),i.selectAll(".pbiclcHelpRectangle").style("opacity",.1),d3.select(It).style("opacity",1);let Yt=M.node().getBoundingClientRect();Y.style("top",J+"px").style("left",E+"px").style("display","block").html(st)}function G(){Y.style("display","none"),C.style("opacity",1),D.style("opacity",1),i.selectAll(".pbiclcHelpRectangle").style("opacity",.5)}}function Dn(){let n="\xA9 OCHA CBPF Section "+Wt;dn&&(n+=" | For more information, please visit <a href='https://cbpf.data.unocha.org'>cbpf.data.unocha.org</a>"),mn.append("div").attr("class","d3chartFooterText").html(n)}function Sn(n,s){n.each(function(){let d=d3.select(this),l=d.text().split(/\s+/).reverse(),i,c=[],a=0,o=1.1,D=d.attr("y"),C=d.attr("x"),k=0,G=d.text(null).append("tspan").attr("x",C).attr("y",D).attr("dy",k+"em");for(;i=l.pop();)c.push(i),G.text(c.join(" ")),G.node().getComputedTextLength()>s&&(c.pop(),G.text(c.join(" ")),c=[i],G=d.append("tspan").attr("x",C).attr("y",D).attr("dy",++a*o+k+"em").text(i))})}function Zt(n,s){if($t){alert("This functionality is not supported by Internet Explorer");return}let l=d3.select("body").append("div").style("position","fixed").attr("id","pbiclcDownloadingDiv").style("left",window.innerWidth/2-100+"px").style("top",window.innerHeight/2-100+"px").append("svg").attr("class","pbiclcDownloadingDivSvg").attr("width",200).attr("height",100),i="Downloading "+n.toUpperCase();Ye(l,200,175,i);let c=z.node().getBoundingClientRect();z.attr("width",c.width).attr("height",c.height);let a=["font-size","font-family","font-weight","fill","stroke","stroke-dasharray","stroke-width","opacity","text-anchor","text-transform","shape-rendering","letter-spacing","white-space"],o=M.node();D(z.node()),n==="png"?dt.style("opacity",0):Et.style("opacity",0),Lt.style("display","none"),z.selectAll("image").attr("xlink:href",function(C){return localStorage.getItem("storedFlag"+C.isoCode)}),html2canvas(o).then(function(C){z.attr("width",null).attr("height",null),n==="png"?dt.style("opacity",1):Et.style("opacity",1),n==="png"?Tn(C):Ln(C),s&&mt&&d3.select(mt).dispatch("mouseout")});function D(C){if(!C.style)return;let k=getComputedStyle(C);for(let G=0;G<a.length;G++)C.style[a[G]]=k[a[G]];for(let G=0;G<C.childNodes.length;G++)D(C.childNodes[G])}}function Tn(n){let d="CBPFcontributions_"+qt(new Date)+".png";n.toBlob(function(l){let i=URL.createObjectURL(l),c=document.createElement("a");c.download!==void 0?(c.setAttribute("href",i),c.setAttribute("download",d),c.style="visibility:hidden",document.body.appendChild(c),c.click(),document.body.removeChild(c)):window.location.href=i}),se(),d3.select("#pbiclcDownloadingDiv").remove()}function Ln(n){let s={top:10,bottom:16,left:20,right:30};d3.image("https://raw.githubusercontent.com/CBPFGMS/cbpfgms.github.io/master/img/assets/bilogo.png").then(function(d){let l,c=M.node().getBoundingClientRect(),a=210-s.left*2,o=a*(c.height/c.width),D=180,C;o>D?(C=297+o-D,l=new jsPDF({format:[210*2.834646,C*2.834646],unit:"mm"})):(C=297,l=new jsPDF);let k;re();let G=l.splitTextToSize("Since the first CBPF was opened in Angola in 1997, donors have contributed more than $5 billion to 27 funds operating in the most severe and complex emergencies around the world.",210-s.left-s.right,{fontSize:12}),E=d3.timeFormat("%A, %d %B %Y")(new Date);l.setTextColor(60),l.setFont("helvetica"),l.setFontType("normal"),l.setFontSize(12),l.text(s.left,48,G),l.setTextColor(65,143,222),l.setFont("helvetica"),l.setFontType("bold"),l.setFontSize(16),l.text(ve,s.left,65),l.setFontSize(12);let J=t.selectedYear.sort(function(ot,ht){return ot-ht}).reduce(function(ot,ht,vt){return ot+(vt>=t.selectedYear.length-2?vt>t.selectedYear.length-2?ht:ht+" and ":ht+", ")},""),st=t.selectedYear.length>1?"Selected years: ":"Selected year: ",It=t.selectedContribution==="total"?"Total (Paid + Pledged)":t.selectedContribution==="paid"?"Paid":"Pledged",Yt=!t.selectedDonors.length&&!t.selectedCbpfs.length?"Selected countries-all":ce();l.fromHTML("<div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>Date: <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+E+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+st+"<span style='color: rgb(65, 143, 222); font-weight: 700;'>"+J+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>Contributions: <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+It+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+Yt.split("-")[0]+": <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+Yt.split("-")[1]+"</span></div>",s.left,70,{width:210-s.left-s.right},function(ot){k=ot}),l.addImage(n,"PNG",s.left,k.y+2,a,o);let Jt=new Date;l.save("CBPFcontributions_"+qt(Jt)+".pdf"),se(),d3.select("#pbiclcDownloadingDiv").remove();function re(){let ot="\xA9 OCHA CBPF Section "+Wt+" | For more information, please visit cbpf.data.unocha.org";l.setFillColor(65,143,222),l.rect(0,s.top,210,15,"F"),l.setFillColor(236,161,84),l.rect(0,s.top+15,210,2,"F"),l.setFillColor(255,255,255),l.rect(s.left,s.top-1,94,20,"F"),l.ellipse(s.left,s.top+9,5,9,"F"),l.ellipse(s.left+94,s.top+9,5,9,"F"),l.addImage(d,"PNG",s.left+2,s.top,90,18),l.setFillColor(236,161,84),l.rect(0,C-s.bottom,210,2,"F"),l.setTextColor(60),l.setFont("arial"),l.setFontType("normal"),l.setFontSize(10),l.text(ot,s.left,C-s.bottom+10)}function ce(){let ot=t.selectedDonors.length?"selectedDonors":"selectedCbpfs",ht=t.selectedDonors.length?"donor":"CBPF",vt=t[ot].length===1?"":"s",u=t[ot].map(function(x){return I[x]}).sort(function(x,b){return x.toLowerCase()<b.toLowerCase()?-1:x.toLowerCase()>b.toLowerCase()?1:0}).reduce(function(x,b,f){return x+(f>=t[ot].length-2?f>t[ot].length-2?b:b+" and ":b+", ")},"");return"Selected "+ht+vt+"-"+u}})}function Ye(n,s,d,l){let i=n.append("g").attr("class","pbiclcd3chartwheelGroup").attr("transform","translate("+s/2+","+d/4+")"),c=i.append("text").attr("text-anchor","middle").style("font-family","Roboto").style("font-weight","bold").style("font-size","11px").attr("y",50).attr("class","contributionColorFill").text(l),a=d3.arc().outerRadius(25).innerRadius(20),o=i.append("path").datum({startAngle:0,endAngle:0}).classed("contributionColorFill",!0).attr("d",a);D();function D(){o.transition().duration(1e3).attrTween("d",function(k){let G=d3.interpolate(0,Math.PI*2);return function(E){return k.endAngle=G(E),a(k)}}).on("end",C)}function C(){o.transition().duration(1e3).attrTween("d",function(k){let G=d3.interpolate(0,Math.PI*2);return function(E){return k.startAngle=G(E),a(k)}}).on("end",function(k){k.startAngle=0,D()})}}function se(){let n=d3.select(".pbiclcd3chartwheelGroup");n.select("path").interrupt(),n.remove()}function Mn(n){if(n.toLowerCase()===q){t.selectedYear.push(q);return}n.split(",").map(function(d){return+d.trim()}).sort(function(d,l){return d-l}).forEach(function(d){d&&U.indexOf(d)>-1&&t.selectedYear.push(d)}),t.selectedYear.length||t.selectedYear.push(new Date().getFullYear())}function He(n){if(U.indexOf(n)>-1)return n;for(;U.indexOf(n)===-1;)n=n>=Wt?n-1:n+1;return n}function Rn(n,s,d){if(!n||n.toLowerCase()==="none")return;let l=n.split(",").map(function(c){return c.trim().toLowerCase()}),i=Object.keys(I);l.forEach(function(c){let a=c.split("@");if(a.length===1){let o=i.find(function(C){return I[C].toLowerCase()===a[0]&&s.indexOf(C)>-1}),D=i.find(function(C){return I[C].toLowerCase()===a[0]&&d.indexOf(C)>-1});o&&t.selectedDonors.push(o),D&&t.selectedCbpfs.push(D)}else if(a[1]==="donor"){let o=i.find(function(D){return I[D].toLowerCase()===a[0]&&s.indexOf(D)>-1});o&&t.selectedDonors.push(o)}else if(a[1]==="fund"){let o=i.find(function(D){return I[D].toLowerCase()===a[0]&&d.indexOf(D)>-1});o&&t.selectedCbpfs.push(o)}}),t.selectedDonors.length&&t.selectedCbpfs.length&&(t.selectedDonors.length=0,t.selectedCbpfs.length=0)}function Ve(n){return n[0].toUpperCase()+n.substring(1)}function Ue(n){let s=(~~Math.log10(n)+1)%3,d=s===1?2:s===2?1:0,l=d3.formatPrefix("."+d+"~",n)(n);if(parseInt(l)===1e3){let i=l[l.length-1],c={k:"M",M:"B"};return 1+(isNaN(i)?c[i]:"")}return l}function Bt(n,s){let d=_e(n/s);return+d.split("%")[0]==0&&n/s!==0?"<1%":d}function ze(n){if(+n==0)return 0;let s,d={Y:Math.pow(10,24),Z:Math.pow(10,21),E:Math.pow(10,18),P:Math.pow(10,15),T:Math.pow(10,12),G:Math.pow(10,9),B:Math.pow(10,9),M:Math.pow(10,6),k:Math.pow(10,3),h:Math.pow(10,2),da:Math.pow(10,1),d:Math.pow(10,-1),c:Math.pow(10,-2),m:Math.pow(10,-3),\u03BC:Math.pow(10,-6),n:Math.pow(10,-9),p:Math.pow(10,-12),f:Math.pow(10,-15),a:Math.pow(10,-18),z:Math.pow(10,-21),y:Math.pow(10,-24)};return Object.keys(d).some(function(l){if(n.indexOf(l)>0)return s=parseFloat(n.split(l)[0])*d[l],!0}),s}}})();})();
