(()=>{(function(){let Zt=window.navigator.userAgent.indexOf("MSIE")>-1||window.navigator.userAgent.indexOf("Trident")>-1,Lt=window.fetch,Yt=window.URLSearchParams,We=window.matchMedia("(pointer: coarse)").matches&&!window.matchMedia("(any-pointer: fine)").matches,Kt=window.location.hostname==="cbpf.data.unocha.org",ge=window.location.hostname+window.location.pathname==="cbpf.data.unocha.org/bookmark.html",fe="https://use.fontawesome.com/releases/v5.6.3/css/all.css",Ue=["https://cbpfgms.github.io/css/d3chartstyles.css","https://cbpfgms.github.io/css/d3chartstylespbigam.css",fe],Gt="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js",he="https://cbpfgms.github.io/libraries/html2canvas.min.js",me="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js",Ot="https://cdn.jsdelivr.net/npm/@ungap/url-search-params@0.1.2/min.min.js",ye="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js",be="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.4/fetch.min.js";if(Ue.forEach(function(A){if(!_e(A)){let v=document.createElement("link");v.setAttribute("rel","stylesheet"),v.setAttribute("type","text/css"),v.setAttribute("href",A),A===fe&&(v.setAttribute("integrity","sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"),v.setAttribute("crossorigin","anonymous")),document.getElementsByTagName("head")[0].appendChild(v)}}),!Qt(Gt))Lt&&Yt?Q(Gt,ft):Lt&&!Yt?Q(Ot,function(){Q(Gt,ft)}):Q(ye,function(){Q(be,function(){Q(Ot,function(){Q(Gt,ft)})})});else if(typeof d3<"u")Lt&&Yt?ft():Lt&&!Yt?Q(Ot,ft):Q(ye,function(){Q(be,function(){Q(Ot,ft)})});else{let A,v=document.getElementsByTagName("script");for(let Z=v.length;Z--;)v[Z].src==Gt&&(A=v[Z]);A.addEventListener("load",ft)}function Q(A,v){let Z=document.getElementsByTagName("head")[0],X=document.createElement("script");X.type="text/javascript",X.src=A,X.onreadystatechange=v,X.onload=v,Z.appendChild(X)}function _e(A){let v=document.getElementsByTagName("link");for(let Z=v.length;Z--;)if(v[Z].href==A)return!0;return!1}function Qt(A){let v=document.getElementsByTagName("script");for(let Z=v.length;Z--;)if(v[Z].src==A)return!0;return!1}function ft(){Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(a){if(this==null)throw new TypeError('"this" is null or not defined');var l=Object(this),r=l.length>>>0;if(typeof a!="function")throw new TypeError("predicate must be a function");for(var e=arguments[1],c=0;c<r;){var p=l[c];if(a.call(e,p,c,l))return p;c++}},configurable:!0,writable:!0}),HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(a,l,r){var e=this.toDataURL(l,r).split(",")[1];setTimeout(function(){for(var c=atob(e),p=c.length,g=new Uint8Array(p),o=0;o<p;o++)g[o]=c.charCodeAt(o);a(new Blob([g],{type:l||"image/png"}))})}});let A=900,v=[4,4,4,4],Z=60,X=6,xe=60,ve=44,It=80,ht=12,Je=window.innerHeight,Xt=new Date,te=Xt.getFullYear(),$e=6e5,Y=1e3,we=.6,ot=2019,W=6,it=18,qe=1,Ze=300,Ke=1,Qe=.2,Xe=1,ee=48,tn=4.5,Pe=it+10,ne=164,vt=.2,en=100,Wn=3,zt=8,Un=3,nn=.48,an=60,on=12,rn=d3.format("~s"),_n=d3.format(".2s"),mt=d3.format(".0%"),jt=d3.format(".1%"),ln=d3.format(",.0f"),yt=d3.local(),rt="#1F69B3",Ce="#ECA154",sn="#eaeaea",Ge="#BFBFBF",cn="#F79A3B",dn="Gender with Age Marker (GAM)",pn="gam",At="pbigam",un="https://cbpf.data.unocha.org/bookmark.html?",gn="https://gms.unocha.org/content/cbpf-gam-marker",ae=d3.utcFormat("_%Y%m%d_%H%M%S_UTC"),fn=["M83.277,10.493l-13.132,12.22H22.821L9.689,10.493c0,0,6.54-9.154,17.311-10.352c10.547-1.172,14.206,5.293,19.493,5.56 c5.273-0.267,8.945-6.731,19.479-5.56C76.754,1.339,83.277,10.493,83.277,10.493z","M48.297,69.165v9.226c1.399-0.228,2.545-0.768,3.418-1.646c0.885-0.879,1.321-1.908,1.321-3.08 c0-1.055-0.371-1.966-1.113-2.728C51.193,70.168,49.977,69.582,48.297,69.165z","M40.614,57.349c0,0.84,0.299,1.615,0.898,2.324c0.599,0.729,1.504,1.303,2.718,1.745v-8.177 c-1.104,0.306-1.979,0.846-2.633,1.602C40.939,55.61,40.614,56.431,40.614,57.349z","M73.693,30.584H19.276c0,0-26.133,20.567-17.542,58.477c0,0,2.855,10.938,15.996,10.938h57.54 c13.125,0,15.97-10.938,15.97-10.938C99.827,51.151,73.693,30.584,73.693,30.584z M56.832,80.019 c-2.045,1.953-4.89,3.151-8.535,3.594v4.421H44.23v-4.311c-3.232-0.318-5.853-1.334-7.875-3.047 c-2.018-1.699-3.307-4.102-3.864-7.207l7.314-0.651c0.3,1.25,0.856,2.338,1.677,3.256c0.823,0.911,1.741,1.575,2.747,1.979v-9.903 c-3.659-0.879-6.348-2.22-8.053-3.997c-1.716-1.804-2.565-3.958-2.565-6.523c0-2.578,0.96-4.753,2.897-6.511 c1.937-1.751,4.508-2.767,7.721-3.034v-2.344h4.066v2.344c2.969,0.306,5.338,1.159,7.09,2.565c1.758,1.406,2.877,3.3,3.372,5.658 l-7.097,0.774c-0.43-1.849-1.549-3.118-3.365-3.776v9.238c4.485,1.035,7.539,2.357,9.16,3.984c1.634,1.635,2.441,3.725,2.441,6.289 C59.898,75.656,58.876,78.072,56.832,80.019z"],hn="https://cbpfapi.unocha.org/vo2/odata/ProjectGAMSummary?PoolfundCodeAbbrv=&$format=csv",mn="https://cbpfapi.unocha.org/vo2/odata/GenderMarker?$format=csv",yn="https://cbpfapi.unocha.org/vo2/odata/AllocationTypes?PoolfundCodeAbbrv=&$format=csv",bn="https://cbpfgms.github.io/pfbi-data/mst/MstRhpf.json",Et=["marker","aggregated"],lt={budget:"allocations",percentagegam:"percentageGam",percentagecbpf:"percentageCbpf"},Ae={percentagegam:"Total allocations for the Marker",percentagecbpf:"Total allocations for the CBPF",numerator:"Allocations in the CBPF\u2212Marker combination"},ke=["GM","GAM"],Ht=["2b","2a","1","0","3"],Nt=["4","3","2","1","0"],Wt=["aggregated"],oe=[],ie=["#418FDE","#A4D65E","#E2E868","#ECA154","#E56A54"],M=[],U={},kt={},Tt={},t={selectedYear:[],selectedCbpfs:[],allocationValue:null,gamGroup:null,display:null,showMean:null,cbpfsInData:[]},wt=!1,Ut=!0,Jn,st=v[0]+v[2]+Z+xe+It+ve+3*X,bt,D=new URLSearchParams(location.search);D.has("viz")||D.append("viz",pn);let T=d3.select("#d3chartcontainerpbigam"),xn=T.node().getAttribute("data-showhelp")==="true",vn=T.node().getAttribute("data-showlink")==="true",Te=+T.node().getAttribute("data-minpercentage")||0,Be=T.node().getAttribute("data-title")?T.node().getAttribute("data-title"):dn,wn=D.has("year")?D.get("year").replace(/\|/g,","):T.node().getAttribute("data-year"),Pn=D.has("fund")?D.get("fund").replace(/\|/g,","):T.node().getAttribute("data-cbpf"),Cn=D.get("gamgroup");t.showMean=D.has("showmean")?D.get("showmean")==="true":T.node().getAttribute("data-showmean")==="true",t.display=D.has("display")?D.get("display"):Et.indexOf(T.node().getAttribute("data-display"))>-1?T.node().getAttribute("data-display"):Et[0],t.allocationValue=D.has("valuetype")?D.get("valuetype"):lt[T.node().getAttribute("data-valuetype").replace(" ","").toLowerCase()]?lt[T.node().getAttribute("data-valuetype").replace(" ","").toLowerCase()]:"allocations";let Se=T.node().getAttribute("data-responsive")==="true",Gn=T.node().getAttribute("data-lazyload")==="true";Se===!1&&T.style("width",A+"px").style("height",st+"px");let Bt=T.append("div").attr("class","pbigamTopDiv"),An=Bt.append("div").attr("class","pbigamTitleDiv"),et=Bt.append("div").attr("class","pbigamIconsDiv d3chartIconsDiv"),re=T.append("div").attr("class","pbigamSelectTitleDiv"),_t=T.append("div").attr("class","pbigamSelectDiv"),le=T.append("div").attr("class","pbigamlaunchedValueDiv").append("span").attr("class","pbigamlaunchedValue"),E=T.append("svg").attr("viewBox","0 0 "+A+" "+st).style("background-color","white");Zt&&E.attr("height",st);let kn=T.append("div").attr("class","pbigamYearsDescriptionDiv"),Tn=Kt?null:T.append("div").attr("class","pbigamFooterDiv");He(E,A,st,"Loading visualisation...");let Pt=T.append("div").attr("id","pbigamSnapshotTooltip").attr("class","pbigamSnapshotContent").style("display","none").on("mouseleave",function(){wt=!1,Pt.style("display","none"),I.style("display","none"),bt&&d3.select(bt).dispatch("mouseout")});Pt.append("p").attr("id","pbigamSnapshotTooltipPdfText").html("Download PDF").on("click",function(){wt=!1,qt("pdf",!0)}),Pt.append("p").attr("id","pbigamSnapshotTooltipPngText").html("Download Image (PNG)").on("click",function(){wt=!1,qt("png",!0)});let De=!We&&(window.safari||window.navigator.userAgent.indexOf("Edge")>-1);De&&Pt.append("p").attr("id","pbigamTooltipBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default");let I=T.append("div").attr("id","pbigamtooltipdiv").style("display","none");T.on("contextmenu",function(){d3.event.preventDefault();let a=d3.mouse(this);wt=!0,Pt.style("display","block").style("top",a[1]-4+"px").style("left",a[0]-4+"px")});let b={main:E.append("g").attr("class","pbigamtopPanel").attr("transform","translate("+v[3]+","+v[0]+")"),width:A-v[1]-v[3],height:Z,padding:[0,0,0,0],moneyBagPadding:94,leftPadding:[176,464,632],mainValueVerPadding:12,mainValueHorPadding:4},i={main:E.append("g").attr("class","pbigambuttonsPanel").attr("transform","translate("+v[3]+","+(v[0]+b.height+X)+")"),width:A-v[1]-v[3],height:xe,padding:[0,0,30,0],buttonWidth:52,buttonPadding:4,buttonVerticalPadding:4,arrowPadding:18,buttonsAllocationsWidth:106,displayPadding:696,buttonDisplayWidth:96},y={main:E.append("g").attr("class","pbigambeeswarmPanel").attr("transform","translate("+v[3]+","+(v[0]+b.height+i.height+2*X)+")"),width:A-v[1]-v[3],height:It,padding:[38,it+78,14,220],axisVerticalPadding:16},_={main:E.append("g").attr("class","pbigamlegendPanel").attr("transform","translate("+v[3]+","+(v[0]+b.height+i.height+y.height+3*X)+")"),width:A-v[1]-v[3],height:ve},ut=d3.scaleOrdinal().range(ie).unknown(ie[ie.length-1]),St=d3.scaleLinear().range([y.padding[3],y.width-y.padding[1]]),$=d3.scalePoint().padding(.5),nt=d3.scaleSqrt().range([1.5,it]),Me=d3.axisTop(St),Ve=d3.axisLeft($).tickSizeOuter(0).tickFormat(function(a){return t.display==="aggregated"?"All":t.gamGroup==="GM"&&a==="3"?"3/4":a}),Fe=y.main.append("g").attr("class","pbigamxAxisGroup").attr("transform","translate(0,"+(y.padding[0]-y.axisVerticalPadding)+")"),Re=y.main.append("g").attr("class","pbigamyAxisGroup").attr("transform","translate("+y.padding[3]+",0)"),se=d3.forceSimulation().force("xPosition",d3.forceX(function(a){return St(a[t.allocationValue])}).strength(Ke)).force("yPosition",d3.forceY(function(a){return t.display==="aggregated"?$(Wt[0]):$(a.gamCode)===void 0?$("3"):$(a.gamCode)}).strength(Qe)).force("collision",d3.forceCollide(function(a){return nt(a.projects)+qe}).strength(Xe));Qt(he)||Q(he,null),Qt(me)||Q(me,null),Kt&&!ge?Promise.all([window.cbpfbiDataObject.dataGam,window.cbpfbiDataObject.masterGam,window.cbpfbiDataObject.launchedAllocationsData,window.cbpfbiDataObject.masterRegionalFunds]).then(a=>Le(a)):Promise.all([Jt(At+"data",hn,"data","csv"),Jt(At+"metadata",mn,"metadata","csv"),Jt("launchedAllocationsData",yn,"launched allocations data","csv"),Jt("masterRegionalFunds",bn,"master regional funds data","json")]).then(a=>Le(a));function Jt(a,l,r,e){if(localStorage.getItem(a)&&JSON.parse(localStorage.getItem(a)).timestamp>Xt.getTime()-$e){let c=e==="csv"?d3.csvParse(JSON.parse(localStorage.getItem(a)).data,d3.autoType):JSON.parse(localStorage.getItem(a)).data;return console.info(At+" chart info: "+r+" from local storage"),Promise.resolve(c)}else{let c=e==="csv"?d3.csv:d3.json,p=e==="csv"?d3.autoType:null;return c(l,p).then(g=>{try{localStorage.setItem(a,JSON.stringify({data:e==="csv"?d3.csvFormat(g):g,timestamp:Xt.getTime()}))}catch(o){console.info(At+" chart, "+o)}return console.info(At+" chart info: "+r+" from API"),g})}}function Le([a,l,r,e]){pe(),Mn(a,l),Rn(wn),t.selectedCbpfs=Ln(Pn),t.gamGroup=Cn||(t.selectedYear.length===1?M.filter(function(p){return t.selectedYear.indexOf(p.year)>-1}).reverse()[0].gamGroup:M.filter(function(p){return t.selectedYear.indexOf(p.year)>-1&&p.year!==ot})[0].gamGroup),Gn?(d3.select(window).on("scroll.pbigam",c),d3.select("body").on("d3ChartsYear.pbigam",function(){t.selectedYear=[Ie(+d3.event.detail).year],t.gamGroup=M.find(function(p){return p.year===t.selectedYear[0]}).gamGroup}),c()):Ye(a,r,e);function c(){let p=T.node().getBoundingClientRect();p.bottom<0||p.top-Je>0||(d3.select(window).on("scroll.pbigam",null),Ye(a,r,e))}}function Ye(a,l,r){let e=Vt(a,l);Bn(a),Sn(a,l,r),ce(e,r),Dn(a,l,r),ze(),Oe(),de(),Dt(e),Mt(e),Kt||On(),xn&&je()}function Bn(a){let l=An.append("p").attr("id","pbigamd3chartTitle").html(Be),r=et.append("button").attr("id","pbigamHelpButton");r.html("HELP  ").append("span").attr("class","fas fa-info");let e=et.append("button").attr("id","pbigamDownloadButton");e.html(".CSV  ").append("span").attr("class","fas fa-download");let c=et.append("div").attr("class","pbigamSnapshotDiv");c.append("button").attr("id","pbigamSnapshotButton").html("IMAGE ").append("span").attr("class","fas fa-camera");let g=c.append("div").attr("class","pbigamSnapshotContent"),o=g.append("p").attr("id","pbigamSnapshotPdfText").html("Download PDF").on("click",function(){qt("pdf",!1)}),f=g.append("p").attr("id","pbigamSnapshotPngText").html("Download Image (PNG)").on("click",function(){qt("png",!1)}),d=et.append("button").datum({clicked:!1}).attr("id","pbigamPlayButton");if(d.html("PLAY  ").append("span").attr("class","fas fa-play"),d.on("click",function(u){u.clicked=!u.clicked,d.html(u.clicked?"PAUSE ":"PLAY  ").append("span").attr("class",u.clicked?"fas fa-pause":"fas fa-play"),u.clicked?(t.selectedYear.length=1,h(),timer=d3.interval(h,3*Y)):timer.stop();function h(){let C=M.filter(function(B){return B.year!=="gap"}).map(function(B){return B.year+B.gamGroup}),V=C.indexOf(t.selectedYear[0]+t.gamGroup);t.selectedYear[0]=+C[(V+1)%C.length].slice(0,4),t.gamGroup=C[(V+1)%C.length].slice(4),d3.selectAll(".pbigambuttonsRects").filter(function(B){return B.year===t.selectedYear[0]&&B.gamGroup===t.gamGroup}).dispatch("click");let w=M.map(function(B){return B.year+B.gamGroup}),G=w.indexOf(t.selectedYear[0]+t.gamGroup)<W/2?0:w.indexOf(t.selectedYear[0]+t.gamGroup)>M.length-W/2?M.length-W:w.indexOf(t.selectedYear[0]+t.gamGroup)-W/2,O=-(i.buttonWidth*G);O===0?(E.select(".pbigamLeftArrowGroup").select("text").style("fill","#ccc"),E.select(".pbigamLeftArrowGroup").attr("pointer-events","none")):(E.select(".pbigamLeftArrowGroup").select("text").style("fill","#666"),E.select(".pbigamLeftArrowGroup").attr("pointer-events","all")),Math.abs(O)>=(M.length-W)*i.buttonWidth?(E.select(".pbigamRightArrowGroup").select("text").style("fill","#ccc"),E.select(".pbigamRightArrowGroup").attr("pointer-events","none")):(E.select(".pbigamRightArrowGroup").select("text").style("fill","#666"),E.select(".pbigamRightArrowGroup").attr("pointer-events","all")),E.select(".pbigambuttonsGroup").transition().duration(Y).attrTween("transform",function(){return d3.interpolateString(this.getAttribute("transform"),"translate("+O+",0)")})}}),!ge){let u=et.append("button").attr("id","pbigamShareButton");u.html("SHARE  ").append("span").attr("class","fas fa-share");let h=T.append("div").attr("class","d3chartShareDiv").style("display","none");u.on("mouseover",function(){h.html("Click to copy").style("display","block");let C=this.getBoundingClientRect(),V=T.node().getBoundingClientRect(),m=h.node().getBoundingClientRect(),w=C.top-V.top-(m.height-C.height)/2,G=C.left-V.left-m.width-12;h.style("top",w+"px").style("left",G+"20px")}).on("mouseout",function(){h.style("display","none")}).on("click",function(){let C=un+D.toString();h.append("input").attr("type","text").attr("readonly",!0).attr("spellcheck","false").property("value",C).node().select(),document.execCommand("copy"),h.html("Copied!");let m=this.getBoundingClientRect(),w=T.node().getBoundingClientRect(),G=h.node().getBoundingClientRect(),O=m.left-w.left-G.width-12;h.style("left",O+"20px")})}if(De){let u=g.append("p").attr("id","pbigamBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default")}c.on("mouseover",function(){g.style("display","block")}).on("mouseout",function(){g.style("display","none")}),r.on("click",je),e.on("click",function(){let u=Fn(a),C="GenderAgeMarker_"+ae(new Date)+".csv",V=new Blob([u],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(V,filename);else{let m=document.createElement("a");if(m.download!==void 0){let w=URL.createObjectURL(V);m.setAttribute("href",w),m.setAttribute("download",C),m.style="visibility:hidden",document.body.appendChild(m),m.click(),document.body.removeChild(m)}}})}function Sn(a,l,r){re.html("Select CBPF:");let e=d3.keys(U);e.unshift("All CBPFs");let c=_t.selectAll(null).data(e).enter().append("div").attr("class","pbigamCheckboxDiv");c.filter(function(u){return u!=="All CBPFs"}).style("opacity",function(u){return t.cbpfsInData.indexOf(u)===-1?we:1});let p=c.append("label"),g=p.append("input").attr("type","checkbox").property("checked",function(u){return t.selectedCbpfs.length!==d3.keys(U).length&&t.selectedCbpfs.indexOf(u)>-1}).attr("value",function(u){return u}),o=p.append("span").attr("class","pbigamCheckboxText").html(function(u){return U[u]||u}),f=c.filter(function(u){return u==="All CBPFs"}).select("input");d3.select(f.node().nextSibling).attr("class","pbigamCheckboxTextAllCbpfs");let d=c.filter(function(u){return u!=="All CBPFs"}).select("input");d.property("disabled",function(u){return t.cbpfsInData.indexOf(u)===-1}),f.property("checked",function(){return t.selectedCbpfs.length===d3.keys(U).length}),p.select("input").on("change",function(){if(this.value==="All CBPFs")this.checked?(t.selectedCbpfs=d3.keys(U),d.property("checked",!1)):t.selectedCbpfs.length=0;else{if(this.checked)t.selectedCbpfs.length===d3.keys(U).length?t.selectedCbpfs=[this.value]:t.selectedCbpfs.push(this.value);else{let h=t.selectedCbpfs.indexOf(this.value);t.selectedCbpfs.splice(h,1)}f.property("checked",!1)}if(!t.selectedCbpfs.length||t.selectedCbpfs.length===d3.keys(U).length)D.delete("fund");else{let h=t.selectedCbpfs.map(function(C){return U[C]}).join("|");D.has("fund")?D.set("fund",h):D.append("fund",h)}let u=Vt(a,l);ce(u,r),Dt(u),Mt(u)})}function ce(a,l){let r=t.selectedYear.sort(function(P,S){return P-S}).filter(function(P){return kt[P]}),e=r.reduce(function(P,S,R){return P+(R>=r.length-2?R>r.length-2?S:S+" and ":S+", ")},"");le.style("opacity",t.selectedYear.some(P=>kt[P])?1:0).html("Launched Allocations in "+e+": "),le.append("span").classed("contributionColorHTMLcolor",!0).html("$"+at(Tt.launched).replace("k"," Thousand").replace("M"," Million").replace("G"," Billion"));let c=d3.sum(a,function(P){return P.allocations}),p=d3.sum(a,function(P){return P.projects}),g=a.map(function(P){return P.cbpfName}).filter(function(P,S,R){return R.indexOf(P)===S}),o=g.filter(function(P){return!P.includes("RhPF")}).length,f=new Set;g.forEach(function(P){if(P.includes("RhPF")){let S=P.split("(RhPF")[0].trim(),R=l.find(function(H){return H.RFundName.includes(S)});R&&f.add(R.RFundAbbrv)}});let d=Array.from(f).length,u=b.main.selectAll(".pbigamtopPanelMoneyBag").data([!0]).enter().append("g").attr("class","pbigamtopPanelMoneyBag contributionColorFill").attr("transform","translate("+b.moneyBagPadding+",6) scale(0.5)").each(function(P,S,R){fn.forEach(function(H){d3.select(R[S]).append("path").attr("d",H)})}),h=d3.select(".pbigamtopPanelMainValue").size()!==0?d3.select(".pbigamtopPanelMainValue").datum():0,C=d3.select(".pbigamtopPanelProjectsNumber").size()!==0?d3.select(".pbigamtopPanelProjectsNumber").datum():0,V=d3.select(".pbigamtopPanelCbpfsNumber").size()!==0?d3.select(".pbigamtopPanelCbpfsNumber").datum():0,m=d3.select(".pbigamtopPanelRhpfsNumber").size()!==0?d3.select(".pbigamtopPanelRhpfsNumber").datum():0,w=b.main.selectAll(".pbigammainValueGroup").data([!0]);w=w.enter().append("g").attr("class","pbigammainValueGroup").merge(w);let G=w.selectAll(".pbigamtopPanelMainValue").data([c]);G=G.enter().append("text").attr("class","pbigamtopPanelMainValue contributionColorFill").attr("text-anchor","end").merge(G).attr("y",b.height-b.mainValueVerPadding).attr("x",b.moneyBagPadding+b.leftPadding[0]-b.mainValueHorPadding),G.transition().duration(Y).tween("text",function(P){let S=this,R=d3.interpolate(h,P);return function(H){let dt=at(R(H));S.textContent="$"+(+dt==+dt?dt:dt.substring(0,dt.length-1))}}).on("end",function(){let P=this.getBoundingClientRect(),S=T.node().getBoundingClientRect(),R=P.left-S.left;le.style("padding-left",R+"px","important")});let O=w.selectAll(".pbigamtopPanelMainText").data([c]);O=O.enter().append("text").attr("class","pbigamtopPanelMainText").style("opacity",0).attr("text-anchor","start").merge(O).attr("y",b.height-b.mainValueVerPadding*2.7).attr("x",b.moneyBagPadding+b.leftPadding[0]+b.mainValueHorPadding),O.transition().duration(Y).style("opacity",1).text(function(P){let S=at(P),R=S[S.length-1];return(R==="k"?"Thousand":R==="M"?"Million":R==="B"?"Billion":"")+" allocated"});let B=w.selectAll(".pbigamtopPanelSubText").data([!0]);B=B.enter().append("text").attr("class","pbigamtopPanelSubText").style("opacity",0).attr("text-anchor","start").merge(B).attr("y",b.height-b.mainValueVerPadding*1.2).attr("x",b.moneyBagPadding+b.leftPadding[0]+b.mainValueHorPadding),B.transition().duration(Y).style("opacity",1).text(function(P){return"in "+(t.selectedYear.length===1?t.selectedYear[0]===ot?ot+"*":t.selectedYear[0]:"years*")});let N=w.selectAll(".pbigamtopPanelProjectsNumber").data([p]);N=N.enter().append("text").attr("class","pbigamtopPanelProjectsNumber contributionColorFill").attr("text-anchor","end").merge(N).attr("y",b.height-b.mainValueVerPadding).attr("x",b.moneyBagPadding+b.leftPadding[1]-b.mainValueHorPadding),N.transition().duration(Y).tween("text",function(P){let S=this,R=d3.interpolate(C,P);return function(H){S.textContent=~~R(H)}});let n=w.selectAll(".pbigamtopPanelProjectsText").data([p]);n=n.enter().append("text").attr("class","pbigamtopPanelProjectsText").attr("x",b.moneyBagPadding+b.leftPadding[1]+b.mainValueHorPadding).attr("text-anchor","start").merge(n).attr("y",b.height-b.mainValueVerPadding*2).text("Projects");let k=w.selectAll(".pbigamtopPanelCbpfsNumber").data(o?[o]:[]);k.exit().remove(),k=k.enter().append("text").attr("class","pbigamtopPanelCbpfsNumber contributionColorFill").attr("text-anchor","end").merge(k).style("font-size",d?"22px":"48px").attr("y",b.height-b.mainValueVerPadding*(d?2.7:1)).attr("x",b.moneyBagPadding+b.leftPadding[2]-b.mainValueHorPadding),k.transition().duration(Y).tween("text",function(P){let S=this,R=d3.interpolate(V,P);return function(H){S.textContent=~~R(H)}});let F=w.selectAll(".pbigamtopPanelCbpfsText").data(o?[o]:[]);F.exit().remove(),F=F.enter().append("text").attr("class","pbigamtopPanelCbpfsText").attr("x",b.moneyBagPadding+b.leftPadding[2]+b.mainValueHorPadding).attr("text-anchor","start").merge(F).style("font-size",d?"15px":"18px").attr("y",b.height-b.mainValueVerPadding*(d?2.85:1.9)).text(function(P){return P>1?"CBPFs":"CBPF"});let K=w.selectAll(".pbigamtopPanelRhpfsNumber").data(d?[d]:[]);K.exit().remove(),K=K.enter().append("text").attr("class","pbigamtopPanelRhpfsNumber contributionColorFill").attr("text-anchor","end").merge(K).style("font-size",o?"22px":"48px").attr("y",b.height-b.mainValueVerPadding*(o?.8:1)).attr("x",b.moneyBagPadding+b.leftPadding[2]-b.mainValueHorPadding),K.transition().duration(Y).tween("text",function(P){let S=this,R=d3.interpolate(m,P);return function(H){S.textContent=~~R(H)}});let ct=w.selectAll(".pbigamtopPanelRhpfsText").data(d?[d]:[]);ct.exit().remove(),ct=ct.enter().append("text").attr("class","pbigamtopPanelRhpfsText").attr("x",b.moneyBagPadding+b.leftPadding[2]+b.mainValueHorPadding).attr("text-anchor","start").style("cursor","default").merge(ct).style("font-size",o?"15px":"18px").attr("y",b.height-b.mainValueVerPadding*(o?1:1.9)).text(function(P){return P>1?"Regional funds":"Regional fund"}),ct.append("tspan").attr("class","pbigaminfoIcon contributionColorFill").text(" \uF05A"),ct.on("mouseover",xt).on("mouseout",Ft);function xt(){let P=this.getBoundingClientRect().top-T.node().getBoundingClientRect().top+this.getBoundingClientRect().height+on;I.style("display","block").html(null);let S=[];a.forEach(function(q){if(q.cbpfName.includes("RhPF")){let gt=q.cbpfName.split("(RhPF")[0].trim(),tt=l.find(function(Ct){return Ct.RFundName.includes(gt)}),pt=S.find(function(Ct){return Ct.rfCode===tt.RFundAbbrv});pt?pt.funds.includes(q.cbpfName)||pt.funds.push(q.cbpfName):S.push({rfCode:tt.RFundAbbrv,rfName:tt.RFundTitle,funds:[q.cbpfName]})}});let H=I.append("div").style("max-width","300px").attr("id","pbigamInnerTooltipDiv").selectAll(null).data(S).enter().append("div").attr("class","pbigamFundsDiv");H.append("div").attr("class","pbigamfundsDivTitle").html(function(q){return q.rfName}),H.append("div").html(function(q){return q.funds.length+(q.funds.length>1?" Country envelopes:":" Country envelope:")});let dt=H.append("ul").selectAll(null).data(function(q){return q.funds}).enter().append("li").attr("class","pbigamFundsList").html(function(q){return q}),Rt=I.node().getBoundingClientRect();I.style("top",P+"px").style("left",b.width-Rt.width+"px")}function Ft(){wt||I.style("display","none")}}function Dn(a,l,r){let e=i.main.selectAll(".pbigambuttonsLegendGroup").data(ke).enter().append("g").attr("class","pbigambuttonsLegendGroup").attr("pointer-events","none").attr("transform",function(s,x){return"translate("+(i.arrowPadding+i.buttonPadding/2+x*220)+","+(i.height-i.padding[2]+12)+")"}),c=e.append("rect").attr("width",ht).attr("height",ht).attr("rx","2px").attr("ry","2px").style("fill",function(s,x){return x?Ce:Ge}),p=e.append("text").attr("class","pbigambuttonsLegendText").attr("x",ht+3).attr("y",ht-2).text(function(s,x){return x?"GAM, post 2019":"GM, pre 2019"}),g=i.main.append("clipPath").attr("id","pbigamclipPathButtons").append("rect").attr("width",W*i.buttonWidth).attr("height",i.height),f=i.main.append("g").attr("class","pbigamClipPathGroup").attr("transform","translate("+(i.padding[3]+i.arrowPadding)+",0)").attr("clip-path","url(#pbigamclipPathButtons)").append("g").attr("class","pbigambuttonsGroup").attr("transform","translate(0,0)").style("cursor","pointer"),d=M.filter(function(s){return s.gamGroup==="GM"}).length,u=M.filter(function(s){return s.gamGroup==="GAM"}).length,h=f.append("rect").attr("rx","1px").attr("ry","1px").attr("x",i.buttonPadding/2).attr("y",i.height-i.padding[2]).attr("height",4).attr("width",d*i.buttonWidth-i.buttonPadding).style("fill",Ge),C=f.append("rect").attr("rx","1px").attr("ry","1px").attr("x",i.buttonPadding/2+d*i.buttonWidth+i.buttonWidth).attr("y",i.height-i.padding[2]).attr("height",4).attr("width",u*i.buttonWidth-i.buttonPadding).style("fill",Ce),V=f.selectAll(null).data(M).enter().append("rect").attr("rx","2px").attr("ry","2px").attr("class","pbigambuttonsRects").attr("width",i.buttonWidth-i.buttonPadding).attr("height",i.height-i.padding[0]-i.padding[2]-i.buttonVerticalPadding*2).attr("y",i.padding[0]+i.buttonVerticalPadding).attr("x",function(s,x){return x*i.buttonWidth+i.buttonPadding/2}).style("fill",function(s){return t.selectedYear.indexOf(s.year)>-1&&t.gamGroup===s.gamGroup?rt:sn}).style("opacity",function(s){return s.year!=="gap"?1:0}).attr("pointer-events",function(s){return s.year!=="gap"?"all":"none"}),m=f.selectAll(null).data(M).enter().append("text").attr("text-anchor","middle").attr("class","pbigambuttonsText").attr("y",4.8*i.buttonVerticalPadding).attr("x",function(s,x){return x*i.buttonWidth+i.buttonWidth/2}).style("fill",function(s){return t.selectedYear.indexOf(s.year)>-1&&t.gamGroup===s.gamGroup?"white":"#444"}).style("opacity",function(s){return s.year!=="gap"?1:0}).text(function(s){return s.year}),w=i.main.append("g").attr("class","pbigamLeftArrowGroup").style("cursor","pointer").style("opacity",0).attr("pointer-events","none").attr("transform","translate("+i.padding[3]+",0)"),G=w.append("rect").style("fill","white").attr("width",i.arrowPadding).attr("height",i.height-i.padding[0]-i.padding[2]-i.buttonVerticalPadding*2).attr("y",i.padding[0]+i.buttonVerticalPadding),O=w.append("text").attr("class","pbigamleftArrowText").attr("x",0).attr("y",i.padding[0]+i.buttonVerticalPadding*5.4).style("fill","#666").text("\u25C4"),B=i.main.append("g").attr("class","pbigamRightArrowGroup").style("cursor","pointer").style("opacity",0).attr("pointer-events","none").attr("transform","translate("+(i.padding[3]+i.arrowPadding+W*i.buttonWidth)+",0)"),N=B.append("rect").style("fill","white").attr("width",i.arrowPadding).attr("height",i.height-i.padding[0]-i.padding[2]-i.buttonVerticalPadding*2).attr("y",i.padding[0]+i.buttonVerticalPadding),n=B.append("text").attr("class","pbigamrightArrowText").attr("x",-1).attr("y",i.padding[0]+i.buttonVerticalPadding*5.4).style("fill","#666").text("\u25BA");M.length>W&&(B.style("opacity",1).attr("pointer-events","all"),w.style("opacity",1).attr("pointer-events","all"),Rt(),dt(),w.on("click",function(){w.attr("pointer-events","none");let s=$t(f.attr("transform"))[0];B.select("text").style("fill","#666"),B.attr("pointer-events","all"),f.transition().duration(Y).attr("transform","translate("+Math.min(0,s+W*i.buttonWidth)+",0)").on("end",H)}),B.on("click",function(){B.attr("pointer-events","none");let s=$t(f.attr("transform"))[0];w.select("text").style("fill","#666"),w.attr("pointer-events","all"),f.transition().duration(Y).attr("transform","translate("+Math.max(-((M.length-W)*i.buttonWidth),-(Math.abs(s)+W*i.buttonWidth))+",0)").on("end",H)}));let k=i.main.append("g").attr("class","pbigambuttonsAllocationsGroup").style("cursor","pointer"),F=k.selectAll(null).data(d3.keys(lt)).enter().append("rect").attr("rx","2px").attr("ry","2px").attr("class","pbigambuttonsAllocationsRects").attr("width",function(s,x){return i.buttonsAllocationsWidth+(x?18:-36)-i.buttonPadding}).attr("height",i.height-i.padding[0]-i.padding[2]-i.buttonVerticalPadding*2).attr("y",i.padding[0]+i.buttonVerticalPadding).attr("x",function(s,x){return x*(i.buttonsAllocationsWidth+(x===1?-36:-9))+i.buttonPadding/2}).style("fill",function(s){return lt[s]===t.allocationValue?rt:"#eaeaea"}),K=k.selectAll(null).data(d3.keys(lt)).enter().append("text").attr("text-anchor","middle").attr("class","pbigambuttonsAllocationsText").attr("y",4.8*i.buttonVerticalPadding).attr("x",function(s,x){return x*i.buttonsAllocationsWidth+i.buttonsAllocationsWidth/2-(x===1?27:x?9:18)}).style("fill",function(s){return lt[s]===t.allocationValue?"white":"#444"}).attr("letter-spacing",function(s,x){return x?-.6:"normal"}).text(function(s){return s==="budget"?"Budget":s==="percentagegam"?"Budget % of per Marker":"Budget % of per CBPF"}),ct=Math.min(i.padding[3]+i.arrowPadding+f.node().getBoundingClientRect().width,i.padding[3]+W*i.buttonWidth+2*i.arrowPadding),xt=k.node().getBoundingClientRect().width,Ft=ct+(i.displayPadding-ct-xt)/2;k.attr("transform","translate("+Ft+",0)");let P=i.main.append("g").attr("class","pbigambuttonsDisplayGroup").attr("transform","translate("+i.displayPadding+",0)").style("cursor","pointer"),S=P.selectAll(null).data(Et).enter().append("rect").attr("rx","2px").attr("ry","2px").attr("class","pbigambuttonsDisplayRects").attr("width",i.buttonDisplayWidth-i.buttonPadding).attr("height",i.height-i.padding[0]-i.padding[2]-i.buttonVerticalPadding*2).attr("y",i.padding[0]+i.buttonVerticalPadding).attr("x",function(s,x){return x*i.buttonDisplayWidth+i.buttonPadding/2}).style("fill",function(s){return s===t.display?rt:"#eaeaea"}),R=P.selectAll(null).data(Et).enter().append("text").attr("text-anchor","middle").attr("class","pbigambuttonsDisplayText").attr("y",4.8*i.buttonVerticalPadding).attr("x",function(s,x){return x*i.buttonDisplayWidth+i.buttonDisplayWidth/2}).style("fill",function(s){return s===t.display?"white":"#444"}).text(function(s){return s==="marker"?"View by Marker":"Overall View"});V.on("mouseover",q).on("mouseout",gt).on("click",function(s){let x=this;if(d3.event.altKey){tt(s,!1);return}yt.get(this)!=="clicked"?(yt.set(this,"clicked"),setTimeout(function(){yt.get(x)==="clicked"&&tt(s,!0),yt.set(x,null)},250)):(tt(s,!1),yt.set(this,null))}),d3.select("body").on("d3ChartsYear.pbigam",function(){tt(Ie(+d3.event.detail),!0),Rt(),H()}),F.on("mouseover",pt).on("mouseout",jn).on("click",En),S.on("mouseover",Ct).on("mouseout",ue).on("click",L);function H(){let s=$t(f.attr("transform"))[0];s===0?(w.select("text").style("fill","#ccc"),w.attr("pointer-events","none")):(w.select("text").style("fill","#666"),w.attr("pointer-events","all")),Math.abs(s)>=(M.length-W)*i.buttonWidth?(B.select("text").style("fill","#ccc"),B.attr("pointer-events","none")):(B.select("text").style("fill","#666"),B.attr("pointer-events","all"))}function dt(){let s=$t(f.attr("transform"))[0];s===0&&(w.select("text").style("fill","#ccc"),w.attr("pointer-events","none")),Math.abs(s)>=(M.length-W)*i.buttonWidth&&(B.select("text").style("fill","#ccc"),B.attr("pointer-events","none"))}function Rt(){let s=M.map(function(z){return z.year+z.gamGroup}),x=s.indexOf(t.selectedYear[0]+t.gamGroup)<W/2?0:s.indexOf(t.selectedYear[0]+t.gamGroup)>M.length-W/2?M.length-W:s.indexOf(t.selectedYear[0]+t.gamGroup)-W/2;f.attr("transform","translate("+-(i.buttonWidth*x)+",0)")}function q(s){I.style("display","block").html(null),I.append("div").style("max-width","200px").attr("id","pbigamInnerTooltipDiv").html("Click for selecting a single year. Double-click or ALT + click for selecting multiple years (for the same marker system).");let z=T.node().getBoundingClientRect(),J=this.getBoundingClientRect();tooltipSize=I.node().getBoundingClientRect(),I.style("left",J.left+J.width/2-z.left>z.width-tooltipSize.width/2-v[1]?z.width-tooltipSize.width-v[1]+"px":J.left+J.width/2-z.left<tooltipSize.width/2+i.padding[3]+v[0]?i.padding[3]+v[0]+"px":J.left+J.width/2-z.left-tooltipSize.width/2+"px").style("top",J.top+J.height/2-z.top<tooltipSize.height?J.top-z.top+J.height+2+"px":J.top-z.top-tooltipSize.height-4+"px"),d3.select(this).style("fill",rt),m.filter(function(j){return j.year===s.year&&j.gamGroup===s.gamGroup}).style("fill","white")}function gt(s){I.style("display","none"),!(t.selectedYear.indexOf(s.year)>-1&&t.gamGroup===s.gamGroup)&&(d3.select(this).style("fill","#eaeaea"),m.filter(function(x){return x.year===s.year&&x.gamGroup===s.gamGroup}).style("fill","#444"))}function tt(s,x){if(x||s.gamGroup!==t.gamGroup)t.selectedYear=[s.year],t.gamGroup=s.gamGroup;else{let j=t.selectedYear.indexOf(s.year);if(j>-1){if(t.selectedYear.length===1)return;t.selectedYear.splice(j,1)}else t.selectedYear.push(s.year)}let z=t.selectedYear.map(function(j){return j}).join("|");D.has("year")?D.set("year",z):D.append("year",z),D.has("gamgroup")?D.set("gamgroup",t.gamGroup):D.append("gamgroup",t.gamGroup),V.style("fill",function(j){return t.selectedYear.indexOf(j.year)>-1&&t.gamGroup===j.gamGroup?rt:"#eaeaea"}),m.style("fill",function(j){return t.selectedYear.indexOf(j.year)>-1&&t.gamGroup===j.gamGroup?"white":"#444"}),ze();let J=Vt(a,l);_t.selectAll(".pbigamCheckboxDiv").filter(function(j){return j!=="All CBPFs"}).select("input").property("disabled",function(j){return t.cbpfsInData.indexOf(j)===-1}),_t.selectAll(".pbigamCheckboxDiv").filter(function(j){return j!=="All CBPFs"}).style("opacity",function(j){return t.cbpfsInData.indexOf(j)===-1?we:1}),de(),ce(J,r),Dt(J),Mt(J)}function pt(s){if(d3.select(this).style("fill",rt),d3.select(this.parentNode).selectAll("text").filter(function(Hn){return Hn===s}).style("fill","white"),s==="budget")return;let x=this.getBoundingClientRect(),z=T.node().getBoundingClientRect();I.style("display","block").html(null);let J=I.append("div").style("display","flex").style("align-items","center").style("font-style","italic").style("font-size","12px").style("width","270px"),j=J.append("div").style("display","flex").style("flex","0 92%").style("flex-direction","column"),qn=J.append("div").style("flex","0 8%").style("white-space","pre").html(" %"),Zn=j.append("div").style("text-align","center").style("border-bottom","1px solid gray").html(Ae.numerator),Kn=j.append("div").style("text-align","center").html(Ae[s]),Ne=I.node().getBoundingClientRect();I.style("top",x.top-z.top-Ne.height-8+"px").style("left",x.left-z.left+x.width/2-Ne.width/2+"px")}function Ct(s){d3.select(this).style("fill",rt),d3.select(this.parentNode).selectAll("text").filter(function(x){return x===s}).style("fill","white")}function ue(s){s!==t.display&&(d3.select(this).style("fill","#eaeaea"),R.filter(function(x){return x===s}).style("fill","#444"))}function L(s){t.display=s,D.has("display")?D.set("display",s):D.append("display",s),S.style("fill",function(z){return t.display===z?rt:"#eaeaea"}),R.style("fill",function(z){return t.display===z?"white":"#444"});let x=Vt(a,l);Oe(),de(),Dt(x),Mt(x)}function jn(s){I.style("display","none"),lt[s]!==t.allocationValue&&(d3.select(this).style("fill","#eaeaea"),K.filter(function(x){return x===s}).style("fill","#444"))}function En(s){I.style("display","none"),t.allocationValue=lt[s],D.has("valuetype")?D.set("valuetype",s):D.append("valuetype",s),F.style("fill",function(z){return t.allocationValue===lt[z]?rt:"#eaeaea"}),K.style("fill",function(z){return t.allocationValue===lt[z]?"white":"#444"});let x=Vt(a,l);Dt(x),Mt(x)}}function Dt(a){nt.domain([1,d3.max(a,function(n){return n.projects})]),St.domain([0,d3.max(a,function(n){return n[t.allocationValue]})]);let l=$.domain().map(function(n){return{gamCode:n,mean:n==="aggregated"?d3.mean(a,function(k){return k[t.allocationValue]}):d3.mean(a.filter(function(k){return k.gamCode===n}),function(k){return k[t.allocationValue]})||0}});se.nodes(a).stop(),se.alpha(1).alphaTarget(0);for(let n=0;n<Ze;n++)se.tick();let r=y.main.selectAll(".pbigambeeswarm").data(a,function(n){return n.cbpfId+n.keygamGroup+n.gamCode}),e=r.exit().transition().duration(Y).style("opacity",0).remove();r=r.enter().append("circle").attr("class","pbigambeeswarm").attr("r",function(n){return nt(n.projects)}).attr("cx",function(n){return n.x}).attr("cy",function(n){return n.y}).style("fill",function(n){return ut(n.gamCode)}).style("stroke",function(n){return d3.color(ut(n.gamCode)).darker()}).style("stroke-width","1px").merge(r),r.transition().duration(Y).attr("r",function(n){return nt(n.projects)}).attr("cx",function(n){return n.x}).attr("cy",function(n){return n.y}).style("fill",function(n){return ut(n.gamCode)}).style("stroke",function(n){return d3.color(ut(n.gamCode)).darker()}),r.on("mouseover",N).on("mouseout",function(){wt||(bt=null,g.style("opacity",t.allocationValue==="allocations"?1:0),d.style("opacity",t.allocationValue==="allocations"?1:0),y.main.selectAll(".pbigambeeswarmLabel, .pbigambeeswarmLabelBack").remove(),r.style("opacity",1),I.style("display","none"))}),Me.tickSizeInner(-(y.height-y.padding[0]-y.padding[2]+y.axisVerticalPadding)).tickFormat(function(n){return t.allocationValue==="allocations"?rn(n).replace("G","B"):mt(n)}),Fe.transition().duration(Y).call(Me),Fe.selectAll(".tick").filter(function(n){return n===0}).remove(),Ve.tickSizeInner(t.display!=="aggregated"?it/2:it),Re.transition().duration(Y).call(Ve).selectAll(".tick text").style("fill",function(n){return d3.color(ut(n)).darker(.8)});let p=y.main.selectAll(".pbigamaxisLabelCode").data([!0]).enter().append("text").attr("class","pbigamaxisLabelCode").attr("x",y.padding[3]-it).attr("y",y.padding[0]-y.axisVerticalPadding-3).attr("text-anchor","middle").text("Marker Code"),g=y.main.selectAll(".pbigamtotalLabel").data([!0]);g=g.enter().append("text").attr("class","pbigamtotalLabel").attr("text-anchor","end").attr("x",y.width-zt).attr("y",y.padding[0]-y.axisVerticalPadding-3).text("Total").merge(g),g.transition().duration(Y).style("opacity",t.allocationValue==="allocations"?1:0);let o=t.display==="aggregated"?[{value:d3.sum(a,function(n){return n.allocations}),marker:Wt[0]}]:a.reduce(function(n,k){let F=n.find(function(K){return K.marker===(t.gamGroup==="GM"&&k.gamCode==="4"?"3":k.gamCode)});return F?F.value+=k.allocations:n.push({value:k.allocations,marker:t.gamGroup==="GM"&&k.gamCode==="4"?"3":k.gamCode}),n},[]),f=d3.sum(o,function(n){return n.value}),d=y.main.selectAll(".pbigamtotalValues").data(o,function(n){return n.marker}),u=d.exit().transition().duration(Y).style("opacity",0).remove(),h=d.enter().append("text").attr("class","pbigamtotalValues").attr("text-anchor","end").style("opacity",t.allocationValue==="allocations"?1:0).attr("x",y.width-zt).attr("y",function(n){return $(n.marker)}).text(function(n){return"$"+at(n.value)});h.append("tspan").attr("class","pbigamtotalValuesTspan").attr("dy","1.2em").attr("x",y.width-zt).text(function(n){return"("+jt(n.value/f)+")"}),d=h.merge(d),d.transition().duration(Y).style("opacity",t.allocationValue==="allocations"?1:0).attr("y",function(n){return $(n.marker)}),d.text(function(n){return"$"+at(n.value)}).append("tspan").attr("class","pbigamtotalValuesTspan").attr("dy","1.2em").attr("x",y.width-zt).text(function(n){return"("+jt(n.value/f)+")"});let C;if(t.display!=="aggregated"){if(C=JSON.parse(JSON.stringify(oe.filter(function(n){return t.gamGroup===n.gamGroup}))),t.gamGroup==="GM"){let n=C.find(function(F){return F.gamCode==="3"}),k=C.find(function(F){return F.gamCode==="4"});n.gamDescription=n.gamDescription+"/"+k.gamDescription,C=C.filter(function(F){return F.gamCode!=="4"})}}else t.gamGroup==="GM"?C=["All Gender Markers combined"]:C=["All Gender and Age Markers combined"];let V=y.main.selectAll(".pbigamaxisDescriptions").data(C),m=V.exit().transition().duration(Y).style("opacity",0).remove();V=V.enter().append("text").attr("class","pbigamaxisDescriptions").attr("text-anchor","middle").attr("x",(y.padding[3]-ee)/2).merge(V),V.attr("y",function(n){return $(n.gamCode)||$("aggregated")}).text(function(n){return n.gamDescription||n}).call(Ee,t.display!=="aggregated"?y.padding[3]-ee:y.padding[3]-ee-30),V.each(function(n){let k=d3.select(this).selectAll("tspan").size(),F=+d3.select(this).attr("y");d3.select(this).selectAll("tspan").attr("y",k-1?F-tn*(k-1):F+3)});let G=y.main.selectAll(".pbigammeanGroup").data(l,function(n){return n.gamCode}),O=G.exit().transition().duration(Y).style("opacity",0).remove(),B=G.enter().append("g").attr("class","pbigammeanGroup").attr("transform",function(n){return"translate("+St(n.mean)+","+$(n.gamCode)+")"});B.append("line").attr("y1",-$.step()/2+4).attr("y2",$.step()/2-4).style("stroke-dasharray","4,2").style("stroke-width","1.5px").style("stroke","#546f6f"),B.append("text").attr("class","pbigammeanGroupTextBack").attr("x",3).attr("y",$.step()/2-6).text(function(n){return"mean: "+(t.allocationValue==="allocations"?at(n.mean):mt(n.mean))}),B.append("text").attr("class","pbigammeanGroupText").attr("x",3).attr("y",$.step()/2-6).text(function(n){return"mean: "+(t.allocationValue==="allocations"?at(n.mean):mt(n.mean))}),G=B.merge(G),G.raise(),G.style("opacity",t.showMean&&t.allocationValue==="allocations"?1:0).transition().duration(Y).attr("transform",function(n){return"translate("+St(n.mean)+","+$(n.gamCode)+")"}),G.select(".pbigammeanGroupTextBack").text(function(n){return"mean: "+(t.allocationValue==="allocations"?at(n.mean):mt(n.mean))}),G.select(".pbigammeanGroupText").text(function(n){return"mean: "+(t.allocationValue==="allocations"?at(n.mean):mt(n.mean))});function N(n){bt=this;let k=t.allocationValue==="allocations"?36:24;g.style("opacity",vt),d.style("opacity",vt);let F=JSON.parse(JSON.stringify(a.filter(function(L){return t.display==="aggregated"||t.allocationValue==="percentageGam"?L.cbpfId===n.cbpfId&&L.gamCode===n.gamCode:L.cbpfId===n.cbpfId}))),K=y.main.selectAll(null).data(F).enter().append("text").attr("class","pbigambeeswarmLabelBack").attr("x",function(L){return L.x+nt(L.projects)+2}).attr("y",function(L){return L.y+3}).text(function(L){return t.allocationValue==="allocations"?at(L.allocations):mt(L[t.allocationValue])}),ct=y.main.selectAll(null).data(F).enter().append("text").attr("class","pbigambeeswarmLabel").attr("x",function(L){return L.x+nt(L.projects)+2}).attr("y",function(L){return L.y+3}).text(function(L){return t.allocationValue==="allocations"?at(L.allocations):mt(L[t.allocationValue])});r.style("opacity",function(L){return t.allocationValue!=="percentageGam"?t.display==="aggregated"?L.cbpfId===n.cbpfId&&L.gamCode===n.gamCode?1:vt:L.cbpfId===n.cbpfId?1:vt:this===bt?1:vt}),I.style("display","block").html(null);let xt=I.append("div").style("display","flex").style("align-items","center").style("width",y.width*nn+"px").style("height",an+"px"),Ft=xt.append("div").style("padding","5px").style("line-height",1).style("display","flex").style("justify-content","center").style("align-items","center").style("height","100%").style("border-right","1px solid #ddd").style("flex","0 18%"),P=xt.append("div").style("padding","5px").style("font-size","12px").style("height","100%").style("border-right","1px solid #ddd").style("flex","0 42%").style("display","flex").style("justify-content","center").style("align-items","center").append("div"),S=xt.append("div").style("padding","5px").style("font-size","11px").style("height","100%").style("display","flex").style("justify-content","center").style("align-items","center").style("flex","0 40%"),R=Ft.append("div").classed("contributionColorHTMLcolor",!0).style("font-size","13px").style("font-weight",700).style("text-align","center").html(n.cbpfName),H=P.append("div").html((t.gamGroup==="GM"?"&bull; Gender Marker: ":"&bull; Gender and Age Marker: ")+n.gamCode),dt=P.append("div").html("&bull; Number of projects: "+n.projects),Rt=P.append("div").html("&bull; Allocations: ").append("span").attr("class","contributionColorHTMLcolor").style("font-weight",700).html("$"+ln(n.allocations)),q=S.append("div").style("line-height","110%").html("(these allocations correspond to <span class='contributionColorHTMLcolor'><strong>"+jt(n.percentageCbpf)+"</strong></span> of the total allocations in "+n.cbpfName+" and to <span class='contributionColorHTMLcolor'><strong>"+jt(n.percentageGam)+"</strong></span> of all CBPF allocations with Marker "+n.gamCode+")"),gt=T.node().getBoundingClientRect(),tt=this.getBoundingClientRect(),pt=I.node().getBoundingClientRect(),ue=Re.selectAll(".tick line").filter(function(L){return L===(t.display==="aggregated"?"aggregated":n.gamCode)}).node().getBoundingClientRect();I.style("top",ue.top-gt.top-pt.height/2+"px").style("left",gt.right-tt.right-k<pt.width?tt.left-pt.width-gt.left-4+"px":tt.right+k-gt.left+"px")}}function Mt(a){let l=_.main.selectAll(".pbigamlegendSizeTitle").data([!0]).enter().append("text").attr("text-anchor","end").attr("class","pbigamlegendSizeTitle").attr("y",_.height/2-3).attr("x",y.padding[3]-10).text("Size:").append("tspan").attr("dy","1em").attr("x",y.padding[3]-10).attr("class","pbigamsizeTitleSpan").text("(# of projects per CBPF)"),r=d3.max(a,function(m){return m.projects}),e=[r,r/Math.PI,1],c=_.main.selectAll(".pbigamlegendSizeCircles").data(e).enter().append("circle").attr("class","pbigamlegendSizeCircles").attr("cx",y.padding[3]+it).attr("cy",function(m){return _.height-2-nt(m)}).attr("r",function(m){return nt(m)}).style("fill","none").style("stroke","#ccc").style("stroke-width","0.5px"),p=_.main.selectAll(".pbigamlegendSizeLines").data(e).enter().append("line").attr("class","pbigamlegendSizeLines").attr("x1",y.padding[3]+it).attr("x2",y.padding[3]+it+Pe).attr("y1",function(m){return _.height-2-nt(m)*2}).attr("y2",function(m){return _.height-2-nt(m)*2}).style("fill","none").style("stroke","#999").style("stroke-dasharray","1, 1").style("stroke-width","0.5px"),g=_.main.selectAll(".pbigamlegendSizeLabels").data(e);g=g.enter().append("text").attr("class","pbigamlegendSizeLabels").attr("x",y.padding[3]+it+Pe+2).attr("y",function(m){return _.height+1-nt(m)*2}).merge(g),g.transition().duration(Y).tween("text",function(m){let w=this,G=d3.interpolate(yt.get(this)||0,m);return function(O){w.textContent=~~G(O)}}).on("end",function(m){yt.set(this,m)});let o=_.main.selectAll(".pbigamlegendColorTitle").data([!0]).enter().append("text").attr("class","pbigamlegendColorTitle").style("opacity",t.display==="aggregated"?1:0).attr("text-anchor","end").attr("y",_.height/2-3).attr("x",y.padding[3]+ne).text("Color:").append("tspan").attr("x",y.padding[3]+ne).attr("dy","1em").attr("class","pbigamcolorTitleSpan").text(" (marker code)");_.main.select(".pbigamlegendColorTitle").transition().duration(Y).style("opacity",t.display==="aggregated"?1:0);let f=t.display!=="aggregated"?[]:t.gamGroup==="GM"?Ht:Nt,d=_.main.selectAll(".pbigamlegendColorGroup").data(f),u=d.exit().transition().duration(Y).style("opacity",0).remove(),h=d.enter().append("g").attr("class","pbigamlegendColorGroup").attr("transform",function(m,w){return"translate("+(y.padding[3]+ne+8+w*38)+",0)"});h.append("rect").attr("y",15).attr("width",ht).attr("height",ht).attr("rx",2).attr("ry",2).style("fill",function(m){return ut(m)}),h.append("text").attr("y",25).attr("x",ht+3).text(function(m){return t.gamGroup==="GM"&&m==="3"?"3/4":m}),d=h.merge(d),d.select("rect").style("fill",function(m){return ut(m)}),d.select("text").text(function(m){return t.gamGroup==="GM"&&m==="3"?"3/4":m}),d.on("mouseover",function(m){y.main.selectAll(".pbigambeeswarm").style("opacity",function(w){return w.gamCode===m?1:vt})}).on("mouseout",function(){y.main.selectAll(".pbigambeeswarm").style("opacity",1)});let C=_.main.selectAll(".pbigamshowMeanGroup").data([{clicked:t.showMean}]),V=C.enter().append("g").attr("class","pbigamshowMeanGroup").attr("cursor","pointer").attr("transform","translate("+(_.width-en)+","+(_.height/2-1)+")");V.append("rect").attr("width",12).attr("height",12).attr("rx",2).attr("ry",2).attr("x",-6).attr("y",-5).attr("fill","white").attr("stroke","darkslategray"),V.append("polyline").style("stroke-width","2px").attr("points","-4,1 -1,4 4,-3").style("fill","none").style("stroke",t.showMean?"darkslategray":"white"),V.append("text").attr("class","pbigamshowMeanText").attr("x",10).attr("y",5),C=V.merge(C),C.style("opacity",t.allocationValue==="allocations"?1:0).style("pointer-events",t.allocationValue==="allocations"?"all":"none"),C.select("text").text("Show "+(t.display==="aggregated"?"mean":"means")),C.on("click",function(m){t.showMean=m.clicked=!m.clicked,C.select("polyline").style("stroke",t.showMean?"darkslategray":"white"),y.main.selectAll(".pbigammeanGroup").style("opacity",t.showMean?1:0),D.has("showmean")?D.set("showmean",t.showMean):D.append("showmean",t.showMean)})}function Oe(){let a=t.display==="aggregated"?Wt.length:t.gamGroup==="GM"?Ht.length:Nt.length,l=t.display==="aggregated"?It*1.5:It;y.height=y.padding[0]+y.padding[2]+a*l,st=v[0]+v[2]+b.height+i.height+y.height+_.height+3*X,Se===!1&&T.style("height",st+"px"),Zt?E.transition().duration(Ut?1:Y).attr("viewBox","0 0 "+A+" "+st).attr("height",st):E.transition().duration(Ut?1:Y).attr("viewBox","0 0 "+A+" "+st),_.main.transition().duration(Ut?1:Y).attr("transform","translate("+v[3]+","+(v[0]+b.height+i.height+y.height+3*X)+")"),Ut=!1}function de(){ut.domain(t.gamGroup==="GM"?Ht:Nt),$.domain(t.display==="aggregated"?Wt:t.gamGroup==="GM"?Ht:Nt).range([y.padding[0],y.height-y.padding[2]])}function Mn(a,l){l.forEach(function(e){e.GenderMarkerCode=e.GenderMarkerCode+"",oe.push({gamGroup:e.GenderMarkerGroup,gamCode:e.GenderMarkerCode+"",gamFullDescription:e.GenderMarkerDescription,gamDescription:e.GenderMarkerDescription.split("-")[1].trim()})}),a.forEach(function(e){e.GenderMarkerCode=e.GenderMarkerCode+"",U["id"+e.PooledFundId]||(U["id"+e.PooledFundId]=e.PooledFundName),M.find(function(p){return p.year===+e.AllocationYear&&p.gamGroup===e.GenderMarkerGroup})||M.push({year:+e.AllocationYear,gamGroup:e.GenderMarkerGroup})}),M.sort(function(e,c){return e.year-c.year||(e.gamGroup===ke[0]?-1:1)});let r=M.map(function(e){return e.gamGroup}).indexOf("GAM");M.splice(r,0,{year:"gap",gamGroup:"gap"})}function Vn(a,l,r){return r===0?{underApprovalPercent:0,underPlusApprovedPercent:0}:{underApprovalPercent:a/r*100,underPlusApprovedPercent:(a+l)/r*100}}function Vt(a,l){Tt.launched=0,Tt.underApproval=0;for(let o in kt)delete kt[o];let r={},e=t.selectedCbpfs.length===d3.keys(U).length;l.forEach(function(o){t.selectedYear.includes(o.AllocationYear)&&(e||t.selectedCbpfs.includes("id"+o.PooledFundId))&&(r[o.AllocationYear]={underApproval:(r[o.AllocationYear]?r[o.AllocationYear].underApproval:0)+o.TotalUnderApprovalBudget,approved:(r[o.AllocationYear]?r[o.AllocationYear].approved:0)+o.TotalApprovedBudget,launched:(r[o.AllocationYear]?r[o.AllocationYear].launched:0)+o.TotalUSDPlanned},Tt.launched+=o.TotalUSDPlanned,Tt.underApproval+=o.TotalUnderApprovalBudget)});for(let o in r){let{underApprovalPercent:f,underPlusApprovedPercent:d}=Vn(r[o].underApproval,r[o].approved,r[o].launched);kt[o]=f>Te||d<Te}let c=[],p=oe.filter(function(o){return o.gamGroup===t.gamGroup}).map(function(o){return{gamCode:o.gamCode,total:0}}),g=d3.keys(U).map(function(o){return{cbpfId:o,total:0}});if(t.cbpfsInData.length=0,a.forEach(function(o){if(t.selectedYear.indexOf(+o.AllocationYear)>-1&&t.gamGroup===o.GenderMarkerGroup&&t.cbpfsInData.indexOf("id"+o.PooledFundId)===-1&&t.cbpfsInData.push("id"+o.PooledFundId),t.selectedYear.indexOf(+o.AllocationYear)>-1&&t.selectedCbpfs.indexOf("id"+o.PooledFundId)>-1&&t.gamGroup===o.GenderMarkerGroup){let f=c.find(function(h){return h.cbpfId==="id"+o.PooledFundId&&h.gamCode===o.GenderMarkerCode&&h.keygamGroup===o.GenderMarkerGroup});f?(f.projects+=+o.TotalProjects,f.beneficiaries+=+o.TotalBeneficiaries,f.allocations+=+o.TotalBudget):c.push({cbpfName:o.PooledFundName,cbpfId:"id"+o.PooledFundId,gamCode:o.GenderMarkerCode,projects:+o.TotalProjects,beneficiaries:+o.TotalBeneficiaries,allocations:+o.TotalBudget,keygamGroup:o.GenderMarkerGroup});let d=p.find(function(h){return h.gamCode===o.GenderMarkerCode});d&&(d.total+=+o.TotalBudget);let u=g.find(function(h){return h.cbpfId==="id"+o.PooledFundId});u&&(u.total+=+o.TotalBudget)}}),t.gamGroup==="GM"){let o=p.find(function(u){return u.gamCode==="3"}),f=p.find(function(u){return u.gamCode==="4"}),d=o.total+f.total;o.total=d,f.total=d}return c.forEach(function(o){thisGamTotal=p.find(function(f){return f.gamCode===o.gamCode}),thisCbpfTotal=g.find(function(f){return f.cbpfId===o.cbpfId}),o.percentageGam=thisGamTotal&&thisGamTotal.total?o.allocations/thisGamTotal.total:0,o.percentageCbpf=thisCbpfTotal&&thisCbpfTotal.total?o.allocations/thisCbpfTotal.total:0}),c}function Fn(a){let l=JSON.parse(JSON.stringify(a.filter(function(e){return t.selectedYear.indexOf(+e.AllocationYear)>-1&&t.selectedCbpfs.indexOf("id"+e.PooledFundId)>-1&&t.gamGroup===e.GenderMarkerGroup})));return d3.csvFormat(l)}function Rn(a){let l=a.split(",").map(function(e){return+e.trim()}).filter(function(e){return e&&M.find(function(c){return c.year===e})}).sort(function(e,c){return e-c}),r=[];l.forEach(function(e){if(e!==ot){let c=M.find(function(p){return p.year===e}).gamGroup;r.indexOf(c)===-1&&r.push(c)}}),r.length>1?t.selectedYear.push(M[M.length-1].year):l.forEach(function(e){t.selectedYear.push(e)}),t.selectedYear.length||t.selectedYear.push(M[M.length-1].year)}function Ie(a){if(a===ot)return{year:a,gamGroup:"GAM"};let l;for(l=M.find(function(r){return r.year===a});!l;)a=a>=te?a-1:a+1,l=M.find(function(r){return r.year===a});return l}function Ln(a){let l=[],r=a.split(",").map(function(c){return c.trim().toLowerCase()});return r.some(function(c){return Yn(d3.values(U)).indexOf(c)===-1})?d3.keys(U):(r.forEach(function(c){for(var p in U)U[p].toLowerCase()===c&&l.push(p)}),l)}function Yn(a){let l=[];for(let r in a)l.push(a[r].toLowerCase());return l}function at(a){let l=(~~Math.log10(a)+1)%3,r=l===1?2:l===2?1:0,e=d3.formatPrefix("."+r+"~",a)(a).replace("G","B");if(parseInt(e)===1e3){let c=e[e.length-1],p={k:"M",M:"B"};return 1+(isNaN(c)?p[c]:"")}return e}function $t(a){let l=document.createElementNS("http://www.w3.org/2000/svg","g");l.setAttributeNS(null,"transform",a);let r=l.transform.baseVal.consolidate().matrix;return[r.e,r.f]}function ze(){kn.html(function(){return t.selectedYear.length===1&&t.selectedYear[0]!==ot?null:t.selectedYear.length===1&&t.selectedYear[0]===ot&&t.gamGroup==="GAM"?"*Allocations in "+ot+" with the new Gender and Age Marker (GAM)":t.selectedYear.length===1&&t.selectedYear[0]===ot&&t.gamGroup==="GM"?"*Allocations in "+ot+" with the old Gender Marker (GM)":"*Selected years: "+t.selectedYear.sort(function(l,r){return l-r}).reduce(function(l,r,e){return l+(e>=t.selectedYear.length-2?e>t.selectedYear.length-2?r:r+" and ":r+", ")},"")})}function je(){et.style("opacity",0).style("pointer-events","none"),et.style("opacity",0).style("pointer-events","none");let a=T.append("div").attr("class","pbigamOverDivHelp"),l=re.node().getBoundingClientRect(),r=window.getComputedStyle(re.node()),e=_t.node().getBoundingClientRect(),c=Bt.node().getBoundingClientRect(),p=et.node().getBoundingClientRect(),g=c.height*(A/c.width),o=(l.height+e.height+parseInt(r["margin-top"])+parseInt(r["margin-bottom"]))*(A/c.width),f=a.append("svg").attr("viewBox","0 0 "+A+" "+(st+g+o)),d=[{text:"CLOSE",width:90},{text:"GO TO HELP PORTAL",width:180}],u=f.selectAll(null).data(d).enter().append("g");u.append("rect").attr("rx",4).attr("ry",4).style("stroke","rgba(0, 0, 0, 0.3)").style("stroke-width","1px").style("fill",cn).style("cursor","pointer").attr("y",6).attr("height",22).attr("width",function(G){return G.width}).attr("x",function(G,O){return A-v[1]-G.width-(O?d[0].width+8:0)}).on("click",function(G,O){et.style("opacity",1).style("pointer-events","all"),a.remove(),O&&window.open(gn,"help_portal")}),u.append("text").attr("class","pbigamAnnotationMainText").attr("text-anchor","middle").attr("x",function(G,O){return A-v[1]-G.width/2-(O?d[0].width+8:0)}).attr("y",22).text(function(G){return G.text}),[{x:8,y:g+(o-e.height)*(c.width/A),width:A-28,height:e.height*(A/c.width),xTooltip:300*(c.width/A),yTooltip:(g+o+8)*(c.width/A),text:"Use these checkboxes to select the CBPF. A disabled checkbox means that the correspondent CBPF has no data for that year."},{x:6,y:70+g+o,width:346,height:30,xTooltip:38*(c.width/A),yTooltip:(g+o+106)*(c.width/A),text:"Use these buttons to select the year. You can select more than one year, as long as they belong to the same Marker system. Double click or press ALT when clicking to select just a single year. Click the arrows to reveal more years. If you select a year that belongs to a different Marker system, that year will be selected as a single year."},{x:368,y:70+g+o,width:323,height:30,xTooltip:382*(c.width/A),yTooltip:(g+o+106)*(c.width/A),text:"Use these buttons to change how the circles are distributed along the x axis. Each circle represents a given CBPF/Marker combination. \u201CBudget\u201D shows the allocation values, in dollars. \u201CBudget % of per Marker\u201D will show that value as a percentage of the total for the same Marker, which is adequate for comparing CBPFs in the same Marker. \u201C\u201CBudget % of per CBPF\u201D will show that value as a percentage of the total for that CBPF, which is adequate for comparing Markers in the same CBPF."},{x:698,y:70+g+o,width:196,height:30,xTooltip:650*(c.width/A),yTooltip:(g+o+106)*(c.width/A),text:"Use these buttons to aggregate all Markers in a single row or to separate the CBPF/Marker combination by Marker."},{x:190,y:186+g+o,width:700,height:370,xTooltip:380*(c.width/A),yTooltip:(g+o+112)*(c.width/A),text:"Hover over the circles to get additional information. The tooltip will show up below the chart, over the legend area."}].forEach(function(G){f.append("rect").attr("rx",4).attr("ry",4).attr("x",G.x).attr("y",G.y).attr("width",G.width).attr("height",G.height).style("stroke",rt).style("stroke-width","3px").style("fill","none").style("opacity",.5).attr("class","pbigamHelpRectangle").attr("pointer-events","all").on("mouseover",function(){let O=this;m(G.xTooltip,G.yTooltip,G.text,O)}).on("mouseout",w)});let C=f.append("rect").attr("x",A/2-180).attr("y",120+g+o).attr("width",360).attr("height",50).attr("pointer-events","none").style("fill","white").style("stroke","#888"),V=f.append("text").attr("class","pbigamAnnotationExplanationText").attr("font-family","Roboto").attr("font-size","18px").style("fill","#222").attr("text-anchor","middle").attr("x",A/2).attr("y",140+g+o).attr("pointer-events","none").text("Hover over the elements surrounded by a blue rectangle to get additional information").call(Ee,350);function m(G,O,B,N){V.style("opacity",0),C.style("opacity",0),f.selectAll(".pbigamHelpRectangle").style("opacity",.1),d3.select(N).style("opacity",1);let n=T.node().getBoundingClientRect();I.style("top",O+"px").style("left",G+"px").style("display","block");let k=I.append("div").style("width","280px").html(B)}function w(){I.style("display","none").html(null),V.style("opacity",1),C.style("opacity",1),f.selectAll(".pbigamHelpRectangle").style("opacity",.5)}}function Ee(a,l){a.each(function(){let r=d3.select(this),e=r.text().split(/\s+/).reverse(),c,p=[],g=0,o=1.1,f=r.attr("y"),d=r.attr("x"),u=0,h=r.text(null).append("tspan").attr("x",d).attr("y",f).attr("dy",u+"em");for(;c=e.pop();)p.push(c),h.text(p.join(" ")),h.node().getComputedTextLength()>l&&(p.pop(),h.text(p.join(" ")),p=[c],h=r.append("tspan").attr("x",d).attr("y",f).attr("dy",++g*o+u+"em").text(c))})}function On(){let a="\xA9 OCHA CBPF Section "+te;vn&&(a+=" | For more information, please visit <a href='https://cbpf.data.unocha.org'>cbpf.data.unocha.org</a>"),Tn.append("div").attr("class","d3chartFooterText").html(a)}function qt(a,l){if(Zt){alert("This functionality is not supported by Internet Explorer");return}let e=d3.select("body").append("div").style("position","fixed").attr("id","pbigamDownloadingDiv").style("left",window.innerWidth/2-100+"px").style("top",window.innerHeight/2-100+"px").append("svg").attr("class","pbigamDownloadingDivSvg").attr("width",200).attr("height",100),c="Downloading "+a.toUpperCase();He(e,200,175,c);let p=E.node().getBoundingClientRect();E.attr("width",p.width).attr("height",p.height);let g=["font-size","font-family","font-weight","fill","stroke","stroke-dasharray","stroke-width","opacity","text-anchor","text-transform","shape-rendering","letter-spacing","white-space"],o=T.node();f(E.node()),a==="png"?et.style("opacity",0):Bt.style("opacity",0),Pt.style("display","none"),html2canvas(o).then(function(d){E.attr("width",null).attr("height",null),a==="png"?et.style("opacity",1):Bt.style("opacity",1),a==="png"?In(d):zn(d),l&&bt&&d3.select(bt).dispatch("mouseout")});function f(d){if(!d.style)return;let u=getComputedStyle(d);for(let h=0;h<g.length;h++)d.style[g[h]]=u[g[h]];for(let h=0;h<d.childNodes.length;h++)f(d.childNodes[h])}}function In(a){let r="GenderAgeMarker_"+ae(new Date)+".png";a.toBlob(function(e){let c=URL.createObjectURL(e),p=document.createElement("a");p.download!==void 0?(p.setAttribute("href",c),p.setAttribute("download",r),p.style="visibility:hidden",document.body.appendChild(p),p.click(),document.body.removeChild(p)):window.location.href=c}),pe(),d3.select("#pbigamDownloadingDiv").remove()}function zn(a){let l={top:10,bottom:16,left:20,right:30};d3.image("https://raw.githubusercontent.com/CBPFGMS/cbpfgms.github.io/master/img/assets/bilogo.png").then(function(r){let e,p=T.node().getBoundingClientRect(),g=210-l.left*2,o=g*(p.height/p.width),f=180,d;o>f?(d=297+o-f,e=new jsPDF({format:[210*2.834646,d*2.834646],unit:"mm"})):(d=297,e=new jsPDF);let u;O();let h=e.splitTextToSize("",210-l.left-l.right,{fontSize:12}),C=d3.timeFormat("%A, %d %B %Y")(new Date);e.setTextColor(60),e.setFont("helvetica"),e.setFontType("normal"),e.setFontSize(12),e.text(l.left,48,h),e.setTextColor(65,143,222),e.setFont("helvetica"),e.setFontType("bold"),e.setFontSize(16),e.text(Be,l.left,65),e.setFontSize(12);let V=t.selectedYear.sort(function(N,n){return N-n}).reduce(function(N,n,k){return N+(k>=t.selectedYear.length-2?k>t.selectedYear.length-2?n:n+" and ":n+", ")},""),m=t.selectedYear.length>1?"Selected years: ":"Selected year: ",w=t.selectedCbpfs.length===d3.keys(U).length?"Selected CBPFs-All":B();e.fromHTML("<div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>Date: <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+C+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+m+"<span style='color: rgb(65, 143, 222); font-weight: 700;'>"+V+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>Marker System: <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+(t.gamGroup==="GM"?"Gender Marker":"Gender and Age Marker")+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+w.split("-")[0]+": <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+w.split("-")[1]+"</span></div>",l.left,70,{width:210-l.left-l.right},function(N){u=N}),e.addImage(a,"PNG",l.left,u.y+2,g,o);let G=new Date;e.save("GenderAgeMarker__"+ae(G)+".pdf"),pe(),d3.select("#pbigamDownloadingDiv").remove();function O(){let N="\xA9 OCHA CBPF Section "+te+" | For more information, please visit cbpf.data.unocha.org";e.setFillColor(65,143,222),e.rect(0,l.top,210,15,"F"),e.setFillColor(236,161,84),e.rect(0,l.top+15,210,2,"F"),e.setFillColor(255,255,255),e.rect(l.left,l.top-1,94,20,"F"),e.ellipse(l.left,l.top+9,5,9,"F"),e.ellipse(l.left+94,l.top+9,5,9,"F"),e.addImage(r,"PNG",l.left+2,l.top,90,18),e.setFillColor(236,161,84),e.rect(0,d-l.bottom,210,2,"F"),e.setTextColor(60),e.setFont("arial"),e.setFontType("normal"),e.setFontSize(10),e.text(N,l.left,d-l.bottom+10)}function B(){let N=t.selectedCbpfs.length===1?"":"s",n=t.selectedCbpfs.map(function(k){return U[k]}).sort(function(k,F){return k.toLowerCase()<F.toLowerCase()?-1:k.toLowerCase()>F.toLowerCase()?1:0}).reduce(function(k,F,K){return k+(K>=t.selectedCbpfs.length-2?K>t.selectedCbpfs.length-2?F:F+" and ":F+", ")},"");return"Selected CBPF"+N+"-"+n}})}function He(a,l,r,e){let c=a.append("g").attr("class","pbigamd3chartwheelGroup").attr("transform","translate("+l/2+","+r/4+")"),p=c.append("text").attr("text-anchor","middle").style("font-family","Roboto").style("font-weight","bold").style("font-size","11px").attr("y",50).attr("class","contributionColorFill").text(e),g=d3.arc().outerRadius(25).innerRadius(20),o=c.append("path").datum({startAngle:0,endAngle:0}).classed("contributionColorFill",!0).attr("d",g);f();function f(){o.transition().duration(1e3).attrTween("d",function(u){let h=d3.interpolate(0,Math.PI*2);return function(C){return u.endAngle=h(C),g(u)}}).on("end",d)}function d(){o.transition().duration(1e3).attrTween("d",function(u){let h=d3.interpolate(0,Math.PI*2);return function(C){return u.startAngle=h(C),g(u)}}).on("end",function(u){u.startAngle=0,f()})}}function pe(){let a=d3.select(".pbigamd3chartwheelGroup");a.select("path").interrupt(),a.remove()}}})();})();
