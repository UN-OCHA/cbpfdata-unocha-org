(()=>{(function(){let we=window.navigator.userAgent.indexOf("MSIE")>-1||window.navigator.userAgent.indexOf("Trident")>-1,Jt=window.fetch,Zt=window.URLSearchParams,$e=window.matchMedia("(pointer: coarse)").matches&&!window.matchMedia("(any-pointer: fine)").matches,le=window.location.hostname==="cbpf.data.unocha.org",Pe=window.location.hostname+window.location.pathname==="cbpf.data.unocha.org/bookmark.html",ve="https://use.fontawesome.com/releases/v5.6.3/css/all.css",_e=["https://cbpfgms.github.io/css/d3chartstyles.css","https://cbpfgms.github.io/css/d3chartstylespbifdc.css",ve],qt="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js",Ce="https://cbpfgms.github.io/libraries/html2canvas.min.js",Ae="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js",Kt="https://cdn.jsdelivr.net/npm/@ungap/url-search-params@0.1.2/min.min.js",Te="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js",ke="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.4/fetch.min.js";if(_e.forEach(function(k){if(!Je(k)){let g=document.createElement("link");g.setAttribute("rel","stylesheet"),g.setAttribute("type","text/css"),g.setAttribute("href",k),k===ve&&(g.setAttribute("integrity","sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"),g.setAttribute("crossorigin","anonymous")),document.getElementsByTagName("head")[0].appendChild(g)}}),!ce(qt))Jt&&Zt?yt(qt,It):Jt&&!Zt?yt(Kt,function(){yt(qt,It)}):yt(Te,function(){yt(ke,function(){yt(Kt,function(){yt(qt,It)})})});else if(typeof d3<"u")Jt&&Zt?It():Jt&&!Zt?yt(Kt,It):yt(Te,function(){yt(ke,function(){yt(Kt,It)})});else{let k,g=document.getElementsByTagName("script");for(let q=g.length;q--;)g[q].src==qt&&(k=g[q]);k.addEventListener("load",It)}function yt(k,g){let q=document.getElementsByTagName("head")[0],lt=document.createElement("script");lt.type="text/javascript",lt.src=k,lt.onreadystatechange=g,lt.onload=g,q.appendChild(lt)}function Je(k){let g=document.getElementsByTagName("link");for(let q=g.length;q--;)if(g[q].href==k)return!0;return!1}function ce(k){let g=document.getElementsByTagName("script");for(let q=g.length;q--;)if(g[q].src==k)return!0;return!1}function It(){Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(r){if(this==null)throw new TypeError('"this" is null or not defined');var c=Object(this),m=c.length>>>0;if(typeof r!="function")throw new TypeError("predicate must be a function");for(var e=arguments[1],s=0;s<m;){var A=c[s];if(r.call(e,A,s,c))return A;s++}},configurable:!0,writable:!0}),Math.log10=Math.log10||function(r){return Math.log(r)*Math.LOG10E},HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(r,c,m){var e=this.toDataURL(c,m).split(",")[1];setTimeout(function(){for(var s=atob(e),A=s.length,d=new Uint8Array(A),S=0;S<A;S++)d[S]=s.charCodeAt(S);r(new Blob([d],{type:c||"image/png"}))})}});let k=900,g=[4,6,4,6],q="pbifdc",lt=60,ct=580,Gt=30,Lt=4,dt=16,Z=.75,jt=1-Z,Mt=g[0]+lt+Gt+ct+2*Lt+g[2],U=10,vt=2,Nt=4,xt=10,Tt=d3.format("~s"),ft=d3.format(",.0f"),zt=d3.format(".0%"),Qt=d3.format(".3s"),it="Contributions Flow",Pt="#1F69B3",u="#F79A3B",M=new Date,Ot=M.getFullYear(),j=6e5,Ht=d3.utcFormat("_%Y%m%d_%H%M%S_UTC"),zn=22,Wt=35,Ke=20,Qe=20,Xe=10,Yn=1.1,tn=2,en=300,G=2,nn=14,Xt=82,on=6,an=4,rn=12,Ct=d3.local(),sn=["paid","pledge","total"],Dt={},ln="funding-overview",cn="https://cbpf.data.unocha.org/bookmark.html?",dn="https://gms.unocha.org/content/funding-overview",Se="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",pn="https://cbpfgms.github.io/img/assets/flags24.json",un="https://cbpfapi.unocha.org/vo2/odata/ContributionTotal?$format=csv&ShowAllPooledFunds=1",fn="https://raw.githubusercontent.com/CBPFGMS/cbpfgms.github.io/master/img/assets/worldmap.json",hn="https://cbpfgms.github.io/pfbi-data/mst/MstRhpf.json",te=24,gn=["M83.277,10.493l-13.132,12.22H22.821L9.689,10.493c0,0,6.54-9.154,17.311-10.352c10.547-1.172,14.206,5.293,19.493,5.56 c5.273-0.267,8.945-6.731,19.479-5.56C76.754,1.339,83.277,10.493,83.277,10.493z","M48.297,69.165v9.226c1.399-0.228,2.545-0.768,3.418-1.646c0.885-0.879,1.321-1.908,1.321-3.08 c0-1.055-0.371-1.966-1.113-2.728C51.193,70.168,49.977,69.582,48.297,69.165z","M40.614,57.349c0,0.84,0.299,1.615,0.898,2.324c0.599,0.729,1.504,1.303,2.718,1.745v-8.177 c-1.104,0.306-1.979,0.846-2.633,1.602C40.939,55.61,40.614,56.431,40.614,57.349z","M73.693,30.584H19.276c0,0-26.133,20.567-17.542,58.477c0,0,2.855,10.938,15.996,10.938h57.54 c13.125,0,15.97-10.938,15.97-10.938C99.827,51.151,73.693,30.584,73.693,30.584z M56.832,80.019 c-2.045,1.953-4.89,3.151-8.535,3.594v4.421H44.23v-4.311c-3.232-0.318-5.853-1.334-7.875-3.047 c-2.018-1.699-3.307-4.102-3.864-7.207l7.314-0.651c0.3,1.25,0.856,2.338,1.677,3.256c0.823,0.911,1.741,1.575,2.747,1.979v-9.903 c-3.659-0.879-6.348-2.22-8.053-3.997c-1.716-1.804-2.565-3.958-2.565-6.523c0-2.578,0.96-4.753,2.897-6.511 c1.937-1.751,4.508-2.767,7.721-3.034v-2.344h4.066v2.344c2.969,0.306,5.338,1.159,7.09,2.565c1.758,1.406,2.877,3.3,3.372,5.658 l-7.097,0.774c-0.43-1.849-1.549-3.118-3.365-3.776v9.238c4.485,1.035,7.539,2.357,9.16,3.984c1.634,1.635,2.441,3.725,2.441,6.289 C59.898,75.656,58.876,78.072,56.832,80.019z"],N=1e3,En=500,mn=window.innerHeight,o={selectedYear:[],showMap:null,showNames:null},Q={},_,Le,Vn,gt=!1,Me,H,de={"Latin America and the Caribbean":["CO","HT"],"West and Central Africa":["CF","CD","NG"],"Southern and Eastern Africa":["ET","SO","SS","SD"],"Middle East and North Africa":["IQ","JO","LB","PS","SY","XX","YE"],"Asia and the Pacific":["AF","MM","PK"],All:null},J=new URLSearchParams(location.search);J.has("viz")||J.append("viz",ln);let E=d3.select("#d3chartcontainerpbifdc"),yn=J.has("year")?J.get("year").replace(/\|/g,","):E.node().getAttribute("data-year"),Ne=J.has("regions")?J.get("regions").replace(/\|/g,","):E.node().getAttribute("data-regions"),ee=Ne.toLowerCase()==="all"?"All":Ne.split(",");ee!=="All"&&ee.some(function(r){return d3.keys(de).indexOf(r)===-1})&&(ee="All"),o.selectedRegion=ee;let xn=J.has("showmap")?J.get("showmap")==="true":E.node().getAttribute("data-showmap")==="true",bn=J.has("shownames")?J.get("shownames")==="true":E.node().getAttribute("data-shownames")==="true",wn=E.node().getAttribute("data-responsive")==="true",Pn=E.node().getAttribute("data-lazyload")==="true",Be=E.node().getAttribute("data-title")||it,vn=E.node().getAttribute("data-showhelp")==="true",Cn=E.node().getAttribute("data-showlink")==="true";wn==="false"&&E.style("width",k+"px").style("height",Mt+"px");let Ut=E.append("div").attr("class","pbifdcTopDiv"),An=Ut.append("div").attr("class","pbifdcTitleDiv"),kt=Ut.append("div").attr("class","pbifdcIconsDiv d3chartIconsDiv"),X=E.append("svg").attr("viewBox","0 0 "+k+" "+Mt).style("background-color","white");we&&X.attr("height",Mt);let Tn=E.append("div").attr("class","pbifdcYearsDescriptionDiv"),kn=le?null:E.append("div").attr("class","pbifdcFooterDiv");He(X,k,Mt,"Loading visualisation...");let Yt=E.append("div").attr("id","pbifdcSnapshotTooltip").attr("class","pbifdcSnapshotContent").style("display","none").on("mouseleave",function(){gt=!1,Yt.style("display","none"),ht.style("display","none"),H&&d3.select(H).dispatch("mouseout")});Yt.append("p").attr("id","pbifdcSnapshotTooltipPdfText").html("Download PDF").on("click",function(){gt=!1,ie("pdf",!0)}),Yt.append("p").attr("id","pbifdcSnapshotTooltipPngText").html("Download Image (PNG)").on("click",function(){gt=!1,ie("png",!0)});let De=!$e&&(window.safari||window.navigator.userAgent.indexOf("Edge")>-1);De&&Yt.append("p").attr("id","pbifdcTooltipBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default");let ht=E.append("div").attr("id","pbifdctooltipdiv").style("display","none");E.on("contextmenu",function(){d3.event.preventDefault();let r=d3.mouse(this);gt=!0,Yt.style("display","block").style("top",r[1]-4+"px").style("left",r[0]-4+"px")});let P={main:X.append("g").attr("class","pbifdcTopPanel").attr("transform","translate("+g[3]+","+g[0]+")"),width:k-g[1]-g[3],height:lt,moneyBagPadding:26,leftPadding:[174,428,546],mainValueVerPadding:12,mainValueHorPadding:3},w={main:X.append("g").attr("class","pbifdcButtonsPanel").attr("transform","translate("+g[3]+","+(g[0]+P.height+Lt)+")"),width:k-g[1]-g[3],height:Gt,padding:[0,0,0,6],buttonWidth:60,buttonPadding:4,buttonVerticalPadding:4,arrowPadding:18},x={main:X.append("g").attr("class","pbifdcNodesPanel").attr("transform","translate("+g[3]+","+(g[0]+P.height+w.height+2*Lt)+")"),width:(k-g[1]-g[3]-dt)*Z,height:ct,padding:[8,28,8,16]},n={main:X.append("g").attr("class","pbifdcLegendPanel").attr("transform","translate("+(g[3]+x.width+dt)+","+(g[0]+P.height+w.height+2*Lt)+")"),width:(k-g[1]-g[3]-dt)*jt,height:ct,padding:[10,6,12,6]},rt={main:X.append("g").attr("class","pbifdcGeoMenuPanel").attr("transform","translate("+(g[3]+w.padding[3]+w.arrowPadding+w.buttonPadding/2)+","+(g[0]+P.height+w.height+2*Lt)+")"),widthCollapsed:140,widthTotal:190,heightCollapsed:20,heightTotal:166,padding:[42,4,4,24],titlePadding:6},qn=x.main.append("clipPath").attr("id","pbifdcMapClip").append("rect").attr("width",x.width-x.padding[1]-x.padding[3]).attr("height",x.height-x.padding[0]-x.padding[2]),jn=x.main.append("clipPath").attr("id","pbifdcMainClip").append("rect").attr("width",x.width+dt).attr("height",x.height),pe=x.main.append("g").attr("class","pbifdcMapLayer").attr("clip-path","url(#pbifdcMapClip)").style("opacity",0),ue=x.main.append("g").attr("class","pbifdcZoomLayer").style("opacity",0).attr("cursor","move").attr("pointer-events","none"),Sn=x.main.append("g").attr("class","pbifdcLinksLayer").attr("clip-path","url(#pbifdcMainClip)"),Ln=x.main.append("g").attr("class","pbifdcNodesLayer").attr("clip-path","url(#pbifdcMainClip)"),fe=x.main.append("g").attr("class","pbifdcNodesLabelLayer").attr("clip-path","url(#pbifdcMainClip)"),Hn=ue.append("rect").attr("width",x.width).attr("height",x.height),he=pe.append("g").attr("class","pbifdcMapContainer"),Mn=d3.geoMercator().scale((x.width-x.padding[1]-x.padding[3])/(2*Math.PI)).translate([(x.width-x.padding[1]-x.padding[3])/2,(x.height-x.padding[0]-x.padding[2])/1.53]),ge=d3.geoPath().projection(Mn),me=d3.scaleSqrt().range([.5,Wt]),Fe=d3.scaleSqrt().range([.5,Ke]),Re=d3.scaleLinear().range([1,Qe]),Ie=d3.scaleLinear().range([1,Xe]),Et=d3.scaleLinear().range([.25,.75]),Ft=d3.scaleLinear(),$t=d3.scalePoint().padding(.5),Ge=d3.axisTop(Ft).tickSizeOuter(0).ticks(2).tickPadding(4).tickFormat(function(r){return"$"+Tt(r).replace("G","B")}),Oe=d3.axisLeft($t).tickPadding(6).tickSizeInner(0).tickSizeOuter(0);ce(Ce)||yt(Ce,null),ce(Ae)||yt(Ae,null),le&&!Pe?Promise.all([window.cbpfbiDataObject.contributionsTotalData,window.cbpfbiDataObject.worldMap,window.cbpfbiDataObject.flags,window.cbpfbiDataObject.masterRegionalFunds]).then(r=>ze(r)):Promise.all([ne(q+"data",un,"contributions data","csv"),ne(q+"map",fn,"map data","json"),ne("flags",pn,"flags data","json"),ne("masterRegionalFunds",hn,"master regional funds data","json")]).then(r=>ze(r));function ne(r,c,m,e){if(localStorage.getItem(r)&&JSON.parse(localStorage.getItem(r)).timestamp>M.getTime()-j){let s=e==="csv"?d3.csvParse(JSON.parse(localStorage.getItem(r)).data):JSON.parse(localStorage.getItem(r)).data;return console.info(q+" chart info: "+m+" from local storage"),Promise.resolve(s)}else return(e==="csv"?d3.csv:d3.json)(c).then(A=>{try{localStorage.setItem(r,JSON.stringify({data:e==="csv"?d3.csvFormat(A):A,timestamp:M.getTime()}))}catch(d){console.info(q+" chart, "+d)}return console.info(q+" chart info: "+m+" from API"),A})}function ze(r){ye(),_=r[0].map(function(m){return+m.FiscalYear}).filter(function(m,e,s){return s.indexOf(m)===e}).sort(),Dn(yn),o.showMap=xn,o.showNames=bn,Pn?(d3.select(window).on("scroll.pbifdc",c),d3.select("body").on("d3ChartsYear.pbifdc",function(){o.selectedYear=[Ve(+d3.event.detail)]}),c()):Ye(r);function c(){let m=E.node().getBoundingClientRect();m.bottom<0||m.top-mn>0||(d3.select(window).on("scroll.pbifdc",null),Ye(r))}}function Ye(r){let c=r[2],m=r[3];A(),le||Bn();let e=oe(r[0]),s=r[1];d(s),pe.transition().duration(N).style("opacity",function(){return o.showMap?1:0}),S(e.nodes),nt(),$(e.nodes,e.links),st(),z(e.nodes,e.links),_t(),je(),vn&&Ee();function A(){let p=An.append("p").attr("id","pbifdcd3chartTitle").html(Be),D=kt.append("button").attr("id","pbifdcHelpButton");D.html("HELP  ").append("span").attr("class","fas fa-info");let a=kt.append("button").attr("id","pbifdcDownloadButton");a.html(".CSV  ").append("span").attr("class","fas fa-download");let l=kt.append("div").attr("class","pbifdcSnapshotDiv");l.append("button").attr("id","pbifdcSnapshotButton").html("IMAGE ").append("span").attr("class","fas fa-camera");let i=l.append("div").attr("class","pbifdcSnapshotContent"),I=i.append("p").attr("id","pbifdcSnapshotPdfText").html("Download PDF").on("click",function(){ie("pdf",!1)}),K=i.append("p").attr("id","pbifdcSnapshotPngText").html("Download Image (PNG)").on("click",function(){ie("png",!1)}),F=kt.append("button").datum({clicked:!1}).attr("id","pbifdcPlayButton");if(F.html("PLAY  ").append("span").attr("class","fas fa-play"),F.on("click",function(Y){Y.clicked=!Y.clicked,F.html(Y.clicked?"PAUSE ":"PLAY  ").append("span").attr("class",Y.clicked?"fas fa-pause":"fas fa-play"),Y.clicked?(o.selectedYear.length=1,v(),Me=d3.interval(v,3*N)):Me.stop();function v(){let B=_.indexOf(o.selectedYear[0]);o.selectedYear[0]=_[(B+1)%_.length],d3.selectAll(".pbifdcbuttonsRects").filter(function(at){return at===o.selectedYear[0]}).dispatch("click");let C=o.selectedYear[0]<_[U/2]?0:o.selectedYear[0]>_[_.length-U/2]?_.length-U:_.indexOf(o.selectedYear[0])-U/2,W=-(w.buttonWidth*C);W===0?(X.select(".pbifdcLeftArrowGroup").select("text").style("fill","#ccc"),X.select(".pbifdcLeftArrowGroup").attr("pointer-events","none")):(X.select(".pbifdcLeftArrowGroup").select("text").style("fill","#666"),X.select(".pbifdcLeftArrowGroup").attr("pointer-events","all")),Math.abs(W)>=(_.length-U)*w.buttonWidth?(X.select(".pbifdcRightArrowGroup").select("text").style("fill","#ccc"),X.select(".pbifdcRightArrowGroup").attr("pointer-events","none")):(X.select(".pbifdcRightArrowGroup").select("text").style("fill","#666"),X.select(".pbifdcRightArrowGroup").attr("pointer-events","all")),X.select(".pbifdcbuttonsGroup").transition().duration(N).attrTween("transform",function(){return d3.interpolateString(this.getAttribute("transform"),"translate("+W+",0)")})}}),!Pe){let Y=kt.append("button").attr("id","pbifdcShareButton");Y.html("SHARE  ").append("span").attr("class","fas fa-share");let v=E.append("div").attr("class","d3chartShareDiv").style("display","none");Y.on("mouseover",function(){v.html("Click to copy").style("display","block");let B=this.getBoundingClientRect(),O=E.node().getBoundingClientRect(),C=v.node().getBoundingClientRect(),W=B.top-O.top-(C.height-B.height)/2,at=B.left-O.left-C.width-12;v.style("top",W+"px").style("left",at+"20px")}).on("mouseout",function(){v.style("display","none")}).on("click",function(){let B=cn+J.toString();v.append("input").attr("type","text").attr("readonly",!0).attr("spellcheck","false").property("value",B).node().select(),document.execCommand("copy"),v.html("Copied!");let C=this.getBoundingClientRect(),W=E.node().getBoundingClientRect(),at=v.node().getBoundingClientRect(),Bt=C.left-W.left-at.width-12;v.style("left",Bt+"20px")})}if(De){let Y=i.append("p").attr("id","pbifdcBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default")}l.on("mouseover",function(){i.style("display","block")}).on("mouseout",function(){i.style("display","none")}),D.on("click",Ee),a.on("click",function(){let Y=Nn(r[0]),B="ContributionsFlow_"+Ht(new Date)+".csv",O=new Blob([Y],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(O,filename);else{let C=document.createElement("a");if(C.download!==void 0){let W=URL.createObjectURL(O);C.setAttribute("href",W),C.setAttribute("download",B),C.style="visibility:hidden",document.body.appendChild(C),C.click(),document.body.removeChild(C)}}})}function d(p){p.features.forEach(function(a){Q[a.properties.iso_a2.toLowerCase()]={x:ge.centroid(a.geometry)[0],y:ge.centroid(a.geometry)[1]}}),Q.us.x+=60,Q.us.y+=40,Q.ca.x-=20,Q.ca.y+=40,Q.no.y+=40,Q.fr.x+=9,Q.fr.y-=9,Q.xx=Q.tr;let D=he.append("path").attr("d",ge(p)).attr("fill","none").attr("stroke","#e9e9f9").attr("stroke-width","1px")}function S(p){let D=p.filter(function(t){return t.category==="Donor"}),a=d3.sum(D,function(t){return t.total});Le=D.length;let l=p.filter(function(t){return t.category==="CBPF"&&!t.name.includes("RhPF")}).length,ot=new Set;p.forEach(function(t){if(t.category==="CBPF"&&t.name.includes("RhPF")){let L=t.name.split("(RhPF")[0].trim(),y=m.find(function(h){return h.RFundName.includes(L)});y&&ot.add(y.RFundAbbrv)}});let i=Array.from(ot).length;sn.forEach(function(t){Dt[t]=d3.sum(D,function(L){return L[t]})}),P.main.selectAll(".pbifdctopPanelMoneyBag").data([!0]).enter().append("g").attr("class","pbifdctopPanelMoneyBag contributionColorFill").attr("transform","translate("+P.moneyBagPadding+",6) scale(0.5)").each(function(t,L,y){gn.forEach(function(h){d3.select(y[L]).append("path").attr("d",h)})});let K=d3.select(".pbifdctopPanelMainValue").size()!==0?d3.select(".pbifdctopPanelMainValue").datum():0,F=d3.select(".pbifdctopPanelDonorsNumber").size()!==0?d3.select(".pbifdctopPanelDonorsNumber").datum():0,Y=d3.select(".pbifdctopPanelCbpfsNumber").size()!==0?d3.select(".pbifdctopPanelCbpfsNumber").datum():0,v=d3.select(".pbifdctopPanelRhpfsNumber").size()!==0?d3.select(".pbifdctopPanelRhpfsNumber").datum():0,B=P.main.selectAll(".pbifdcmainValueGroup").data([!0]);B=B.enter().append("g").attr("class","pbifdcmainValueGroup").merge(B);let O=B.selectAll(".pbifdctopPanelMainValue").data([a]);O=O.enter().append("text").attr("class","pbifdctopPanelMainValue contributionColorFill").attr("text-anchor","end").attr("x",P.moneyBagPadding+P.leftPadding[0]-P.mainValueHorPadding).attr("y",P.height-P.mainValueVerPadding).merge(O),O.transition().duration(N).tween("text",function(t){let L=this,y=d3.interpolate(K,t);return function(h){let b=qe(y(h));L.textContent="$"+b.substring(0,b.length-1)}});let C=B.selectAll(".pbifdctopPanelMainText").data([a]);C=C.enter().append("text").attr("class","pbifdctopPanelMainText").style("opacity",0).attr("text-anchor","start").attr("x",P.moneyBagPadding+P.leftPadding[0]+P.mainValueHorPadding).attr("y",P.height-P.mainValueVerPadding*2.9).merge(C),C.transition().duration(N).style("opacity",1).text(function(t){let L=o.selectedYear.length===1?o.selectedYear[0]:"years*",y=qe(t),h=y[y.length-1];return(h==="k"?"Thousand":h==="M"?"Million":h==="G"?"Billion":"")+" Donated in "+L});let W=B.selectAll(".pbifdctopPanelSubText").data([!0]);W=W.enter().append("text").attr("class","pbifdctopPanelSubText").style("opacity",0).attr("text-anchor","start").attr("x",P.moneyBagPadding+P.leftPadding[0]+P.mainValueHorPadding).attr("y",P.height-P.mainValueVerPadding*1.3).merge(W),W.transition().duration(N).style("opacity",1).text(o.selectedYear<=new Date().getFullYear()?"(Total Contributions)":"(Pledged Values)");let at=B.selectAll(".pbifdctopPanelDonorsNumber").data([Le]);at=at.enter().append("text").attr("class","pbifdctopPanelDonorsNumber contributionColorFill").attr("text-anchor","end").attr("x",P.moneyBagPadding+P.leftPadding[1]-P.mainValueHorPadding).attr("y",P.height-P.mainValueVerPadding).merge(at),at.transition().duration(N).tween("text",function(t){let L=this,y=d3.interpolate(F,t);return function(h){L.textContent=~~y(h)}});let Bt=B.selectAll(".pbifdctopPanelDonorsText").data([!0]).enter().append("text").attr("class","pbifdctopPanelDonorsText").attr("y",P.height-P.mainValueVerPadding*1.9).attr("text-anchor","start").text("Donors").attr("x",P.moneyBagPadding+P.leftPadding[1]),pt=B.selectAll(".pbifdctopPanelCbpfsNumber").data(l?[l]:[]);pt.exit().remove(),pt=pt.enter().append("text").attr("class","pbifdctopPanelCbpfsNumber allocationColorFill").attr("text-anchor","end").attr("x",P.moneyBagPadding+P.leftPadding[2]-P.mainValueHorPadding).merge(pt).style("font-size",i?"22px":"48px").attr("y",P.height-P.mainValueVerPadding*(i?2.7:1)),pt.transition().duration(N).tween("text",function(t){let L=this,y=d3.interpolate(Y,t);return function(h){L.textContent=~~y(h)}});let ut=B.selectAll(".pbifdctopPanelCbpfsText").data(l?[l]:[]);ut.exit().remove(),ut=ut.enter().append("text").attr("class","pbifdctopPanelCbpfsText").attr("text-anchor","start").attr("x",P.moneyBagPadding+P.leftPadding[2]).merge(ut).style("font-size",i?"14px":"16px").attr("y",P.height-P.mainValueVerPadding*(i?2.85:1.9)).text(l>1?"CBPFs":"CBPF");let tt=B.selectAll(".pbifdctopPanelRhpfsNumber").data(i?[i]:[]);tt.exit().remove(),tt=tt.enter().append("text").attr("class","pbifdctopPanelRhpfsNumber allocationColorFill").attr("text-anchor","end").attr("x",P.moneyBagPadding+P.leftPadding[2]-P.mainValueHorPadding).merge(tt).style("font-size",l?"22px":"48px").attr("y",P.height-P.mainValueVerPadding*(l?.8:1)),tt.transition().duration(N).tween("text",function(t){let L=this,y=d3.interpolate(v,t);return function(h){L.textContent=~~y(h)}});let wt=B.selectAll(".pbifdctopPanelRhpfsText").data(i?[i]:[]);wt.exit().remove(),wt=wt.enter().append("text").attr("class","pbifdctopPanelRhpfsText").attr("text-anchor","start").style("cursor","default").attr("x",P.moneyBagPadding+P.leftPadding[2]).merge(wt).style("font-size",l?"14px":"16px").attr("y",P.height-P.mainValueVerPadding*(l?1:1.9)).text(i>1?"Regional funds":"Regional fund"),wt.append("tspan").attr("class","pbifdcinfoIcon contributionColorFill").text(" \uF05A"),P.main.selectAll(".pbifdctopPanelOverRectangle").data([!0]).enter().append("rect").attr("class","pbifdctopPanelOverRectangle").attr("width",P.width/2).attr("height",P.height).style("opacity",0).on("mouseover",Rt).on("mouseout",We),wt.on("mouseover",re).on("mouseout",We)}function nt(){let p=w.main.append("clipPath").attr("id","pbifdcclipPathButtons").append("rect").attr("width",U*w.buttonWidth).attr("height",w.height),a=w.main.append("g").attr("class","pbifdcClipPathGroup").attr("transform","translate("+(w.padding[3]+w.arrowPadding)+",0)").attr("clip-path","url(#pbifdcclipPathButtons)").append("g").attr("class","pbifdcbuttonsGroup").attr("transform","translate(0,0)").style("cursor","pointer"),l=a.selectAll(null).data(_).enter().append("rect").attr("rx","2px").attr("ry","2px").attr("class","pbifdcbuttonsRects").attr("width",w.buttonWidth-w.buttonPadding).attr("height",w.height-w.buttonVerticalPadding*2).attr("y",w.buttonVerticalPadding).attr("x",function(R,St){return St*w.buttonWidth+w.buttonPadding/2}).style("fill",function(R){return o.selectedYear.indexOf(R)>-1?Pt:"#eaeaea"}),ot=a.selectAll(null).data(_).enter().append("text").attr("text-anchor","middle").attr("class","pbifdcbuttonsText").attr("y",w.height/1.6).attr("x",function(R,St){return St*w.buttonWidth+w.buttonWidth/2}).style("fill",function(R){return o.selectedYear.indexOf(R)>-1?"white":"#444"}).text(function(R){return R}),i=w.main.append("g").attr("class","pbifdcLeftArrowGroup").style("cursor","pointer").attr("transform","translate("+w.padding[3]+",0)"),I=i.append("rect").style("fill","white").attr("width",w.arrowPadding).attr("height",w.height),K=i.append("text").attr("class","pbifdcleftArrowText").attr("x",0).attr("y",w.height-w.buttonVerticalPadding*2.1).style("fill","#666").text("\u25C4"),F=w.main.append("g").attr("class","pbifdcRightArrowGroup").style("cursor","pointer").attr("transform","translate("+(w.padding[3]+w.arrowPadding+U*w.buttonWidth)+",0)"),Y=F.append("rect").style("fill","white").attr("width",w.arrowPadding).attr("height",w.height),v=F.append("text").attr("class","pbifdcrightArrowText").attr("x",-1).attr("y",w.height-w.buttonVerticalPadding*2.1).style("fill","#666").text("\u25BA"),B=w.main.append("g").attr("class","pbifdcShowMapGroup").attr("transform","translate("+(g[3]+x.width+dt)+","+w.height*.6+")").style("cursor","pointer").attr("pointer-events","all"),O=w.main.append("g").attr("transform","translate("+(g[3]+x.width+dt-xt)+","+w.height*.6+")").style("opacity",0).attr("pointer-events","none"),C=O.append("text").attr("class","pbifdcShowMapGroupLegendText").text("Show the nodes in their corresponding geographic coordinates").attr("x",0).attr("y",0).call(Vt,150),W=O.append("polyline").attr("points","56,30 0,30 0,40").style("fill","none").style("stroke","#aaa").style("stroke-width","1px"),at=B.append("rect").attr("width",14).attr("height",14).attr("rx",2).attr("ry",2).attr("x",-9).attr("y",-11).attr("fill","white").attr("stroke","darkslategray"),Bt=B.append("polyline").style("stroke-width","2px").attr("points","-6,-4 -3,-1 2,-8").style("fill","none").style("stroke",o.showMap?"darkslategray":"white"),pt=B.append("text").attr("class","pbifdcShowMapTextControl").attr("x",8).text("Show Map"),ut=w.main.append("g").attr("class","pbifdcShowNamesGroup").attr("transform","translate("+(g[3]+x.width+dt+Xt)+","+w.height*.6+")").style("cursor","pointer").attr("pointer-events","all"),tt=w.main.append("g").attr("transform","translate("+(g[3]+x.width+dt+Xt-xt)+","+w.height*.6+")").style("opacity",0).attr("pointer-events","none"),wt=tt.append("text").attr("class","pbifdcShowMapGroupLegendText").text("Show or hide the name of each node. Hiding the name is useful in the map view").attr("x",0).attr("y",0).call(Vt,140),At=tt.append("polyline").attr("points","76,30 0,30 0,40").style("fill","none").style("stroke","#aaa").style("stroke-width","1px"),t=ut.append("rect").attr("width",14).attr("height",14).attr("rx",2).attr("ry",2).attr("x",-9).attr("y",-11).attr("fill","white").attr("stroke","darkslategray"),L=ut.append("polyline").style("stroke-width","2px").attr("points","-6,-4 -3,-1 2,-8").style("fill","none").style("stroke",o.showNames?"darkslategray":"white"),y=ut.append("text").attr("class","pbifdcShowMapTextControl").attr("x",8).text("Show Names");l.on("mouseover",In).on("mouseout",Gn).on("click",function(R){let St=this;if(d3.event.altKey){mt(R,!1);return}Ct.get(this)!=="clicked"?(Ct.set(this,"clicked"),setTimeout(function(){Ct.get(St)==="clicked"&&mt(R,!0),Ct.set(St,null)},250)):(mt(R,!1),Ct.set(this,null))}),d3.select("body").on("d3ChartsYear.pbifdc",function(){mt(Ve(+d3.event.detail),!0),et(),h()}),et(),b(),i.on("click",function(){i.attr("pointer-events","none");let R=ae(a.attr("transform"))[0];F.select("text").style("fill","#666"),F.attr("pointer-events","all"),a.transition().duration(N).attr("transform","translate("+Math.min(0,R+U*w.buttonWidth)+",0)").on("end",h)}),F.on("click",function(){F.attr("pointer-events","none");let R=ae(a.attr("transform"))[0];i.select("text").style("fill","#666"),i.attr("pointer-events","all"),a.transition().duration(N).attr("transform","translate("+Math.max(-((_.length-U)*w.buttonWidth),-(Math.abs(R)+U*w.buttonWidth))+",0)").on("end",h)}),B.on("mouseover",function(){H=this,O.transition().duration(N).attr("transform","translate("+(g[3]+x.width+dt-xt)+",-36)").style("opacity",1)}).on("mouseout",function(){gt||(H=null,O.interrupt().attr("transform","translate("+(g[3]+x.width+dt-xt)+","+w.height*.6+")").style("opacity",0))}).on("click",function(){o.showMap=!o.showMap,J.has("showmap")?J.set("showmap",o.showMap):J.append("showmap",o.showMap),Bt.style("stroke",o.showMap?"darkslategray":"white"),O.interrupt().style("opacity",0),pe.style("opacity",function(){return o.showMap?1:0}),$(e.nodes,e.links),z(e.nodes,e.links)}),ut.on("mouseover",function(){H=this,tt.transition().duration(N).attr("transform","translate("+(g[3]+x.width+dt+Xt-xt)+",-36)").style("opacity",1)}).on("mouseout",function(){gt||(H=null,tt.interrupt().attr("transform","translate("+(g[3]+x.width+dt+Xt-xt)+","+w.height*.6+")").style("opacity",0))}).on("click",function(){o.showNames=!o.showNames,J.has("shownames")?J.set("shownames",o.showNames):J.append("shownames",o.showNames),L.style("stroke",o.showNames?"darkslategray":"white"),tt.interrupt().style("opacity",0),fe.selectAll(".pbifdcNodesLabelBack, .pbifdcNodesLabel").style("opacity",o.showNames?1:0),fe.selectAll(".pbifdcNodesLabelBack, .pbifdcNodesLabel").attr("pointer-events",o.showNames?"all":"none")});function h(){let R=ae(a.attr("transform"))[0];R===0?(i.select("text").style("fill","#ccc"),i.attr("pointer-events","none")):(i.select("text").style("fill","#666"),i.attr("pointer-events","all")),Math.abs(R)>=(_.length-U)*w.buttonWidth?(F.select("text").style("fill","#ccc"),F.attr("pointer-events","none")):(F.select("text").style("fill","#666"),F.attr("pointer-events","all"))}function b(){let R=ae(a.attr("transform"))[0];R===0&&(i.select("text").style("fill","#ccc"),i.attr("pointer-events","none")),Math.abs(R)>=(_.length-U)*w.buttonWidth&&(F.select("text").style("fill","#ccc"),F.attr("pointer-events","none"))}function et(){let R=o.selectedYear[0]<_[U/2]?0:o.selectedYear[0]>_[_.length-U/2]?_.length-U:_.indexOf(o.selectedYear[0])-U/2;a.attr("transform","translate("+-(w.buttonWidth*R)+",0)")}}function $(p,D){let a;o.showMap?a=d3.zoomTransform(x.main.node()):(ue.attr("pointer-events","none"),x.main.on(".zoom",null));let l={geoSimulation:d3.forceSimulation().force("link",d3.forceLink().id(function(t){return t.uniqueId}).strength(0)).force("x",d3.forceX(function(t){return Q[t.isoCode.toLowerCase()]&&Q[t.isoCode.toLowerCase()].x===Q[t.isoCode.toLowerCase()].x?Q[t.isoCode.toLowerCase()].x:Q.ch.x}).strength(1)).force("y",d3.forceY(function(t){return Q[t.isoCode.toLowerCase()]&&Q[t.isoCode.toLowerCase()].y===Q[t.isoCode.toLowerCase()].y?Q[t.isoCode.toLowerCase()].y:Q.ch.y}).strength(1)),naturalSimulation:d3.forceSimulation().force("link",d3.forceLink().id(function(t){return t.uniqueId})).force("charge",d3.forceManyBody()).force("center",d3.forceCenter(x.width/2,x.height/2)).force("collide",d3.forceCollide(function(t){return nn+me(t.total)*tn})).force("boundary",Ze(x.padding[3]+Wt,x.padding[0]+Wt,x.width-x.padding[1]-Wt,x.height-x.padding[2]-Wt))},ot=o.showMap?l.geoSimulation:l.naturalSimulation,i=o.showMap?Fe:me,I=o.showMap?Ie:Re;i.domain([0,d3.max(p,function(t){return t.total})]),I.domain([0,d3.max(D,function(t){return t.total})]),Et.domain([0,d3.max(D,function(t){return t.total})]),ot.stop(),ot.nodes(p),ot.force("link").links(D);for(let t=0;t<en;++t)ot.tick();let K=Sn.selectAll(".pbifdcLinks").data(D,function(t){return t.source.uniqueId+t.target.uniqueId}),F=K.exit().transition().duration(N).attr("stroke-width",0).remove();K=K.enter().append("path").style("opacity",0).style("fill","none").style("stroke","#ccc").attr("stroke-width",0).attr("class","pbifdcLinks").attr("d",function(t){let L=~~(Math.random()*2);Ct.set(this,L);let y=t.target.x-t.source.x,h=t.target.y-t.source.y,b=Math.sqrt(y*y+h*h);return"M"+t.source.x+","+t.source.y+"A"+b+","+b+" 0 0 "+L+" "+t.target.x+","+t.target.y}).attr("transform",function(){return o.showMap?a:"translate(0,0) scale(1)"}).merge(K),K.transition().duration(N).style("opacity",function(t){return Et(t.total)}).attr("stroke-width",function(t){return o.showMap?I(t.total)/a.k:I(t.total)}).attr("d",function(t){let L=Ct.get(this),y=t.target.x-t.source.x,h=t.target.y-t.source.y,b=Math.sqrt(y*y+h*h);return"M"+t.source.x+","+t.source.y+"A"+b+","+b+" 0 0 "+L+" "+t.target.x+","+t.target.y}).attr("transform",function(){return o.showMap?a:"translate(0,0) scale(1)"});let v=Ln.selectAll(".pbifdcNodeCircle").data(p,function(t){return t.uniqueId}),B=v.exit().transition().duration(N).attr("r",0).remove();v=v.enter().append("circle").attr("r",0).attr("cx",function(t){return o.showMap?t.x*a.k+a.x:t.x}).attr("cy",function(t){return o.showMap?t.y*a.k+a.y:t.y}).attr("class",function(t){return t.category==="Donor"?"pbifdcNodeCircle contributionColorFill":"pbifdcNodeCircle allocationColorFill"}).style("stroke","darkslategray").style("stroke-width","1px").merge(v),o.showMap&&v.sort(function(t,L){return L.total-t.total}),v.transition().duration(N).attr("r",function(t){return i(t.total)}).attr("cx",function(t){return o.showMap?t.x*a.k+a.x:t.x}).attr("cy",function(t){return o.showMap?t.y*a.k+a.y:t.y}).on("end",function(){o.showMap&&ut()});let C=fe.selectAll(".pbifdcNodesLabelGroup").data(p,function(t){return t.uniqueId}),W=C.exit().transition().duration(N).style("opacity",0).remove(),at=C.enter().append("g").attr("class","pbifdcNodesLabelGroup").style("opacity",0).style("cursor","default"),Bt=at.append("text").attr("class","pbifdcNodesLabelBack").attr("x",function(t){return o.showMap?t.x*a.k+a.x:t.x}).attr("y",function(t){return o.showMap?t.y*a.k+a.y:t.y}).attr("dx",function(t){return i(t.total)+G}).style("opacity",o.showNames?1:0).attr("pointer-events",o.showNames?"all":"none").text(function(t){return t.labelText.length>2?t.labelText[0]+" "+t.labelText[1]:t.labelText[0]}).each(function(t){t.labelText.length>1&&d3.select(this).append("tspan").attr("x",o.showMap?t.x*a.k+a.x+i(t.total)+G:t.x+i(t.total)+G).attr("dy",10).text(t.labelText.length>2?t.labelText[2]:t.labelText[1])}),pt=at.append("text").attr("class","pbifdcNodesLabel").attr("x",function(t){return o.showMap?t.x*a.k+a.x:t.x}).attr("y",function(t){return o.showMap?t.y*a.k+a.y:t.y}).attr("dx",function(t){return i(t.total)+G}).style("opacity",o.showNames?1:0).attr("pointer-events",o.showNames?"all":"none").text(function(t){return t.labelText.length>2?t.labelText[0]+" "+t.labelText[1]:t.labelText[0]}).each(function(t){t.labelText.length>1&&d3.select(this).append("tspan").attr("x",o.showMap?t.x*a.k+a.x+i(t.total)+G:t.x+i(t.total)+G).attr("dy",10).text(t.labelText.length>2?t.labelText[2]:t.labelText[1])});C=at.merge(C),C.transition().duration(N).style("opacity",1),C.select("text.pbifdcNodesLabelBack").transition().duration(N).attr("x",function(t){return o.showMap?t.x*a.k+a.x:t.x}).attr("y",function(t){return o.showMap?t.y*a.k+a.y:t.y}).attr("dx",function(t){return i(t.total)+G}),C.select("text.pbifdcNodesLabel").transition().duration(N).attr("x",function(t){return o.showMap?t.x*a.k+a.x:t.x}).attr("y",function(t){return o.showMap?t.y*a.k+a.y:t.y}).attr("dx",function(t){return i(t.total)+G}),C.select(".pbifdcNodesLabelBack tspan").transition().duration(N).attr("x",function(t){return o.showMap?t.x*a.k+a.x+i(t.total)+G:t.x+i(t.total)+G}),C.select(".pbifdcNodesLabel tspan").transition().duration(N).attr("x",function(t){return o.showMap?t.x*a.k+a.x+i(t.total)+G:t.x+i(t.total)+G}),v.on("mouseover",null).on("mouseout",null),C.on("mouseover",null).on("mouseout",null),K.on("mouseover",null).on("mouseout",null),d3.timeout(function(){v.on("mouseover",tt).on("mouseout",At),C.on("mouseover",tt).on("mouseout",At),K.on("mouseover",wt).on("mouseout",At)},N*1.1);function ut(){ue.attr("pointer-events","all");let t=d3.zoom().scaleExtent([1,20]).extent([[0,0],[x.width,x.height]]).translateExtent([[0,0],[x.width,x.height]]).on("zoom",L);x.main.call(t);function L(){he.attr("transform",d3.event.transform),he.select("path").attr("stroke-width",1/d3.event.transform.k+"px"),v.attr("cx",function(y){return y.x*d3.event.transform.k+d3.event.transform.x}).attr("cy",function(y){return y.y*d3.event.transform.k+d3.event.transform.y}),C.select("text.pbifdcNodesLabelBack").attr("x",function(y){return y.x*d3.event.transform.k+d3.event.transform.x}).attr("y",function(y){return y.y*d3.event.transform.k+d3.event.transform.y}),C.select("text.pbifdcNodesLabel").attr("x",function(y){return y.x*d3.event.transform.k+d3.event.transform.x}).attr("y",function(y){return y.y*d3.event.transform.k+d3.event.transform.y}),C.select(".pbifdcNodesLabelBack tspan").attr("x",function(y){return y.x*d3.event.transform.k+d3.event.transform.x+i(y.total)+G}),C.select(".pbifdcNodesLabel tspan").attr("x",function(y){return y.x*d3.event.transform.k+d3.event.transform.x+i(y.total)+G}),K.attr("transform",d3.event.transform).attr("stroke-width",function(y){return I(y.total)/d3.event.transform.k})}}function tt(t){H=this,o.showMap&&(a=d3.zoomTransform(x.main.node()));let L=t.connections.map(function(b){return b.uniqueId}),y=v.filter(function(b){return L.indexOf(b.uniqueId)>-1}),h=C.filter(function(b){return L.indexOf(b.uniqueId)>-1});L.push(t.uniqueId),v.style("opacity",function(b){return L.indexOf(b.uniqueId)>-1?1:0}),C.style("opacity",function(b){return L.indexOf(b.uniqueId)>-1?1:0}),K.style("opacity",function(b){return b.source.uniqueId===t.uniqueId||b.target.uniqueId===t.uniqueId?Et(b.total):0}),V(t),y.transition().duration(N/2).attr("r",function(b){let et=t.connections.find(function(R){return b.uniqueId===R.uniqueId});return i(et.total)}),h.select("text.pbifdcNodesLabelBack").transition().duration(N/2).attr("dx",function(b){let et=t.connections.find(function(R){return b.uniqueId===R.uniqueId});return Ct.set(this.parentNode,et),i(et.total)+G}),h.select("text.pbifdcNodesLabel").transition().duration(N/2).attr("dx",function(b){let et=Ct.get(this);return i(et.total)+G}),h.select(".pbifdcNodesLabelBack tspan").transition().duration(N/2).attr("x",function(b){let et=Ct.get(this);return o.showMap?b.x*a.k+a.x+i(et.total)+G:b.x+i(et.total)+G}),h.select(".pbifdcNodesLabel tspan").transition().duration(N/2).attr("x",function(b){let et=Ct.get(this);return o.showMap?b.x*a.k+a.x+i(et.total)+G:b.x+i(et.total)+G})}function wt(t){H=this,o.showMap&&(a=d3.zoomTransform(x.main.node())),v.style("opacity",function(y){return y.uniqueId===t.source.uniqueId||y.uniqueId===t.target.uniqueId?1:0}),C.style("opacity",function(y){return y.uniqueId===t.source.uniqueId||y.uniqueId===t.target.uniqueId?1:0}),K.style("opacity",0),d3.select(this).style("opacity",function(y){return Et(y.total)});let L=t.source.connections.find(function(y){return y.uniqueId===t.target.uniqueId}).total;[t.source,t.target].forEach(function(y){v.filter(function(b){return b.uniqueId===y.uniqueId}).transition().duration(N/2).attr("r",i(L));let h=C.filter(function(b){return b.uniqueId===y.uniqueId});h.select("text.pbifdcNodesLabelBack").transition().duration(N/2).attr("dx",function(b){return i(L)+G}),h.select("text.pbifdcNodesLabel").transition().duration(N/2).attr("dx",function(b){return i(L)+G}),h.select(".pbifdcNodesLabelBack tspan").transition().duration(N/2).attr("x",function(b){return o.showMap?b.x*a.k+a.x+i(L)+G:b.x+i(L)+G}),h.select(".pbifdcNodesLabel tspan").transition().duration(N/2).attr("x",function(b){return o.showMap?b.x*a.k+a.x+i(L)+G:b.x+i(L)+G})}),bt(t)}function At(){gt||(H=null,v.interrupt(),C.selectAll("*").interrupt(),v.style("opacity",1).attr("r",function(t){return i(t.total)}),C.style("opacity",1),C.select("text.pbifdcNodesLabelBack").attr("dx",function(t){return i(t.total)+G}),C.select("text.pbifdcNodesLabel").attr("dx",function(t){return i(t.total)+G}),C.select(".pbifdcNodesLabelBack tspan").attr("x",function(t){return o.showMap?t.x*a.k+a.x+i(t.total)+G:t.x+i(t.total)+G}),C.select(".pbifdcNodesLabel tspan").attr("x",function(t){return o.showMap?t.x*a.k+a.x+i(t.total)+G:t.x+i(t.total)+G}),K.style("opacity",function(t){return Et(t.total)}),z(e.nodes,e.links))}}function st(){let p=n.main.append("rect").attr("width",n.width).attr("height",n.height).attr("rx",3).attr("ry",3).style("fill","none").style("stroke-width","0.5px").style("stroke","#ccc")}function z(p,D){let a=n.main.selectAll(".pbifdcNodeLegendGroup,.pbifdcLinkLegendGroup,.pbifdcLegendGroup");a.selectAll("*").interrupt(),a.remove();let l=o.showMap?Fe:me,ot=o.showMap?Ie:Re,i=n.main.append("g").attr("class","pbifdcLegendGroup"),I=i.append("text").attr("class","pbifdcLegendTitle").attr("x",n.width/2).attr("text-anchor","middle").attr("y",n.padding[0]+16).text("LEGEND");if(p.length===0){i.append("text").attr("class","pbifdcLegendSubTitle").attr("x",n.width/2).attr("y",n.padding[0]+86).attr("text-anchor","middle").text("No data for the current selection ("+o.selectedRegion.join(",")+")").call(Vt,200);return}let K=i.append("text").attr("class","pbifdcLegendSubTitle").attr("x",n.padding[3]).attr("y",n.padding[0]+66).text("COLOR:"),F=i.selectAll(null).data(["Donor","CBPF"]).enter().append("g").attr("transform",function(f,T){return"translate("+n.padding[3]+","+(n.padding[0]+76+T*20)+")"});F.append("rect").attr("width",16).attr("height",16).attr("rx",2).attr("ry",2).style("stroke","darkslategray").attr("class",function(f,T){return T?"allocationColorFill":"contributionColorFill"}),F.append("text").attr("x",22).attr("y",12).style("cursor","default").attr("class","pbifdcLegendTextSmall").text(function(f,T){return T?"CBPF":"Donor"});let Y=i.append("text").attr("class","pbifdcLegendSubTitle").attr("x",n.padding[3]).attr("y",n.padding[0]+192).text("SIZE:"),v=Y.append("tspan").attr("class","pbifdcLegendTextSmall2").text(" (hover for info)"),B=i.append("text").attr("class","pbifdcLegendTextSmall2").style("opacity",0).attr("x",n.padding[3]).attr("y",n.padding[0]+162).text("The size of each node represents the total amount received (CBPF) or donated (donor).").call(Vt,n.width-n.padding[1]-n.padding[3]),O=i.append("rect").attr("y",n.padding[0]+122).attr("width",n.width).attr("height",80).style("opacity",0),C=d3.extent(p,function(f){return f.total}).map(function(f){return p.find(function(T){return T.total===f})}).reverse(),W=i.selectAll(null).data(C).enter().append("g"),at=W.append("text").attr("class","pbifdcLegendTextSmall").style("cursor","default").attr("x",n.padding[3]).attr("y",function(f,T){return T?n.padding[0]+216+l.range()[1]*2+54:n.padding[0]+216}).text(function(f,T){return T?"Smallest node:":"Biggest node:"}),Bt=W.append("text").attr("class","pbifdcLegendTextSmall").style("cursor","default").attr("x",n.padding[3]).attr("y",function(f,T){return T?n.padding[0]+232+l.range()[1]*2+54:n.padding[0]+232}).text(function(f){return f.name+" ("+f.category+"): $"+ft(f.total)}).each(function(f){let T=parseInt(d3.style(this,"font-size"));for(;this.getComputedTextLength()>n.width-n.padding[3];)d3.select(this).style("font-size",--T)}),pt=d3.max(p,function(f){return f.total}),ut=[0,pt/4,pt/2,pt],tt=i.selectAll(null).data(ut).enter().append("g"),wt=tt.append("line").attr("x1",n.padding[3]+l.range()[1]).attr("x2",n.padding[3]+l.range()[1]+70).attr("y1",function(f){return f?n.padding[0]+250+l.range()[1]*2-l(f)*2:n.padding[0]+250+l.range()[1]*2}).attr("y2",function(f){return f?n.padding[0]+250+l.range()[1]*2-l(f)*2:n.padding[0]+250+l.range()[1]*2}).style("stroke","#ddd").style("stroke-dasharray","2,2").style("stroke-width","1px"),At=tt.append("circle").attr("cx",n.padding[3]+l.range()[1]).attr("cy",function(f){return n.padding[0]+250+l.range()[1]*2-l(f)}).attr("r",function(f){return f?l(f):0}).style("fill","none").style("stroke","darkslategray"),t=tt.append("text").attr("class","pbifdcLegendTextSmall3").attr("x",n.padding[3]+l.range()[1]+74).attr("y",function(f,T){return o.showMap&&T===1?n.padding[0]+255+l.range()[1]*2-l(f)*2:T?n.padding[0]+253+l.range()[1]*2-l(f)*2:n.padding[0]+253+l.range()[1]*2}).text(function(f){if(f){let T=d3.formatPrefix(".0",f)(f),be=T[T.length-1];return T=T.slice(0,-1),T+(be==="k"?" Thousand":be==="M"?" Million":be==="G"?" Billion":"")}else return"0"}),L=i.append("text").attr("class","pbifdcLegendSubTitle").attr("x",n.padding[3]).attr("y",n.padding[0]+364+l.range()[1]*2).text("LINKS:"),y=L.append("tspan").attr("class","pbifdcLegendTextSmall2").text(" (hover for info)"),h=i.append("text").attr("class","pbifdcLegendTextSmall2").style("opacity",0).attr("x",n.padding[3]).attr("y",n.padding[0]+340+l.range()[1]*2).text("The width of each link represents the amount donated from a donor to a CBPF.").call(Vt,n.width-n.padding[1]-n.padding[3]),b=i.append("rect").attr("y",n.padding[0]+300+l.range()[1]*2).attr("width",n.width).attr("height",80).style("opacity",0),et=d3.extent(D,function(f){return f.total}).map(function(f){return D.find(function(T){return T.total===f})}).reverse(),R=i.selectAll(null).data(et).enter().append("g"),St=R.append("text").attr("class","pbifdcLegendTextSmall").style("cursor","default").attr("x",n.padding[3]).attr("y",function(f,T){return n.padding[0]+391+l.range()[1]*2+T*53}).text(function(f,T){return T?"Smallest individual donation:":"Biggest individual donation:"});R.append("text").attr("class","pbifdcLegendTextSmall").style("cursor","default").attr("x",n.padding[3]+50).attr("y",function(f,T){return n.padding[0]+407+l.range()[1]*2+T*53}).text(function(f){return f.source.name+" to "+f.target.name+","}).append("tspan").attr("x",n.padding[3]+50).attr("y",function(f,T){return n.padding[0]+423+l.range()[1]*2+T*53}).text(function(f){return"$"+ft(f.total)}).each(function(){let f=parseInt(d3.style(this.parentNode,"font-size"));for(;this.parentNode.getBoundingClientRect().width>n.width-n.padding[3]-n.padding[1]-50;)d3.select(this.parentNode).style("font-size",--f)});let se=R.append("line").attr("x1",n.padding[3]).attr("x2",n.padding[3]+40).attr("y1",function(f,T){return n.padding[0]+411+l.range()[1]*2+T*53}).attr("y2",function(f,T){return n.padding[0]+411+l.range()[1]*2+T*53}).style("stroke","#ccc").style("opacity",.5).attr("stroke-width",function(f){return ot(f.total)});F.on("mouseover",function(f){H=this,x.main.selectAll(".pbifdcNodeCircle, .pbifdcNodesLabelGroup").style("opacity",function(T){return T.category===f?1:0}),x.main.selectAll(".pbifdcLinks").style("opacity",0)}).on("mouseout",function(){gt||(H=null,xe())}),W.on("mouseover",function(f){H=this,x.main.selectAll(".pbifdcNodeCircle, .pbifdcNodesLabelGroup").style("opacity",function(T){return T.uniqueId===f.uniqueId?1:0}),x.main.selectAll(".pbifdcLinks").style("opacity",0)}).on("mouseout",function(){gt||(H=null,At.style("opacity",1),xe())}),R.on("mouseover",function(f){H=this,x.main.selectAll(".pbifdcNodeCircle, .pbifdcNodesLabelGroup").style("opacity",function(T){return T.uniqueId===f.source.uniqueId||T.uniqueId===f.target.uniqueId?1:0}),x.main.selectAll(".pbifdcLinks").style("opacity",function(T){return T.source.uniqueId===f.source.uniqueId&&T.target.uniqueId===f.target.uniqueId?1:0})}).on("mouseout",function(){gt||(H=null,xe())}),O.on("mouseover",function(){H=this,Y.transition().duration(N).attr("y",n.padding[0]+142),v.transition().duration(N).style("opacity",0),B.transition().duration(N).style("opacity",1)}).on("mouseout",function(){gt||(H=null,Y.interrupt().attr("y",n.padding[0]+192),v.interrupt().style("opacity",1),B.interrupt().style("opacity",0))}),b.on("mouseover",function(){H=this,L.transition().duration(N).attr("y",n.padding[0]+320+l.range()[1]*2),y.transition().duration(N).style("opacity",0),h.transition().duration(N).style("opacity",1)}).on("mouseout",function(){gt||(H=null,L.interrupt().attr("y",n.padding[0]+364+l.range()[1]*2),y.interrupt().style("opacity",1),h.interrupt().style("opacity",0))});function xe(){x.main.selectAll(".pbifdcNodeCircle, .pbifdcNodesLabelGroup").style("opacity",1),x.main.selectAll(".pbifdcLinks").style("opacity",function(f){return Et(f.total)})}}function V(p){let D=n.main.selectAll(".pbifdcNodeLegendGroup,.pbifdcLinkLegendGroup,.pbifdcLegendGroup");D.selectAll("*").interrupt(),D.remove();let a=n.main.append("g").attr("class","pbifdcNodeLegendGroup"),l=a.append("text").attr("class","pbifdcLegendSubTitle").attr("x",n.width/2).attr("text-anchor","middle").attr("y",n.padding[0]+16).text(p.category),ot=a.append("text").attr("class","pbifdcLegendTitle").attr("x",n.width/2).attr("text-anchor","middle").attr("y",n.padding[0]+36).text(p.name);if(p.category==="Donor"){let h=ot.node().getBBox(),b=a.append("image").attr("y",n.padding[0]+18).attr("x",h.x+h.width+4).attr("width",te).attr("height",te).attr("href",!p.isoCode||!c[p.isoCode.toLowerCase()]?Se:c[p.isoCode.toLowerCase()])}let i=a.append("text").attr("class","pbifdcLegendSubTitle").attr("x",n.padding[3]).attr("y",n.padding[0]+70).text("SUMMARY:"),I=a.append("text").attr("class","pbifdcLegendTextSmall").attr("x",n.padding[3]).attr("y",n.padding[0]+90).text("Total "+(p.category==="Donor"?"donated:":"received:")),K=a.append("text").attr("class","pbifdcLegendTextSmall").attr("x",n.padding[3]).attr("y",n.padding[0]+106).text("Paid amount:"),F=a.append("text").attr("class","pbifdcLegendTextSmall").attr("x",n.padding[3]).attr("y",n.padding[0]+122).text("Pledged amount:"),Y=a.append("text").attr("class","pbifdcLegendTextSmall").attr("x",n.width-n.padding[1]).attr("text-anchor","end").attr("y",n.padding[0]+90).text("$"+ft(p.total)),v=a.append("text").attr("class","pbifdcLegendTextSmall").attr("x",n.width-n.padding[1]).attr("text-anchor","end").attr("y",n.padding[0]+106).text("$"+ft(p.paid)),B=a.append("text").attr("class","pbifdcLegendTextSmall").attr("x",n.width-n.padding[1]).attr("text-anchor","end").attr("y",n.padding[0]+122).text("$"+ft(p.pledge)),O=a.append("text").attr("class","pbifdcLegendTextSmall").attr("x",n.padding[3]).attr("y",n.padding[0]+152).text(p.category==="Donor"?"Donated to: "+(p.connections.length===1?p.connections.length+" CBPF":p.connections.length+" CBPFs"):"Received from: "+(p.connections.length===1?p.connections.length+" donor":p.connections.length+" donors")),C=a.append("text").attr("class","pbifdcLegendSubTitle").attr("x",n.padding[3]).attr("y",n.padding[0]+190).text(p.category==="Donor"?"AMOUNT DONATED:":"AMOUNT RECEIVED:"),W=18,at=n.height-n.padding[2]-220;for(;W*p.connections.length>at;)W-=.2;p.connections.sort(function(h,b){return b.total-h.total}),$t.range([230,230+p.connections.length*W]).domain(p.connections.map(function(h){return h.name}));let Bt=a.append("g").attr("class","pbifdcYAxisLegendGroup").call(Oe),pt=0;Bt.selectAll("text").each(function(h){let b=this.getComputedTextLength();pt=b>pt?b:pt}),Ft.range([n.padding[3]+~~pt+Oe.tickPadding(),n.width-n.padding[1]-40]).domain([0,d3.max(p.connections,function(h){return h.total})]),Bt.attr("transform","translate("+Ft.range()[0]+",0)"),Ge.tickSizeInner(-($t.range()[1]-$t.range()[0]));let ut=a.append("g").attr("class","pbifdcXAxisLegendGroup").attr("transform","translate(0,230)").call(Ge);ut.selectAll(".tick").filter(function(h){return h===0}).remove(),ut.selectAll(".tick").call(tt);function tt(h){if(h.size()<2)return;let b=h.filter(function(Ue,se){return!se}).select("text"),et=h.filter(function(Ue,se){return se}).select("text"),R=6,St=0;for(;et.node().getBoundingClientRect().left<b.node().getBoundingClientRect().right+R;)b.attr("x",-++St),et.attr("x",St)}let wt=p.category==="Donor"?"allocationColorFill":"contributionColorFill",At=a.selectAll(null).data(p.connections).enter().append("g").attr("transform",function(h){return"translate(0,"+$t(h.name)+")"}),t=At.append("rect").attr("x",Ft(0)).attr("y",-(vt/2-vt/4)).attr("height",vt).attr("width",function(h){return Ft(h.total)-Ft(0)}).classed(wt,!0),L=At.append("circle").attr("cx",function(h){return Ft(h.total)}).attr("cy",vt/4).attr("r",Nt).classed(wt,!0),y=At.append("text").attr("class","pbifdcLegendLabel").attr("y",an).attr("x",function(h){return Ft(h.total)+on}).text(function(h){return Qt(h.total).replace("G","B")})}function bt(p){let D=n.main.selectAll(".pbifdcNodeLegendGroup,.pbifdcLinkLegendGroup,.pbifdcLegendGroup");D.selectAll("*").interrupt(),D.remove();let a=n.main.append("g").attr("class","pbifdcLinkLegendGroup"),l=a.append("text").attr("class","pbifdcLegendSubTitle").attr("x",n.width/2).attr("text-anchor","middle").attr("y",n.padding[0]+16).text("Donor"),i=a.append("text").attr("class","pbifdcLegendTitle").attr("x",n.width/2).attr("text-anchor","middle").attr("y",n.padding[0]+36).text(p.source.name).node().getBBox(),I=a.append("image").attr("y",n.padding[0]+18).attr("x",i.x+i.width+4).attr("width",te).attr("height",te).attr("href",!p.isoCode||!c[p.isoCode.toLowerCase()]?Se:c[p.isoCode.toLowerCase()]),K=a.append("text").attr("class","pbifdcLegendSubTitle").attr("x",n.width/2).attr("text-anchor","middle").attr("y",n.padding[0]+66).text("CBPF:"),F=a.append("text").attr("class","pbifdcLegendTitle").attr("x",n.width/2).attr("text-anchor","middle").attr("y",n.padding[0]+86).text(p.target.name),Y=a.append("text").attr("class","pbifdcLegendSubTitle").attr("x",n.padding[3]).attr("y",n.padding[0]+130).text("SUMMARY:"),v=a.append("text").attr("class","pbifdcLegendTextSmall").attr("x",n.padding[3]).attr("y",n.padding[0]+150).text("Total donated:"),B=a.append("text").attr("class","pbifdcLegendTextSmall").attr("x",n.padding[3]).attr("y",n.padding[0]+166).text("Paid amount:"),O=a.append("text").attr("class","pbifdcLegendTextSmall").attr("x",n.padding[3]).attr("y",n.padding[0]+182).text("Pledged amount:"),C=a.append("text").attr("class","pbifdcLegendTextSmall").attr("x",n.width-n.padding[1]).attr("text-anchor","end").attr("y",n.padding[0]+150).text("$"+ft(p.total)),W=a.append("text").attr("class","pbifdcLegendTextSmall").attr("x",n.width-n.padding[1]).attr("text-anchor","end").attr("y",n.padding[0]+166).text("$"+ft(p.paid)),at=a.append("text").attr("class","pbifdcLegendTextSmall").attr("x",n.width-n.padding[1]).attr("text-anchor","end").attr("y",n.padding[0]+182).text("$"+ft(p.pledge))}function _t(){let p=rt.main.append("g"),D=p.append("rect").attr("rx",2).attr("ry",2).attr("width",rt.widthCollapsed).attr("height",rt.heightCollapsed).style("fill","whitesmoke").style("stroke-width",1).style("opacity",.9).style("stroke","#aaa"),a=p.append("clipPath").attr("id","pbifdcGeoMenuClip").append("rect").attr("width",rt.widthCollapsed).attr("height",rt.heightCollapsed),l=p.append("text").attr("class","pbifdcGeoMenuTitle").attr("x",rt.titlePadding).attr("y",15).text("Select CBPFs by Region:"),ot=d3.keys(de),I=p.append("g").attr("clip-path","url(#pbifdcGeoMenuClip)").selectAll(null).data(ot).enter().append("g").attr("class","pbifdcGeoMenuGroups").attr("pointer-events","none").attr("transform",function(v,B){return"translate("+rt.padding[3]+","+(rt.padding[0]+22*B)+")"}),K=I.append("text").attr("class","pbifdcGeoMenuText").attr("x",0).text(function(v){return v});I.each(function(v){v!=="All"?d3.select(this).append("rect").attr("width",14).attr("height",14).attr("rx",2).attr("ry",2).attr("x",-19).attr("y",-12).style("fill","none").style("stroke","darkslategray"):d3.select(this).append("circle").attr("r",7).attr("cx",-12).attr("cy",-4).style("fill","none").style("stroke","darkslategray")});let F=I.filter(":not(:last-child)").append("polyline").style("stroke-width","2px").attr("points","-16,-5 -13,-2 -8,-9").style("fill","none").style("stroke","none"),Y=I.filter(":last-child").append("circle").attr("r",4).attr("cx",-12).attr("cy",-4).style("fill","none");o.selectedRegion==="All"?Y.style("fill","darkslategray"):F.filter(function(v){return o.selectedRegion.indexOf(v)>-1}).style("stroke","darkslategray"),p.on("mouseover",function(){H=this,D.transition().duration(N/2).attr("height",rt.heightTotal).attr("width",rt.widthTotal),a.transition().duration(N/2).attr("height",rt.heightTotal).attr("width",rt.widthTotal),l.transition().duration(N/2).attr("x",rt.padding[3]),I.attr("pointer-events","all")}).on("mouseleave",function(){gt||(H=null,D.interrupt().attr("height",rt.heightCollapsed).attr("width",rt.widthCollapsed),a.interrupt().attr("height",rt.heightCollapsed).attr("width",rt.widthCollapsed),l.interrupt().attr("x",rt.titlePadding),I.attr("pointer-events","none"))}),I.on("click",function(v){if(v==="All")o.selectedRegion="All",F.style("stroke","none"),Y.style("fill","darkslategray");else{if(o.selectedRegion==="All")o.selectedRegion=[v];else{let O=o.selectedRegion.indexOf(v);if(O===-1)o.selectedRegion.push(v);else if(o.selectedRegion.length===1){o.selectedRegion="All",F.style("stroke","none"),Y.style("fill","darkslategray"),e=oe(r[0]),S(e.nodes),$(e.nodes,e.links),z(e.nodes,e.links);return}else o.selectedRegion.splice(O,1)}Y.style("fill","none"),F.style("stroke",function(O){return o.selectedRegion.indexOf(O)>-1?"darkslategray":"none"})}let B=o.selectedRegion==="All"?"All":o.selectedRegion.map(function(O){return O}).join("|");J.has("regions")?J.set("regions",B):J.append("regions",B),e=oe(r[0]),S(e.nodes),$(e.nodes,e.links),z(e.nodes,e.links)})}function mt(p,D){if(D)o.selectedYear=[p];else{let l=o.selectedYear.indexOf(p);if(l>-1){if(o.selectedYear.length===1)return;o.selectedYear.splice(l,1)}else o.selectedYear.push(p)}let a=o.selectedYear.map(function(l){return l}).join("|");J.has("year")?J.set("year",a):J.append("year",a),d3.selectAll(".pbifdcbuttonsRects").style("fill",function(l){return o.selectedYear.indexOf(l)>-1?Pt:"#eaeaea"}),d3.selectAll(".pbifdcbuttonsText").style("fill",function(l){return o.selectedYear.indexOf(l)>-1?"white":"#444"}),je(),e=oe(r[0]),S(e.nodes),$(e.nodes,e.links),z(e.nodes,e.links)}function Rt(){H=this;let p=this.getBoundingClientRect().top-E.node().getBoundingClientRect().top+this.getBoundingClientRect().height;ht.style("display","block").html("<div style='margin:0px;display:flex;flex-wrap:wrap;width:256px;'><div style='display:flex;flex:0 54%;'>Total contributions:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorHTMLcolor'>$"+ft(Dt.total)+"</span></div><div style='display:flex;flex:0 54%;white-space:pre;'>Total paid <span style='color: #888;'>("+zt(Dt.paid/Dt.total)+")</span>:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorHTMLcolor'>$"+ft(Dt.paid)+"</span></div><div style='display:flex;flex:0 54%;white-space:pre;'>Total pledged <span style='color: #888;'>("+zt(Dt.pledge/Dt.total)+")</span>:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorHTMLcolor'>$"+ft(Dt.pledge)+"</span></div></div>"),ht.style("top",p+"px").style("left",P.moneyBagPadding+"px")}function re(){let p=this.getBoundingClientRect().top-E.node().getBoundingClientRect().top+this.getBoundingClientRect().height+rn;ht.style("display","block").html(null);let D=[];e.nodes.forEach(function(I){if(I.category==="CBPF"&&I.name.includes("RhPF")){let K=I.name.split("(RhPF")[0].trim(),F=m.find(function(v){return v.RFundName.includes(K)}),Y=D.find(function(v){return v.rfCode===F.RFundAbbrv});Y?Y.funds.push(I.name):D.push({rfCode:F.RFundAbbrv,rfName:F.RFundTitle,funds:[I.name]})}});let l=ht.append("div").style("max-width","300px").attr("id","pbifdcInnerTooltipDiv").selectAll(null).data(D).enter().append("div").attr("class","pbifdcFundsDiv");l.append("div").attr("class","pbifdcfundsDivTitle").html(function(I){return I.rfName}),l.append("div").html(function(I){return I.funds.length+(I.funds.length>1?" Country envelopes:":" Country envelope:")});let ot=l.append("ul").selectAll(null).data(function(I){return I.funds}).enter().append("li").attr("class","pbifdcFundsList").html(function(I){return I}),i=ht.node().getBoundingClientRect();ht.style("top",p+"px").style("left",P.width-i.width+"px")}function We(){gt||(H=null,ht.style("display","none"))}function In(p){ht.style("display","block").html(null),ht.append("div").style("max-width","200px").attr("id","pbifdcInnerTooltipDiv").html("Click for selecting a single year. Double-click or ALT + click for selecting multiple years.");let a=E.node().getBoundingClientRect(),l=this.getBoundingClientRect();tooltipSize=ht.node().getBoundingClientRect(),ht.style("left",l.left+l.width/2-a.left>a.width-tooltipSize.width/2-g[1]?a.width-tooltipSize.width-g[1]+"px":l.left+l.width/2-a.left<tooltipSize.width/2+w.padding[3]+g[0]?w.padding[3]+g[0]+"px":l.left+l.width/2-a.left-tooltipSize.width/2+"px").style("top",l.top+l.height/2-a.top<tooltipSize.height?l.top-a.top+l.height+2+"px":l.top-a.top-tooltipSize.height-4+"px"),d3.select(this).style("fill",Pt),d3.select(this.parentNode).selectAll("text").filter(function(ot){return ot===p}).style("fill","white")}function Gn(p){ht.style("display","none"),!(o.selectedYear.indexOf(p)>-1)&&(d3.select(this).style("fill","#eaeaea"),d3.selectAll(".pbifdcbuttonsText").filter(function(D){return D===p}).style("fill","#444"))}}function oe(r){let c;if(o.selectedRegion==="All")c=r.filter(function(e){return o.selectedYear.indexOf(+e.FiscalYear)>-1&&e.GMSDonorISO2Code!==""});else{let e=o.selectedRegion.reduce(function(s,A){return s.concat(de[A].map(function(d){return d.toLowerCase()}))},[]);c=r.filter(function(s){return o.selectedYear.indexOf(+s.FiscalYear)>-1&&e.indexOf(s.PooledFundISO2Code.toLowerCase())>-1&&s.GMSDonorISO2Code!==""})}c.forEach(function(e){e.GMSDonorName.indexOf("Macedonia")>-1&&(e.GMSDonorName="Macedonia")});let m={nodes:[],links:[]};return c.forEach(function(e){let s=m.nodes.find(function(S){return S.uniqueId==="donor"+e.GMSDonorISO2Code}),A=m.nodes.find(function(S){return S.uniqueId==="cbpf"+e.PooledFundISO2Code});if(!s)m.nodes.push({name:e.GMSDonorName,uniqueId:"donor"+e.GMSDonorISO2Code,isoCode:e.GMSDonorISO2Code,category:"Donor",labelText:e.GMSDonorName.split(" "),total:+e.PaidAmt+ +e.PledgeAmt,paid:+e.PaidAmt,pledge:+e.PledgeAmt,connections:[{uniqueId:"cbpf"+e.PooledFundISO2Code,name:e.PooledFundName,total:+e.PaidAmt+ +e.PledgeAmt,paid:+e.PaidAmt,pledge:+e.PledgeAmt}]});else{s.total+=+e.PaidAmt+ +e.PledgeAmt,s.paid+=+e.PaidAmt,s.pledge+=+e.PledgeAmt;let S=s.connections.find(function(nt){return nt.uniqueId==="cbpf"+e.PooledFundISO2Code});S?(S.total+=+e.PaidAmt+ +e.PledgeAmt,S.paid+=+e.PaidAmt,S.pledge+=+e.PledgeAmt):s.connections.push({uniqueId:"cbpf"+e.PooledFundISO2Code,name:e.PooledFundName,total:+e.PaidAmt+ +e.PledgeAmt,paid:+e.PaidAmt,pledge:+e.PledgeAmt})}if(!A)m.nodes.push({name:e.PooledFundName,uniqueId:"cbpf"+e.PooledFundISO2Code,isoCode:e.PooledFundISO2Code,category:"CBPF",labelText:e.PooledFundName.split(" "),total:+e.PaidAmt+ +e.PledgeAmt,paid:+e.PaidAmt,pledge:+e.PledgeAmt,connections:[{uniqueId:"donor"+e.GMSDonorISO2Code,name:e.GMSDonorName,total:+e.PaidAmt+ +e.PledgeAmt,paid:+e.PaidAmt,pledge:+e.PledgeAmt}]});else{A.total+=+e.PaidAmt+ +e.PledgeAmt,A.paid+=+e.PaidAmt,A.pledge+=+e.PledgeAmt;let S=A.connections.find(function(nt){return nt.uniqueId==="donor"+e.GMSDonorISO2Code});S?(S.total+=+e.PaidAmt+ +e.PledgeAmt,S.paid+=+e.PaidAmt,S.pledge+=+e.PledgeAmt):A.connections.push({uniqueId:"donor"+e.GMSDonorISO2Code,name:e.GMSDonorName,total:+e.PaidAmt+ +e.PledgeAmt,paid:+e.PaidAmt,pledge:+e.PledgeAmt})}let d=m.links.find(function(S){return S.source==="donor"+e.GMSDonorISO2Code&&S.target==="cbpf"+e.PooledFundISO2Code});d?(d.total+=+e.PaidAmt+ +e.PledgeAmt,d.paid+=+e.PaidAmt,d.pledge+=+e.PledgeAmt):m.links.push({source:"donor"+e.GMSDonorISO2Code,target:"cbpf"+e.PooledFundISO2Code,total:+e.PaidAmt+ +e.PledgeAmt,paid:+e.PaidAmt,pledge:+e.PledgeAmt})}),m}function Nn(r){let c=r.filter(function(d){return o.selectedYear.indexOf(+d.FiscalYear)>-1}).sort(function(d,S){return+S.FiscalYear-+d.FiscalYear||(d.GMSDonorName.toLowerCase()<S.GMSDonorName.toLowerCase()?-1:d.GMSDonorName.toLowerCase()>S.GMSDonorName.toLowerCase()?1:0)||(d.PooledFundName.toLowerCase()<S.PooledFundName.toLowerCase()?-1:d.PooledFundName.toLowerCase()>S.PooledFundName.toLowerCase()?1:0)}),m=JSON.parse(JSON.stringify(c));m.forEach(function(d){d.Year=+d.FiscalYear,d["Donor Name"]=d.GMSDonorName,d["CBPF Name"]=d.PooledFundName,d["Paid Amount"]=+d.PaidAmt,d["Pledged Amount"]=+d.PledgeAmt,d["Total Contributions"]=+d.PaidAmt+ +d.PledgeAmt,d["Local Curency"]=d.PaidAmtLocalCurrency,d["Exchange Rate"]=d.PaidAmtCurrencyExchangeRate,d["Paid Amount (Local Currency)"]=+d.PaidAmtLocal,d["Pledged Amount (Local Currency)"]=+d.PledgeAmtLocal,d["Total Contributions (Local Currency)"]=+d.PaidAmtLocal+ +d.PledgeAmtLocal,delete d.FiscalYear,delete d.GMSDonorName,delete d.PooledFundName,delete d.PaidAmt,delete d.PledgeAmt,delete d.PaidAmtLocal,delete d.PledgeAmtLocal,delete d.GMSDonorISO2Code,delete d.PooledFundISO2Code,delete d.PledgeAmtLocalCurrency,delete d.PledgeAmtCurrencyExchangeRate,delete d.PaidAmtLocalCurrency,delete d.PaidAmtCurrencyExchangeRate});let e=d3.keys(m[0]),s=function(d,S){return S===null?"":S},A=m.map(function(d){return e.map(function(S){return JSON.stringify(d[S],s)}).join(",")});return A.unshift(e.join(",")),A.join(`\r
`)}function Bn(){let r="\xA9 OCHA CBPF Section "+Ot;Cn&&(r+=" | For more information, please visit <a href='https://cbpf.data.unocha.org'>cbpf.data.unocha.org</a>"),kn.append("div").attr("class","d3chartFooterText").html(r)}function Ee(){kt.style("opacity",0).style("pointer-events","none");let r=E.append("div").attr("class","pbifdcOverDivHelp"),c=Ut.node().getBoundingClientRect(),m=kt.node().getBoundingClientRect(),e=c.height*(k/c.width),s=r.append("svg").attr("viewBox","0 0 "+k+" "+(Mt+e)),A=[{text:"CLOSE",width:90},{text:"GO TO HELP PORTAL",width:180}],d=s.selectAll(null).data(A).enter().append("g");d.append("rect").attr("rx",4).attr("ry",4).style("stroke","rgba(0, 0, 0, 0.3)").style("stroke-width","1px").style("fill",u).style("cursor","pointer").attr("y",6).attr("height",22).attr("width",function(V){return V.width}).attr("x",function(V,bt){return k-g[1]-V.width-(bt?A[0].width+8:0)}).on("click",function(V,bt){kt.style("opacity",1).style("pointer-events","all"),r.remove(),bt&&window.open(dn,"help_portal")}),d.append("text").attr("class","pbifdcAnnotationMainText").attr("text-anchor","middle").attr("x",function(V,bt){return k-g[1]-V.width/2-(bt?A[0].width+8:0)}).attr("y",22).text(function(V){return V.text}),[{x:10,y:72+e,width:640,height:30,xTooltip:180*(c.width/k),yTooltip:(e+112)*(c.width/k),text:"Use these buttons to select the year. Double click or press ALT when clicking to select multiple years. Click the arrows to reveal more years."},{x:668,y:72+e,width:80,height:30,xTooltip:550*(c.width/k),yTooltip:(e+112)*(c.width/k),text:"This checkbox repositions the nodes according to their geographic positions. You can zoom/pan the map."},{x:752,y:72+e,width:96,height:30,xTooltip:600*(c.width/k),yTooltip:(e+112)*(c.width/k),text:"This checkbox shows/hides the nodes labels, which is useful in the \u201Cmap\u201D view."},{x:28,y:106+e,width:148,height:22,xTooltip:10*(c.width/k),yTooltip:(e+136)*(c.width/k),text:"Use these checkboxes to filter the funds by region."},{x:28,y:134+e,width:640,height:546,xTooltip:676*(c.width/k),yTooltip:(e+280)*(c.width/k),text:"Hover over the nodes (the countries) and the links (the donations) present in this area to show additional information about the donor, the CBPF or the donation in the Legend area at the right-hand side. When hovering, the values for the donors and funds change accordingly."},{x:680,y:134+e,width:212,height:546,xTooltip:384*(c.width/k),yTooltip:(e+280)*(c.width/k),text:"The Legend area shows additional information regarding the selected year. When hovering over a node (a donor or a CBPF) or a link (the donations) this Legend area changes, displaying additional information regarding the selected element."}].forEach(function(V){s.append("rect").attr("rx",4).attr("ry",4).attr("x",V.x).attr("y",V.y).attr("width",V.width).attr("height",V.height).style("stroke",Pt).style("stroke-width","3px").style("fill","none").style("opacity",.5).attr("class","pbifdcHelpRectangle").attr("pointer-events","all").on("mouseover",function(){let bt=this;st(V.xTooltip,V.yTooltip,V.text,bt)}).on("mouseout",z)});let nt=s.append("rect").attr("x",k/2-180).attr("y",244).attr("width",360).attr("height",50).attr("pointer-events","none").style("fill","white").style("stroke","#888"),$=s.append("text").attr("class","pbifdcAnnotationExplanationText").attr("font-family","Roboto").attr("font-size","18px").style("fill","#222").attr("text-anchor","middle").attr("x",k/2).attr("y",264).attr("pointer-events","none").text("Hover over the elements surrounded by a blue rectangle to get additional information").call(Vt,350);function st(V,bt,_t,mt){$.style("opacity",0),nt.style("opacity",0),s.selectAll(".pbifdcHelpRectangle").style("opacity",.1),d3.select(mt).style("opacity",1);let Rt=E.node().getBoundingClientRect();ht.style("top",bt+"px").style("left",V+"px").style("display","block").html(_t)}function z(){ht.style("display","none"),$.style("opacity",1),nt.style("opacity",1),s.selectAll(".pbifdcHelpRectangle").style("opacity",.5)}}function Dn(r){r.split(",").map(function(m){return+m.trim()}).sort(function(m,e){return m-e}).forEach(function(m){m&&_.indexOf(m)>-1&&o.selectedYear.push(m)}),o.selectedYear.length||o.selectedYear.push(new Date().getFullYear())}function Ve(r){if(_.indexOf(r)>-1)return r;for(;_.indexOf(r)===-1;)r=r>=Ot?r-1:r+1;return r}function Wn(r){return r[0].toUpperCase()+r.substring(1)}function qe(r){let c=(~~Math.log10(r)+1)%3,m=c===1?2:c===2?1:0,e=d3.formatPrefix("."+m+"~",r)(r);if(parseInt(e)===1e3){let s=e[e.length-1],A={k:"M",M:"B"};return 1+(isNaN(s)?A[s]:"")}return e}function ae(r){let c=document.createElementNS("http://www.w3.org/2000/svg","g");c.setAttributeNS(null,"transform",r);let m=c.transform.baseVal.consolidate().matrix;return[m.e,m.f]}function je(){Tn.html(function(){return o.selectedYear.length===1?null:"*Selected years: "+o.selectedYear.sort(function(c,m){return c-m}).reduce(function(c,m,e){return c+(e>=o.selectedYear.length-2?e>o.selectedYear.length-2?m:m+" and ":m+", ")},"")})}function Vt(r,c){r.each(function(){let m=d3.select(this),e=m.text().split(/\s+/).reverse(),s,A=[],d=0,S=1.1,nt=m.attr("y"),$=m.attr("x"),st=0,z=m.text(null).append("tspan").attr("x",$).attr("y",nt).attr("dy",st+"em");for(;s=e.pop();)A.push(s),z.text(A.join(" ")),z.node().getComputedTextLength()>c&&(A.pop(),z.text(A.join(" ")),A=[s],z=m.append("tspan").attr("x",$).attr("y",nt).attr("dy",++d*S+st+"em").text(s))})}function ie(r,c){if(we){alert("This functionality is not supported by Internet Explorer");return}let e=d3.select("body").append("div").style("position","fixed").attr("id","pbifdcDownloadingDiv").style("left",window.innerWidth/2-100+"px").style("top",window.innerHeight/2-100+"px").append("svg").attr("class","pbifdcDownloadingDivSvg").attr("width",200).attr("height",100),s="Downloading "+r.toUpperCase();He(e,200,175,s);let A=X.node().getBoundingClientRect();X.attr("width",A.width).attr("height",A.height);let d=["font-size","font-family","font-weight","fill","stroke","stroke-dasharray","stroke-width","opacity","text-anchor","text-transform","shape-rendering","letter-spacing","white-space"],S=E.node();nt(X.node()),r==="png"?kt.style("opacity",0):Ut.style("opacity",0),Yt.style("display","none"),html2canvas(S).then(function($){X.attr("width",null).attr("height",null),r==="png"?kt.style("opacity",1):Ut.style("opacity",1),r==="png"?Fn($):Rn($),c&&H&&d3.select(H).dispatch("mouseout")});function nt($){if(!$.style)return;let st=getComputedStyle($);for(let z=0;z<d.length;z++)$.style[d[z]]=st[d[z]];for(let z=0;z<$.childNodes.length;z++)nt($.childNodes[z])}}function Fn(r){let m="ContributionsFlow_"+Ht(new Date)+".png";r.toBlob(function(e){let s=URL.createObjectURL(e),A=document.createElement("a");A.download!==void 0?(A.setAttribute("href",s),A.setAttribute("download",m),A.style="visibility:hidden",document.body.appendChild(A),A.click(),document.body.removeChild(A)):window.location.href=s}),ye(),d3.select("#pbifdcDownloadingDiv").remove()}function Rn(r){let c={top:10,bottom:16,left:20,right:30};d3.image("https://raw.githubusercontent.com/CBPFGMS/cbpfgms.github.io/master/img/assets/bilogo.png").then(function(m){let e,s=new jsPDF;_t();let A=s.splitTextToSize("CBPF receives broad support from United Nations Member States, the private sectors and individuals. Contributions from donors around the world are collected into single, unearmarked funds to support local humanitarian efforts.",210-c.left-c.right,{fontSize:12}),d=d3.timeFormat("%A, %d %B %Y")(new Date);s.setTextColor(60),s.setFont("helvetica"),s.setFontType("normal"),s.setFontSize(12),s.text(c.left,48,A),s.setTextColor(65,143,222),s.setFont("helvetica"),s.setFontType("bold"),s.setFontSize(16),s.text(Be,c.left,71),s.setFontSize(12);let S=o.selectedYear.sort(function(mt,Rt){return mt-Rt}).reduce(function(mt,Rt,re){return mt+(re>=o.selectedYear.length-2?re>o.selectedYear.length-2?Rt:Rt+" and ":Rt+", ")},""),nt=o.selectedYear.length>1?"Selected years: ":"Selected year: ",$=o.selectedRegion!=="All"&&o.selectedRegion.length===1?"Selected Region":"Selected Regions",st=o.selectedRegion==="All"?"All":o.selectedRegion.join(", ");s.fromHTML("<div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>Date: <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+d+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+nt+"<span style='color: rgb(65, 143, 222); font-weight: 700;'>"+S+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+$+": <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+st+"</span></div>",c.left,77,{width:210-c.left-c.right},function(mt){e=mt});let z=E.node().getBoundingClientRect(),V=210-c.left*2;s.addImage(r,"PNG",c.left,e.y+2,V,V*(z.height/z.width));let bt=new Date;s.save("ContributionsFlow_"+Ht(bt)+".pdf"),ye(),d3.select("#pbifdcDownloadingDiv").remove();function _t(){let mt="\xA9 OCHA CBPF Section "+Ot+" | For more information, please visit cbpf.data.unocha.org";s.setFillColor(65,143,222),s.rect(0,c.top,210,15,"F"),s.setFillColor(236,161,84),s.rect(0,c.top+15,210,2,"F"),s.setFillColor(255,255,255),s.rect(c.left,c.top-1,94,20,"F"),s.ellipse(c.left,c.top+9,5,9,"F"),s.ellipse(c.left+94,c.top+9,5,9,"F"),s.addImage(m,"PNG",c.left+2,c.top,90,18),s.setFillColor(236,161,84),s.rect(0,297-c.bottom,210,2,"F"),s.setTextColor(60),s.setFont("arial"),s.setFontType("normal"),s.setFontSize(10),s.text(mt,c.left,297-c.bottom+10)}})}function He(r,c,m,e){let s=r.append("g").attr("class","pbifdcd3chartwheelGroup").attr("transform","translate("+c/2+","+m/4+")"),A=s.append("text").attr("text-anchor","middle").style("font-family","Roboto").style("font-weight","bold").style("font-size","11px").attr("y",50).attr("class","contributionColorFill").text(e),d=d3.arc().outerRadius(25).innerRadius(20),S=s.append("path").datum({startAngle:0,endAngle:0}).classed("contributionColorFill",!0).attr("d",d);nt();function nt(){S.transition().duration(1e3).attrTween("d",function(st){let z=d3.interpolate(0,Math.PI*2);return function(V){return st.endAngle=z(V),d(st)}}).on("end",$)}function $(){S.transition().duration(1e3).attrTween("d",function(st){let z=d3.interpolate(0,Math.PI*2);return function(V){return st.startAngle=z(V),d(st)}}).on("end",function(st){st.startAngle=0,nt()})}}function ye(){let r=d3.select(".pbifdcd3chartwheelGroup");r.select("path").interrupt(),r.remove()}}function Ze(k,g,q,lt){var ct=function(u){return function(){return u}},Gt=ct(.1),Lt=!0,dt=ct(Math.min((q-k)/2,(lt-g)/2)),Z,jt,Mt,U,vt,Nt,xt,Tt,ft,zt;typeof k!="function"&&(k=ct(k==null?-100:+k)),typeof q!="function"&&(q=ct(q==null?100:+q)),typeof g!="function"&&(g=ct(g==null?-100:+g)),typeof lt!="function"&&(lt=ct(lt==null?100:+lt));function Qt(u,M,Ot,j,Ht){return(u-M)*Math.min(2,Math.abs(u-M)/u)*Ot*Ht}function it(u){for(var M=0,Ot=Z.length,j;M<Ot;++M)j=Z[M],j.x<U[M]+Tt[M]||j.x>vt[M]-Tt[M]||j.y<Nt[M]+Tt[M]||j.y>xt[M]-Tt[M]?(j.vx+=Qt(ft[M],j.x,jt[M],Tt[M],u),j.vy+=Qt(zt[M],j.y,Mt[M],Tt[M],u)):(j.vx=0,j.vy=0),Lt&&(j.x>=vt[M]&&(j.vx+=vt[M]-j.x),j.x<=U[M]&&(j.vx+=U[M]-j.x),j.y>=xt[M]&&(j.vy+=xt[M]-j.y),j.y<=Nt[M]&&(j.vy+=Nt[M]-j.y))}function Pt(){if(Z){var u,M=Z.length;for(jt=new Array(M),Mt=new Array(M),U=new Array(M),Nt=new Array(M),vt=new Array(M),xt=new Array(M),zt=new Array(M),ft=new Array(M),Tt=new Array(M),u=0;u<M;++u)jt[u]=isNaN(U[u]=+k(Z[u],u,Z))||isNaN(vt[u]=+q(Z[u],u,Z))?0:+Gt(Z[u],u,Z),Mt[u]=isNaN(Nt[u]=+g(Z[u],u,Z))||isNaN(xt[u]=+lt(Z[u],u,Z))?0:+Gt(Z[u],u,Z),ft[u]=U[u]+(vt[u]-U[u])/2,zt[u]=Nt[u]+(xt[u]-Nt[u])/2,Tt[u]=+dt(Z[u],u,Z)}}return it.initialize=function(u){Z=u,Pt()},it.x0=function(u){return arguments.length?(k=typeof u=="function"?u:ct(+u),Pt(),it):k},it.x1=function(u){return arguments.length?(q=typeof u=="function"?u:ct(+u),Pt(),it):q},it.y0=function(u){return arguments.length?(g=typeof u=="function"?u:ct(+u),Pt(),it):g},it.y1=function(u){return arguments.length?(lt=typeof u=="function"?u:ct(+u),Pt(),it):lt},it.strength=function(u){return arguments.length?(Gt=typeof u=="function"?u:ct(+u),Pt(),it):Gt},it.border=function(u){return arguments.length?(dt=typeof u=="function"?u:ct(+u),Pt(),it):dt},it.hardBoundary=function(u){return arguments.length?(Lt=u,it):Lt},it}})();})();
