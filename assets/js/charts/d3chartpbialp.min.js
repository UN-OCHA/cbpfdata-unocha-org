(()=>{(function(){let Ce=window.navigator.userAgent.indexOf("MSIE")>-1||window.navigator.userAgent.indexOf("Trident")>-1,qt=window.fetch,Jt=window.URLSearchParams,ln=window.matchMedia("(pointer: coarse)").matches&&!window.matchMedia("(any-pointer: fine)").matches,ae=window.location.hostname==="cbpf.data.unocha.org",Te=window.location.hostname+window.location.pathname==="cbpf.data.unocha.org/bookmark.html",we="https://use.fontawesome.com/releases/v5.6.3/css/all.css",rn=["https://cbpfgms.github.io/css/d3chartstyles.css","https://cbpfgms.github.io/css/d3chartstylespbialp.css",we],zt="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js",Oe="https://cbpfgms.github.io/libraries/html2canvas.min.js",ke="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js",Kt="https://cdn.jsdelivr.net/npm/@ungap/url-search-params@0.1.2/min.min.js",Be="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js",Se="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.4/fetch.min.js";if(rn.forEach(function(B){if(!on(B)){let H=document.createElement("link");H.setAttribute("rel","stylesheet"),H.setAttribute("type","text/css"),H.setAttribute("href",B),B===we&&(H.setAttribute("integrity","sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"),H.setAttribute("crossorigin","anonymous")),document.getElementsByTagName("head")[0].appendChild(H)}}),!le(zt))qt&&Jt?nt(zt,wt):qt&&!Jt?nt(Kt,function(){nt(zt,wt)}):nt(Be,function(){nt(Se,function(){nt(Kt,function(){nt(zt,wt)})})});else if(typeof d3<"u")qt&&Jt?wt():qt&&!Jt?nt(Kt,wt):nt(Be,function(){nt(Se,function(){nt(Kt,wt)})});else{let B,H=document.getElementsByTagName("script");for(let C=H.length;C--;)H[C].src==zt&&(B=H[C]);B.addEventListener("load",wt)}function nt(B,H){let C=document.getElementsByTagName("head")[0],dt=document.createElement("script");dt.type="text/javascript",dt.src=B,dt.onreadystatechange=H,dt.onload=H,C.appendChild(dt)}function on(B){let H=document.getElementsByTagName("link");for(let C=H.length;C--;)if(H[C].href==B)return!0;return!1}function le(B){let H=document.getElementsByTagName("script");for(let C=H.length;C--;)if(H[C].src==B)return!0;return!1}function wt(){Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(l){if(this==null)throw new TypeError('"this" is null or not defined');var i=Object(this),r=i.length>>>0;if(typeof l!="function")throw new TypeError("predicate must be a function");for(var s=arguments[1],c=0;c<r;){var d=i[c];if(l.call(s,d,c,i))return d;c++}},configurable:!0,writable:!0}),Math.log10=Math.log10||function(l){return Math.log(l)*Math.LOG10E},HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(l,i,r){var s=this.toDataURL(i,r).split(",")[1];setTimeout(function(){for(var c=atob(s),d=c.length,a=new Uint8Array(d),x=0;x<d;x++)a[x]=c.charCodeAt(x);l(new Blob([a],{type:i||"image/png"}))})}});let B=900,H=400,C=[4,10,28,10],dt=60,re=30,Vt=4,oe=8,sn=window.innerHeight,Gt=18,Ot=2,ie=4,Lt=.3,pn=.4,cn=20,dn=1.1,un=4,se=16,fn=8,Ne=4,gn=70,hn=156,Fe=8,Dt=400,Re=280,Ge=.55,yn=4,st=22,ca=10,bn=12,Le=12,ut="#E56A54",kt="#1F69B3",ft="sandybrown",pe=new Date,ce=pe.getFullYear(),xn=6e5,Zt="pbialp",mn="allocations",vn="https://cbpf.data.unocha.org/bookmark.html?",Pn="https://gms.unocha.org/content/allocations",de=d3.utcFormat("_%Y%m%d_%H%M%S_UTC"),Z=["International NGO","National NGO","Red Cross/Crescent Movement","UN Agency"],ue=Z.concat("total"),Qt={"international ngo":"International NGO","national ngo":"National NGO",others:"Red Cross/Crescent Movement","red cross/crescent movement":"Red Cross/Crescent Movement","un agency":"UN Agency",total:"total",all:"total"},De=d3.format("~s"),at=d3.format(",.0f"),Bt=d3.format(".0%"),Ut=d3.format(".3s"),It=d3.local(),gt=8,An="Allocations by Organization Type",Cn="https://cbpfapi.unocha.org/vo2/odata/AllocationBudgetTotalsByYearAndFund?poolfundAbbrv=&FundingType=3&$format=csv",Tn="https://cbpfapi.unocha.org/vo2/odata/AllocationTypes?PoolfundCodeAbbrv=&$format=csv",wn="https://cbpfgms.github.io/pfbi-data/mst/MstRhpf.json",On=["M83.277,10.493l-13.132,12.22H22.821L9.689,10.493c0,0,6.54-9.154,17.311-10.352c10.547-1.172,14.206,5.293,19.493,5.56 c5.273-0.267,8.945-6.731,19.479-5.56C76.754,1.339,83.277,10.493,83.277,10.493z","M48.297,69.165v9.226c1.399-0.228,2.545-0.768,3.418-1.646c0.885-0.879,1.321-1.908,1.321-3.08 c0-1.055-0.371-1.966-1.113-2.728C51.193,70.168,49.977,69.582,48.297,69.165z","M40.614,57.349c0,0.84,0.299,1.615,0.898,2.324c0.599,0.729,1.504,1.303,2.718,1.745v-8.177 c-1.104,0.306-1.979,0.846-2.633,1.602C40.939,55.61,40.614,56.431,40.614,57.349z","M73.693,30.584H19.276c0,0-26.133,20.567-17.542,58.477c0,0,2.855,10.938,15.996,10.938h57.54 c13.125,0,15.97-10.938,15.97-10.938C99.827,51.151,73.693,30.584,73.693,30.584z M56.832,80.019 c-2.045,1.953-4.89,3.151-8.535,3.594v4.421H44.23v-4.311c-3.232-0.318-5.853-1.334-7.875-3.047 c-2.018-1.699-3.307-4.102-3.864-7.207l7.314-0.651c0.3,1.25,0.856,2.338,1.677,3.256c0.823,0.911,1.741,1.575,2.747,1.979v-9.903 c-3.659-0.879-6.348-2.22-8.053-3.997c-1.716-1.804-2.565-3.958-2.565-6.523c0-2.578,0.96-4.753,2.897-6.511 c1.937-1.751,4.508-2.767,7.721-3.034v-2.344h4.066v2.344c2.969,0.306,5.338,1.159,7.09,2.565c1.758,1.406,2.877,3.3,3.372,5.658 l-7.097,0.774c-0.43-1.849-1.549-3.118-3.365-3.776v9.238c4.485,1.035,7.539,2.357,9.16,3.984c1.634,1.635,2.441,3.725,2.441,6.289 C59.898,75.656,58.876,78.072,56.832,80.019z"],E=1e3,Ht=500,Me=26,te={},Et={},xt={},ht={},fe=[],t={selectedYear:[],selectedPartner:null,selectedCbpfs:[],netFunding:null},lt=C[0]+C[2]+dt+re+H+2*Vt,j,da,St=!1,Ye,ee,Y=new URLSearchParams(location.search);Y.has("viz")||Y.append("viz",mn);let F=d3.select("#d3chartcontainerpbialp"),ze=F.node().getAttribute("data-responsive")==="true",kn=F.node().getAttribute("data-lazyload")==="true",Bn=F.node().getAttribute("data-showhelp")==="true",Ve=+F.node().getAttribute("data-minpercentage")||0,Sn=F.node().getAttribute("data-showlink")==="true",Ue=F.node().getAttribute("data-title")?F.node().getAttribute("data-title"):An,mt=Y.has("average")?Y.get("average")==="true":F.node().getAttribute("data-showaverage")==="true",Nn=Y.has("year")?Y.get("year").replace(/\|/g,","):F.node().getAttribute("data-year"),Fn=Y.has("fund")?Y.get("fund").replace(/\|/g,","):F.node().getAttribute("data-selectedcbpfs");t.selectedPartner=Y.has("partner")&&Object.keys(Qt).indexOf(Y.get("partner").toLowerCase())>-1?Qt[Y.get("partner").toLowerCase()]:Object.keys(Qt).indexOf(F.node().getAttribute("data-partner").toLowerCase())>-1?Qt[F.node().getAttribute("data-partner").toLowerCase()]:"total";let Rn=Y.has("netfunding")?+Y.get("netfunding"):F.node().getAttribute("data-netfunding")==="true"?2:1;t.netFunding=Rn,ze==="false"&&F.style("width",B+"px").style("height",lt+"px");let jt=F.append("div").attr("class","pbialpTopDiv"),Gn=jt.append("div").attr("class","pbialpTitleDiv"),pt=jt.append("div").attr("class","pbialpIconsDiv d3chartIconsDiv"),I=F.append("svg").attr("viewBox","0 0 "+B+" "+lt).style("background-color","white");Ce&&I.attr("height",lt);let Ln=F.append("div").attr("class","pbialpYearsDescriptionDiv"),Dn=F.append("div").attr("class","pbialpSelectionDescriptionDiv"),Mn=ae?null:F.append("div").attr("class","pbialpFooterDiv");tn(I,B,lt,"Loading visualisation...");let Mt=F.append("div").attr("id","pbialpSnapshotTooltip").attr("class","pbialpSnapshotContent").style("display","none").on("mouseleave",function(){St=!1,Mt.style("display","none"),U.style("display","none")});Mt.append("p").attr("id","pbialpSnapshotTooltipPdfText").html("Download PDF").on("click",function(){St=!1,ne("pdf",!0)}),Mt.append("p").attr("id","pbialpSnapshotTooltipPngText").html("Download Image (PNG)").on("click",function(){St=!1,ne("png",!0)});let Ie=!ln&&(window.safari||window.navigator.userAgent.indexOf("Edge")>-1);Ie&&Mt.append("p").attr("id","pbialpTooltipBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default");let U=F.append("div").attr("id","pbialptooltipdiv").style("display","none");F.on("contextmenu",function(){d3.event.preventDefault();let l=d3.mouse(this);St=!0,Mt.style("display","block").style("top",l[1]-4+"px").style("left",l[0]-4+"px")});let b={main:I.append("g").attr("class","pbialpTopPanel").attr("transform","translate("+C[3]+","+C[0]+")"),width:B-C[1]-C[3],height:dt,moneyBagPadding:50,leftPadding:[180,434,138],mainValueVerPadding:12,mainValueHorPadding:4},v={main:I.append("g").attr("class","pbialpButtonPanel").attr("transform","translate("+C[3]+","+(C[0]+b.height+Vt)+")"),width:B-C[1]-C[3],height:re,padding:[0,0,0,6],buttonWidth:50,buttonPadding:4,buttonVerticalPadding:4,arrowPadding:18,buttonPartnersInnerPadding:4},R={main:I.append("g").attr("class","pbialpLollipopPanel").attr("transform","translate("+C[3]+","+(C[0]+b.height+v.height+2*Vt)+")"),width:(B-C[1]-C[3]-oe)*Ge,padding:[46,38,4,0],labelPadding:6},k={main:I.append("g").attr("class","pbialpParallelPanel").attr("transform","translate("+(C[3]+R.width+oe)+","+(C[0]+b.height+v.height+2*Vt)+")"),width:(B-C[1]-C[3]-oe)*(1-Ge),height:H,padding:[46,40,44,0],labelPadding:6},He=I.append("defs").append("filter").attr("x",0).attr("y",0).attr("width",1).attr("height",1).attr("id","backgroundFilter");He.append("feFlood").attr("flood-color","white"),He.append("feComposite").attr("in","SourceGraphic").attr("operator","over");let ge=I.append("g").attr("class","pbialpBottomButtonsGroup"),Yn=R.main.append("clipPath").attr("id","pbialpLollipopPanelClip").append("rect").attr("width",R.width).attr("transform","translate(0,"+-R.padding[0]+")"),ct=d3.scaleLinear(),Q=d3.scalePoint().domain(Z).range([k.padding[3],k.width-k.padding[1]]).padding(.5),Wt=d3.scalePoint().padding(.5),J=d3.scaleLinear().range([k.height-k.padding[2],k.padding[0]]),Ee=d3.scaleOrdinal().domain(Z).range(["InternationalNGOPartnerColor","NationalNGOPartnerColor","OthersPartnerColor","UNAgencyPartnerColor"]),he=d3.scaleOrdinal().domain(Z).range(["Int. NGO","Nat. NGO","RC/CM","UN"]),je=d3.axisTop(ct).tickSizeOuter(0).ticks(5).tickFormat(function(l){return"$"+De(l).replace("G","B")}),zn=d3.axisBottom(Q).tickSizeOuter(0).tickSizeInner(-(H-k.padding[0]-k.padding[2])).tickPadding(cn),ye=d3.axisLeft(Wt).tickSizeInner(2).tickSizeOuter(0),We=d3.line().x(function(l){return Q(l.partner)}).y(function(l){return J(l.percentage)}),$e=d3.line().x(function(l){return Q(l.partner)}).y(J(0)),_e=R.main.append("g").attr("class","pbialpgroupXAxisLollipop").attr("clip-path","url(#pbialpLollipopPanelClip)").attr("transform","translate(0,"+R.padding[0]+")"),Xe=k.main.append("g").attr("class","pbialpgroupXAxisParallel").attr("transform","translate(0,"+(k.height-k.padding[2])+")"),Nt=R.main.append("g").attr("class","pbialpgroupYAxisLollipop"),Vn=d3.symbol().type(d3.symbolTriangle).size(se);le(Oe)||nt(Oe,null),le(ke)||nt(ke,null),ae&&!Te?Promise.all([window.cbpfbiDataObject.allocationsData,window.cbpfbiDataObject.launchedAllocationsData,window.cbpfbiDataObject.masterRegionalFunds]).then(l=>qe(l)):Promise.all([be(Zt+"data",Cn,"allocations data","csv"),be("launchedAllocationsData",Tn,"launched allocations data","csv"),be("masterRegionalFunds",wn,"master regional funds data","json")]).then(l=>qe(l));function be(l,i,r,s){if(localStorage.getItem(l)&&JSON.parse(localStorage.getItem(l)).timestamp>pe.getTime()-xn){let c=s==="csv"?d3.csvParse(JSON.parse(localStorage.getItem(l)).data,d3.autoType):JSON.parse(localStorage.getItem(l)).data;return console.info(Zt+" chart info: "+r+" from local storage"),Promise.resolve(c)}else{let c=s==="csv"?d3.csv:d3.json,d=s==="csv"?d3.autoType:null;return c(i,d).then(a=>{try{localStorage.setItem(l,JSON.stringify({data:s==="csv"?d3.csvFormat(a):a,timestamp:pe.getTime()}))}catch(x){console.info(Zt+" chart, "+x)}return console.info(Zt+" chart info: "+r+" from API"),a})}}function qe([l,i,r]){me(),j=l.map(function(c){return fe.indexOf(c.PooledFundName)===-1&&fe.push(c.PooledFundName),+c.AllocationYear}).filter(function(c,d,a){return a.indexOf(c)===d}).sort(),qn(Nn),Jn(Fn),kn?(d3.select(window).on("scroll.pbialp",s),d3.select("body").on("d3ChartsYear.pbialp",function(){t.selectedYear=[en(+d3.event.detail)]}),s()):Je(l,i,r);function s(){let c=F.node().getBoundingClientRect();c.bottom<0||c.top-sn>0||(d3.select(window).on("scroll.pbialp",null),Je(l,i,r))}}function Je(l,i,r){let s=xe(l,i),c=[];s.forEach(function(o){c.push(o.cbpf),t.selectedCbpfs.indexOf(o.cbpf)>-1&&(o.clicked=!0)}),t.selectedCbpfs=t.selectedCbpfs.filter(function(o){return c.indexOf(o)>-1}),d(),ae||ve(),a(),Ae(),En(),x(s),W(),q(s),K(s),$(),t.selectedCbpfs.length&&(R.main.selectAll(".pbialpCbpfGroup").each(function(o){d3.select(this).select("rect").style("fill",null).classed("contributionColorFill",!o.clicked).classed("contributionColorDarkerFill",o.clicked),d3.select(this).select("circle").style("fill",null).classed("contributionColorFill",!o.clicked).classed("contributionColorDarkerFill",o.clicked)}),vt(s)),Ze(),Bn&&yt();function d(){let o=Gn.append("p").attr("id","pbialpd3chartTitle").html(Ue),h=pt.append("button").attr("id","pbialpHelpButton");h.html("HELP  ").append("span").attr("class","fas fa-info");let p=pt.append("button").attr("id","pbialpDownloadButton");p.html(".CSV  ").append("span").attr("class","fas fa-download");let u=pt.append("div").attr("class","pbialpSnapshotDiv");u.append("button").attr("id","pbialpSnapshotButton").html("IMAGE ").append("span").attr("class","fas fa-camera");let w=u.append("div").attr("class","pbialpSnapshotContent"),m=w.append("p").attr("id","pbialpSnapshotPdfText").html("Download PDF").on("click",function(){ne("pdf",!1)}),M=w.append("p").attr("id","pbialpSnapshotPngText").html("Download Image (PNG)").on("click",function(){ne("png",!1)}),L=pt.append("button").datum({clicked:!1}).attr("id","pbialpPlayButton");if(L.html("PLAY  ").append("span").attr("class","fas fa-play"),L.on("click",function(T){T.clicked=!T.clicked,L.html(T.clicked?"PAUSE ":"PLAY  ").append("span").attr("class",T.clicked?"fas fa-pause":"fas fa-play"),T.clicked?(t.selectedYear.length=1,S(),Ye=d3.interval(S,3*E)):Ye.stop();function S(){let D=j.indexOf(t.selectedYear[0]);t.selectedYear[0]=j[(D+1)%j.length],d3.selectAll(".pbialpbuttonsRects").filter(function(e){return e===t.selectedYear[0]}).dispatch("click");let G=t.selectedYear[0]<j[5]?0:t.selectedYear[0]>j[j.length-4]?j.length-8:j.indexOf(t.selectedYear[0])-4,n=-(v.buttonWidth*G);n===0?(I.select(".pbialpLeftArrowGroup").select("text").style("fill","#ccc"),I.select(".pbialpLeftArrowGroup").attr("pointer-events","none")):(I.select(".pbialpLeftArrowGroup").select("text").style("fill","#666"),I.select(".pbialpLeftArrowGroup").attr("pointer-events","all")),Math.abs(n)>=(j.length-gt)*v.buttonWidth?(I.select(".pbialpRightArrowGroup").select("text").style("fill","#ccc"),I.select(".pbialpRightArrowGroup").attr("pointer-events","none")):(I.select(".pbialpRightArrowGroup").select("text").style("fill","#666"),I.select(".pbialpRightArrowGroup").attr("pointer-events","all")),I.select(".pbialpbuttonsGroup").transition().duration(E).attrTween("transform",function(){return d3.interpolateString(this.getAttribute("transform"),"translate("+n+",0)")})}}),!Te){let T=pt.append("button").attr("id","pbialpShareButton");T.html("SHARE  ").append("span").attr("class","fas fa-share");let S=F.append("div").attr("class","d3chartShareDiv").style("display","none");T.on("mouseover",function(){S.html("Click to copy").style("display","block");let D=this.getBoundingClientRect(),A=F.node().getBoundingClientRect(),G=S.node().getBoundingClientRect(),n=D.top-A.top-(G.height-D.height)/2,e=D.left-A.left-G.width-12;S.style("top",n+"px").style("left",e+"20px")}).on("mouseout",function(){S.style("display","none")}).on("click",function(){let D=vn+Y.toString();S.append("input").attr("type","text").attr("readonly",!0).attr("spellcheck","false").property("value",D).node().select(),document.execCommand("copy"),S.html("Copied!");let G=this.getBoundingClientRect(),n=F.node().getBoundingClientRect(),e=S.node().getBoundingClientRect(),y=G.left-n.left-e.width-12;S.style("left",y+"20px")})}if(Ie){let T=w.append("p").attr("id","pbialpBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default")}u.on("mouseover",function(){w.style("display","block")}).on("mouseout",function(){w.style("display","none")}),h.on("click",yt),p.on("click",function(){let T=Wn(l),D="AllocationsByOrgType_"+de(new Date)+".csv",A=new Blob([T],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(A,filename);else{let G=document.createElement("a");if(G.download!==void 0){let n=URL.createObjectURL(A);G.setAttribute("href",n),G.setAttribute("download",D),G.style="visibility:hidden",document.body.appendChild(G),G.click(),document.body.removeChild(G)}}})}function a(){let o=ge.append("g").attr("class","pbialpLegendGroup").attr("transform","translate("+C[3]+","+(lt-C[2]/1.5)+")").attr("pointer-events","none"),h=o.append("text").attr("class","pbialpLegendText").attr("y",5).text("Figures represent: ").append("tspan").style("font-weight","bold").style("fill","#666").text("Total Allocated ").append("tspan").style("font-weight","normal").text("(").append("tspan").style("font-weight","bold").style("fill",ut).text("Under Approval").append("tspan").style("font-weight","normal").style("fill","#666").text(") \u2014 ").append("tspan").style("font-weight","bold").style("fill",d3.color(ft).darker(.5)).text("% of Partner").append("tspan").style("font-weight","normal").style("fill","#666").text(". The arrow (").append("tspan").style("fill",ut).text("\u25B2").append("tspan").style("fill","#666").text(") indicates Under Approval."),p=o.append("text").attr("class","pbialpLegendText pbialpLegendTextNetFunding").style("opacity",t.netFunding===1?0:1).attr("y",16).style("fill",ut).text("*").append("tspan").style("fill","#666").text("National Partners includes funding to National NGOs, Government/Others and Private Contractors.")}function x(o){let h;t.selectedCbpfs.length?h=o.filter(function(O){return O.clicked}):h=o;let p=h.filter(function(O){return!O.cbpf.includes("RhPF")}).length,u=new Set;h.forEach(function(O){if(O.cbpf.toLowerCase().includes("rhpf")){let z=O.cbpf.split("(")[0].trim(),V=r.find(function(tt){return tt.RFundName.includes(z)});V&&u.add(V.RFundAbbrv)}});let f=Array.from(u).length;ue.forEach(function(O){te[O]=d3.sum(h,function(z){return z[O]})});let w=ht.launched,m=te[t.selectedPartner],M=t.selectedYear.some(O=>xt[O])?w:m;ue.forEach(function(O){Et[O]=d3.sum(h,function(z){return O==="total"?z.underApproval:z["underApproval-"+O]})});let L=Et[t.selectedPartner],T=b.main.selectAll(".pbialptopPanelMoneyBag").data([!0]).enter().append("g").attr("class","pbialptopPanelMoneyBag contributionColorFill").attr("transform","translate("+b.moneyBagPadding+",6) scale(0.5)").each(function(O,z,V){On.forEach(function(tt){d3.select(V[z]).append("path").attr("d",tt)})}),S=d3.select(".pbialptopPanelMainValue").size()!==0?d3.select(".pbialptopPanelMainValue").datum():0,D=d3.select(".pbialptopPanelAllocatedValue").size()!==0?d3.select(".pbialptopPanelAllocatedValue").datum():0,A=d3.select(".pbialptopPanelUnderApprovalValue").size()!==0?d3.select(".pbialptopPanelUnderApprovalValue").datum():0,G=d3.select(".pbialptopPanelCbpfsNumber").size()!==0?d3.select(".pbialptopPanelCbpfsNumber").datum():0,n=d3.select(".pbialptopPanelRhpfsNumber").size()!==0?d3.select(".pbialptopPanelRhpfsNumber").datum():0,e=b.main.selectAll(".pbialpmainValueGroup").data([!0]);e=e.enter().append("g").attr("class","pbialpmainValueGroup").merge(e);let y=e.selectAll(".pbialptopPanelMainValue").data([M]);y=y.enter().append("text").attr("class","pbialptopPanelMainValue contributionColorFill").attr("text-anchor","end").merge(y).attr("y",b.height-b.mainValueVerPadding).attr("x",b.moneyBagPadding+b.leftPadding[0]-b.mainValueHorPadding),y.transition().duration(E).tween("text",function(O){let z=this,V=d3.interpolate(S,O);return function(tt){let Tt=ot(V(tt));z.textContent="$"+(O<1e3?O:Tt.substring(0,Tt.length-1))}});let X=e.selectAll(".pbialptopPanelMainText").data([M]);X=X.enter().append("text").attr("class","pbialptopPanelMainText").attr("text-anchor","start").merge(X).attr("y",b.height-b.mainValueVerPadding*2.8).attr("x",b.moneyBagPadding+b.leftPadding[0]+b.mainValueHorPadding),X.text(function(O){let z=ot(O),V=z[z.length-1];return(V==="k"?"Thousand":V==="M"?"Million":V==="G"?"Billion":"")+(t.selectedYear.some(tt=>xt[tt])?" in Allocations":" Allocated")});let P=e.selectAll(".pbialptopPanelSubText").data([!0]);P=P.enter().append("text").attr("class","pbialptopPanelSubText").attr("text-anchor","start").merge(P).attr("y",b.height-b.mainValueVerPadding*1.3).attr("x",b.moneyBagPadding+b.leftPadding[0]+b.mainValueHorPadding),P.text(function(O){let z=t.selectedYear.length===1?t.selectedYear[0]:"years*";return(t.selectedYear.some(V=>xt[V])?"Launched in ":"in ")+z});let g=b.main.selectAll(".pbialpallocatedValueGroup").data([!0]);g=g.enter().append("g").attr("class","pbialpallocatedValueGroup").merge(g);let N=g.selectAll(".pbialptopPanelAllocatedValue").data([m]);N=N.enter().append("text").attr("class","pbialptopPanelAllocatedValue contributionColorFill").attr("text-anchor","end").attr("y",b.height-b.mainValueVerPadding*3.2).attr("x",b.moneyBagPadding+b.leftPadding[1]-b.mainValueHorPadding/2).merge(N),N.transition().duration(E).style("opacity",t.selectedYear.some(O=>xt[O])?1:0).tween("text",function(O){let z=this,V=d3.interpolate(A,O);return function(tt){let Tt=ot(V(tt));z.textContent="$"+(O<1e3?O:Tt.substring(0,Tt.length-1))}});let _=g.selectAll(".pbialptopPanelAllocatedText").data([m]);_=_.enter().append("text").attr("class","pbialptopPanelAllocatedText").attr("text-anchor","start").attr("y",b.height-b.mainValueVerPadding*3.2).attr("x",b.moneyBagPadding+b.leftPadding[1]+b.mainValueHorPadding/2).merge(_),_.style("opacity",t.selectedYear.some(O=>xt[O])?1:0).text(function(O){let z=ot(O),V=z[z.length-1];return(V==="k"?"Thousand":V==="M"?"Million":V==="G"?"Billion":"")+" Allocated"});let rt=b.main.selectAll(".pbialpunderApprovalValueGroup").data([!0]);rt=rt.enter().append("g").attr("class","pbialpunderApprovalValueGroup").merge(rt);let At=rt.selectAll(".pbialptopPanelUnderApprovalValue").data([L]);At=At.enter().append("text").attr("class","pbialptopPanelUnderApprovalValue contributionColorFill").attr("text-anchor","end").attr("y",b.height-b.mainValueVerPadding).attr("x",b.moneyBagPadding+b.leftPadding[1]-b.mainValueHorPadding/2).merge(At),At.transition().duration(E).tween("text",function(O){let z=this,V=d3.interpolate(A,O);return function(tt){let Tt=ot(V(tt));z.textContent="$"+(O<1e3?O:Tt.substring(0,Tt.length-1))}});let Ft=rt.selectAll(".pbialptopPanelUnderApprovalText").data([L]);Ft=Ft.enter().append("text").attr("class","pbialptopPanelUnderApprovalText").attr("text-anchor","start").attr("y",b.height-b.mainValueVerPadding).attr("x",b.moneyBagPadding+b.leftPadding[1]+b.mainValueHorPadding/2).merge(Ft),Ft.text(function(O){let z=ot(O),V=z[z.length-1];return(V==="k"?"Thousand":V==="M"?"Million":V==="G"?"Billion":"")+" Under Approval"});let Rt=e.selectAll(".pbialptopPanelCbpfsNumber").data(p?[p]:[]);Rt.exit().remove(),Rt=Rt.enter().append("text").attr("class","pbialptopPanelCbpfsNumber contributionColorFill").attr("text-anchor","end").merge(Rt).style("font-size",f?"22px":"48px").attr("y",b.height-b.mainValueVerPadding*(f?2.7:1)).attr("x",b.width-b.leftPadding[2]-b.mainValueHorPadding),Rt.transition().duration(E).tween("text",function(O){let z=this,V=d3.interpolate(G,O);return function(tt){z.textContent=~~V(tt)}});let Ct=e.selectAll(".pbialptopPanelCbpfsText").data(p?[p]:[]);Ct.exit().remove(),Ct=Ct.enter().append("text").attr("class","pbialptopPanelCbpfsText").attr("x",b.width-b.leftPadding[2]+b.mainValueHorPadding).attr("text-anchor","start").merge(Ct).style("font-size",f?"15px":"20px").attr("y",b.height-b.mainValueVerPadding*(f?2.85:1.9)).text(p>1?"CBPFs":"CBPF");let Xt=e.selectAll(".pbialptopPanelRhpfsNumber").data(f?[f]:[]);Xt.exit().remove(),Xt=Xt.enter().append("text").attr("class","pbialptopPanelRhpfsNumber contributionColorFill").attr("text-anchor","end").merge(Xt).style("font-size",p?"22px":"48px").attr("y",b.height-b.mainValueVerPadding*(p?.8:1)).attr("x",b.width-b.leftPadding[2]-b.mainValueHorPadding),Xt.transition().duration(E).tween("text",function(O){let z=this,V=d3.interpolate(n,O);return function(tt){z.textContent=~~V(tt)}});let Yt=e.selectAll(".pbialptopPanelRhpfsText").data(f?[f]:[]);Yt.exit().remove(),Yt=Yt.enter().append("text").attr("class","pbialptopPanelRhpfsText").attr("x",b.width-b.leftPadding[2]+b.mainValueHorPadding).attr("text-anchor","start").style("cursor","default").merge(Yt).style("font-size",p?"15px":"20px").attr("y",b.height-b.mainValueVerPadding*(p?1:1.9)).text(f>1?"Regional funds":"Regional fund"),Yt.append("tspan").attr("class","pbialpinfoIcon contributionColorFill").text(" \uF05A"),b.main.selectAll(".pbialptopPanelOverRectangle").data([!0]).enter().append("rect").attr("class","pbialptopPanelOverRectangle").attr("width",b.width-b.leftPadding[2]).attr("height",b.height).style("opacity",0).on("mouseover",it).on("mouseout",_t),Yt.on("mouseover",Pt).on("mouseout",_t)}function W(){let o=v.main.append("clipPath").attr("id","pbialpClipPathButtons").append("rect").attr("width",gt*v.buttonWidth).attr("height",v.height),p=v.main.append("g").attr("class","pbialpClipPathGroup").attr("transform","translate("+(v.padding[3]+v.arrowPadding)+",0)").attr("clip-path","url(#pbialpClipPathButtons)").append("g").attr("class","pbialpbuttonsGroup").attr("transform","translate(0,0)").style("cursor","pointer"),u=p.selectAll(null).data(j).enter().append("rect").attr("rx","2px").attr("ry","2px").attr("class","pbialpbuttonsRects").attr("width",v.buttonWidth-v.buttonPadding).attr("height",v.height-v.buttonVerticalPadding*2).attr("y",v.buttonVerticalPadding).attr("x",function(P,g){return g*v.buttonWidth+v.buttonPadding/2}).style("fill",function(P){return t.selectedYear.indexOf(P)>-1?kt:"#eaeaea"}),f=p.selectAll(null).data(j).enter().append("text").attr("text-anchor","middle").attr("class","pbialpbuttonsText").attr("y",v.height/1.6).attr("x",function(P,g){return g*v.buttonWidth+v.buttonWidth/2}).style("fill",function(P){return t.selectedYear.indexOf(P)>-1?"white":"#444"}).text(function(P){return P}),m=v.main.append("g").attr("class","pbialpbuttonsPartnersGroup").attr("transform","translate("+(v.padding[3]+3*v.arrowPadding+gt*v.buttonWidth)+",0)").style("cursor","pointer").selectAll(null).data(ue).enter().append("g").attr("class","pbialpButtonsPartnersContainer");m.append("text").attr("class","pbialpbuttonsPartnersText").attr("y",v.height/1.6).attr("x",v.buttonPartnersInnerPadding).style("fill",function(P){return P===t.selectedPartner?"white":"#444"}).text(function(P){return P==="Red Cross/Crescent Movement"?"Red Cross/Cres. Mov.":P==="International NGO"?"Int. NGO":P!=="total"?Kn(P):"All partners"}).filter(function(P){return P==="National NGO"}).text(t.netFunding===1?"National NGO":"Nat. Partners").append("tspan").style("fill",ut).text(t.netFunding===1?"":"*"),m.attr("transform",function(P,g){return g?"translate("+($t(d3.select(this.previousSibling).attr("transform"))[0]+this.previousSibling.firstChild.getComputedTextLength()+2*v.buttonPartnersInnerPadding+v.buttonPadding)+",0)":"translate(0,0)"});let L=m.insert("rect","text").attr("rx","2px").attr("ry","2px").attr("class","pbialpbuttonsPartnersRects").attr("width",function(){return this.nextSibling.getComputedTextLength()+2*v.buttonPartnersInnerPadding}).attr("height",v.height-v.buttonVerticalPadding*2).attr("y",v.buttonVerticalPadding).attr("x",0).style("fill",function(P){return P===t.selectedPartner?kt:"#eaeaea"}),T=v.main.append("g").attr("class","pbialpLeftArrowGroup").style("cursor","pointer").attr("transform","translate("+v.padding[3]+",0)"),S=T.append("rect").style("fill","white").attr("width",v.arrowPadding).attr("height",v.height),D=T.append("text").attr("class","pbialpleftArrowText").attr("x",0).attr("y",v.height-v.buttonVerticalPadding*2.1).style("fill","#666").text("\u25C4"),A=v.main.append("g").attr("class","pbialpRightArrowGroup").style("cursor","pointer").attr("transform","translate("+(v.padding[3]+v.arrowPadding+gt*v.buttonWidth)+",0)"),G=A.append("rect").style("fill","white").attr("width",v.arrowPadding).attr("height",v.height),n=A.append("text").attr("class","pbialprightArrowText").attr("x",-1).attr("y",v.height-v.buttonVerticalPadding*2.1).style("fill","#666").text("\u25BA");u.on("mouseover",ea).on("mouseout",na).on("click",function(P){let g=this;if(d3.event.altKey){et(P,!1);return}It.get(this)!=="clicked"?(It.set(this,"clicked"),setTimeout(function(){It.get(g)==="clicked"&&et(P,!0),It.set(g,null)},250)):(et(P,!1),It.set(this,null))}),d3.select("body").on("d3ChartsYear.pbialp",function(){et(en(+d3.event.detail),!0),X(),e()}),L.on("mouseover",aa).on("mouseout",la).on("click",bt),X(),y(),T.on("click",function(){T.attr("pointer-events","none");let P=$t(p.attr("transform"))[0];A.select("text").style("fill","#666"),A.attr("pointer-events","all"),p.transition().duration(E).attr("transform","translate("+Math.min(0,P+gt*v.buttonWidth)+",0)").on("end",e)}),A.on("click",function(){A.attr("pointer-events","none");let P=$t(p.attr("transform"))[0];T.select("text").style("fill","#666"),T.attr("pointer-events","all"),p.transition().duration(E).attr("transform","translate("+Math.max(-((j.length-gt)*v.buttonWidth),-(Math.abs(P)+gt*v.buttonWidth))+",0)").on("end",e)});function e(){let P=$t(p.attr("transform"))[0];P===0?(T.select("text").style("fill","#ccc"),T.attr("pointer-events","none")):(T.select("text").style("fill","#666"),T.attr("pointer-events","all")),Math.abs(P)>=(j.length-gt)*v.buttonWidth?(A.select("text").style("fill","#ccc"),A.attr("pointer-events","none")):(A.select("text").style("fill","#666"),A.attr("pointer-events","all"))}function y(){let P=$t(p.attr("transform"))[0];P===0&&(T.select("text").style("fill","#ccc"),T.attr("pointer-events","none")),Math.abs(P)>=(j.length-gt)*v.buttonWidth&&(A.select("text").style("fill","#ccc"),A.attr("pointer-events","none"))}function X(){let P=t.selectedYear[0]<j[5]?0:t.selectedYear[0]>j[j.length-4]?j.length-8:j.indexOf(t.selectedYear[0])-4;p.attr("transform","translate("+-(v.buttonWidth*P)+",0)")}}function q(o){o.sort(function(n,e){return e[t.selectedPartner]-n[t.selectedPartner]||(n.cbpf.toLowerCase()<e.cbpf.toLowerCase()?-1:n.cbpf.toLowerCase()>e.cbpf.toLowerCase()?1:0)}),Wt.domain(o.map(function(n){return n.cbpf}));let h=R.main.selectAll(".pbialpLollipopPanelTitle").data([!0]);h=h.enter().append("text").attr("class","pbialpLollipopPanelTitle").attr("y",R.padding[0]-Me).merge(h).text("Allocations by CBPFs").transition().duration(E).attr("x",R.padding[3]);let p=R.main.selectAll(".pbialpCbpfGroup").data(o,function(n){return n.cbpf}),u=p.exit().remove(),f=p.enter().append("g").attr("class","pbialpCbpfGroup").attr("transform",function(n){return"translate(0,"+Wt(n.cbpf)+")"}),w=f.append("rect").attr("class","pbialpCbpfStick").attr("x",R.padding[3]).attr("y",-(Ot/2-Ot/4)).attr("height",Ot).attr("width",0).classed("contributionColorFill",!0),m=f.append("circle").attr("class","pbialpCbpfLollipop").attr("cx",R.padding[3]).attr("cy",Ot/4).attr("r",ie).classed("contributionColorFill",!0),M=f.append("path").attr("class","pbialpCbpfStandardIndicator").attr("d",Vn).style("fill",ut).attr("transform","translate("+R.padding[3]+","+(Math.sqrt(4*se/Math.sqrt(3))/2+Ot)+")"),L=f.append("text").attr("class","pbialpCbpfLabel").attr("x",R.padding[3]+R.labelPadding).attr("y",un).text(Ut(0)),T=f.append("rect").attr("class","pbialpCbpfTooltipRectangle").attr("y",-Gt/2).attr("height",Gt).attr("width",R.width).style("fill","none").attr("pointer-events","all").style("cursor","pointer");p=f.merge(p),p.transition().duration(E).attr("transform",function(n){return"translate(0,"+Wt(n.cbpf)+")"}),p.select(".pbialpCbpfStick").transition().duration(E).attr("x",R.padding[3]).attr("width",function(n){return ct(n[t.selectedPartner])-R.padding[3]}),p.select(".pbialpCbpfLollipop").transition().duration(E).attr("cx",function(n){return ct(n[t.selectedPartner])}),p.select(".pbialpCbpfStandardIndicator").transition().duration(E).style("opacity",function(n){return(t.selectedPartner==="total"?n.underApproval:n["underApproval-"+t.selectedPartner])===0?0:1}).attr("transform",function(n){let e=t.selectedPartner==="total"?n.underApproval:n["underApproval-"+t.selectedPartner],y=ct(n[t.selectedPartner])-ct(e)<ie?ie-Ot/2:0;return"translate("+Math.min(ct(e),ct(n[t.selectedPartner]))+","+(Math.sqrt(4*se/Math.sqrt(3))/2+Ot+y)+")"}),p.select(".pbialpCbpfLabel").transition().duration(E).attr("x",function(n){return ct(n[t.selectedPartner])+R.labelPadding}).tween("text",function(n){let e=this,y=t.selectedPartner==="total"?n.underApproval:n["underApproval-"+t.selectedPartner],X,P,g;t.selectedPartner!=="total"&&(X=n.parallelData.find(_=>_.partner===t.selectedPartner),P=X.percentage,g=X.roundPercentage);let N=d3.interpolate(Zn(e.textContent)||0,n[t.selectedPartner]);return function(_){y===0?t.selectedPartner==="total"||t.selectedPartner!=="total"&&P===0?d3.select(e).text(Ut(N(_)).replace("G","B")):d3.select(e).text(N(1)?Ut(N(_)).replace("G","B"):0).append("tspan").text(" \u2014 ").append("tspan").attr("fill",d3.color(ft).darker(.5)).text(g?g+"%":"<1%"):t.selectedPartner==="total"||t.selectedPartner!=="total"&&P===0?d3.select(e).text(Ut(N(_)).replace("G","B")).append("tspan").attr("class","pbialpCbpfLabelPercentage").attr("dy","-0.5px").text(" (").append("tspan").style("fill",ut).text(d3.formatPrefix(".0",y)(y).replace("G","B")).append("tspan").style("fill","#aaa").text(")"):d3.select(e).text(N(1)?Ut(N(_)).replace("G","B"):0).append("tspan").attr("class","pbialpCbpfLabelPercentage").attr("dy","-0.5px").text(" (").append("tspan").style("fill",ut).text(d3.formatPrefix(".0",y)(y).replace("G","B")).append("tspan").style("fill","#aaa").text(")").append("tspan").attr("dy",null).style("font-size","11px").text(" \u2014 ").append("tspan").attr("fill",d3.color(ft).darker(.5)).text(g?g+"%":"<1%")}}),p.select(".pbialpCbpfTooltipRectangle").on("mouseover",D).on("mouseout",A).on("click",G),je.tickSizeInner(-(Gt*o.length)),Nt.transition().duration(E).attr("transform","translate("+R.padding[3]+",0)").call(ye),_e.transition().duration(E).call(je),_e.selectAll(".tick").filter(function(n){return n===0}).remove(),t.selectedCbpfs.length?(p.style("opacity",function(n){return t.selectedCbpfs.indexOf(n.cbpf)>-1?1:Lt}),Nt.selectAll(".tick").style("opacity",function(n){return t.selectedCbpfs.indexOf(n)>-1?1:Lt})):(p.style("opacity",1),Nt.selectAll(".tick").style("opacity",1));function D(n){ee=this,n.clicked||t.selectedCbpfs.push(n.cbpf),p.style("opacity",function(Ct){return t.selectedCbpfs.indexOf(Ct.cbpf)>-1?1:Lt}),Nt.selectAll(".tick").style("opacity",function(Ct){return t.selectedCbpfs.indexOf(Ct)>-1?1:Lt}),vt(s,n);let e=t.selectedPartner,y=t.selectedPartner==="total"?"standard":"standard-"+t.selectedPartner,X=t.selectedPartner==="total"?"reserve":"reserve-"+t.selectedPartner,P=t.selectedPartner==="total"?"underApproval":"underApproval-"+t.selectedPartner,g=t.selectedPartner==="total"?"Allocations by Partner Type and Modality:":"Allocations for this Partner Type ("+(t.selectedPartner==="National NGO"&&t.netFunding===2?"National Partners":he(t.selectedPartner))+") by Modality, in %:";n[e]?(U.style("display","block").html("<strong><span class='contributionColorDarkerHTMLcolor'>"+n.cbpf+"</span></strong> ("+(t.selectedPartner==="total"?"All Partners":t.selectedPartner==="National NGO"&&t.netFunding===2?"National Partners":t.selectedPartner)+")<br><div style='margin:0px 0px 6px 0px;display:flex;flex-wrap:wrap;width:"+Dt+"px;'><div style='display:flex;flex:0 54%;white-space:pre;'>Allocations:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'>$"+at(n[e])+"</div></div>Allocation Modalities:<div id=pbialpLollipopTooltipBar></div><div style='margin:0px;display:flex;flex-wrap:wrap;width:"+Dt+"px;'><div style='display:flex;flex:0 54%;white-space:pre;'>Standard <span style='color: #888;'>("+Bt(n[y]/n[e])+")</span>:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorDarkerHTMLcolor'>$"+at(n[y])+"</span></div><div style='display:flex;flex:0 54%;white-space:pre;'>Reserve <span style='color: #888;'>("+Bt(n[X]/n[e])+")</span>:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorHTMLcolor'>$"+at(n[X])+"</span></div><div style='display:flex;flex:0 54%;white-space:pre;'>Under Approval:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='pbialpUnderApprovalHTMLClass'>$"+at(n[P])+"</span></div></div><div style='margin-top:6px;'>"+g+"<div><div id=pbialpLollipopTooltipChart></div>"),nn(n,"pbialpLollipopTooltipBar",Dt,e,y,X),t.selectedPartner==="total"?ia(n.parallelData):sa(n.parallelData)):U.style("display","block").html("<strong><span class='contributionColorDarkerHTMLcolor'>"+n.cbpf+"</span></strong><br style='line-height:170%;'/>Partner: <strong>"+(t.selectedPartner==="total"?"All Partners":t.selectedPartner)+"</strong><br><div style='margin:0px 0px 6px 0px;display:flex;flex-wrap:wrap;width:"+Dt*.75+"px;'><div style='display:flex;flex:0 54%;white-space:pre;'>Allocations:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorDarkerHTMLcolor'>$"+at(n[e])+"</span></div><div style='display:flex;flex:0 54%;white-space:pre;'>Under Approval:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorDarkerHTMLcolor'>$"+at(n[P])+"</span></div></div>");let N=d3.mouse(R.main.node()),_=this.getBoundingClientRect(),rt=F.node().getBoundingClientRect(),At=U.node().getBoundingClientRect(),Ft=_.top-rt.top,Rt=_.left-rt.left+(_.width-At.width)/2;U.style("top",N[1]>k.height+C[3]-At.height+Gt?Ft-At.height-4+"px":Ft+Gt+4+"px").style("left",Rt+"px")}function A(n){if(St)return;if(ee=null,!n.clicked){let y=t.selectedCbpfs.indexOf(n.cbpf);y>-1&&t.selectedCbpfs.splice(y,1)}p.style("opacity",function(y){return t.selectedCbpfs.indexOf(y.cbpf)>-1?1:Lt}),Nt.selectAll(".tick").style("opacity",function(y){return t.selectedCbpfs.indexOf(y)>-1?1:Lt}),s.some(function(y){return y.clicked})||(p.style("opacity",1),Nt.selectAll(".tick").style("opacity",1)),k.main.select(".pbialpCbpfParallelGroupAverage").raise(),vt(s),U.style("display","none")}function G(n){if(n.clicked=!n.clicked,n.clicked)t.selectedCbpfs.indexOf(n.cbpf)===-1&&t.selectedCbpfs.push(n.cbpf);else{let y=t.selectedCbpfs.indexOf(n.cbpf);t.selectedCbpfs.splice(y,1)}let e=t.selectedCbpfs.map(function(y){return y}).join("|");Y.has("fund")?Y.set("fund",e):Y.append("fund",e),p.each(function(y){d3.select(this).select("rect").style("fill",null).classed("contributionColorFill",!y.clicked).classed("contributionColorDarkerFill",y.clicked),d3.select(this).select("circle").style("fill",null).classed("contributionColorFill",!y.clicked).classed("contributionColorDarkerFill",y.clicked)}),ht.launched=0,ht.underApproval=0,i.forEach(function(y){t.selectedYear.includes(y.AllocationYear)&&(!t.selectedCbpfs.length||t.selectedCbpfs.includes(y.PooledFundName))&&(ht.launched+=y.TotalUSDPlanned,ht.underApproval+=y.TotalUnderApprovalBudget)}),x(s),an(),vt(s,n)}}function K(o){let h=[],p=d3.sum(o,function(e){return e.total});Z.forEach(function(e){let y=d3.sum(o.map(function(X){return X.parallelData.find(function(P){return P.partner===e}).value}));h.push({total:y,partner:e,percentage:y/p||0,roundPercentage:Math.round((y/p||0)*100)})}),p&&Qe(h);let u=k.main.selectAll(".pbialpParallelPanelTitle").data([!0]);u=u.enter().append("text").attr("class","pbialpParallelPanelTitle").attr("y",k.padding[0]-Me).attr("x",k.padding[3]+(k.width-k.padding[3]-k.padding[1])/2).attr("text-anchor","middle").merge(u).text(t.netFunding===1?"Allocations by Partner Type":"Allocations by Partner Type (including sub-impl. partners)");let f=k.main.selectAll(".pbialpPercentNumbersGroups").data(Z).enter().append("g").attr("class","pbialpPercentNumbersGroups").attr("transform",function(e){return"translate("+Q(e)+",0)"});f.append("text").attr("class","pbialpPercentNumbersText").attr("y",k.padding[0]-fn).attr("x",2).attr("text-anchor","middle").text("100%"),f.append("text").attr("class","pbialpPercentNumbersText").attr("y",H-k.padding[2]+14).attr("x",4).attr("text-anchor","middle").text("0%");let w=k.main.selectAll(".pbialpCbpfParallelGroup").data(o,function(e){return e.cbpf}),m=w.exit().remove(),M=w.enter().append("g").attr("class","pbialpCbpfParallelGroup"),L=M.append("path").attr("class","pbialpUnselectedPath").datum(function(e){return e.parallelData}).style("stroke-width","1px").style("fill","none").attr("d",function(e){return $e(e)}),T=M.selectAll(null).data(function(e){return e.parallelData},function(e){return e.partner}).enter().append("circle").attr("class","pbialpUnselectedCircle").attr("r",Ne).attr("cx",function(e){return Q(e.partner)}).attr("cy",J(0));w=M.merge(w),w.select("path").datum(function(e){return e.parallelData}).transition().duration(E).attr("d",function(e){return We(e)}),w.selectAll("circle").data(function(e){return e.parallelData},function(e){return e.partner}).transition().duration(E).attr("cx",function(e){return Q(e.partner)}).attr("cy",function(e){return J(e.percentage)});let S=k.main.selectAll(".pbialpCbpfParallelGroupAverage").data([h]),D=S.enter().append("g").attr("class","pbialpCbpfParallelGroupAverage").attr("pointer-events","none").style("opacity",mt?1:0),A=D.append("path").attr("class","pbialpCbpfParallelLineAverage").datum(function(e){return e}).style("stroke","#6d8383").style("stroke-width","1px").style("stroke-dasharray","2,2").style("fill","none").attr("d",function(e){return $e(e)}),G=D.selectAll(null).data(function(e){return e},function(e){return e.partner}).enter().append("circle").attr("class","pbialpParallelCircleAverage").attr("r",Ne).attr("cx",function(e){return Q(e.partner)}).attr("cy",J(0)).style("fill","#6d8383"),n=D.selectAll(null).data(function(e){return e},function(e){return e.partner}).enter().append("text").attr("class","pbialpPercentagesText pbialpPercentagesAverage").attr("filter","url(#backgroundFilter)").attr("x",function(e){return Q(e.partner)}).attr("y",J(0)).attr("text-anchor","middle").text(function(e){return ot(e.total).replace("G","B")}).append("tspan").attr("x",function(e){return Q(e.partner)}).attr("dy","1.1em").text(function(e){return"("+e.roundPercentage+"%)"});S=D.merge(S),S.raise(),S.select("path").datum(function(e){return e}).transition().duration(E).attr("d",function(e){return We(e)}),S.selectAll(".pbialpParallelCircleAverage").data(function(e){return e},function(e){return e.partner}).transition().duration(E).attr("cx",function(e){return Q(e.partner)}).attr("cy",function(e){return J(e.percentage)}),S.selectAll("text").data(function(e){return e},function(e){return e.partner}).text(function(e){return ot(e.total).replace("G","B")}).append("tspan").attr("x",function(e){return Q(e.partner)}).attr("dy","1.1em").text(function(e){return"("+e.roundPercentage+"%)"}),S.selectAll("text").transition().duration(E).attr("x",function(e){return Q(e.partner)}).attr("y",function(e){return e.percentage>.95?J(e.percentage)+st/1.2:J(e.percentage)-st}),Xe.call(zn).selectAll(".tick text").call(Qn),t.netFunding!==1&&Xe.selectAll("tspan").filter(function(){return this.textContent==="Partners"}).append("tspan").style("fill",ut).text("*")}function $(){let o=ge.append("g").attr("class","pbialpNetFundingGroup").attr("transform","translate("+(B-C[1]-hn)+","+(lt-C[2]/2)+")").style("cursor","pointer").attr("pointer-events","all"),h=o.append("rect").attr("width",12).attr("height",12).attr("rx",2).attr("ry",2).attr("x",-6).attr("y",-5).attr("fill","white").attr("stroke","darkslategray"),p=o.append("polyline").style("stroke-width","2px").attr("points","-4,1 -1,4 4,-3").style("fill","none").style("stroke",t.netFunding===2?"darkslategray":"white"),u=o.append("text").attr("class","pbialpAverageTextControl").attr("x",10).text("Net Funding*").attr("y",5),f=ge.append("g").attr("class","pbialpShowAverageGroup").attr("transform","translate("+(B-C[1]-gn)+","+(lt-C[2]/2)+")").style("cursor","pointer").attr("pointer-events","all"),w=f.append("rect").attr("width",12).attr("height",12).attr("rx",2).attr("ry",2).attr("x",-6).attr("y",-5).attr("fill","white").attr("stroke","darkslategray"),m=f.append("polyline").style("stroke-width","2px").attr("points","-4,1 -1,4 4,-3").style("fill","none").style("stroke",mt?"darkslategray":"white"),M=f.append("text").attr("class","pbialpAverageTextControl").attr("x",10).text("Show Total").attr("y",5);o.on("click",function(){t.netFunding=3-t.netFunding,Y.has("netfunding")?Y.set("netfunding",t.netFunding):Y.append("netfunding",t.netFunding),p.style("stroke",t.netFunding===2?"darkslategray":"white"),I.selectAll(".pbialpbuttonsPartnersText").filter(function(L){return L==="National NGO"}).text(t.netFunding===1?"National NGO":"Nat. Partners").append("tspan").style("fill",ut).text(t.netFunding===1?"":"*"),I.select(".pbialpLegendTextNetFunding").style("opacity",t.netFunding===1?0:1),s=xe(l,i),s.forEach(function(L){t.selectedCbpfs.indexOf(L.cbpf)>-1&&(L.clicked=!0)}),Ae(),x(s),q(s),K(s),vt(s)}),f.on("click",function(){mt=!mt,Y.has("average")?Y.set("average",mt):Y.append("average",mt),m.style("stroke",mt?"darkslategray":"white"),k.main.select(".pbialpCbpfParallelGroupAverage").style("opacity",mt?1:0)})}function yt(){pt.style("opacity",0).style("pointer-events","none");let o=F.append("div").attr("class","pbialpOverDivHelp"),h=jt.node().getBoundingClientRect(),p=pt.node().getBoundingClientRect(),u=h.height*(B/h.width),f=o.append("svg").attr("viewBox","0 0 "+B+" "+(lt+u+2)),w=[{text:"CLOSE",width:90},{text:"GO TO HELP PORTAL",width:180}],m=f.selectAll(null).data(w).enter().append("g");m.append("rect").attr("rx",4).attr("ry",4).style("stroke","rgba(0, 0, 0, 0.3)").style("stroke-width","1px").style("fill",ft).style("cursor","pointer").attr("y",6).attr("height",22).attr("width",function(A){return A.width}).attr("x",function(A,G){return B-C[1]-A.width-(G?w[0].width+8:0)}).on("click",function(A,G){pt.style("opacity",1).style("pointer-events","all"),o.remove(),G&&window.open(Pn,"help_portal")}),m.append("text").attr("class","pbialpAnnotationMainText").attr("text-anchor","middle").attr("x",function(A,G){return B-C[1]-A.width/2-(G?w[0].width+8:0)}).attr("y",22).text(function(A){return A.text}),[{x:10,y:72+u,width:448,height:30,xTooltip:25*(h.width/B),yTooltip:(u+112)*(h.width/B),text:"Use these buttons to select the year. Double click or press ALT when clicking to select multiple years. Click the arrows to reveal more years."},{x:464,y:72+u,width:420,height:30,xTooltip:530*(h.width/B),yTooltip:(u+112)*(h.width/B),text:"Use these buttons to select the partner type."},{x:10,y:138+u,width:464,height:330,xTooltip:482*(h.width/B),yTooltip:(u+184)*(h.width/B),text:"Hover over the CBPFs to get the additional info and to highlight the corresponding line on the right-hand side (Allocations by Partner Type). Clicking a CBPF keeps it selected, allowing you to hover over the lines on the right-hand side for more info. You can click more than one CBPF."},{x:484,y:132+u,width:378,height:347,xTooltip:56*(h.width/B),yTooltip:(u+184)*(h.width/B),text:"This area shows the allocations by partner type for all CBPFs. Clicking a CBPF on the right-hand side keeps the respective line highlighted. Hover over the line to get additional info. The dotted line is the average for all CBPFs."},{x:722,y:512+u,width:80,height:18,xTooltip:580*(h.width/B),yTooltip:(u+472)*(h.width/B),text:"Click here to show sub-implementing partners."}].forEach(function(A){f.append("rect").attr("rx",4).attr("ry",4).attr("x",A.x).attr("y",A.y).attr("width",A.width).attr("height",A.height).style("stroke",kt).style("stroke-width","3px").style("fill","none").style("opacity",.5).attr("class","pbialpHelpRectangle").attr("pointer-events","all").on("mouseover",function(){let G=this;S(A.xTooltip,A.yTooltip,A.text,G)}).on("mouseout",D)});let L=f.append("rect").attr("x",B/2-180).attr("y",244).attr("width",360).attr("height",50).attr("pointer-events","none").style("fill","white").style("stroke","#888"),T=f.append("text").attr("class","pbialpAnnotationExplanationText").attr("font-family","Roboto").attr("font-size","18px").style("fill","#222").attr("text-anchor","middle").attr("x",B/2).attr("y",264).attr("pointer-events","none").text("Hover over the elements surrounded by a blue rectangle to get additional information").call(ta,350);function S(A,G,n,e){T.style("opacity",0),L.style("opacity",0),f.selectAll(".pbialpHelpRectangle").style("opacity",.1),d3.select(e).style("opacity",1);let y=F.node().getBoundingClientRect();U.style("top",G+"px").style("left",A+"px").style("display","block").html(n)}function D(){U.style("display","none"),T.style("opacity",1),L.style("opacity",1),f.selectAll(".pbialpHelpRectangle").style("opacity",.5)}}function ve(){let o="\xA9 OCHA CBPF Section "+ce;Sn&&(o+=" | For more information, please visit <a href='https://cbpf.data.unocha.org'>cbpf.data.unocha.org</a>"),Mn.append("div").attr("class","d3chartFooterText").html(o)}function vt(o,h){k.main.selectAll(".pbialpPercentagesAverage").style("opacity",t.selectedCbpfs.length===0&&h===void 0?1:0);let p=o.find(function(n){return n.cbpf===t.selectedCbpfs[t.selectedCbpfs.length-1]}),u=p?p.parallelData:[];u.length>0&&u.forEach(function(n){n.uniqueKey=n.partner+(p?p.cbpf:"")});let f=o.filter(function(n){return t.selectedCbpfs.indexOf(n.cbpf)>-1}),w=k.main.selectAll(".pbialpCbpfParallelGroup").filter(function(n){return t.selectedCbpfs.indexOf(n.cbpf)>-1}),m=k.main.selectAll(".pbialpCbpfParallelGroup").filter(function(n){return t.selectedCbpfs.indexOf(n.cbpf)===-1});w.select("path").style("stroke",null).attr("class","contributionColorStroke").style("stroke-width","2px"),w.selectAll("circle").style("fill",null).attr("class","contributionColorFill").on("mouseover",ra).on("mouseout",oa),w.raise(),m.select("path").attr("class","pbialpUnselectedPath").style("stroke-width","1px"),m.selectAll("circle").attr("class","pbialpUnselectedCircle").on("mouseover",null).on("mouseout",null);let M=k.main.selectAll(".pbialpLabelsGroup").data(f,function(n){return n.cbpf}),L=M.exit().remove(),T=M.enter().append("g").attr("class","pbialpLabelsGroup");T.attr("transform",function(n){let e=n.parallelData.find(function(y){return y.partner===Z[Z.length-1]});return n.yPos=J(e.percentage),"translate("+(Q(Z[Z.length-1])+Fe)+","+n.yPos+")"});let S=T.append("text").attr("class","pbialpLabelText").attr("y",4).text(function(n){return n.cbpf.length>Le?n.cbpf.substring(0,Le)+"...":n.cbpf});M=T.merge(M),M.transition().duration(E).attr("transform",function(n){let e=n.parallelData.find(function(y){return y.partner===Z[Z.length-1]});return n.yPos=J(e.percentage),"translate("+(Q(Z[Z.length-1])+Fe)+","+n.yPos+")"});let D=k.main.selectAll(".pbialpPercentagesTextHighlight").data(u,function(n){return n.uniqueKey}),A=D.exit().remove();D=D.enter().append("text").attr("class","pbialpPercentagesTextHighlight").attr("filter","url(#backgroundFilter)").attr("x",function(n){return Q(n.partner)}).attr("y",function(n){return n.percentage>.95?J(n.percentage)+st/1.2:J(n.percentage)-st}).attr("text-anchor","middle").merge(D),D.style("fill",function(n){if(t.selectedPartner.indexOf(n.partner)>-1)return d3.color(ft).darker(.5)}),D.text(function(n){return ot(n.value).replace("G","B")}).append("tspan").attr("x",function(n){return Q(n.partner)}).attr("dy","1.1em").text(function(n){return"("+n.roundPercentage+"%)"}),D.transition().duration(E).attr("y",function(n){return n.percentage>.95?J(n.percentage)+st/1.2:J(n.percentage)-st}),D.raise(),M.on("mouseover",function(n){w.style("opacity",function(y){return n.cbpf===y.cbpf?1:pn}),k.main.selectAll(".pbialpPercentagesTextHighlight").data(n.parallelData).text(function(y){return ot(y.value)}).attr("y",function(y){return y.percentage>.95?J(y.percentage)+st/1.2:J(y.percentage)-st}).append("tspan").attr("x",function(y){return Q(y.partner)}).attr("dy","1.1em").text(function(y){return"("+y.roundPercentage+"%)"})}).on("mouseout",function(){w.style("opacity",1),k.main.selectAll(".pbialpPercentagesTextHighlight").data(u).text(function(e){return ot(e.value)}).attr("y",function(e){return e.percentage>.95?J(e.percentage)+st/1.2:J(e.percentage)-st}).append("tspan").attr("x",function(e){return Q(e.partner)}).attr("dy","1.1em").text(function(e){return"("+e.roundPercentage+"%)"})})}function Pe(){let o=k.main.selectAll(".pbialpgroupXAxisParallel .tick").filter(function(m){return t.selectedPartner.indexOf(m)>-1}),h=k.main.selectAll(".pbialpgroupXAxisParallel .tick").filter(function(m){return t.selectedPartner.indexOf(m)===-1}),p=k.main.select(".pbialpCbpfParallelGroupAverage").selectAll("text").filter(function(m){return t.selectedPartner.indexOf(m.partner)>-1}),u=k.main.select(".pbialpCbpfParallelGroupAverage").selectAll("text").filter(function(m){return t.selectedPartner.indexOf(m.partner)===-1}),f=k.main.selectAll(".pbialpPercentagesTextHighlight").filter(function(m){return t.selectedPartner.indexOf(m.partner)>-1}),w=k.main.selectAll(".pbialpPercentagesTextHighlight").filter(function(m){return t.selectedPartner.indexOf(m.partner)===-1});o.select("line").style("stroke",ft),o.select("text").style("fill",d3.color(ft).darker(.5)),p.style("fill",d3.color(ft).darker(.5)),f.style("fill",ft),u.style("fill",null),h.select("line").style("stroke",null),h.select("text").style("fill",null),w.style("fill",null)}function et(o,h){if(h){if(t.selectedYear[0]===o)return;t.selectedYear=[o]}else{let f=t.selectedYear.indexOf(o);if(f>-1){if(t.selectedYear.length===1)return;t.selectedYear.splice(f,1)}else t.selectedYear.push(o)}let p=t.selectedYear.map(function(f){return f}).join("|");Y.has("year")?Y.set("year",p):Y.append("year",p),d3.selectAll(".pbialpbuttonsRects").style("fill",function(f){return t.selectedYear.indexOf(f)>-1?kt:"#eaeaea"}),d3.selectAll(".pbialpbuttonsText").style("fill",function(f){return t.selectedYear.indexOf(f)>-1?"white":"#444"}),Ze(),s=xe(l,i);let u=s.map(function(f){return f.cbpf});t.selectedCbpfs=t.selectedCbpfs.filter(function(f){return u.indexOf(f)>-1}),s.forEach(function(f){t.selectedCbpfs.indexOf(f.cbpf)>-1&&(f.clicked=!0)}),an(),Ae(),x(s),q(s),K(s),vt(s)}function bt(o){t.selectedPartner!==o&&(t.selectedPartner=o,d3.selectAll(".pbialpbuttonsPartnersRects").style("fill",function(h){return h===t.selectedPartner?kt:"#eaeaea"}),d3.selectAll(".pbialpbuttonsPartnersText").style("fill",function(h){return h===t.selectedPartner?"white":"#444"}),Y.has("partner")?Y.set("partner",o):Y.append("partner",o),x(s),Ke(s,t.selectedPartner),q(s),Pe())}function it(){let o=this.getBoundingClientRect().top-F.node().getBoundingClientRect().top+this.getBoundingClientRect().height;U.style("display","block").html("<div style='margin:0px;display:flex;flex-wrap:wrap;width:270px;'><div style='display:flex;flex:0 54%;'>Allocations:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorHTMLcolor'>$"+at(te.total)+"</span></div><div style='display:flex;flex:0 54%;white-space:pre;'>Under Approval <span style='color: #888;'>("+Bt(Et.total/(te.total+Et.total))+")</span>:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorHTMLcolor'>$"+at(Et.total)+"</span></div></div>"),U.style("top",o+"px").style("left",b.moneyBagPadding+"px")}function Pt(){let o=this.getBoundingClientRect().top-F.node().getBoundingClientRect().top+this.getBoundingClientRect().height+bn;U.style("display","block").html(null);let h=[];s.forEach(function(m){if(m.cbpf.toLowerCase().includes("rhpf")){let M=m.cbpf.split("(")[0].trim(),L=r.find(function(S){return S.RFundName.includes(M)}),T=h.find(function(S){return S.rfCode===L.RFundAbbrv});T?T.funds.push(m.cbpf):h.push({rfCode:L.RFundAbbrv,rfName:L.RFundTitle,funds:[m.cbpf]})}});let u=U.append("div").style("max-width","300px").attr("id","pbialpInnerTooltipDiv").selectAll(null).data(h).enter().append("div").attr("class","pbialpFundsDiv");u.append("div").attr("class","pbialpfundsDivTitle").html(function(m){return m.rfName}),u.append("div").html(function(m){return m.funds.length+(m.funds.length>1?" Country envelopes:":" Country envelope:")});let f=u.append("ul").style("margin-bottom","1em").selectAll(null).data(function(m){return m.funds}).enter().append("li").attr("class","pbialpFundsList").html(function(m){return m}),w=U.node().getBoundingClientRect();U.style("top",o+"px").style("left",b.width-w.width+"px")}function _t(){St||U.style("display","none")}function ea(o){U.style("display","block").html(null),U.append("div").style("max-width","200px").attr("id","pbialpInnerTooltipDiv").html("Click for selecting a single year. Double-click or ALT + click for selecting multiple years.");let p=F.node().getBoundingClientRect(),u=this.getBoundingClientRect();tooltipSize=U.node().getBoundingClientRect(),U.style("left",u.left+u.width/2-p.left>p.width-tooltipSize.width/2-C[1]?p.width-tooltipSize.width-C[1]+"px":u.left+u.width/2-p.left<tooltipSize.width/2+v.padding[3]+C[0]?v.padding[3]+C[0]+"px":u.left+u.width/2-p.left-tooltipSize.width/2+"px").style("top",u.top+u.height/2-p.top<tooltipSize.height?u.top-p.top+u.height+2+"px":u.top-p.top-tooltipSize.height-4+"px"),d3.select(this).style("fill",kt),d3.select(this.parentNode).selectAll("text").filter(function(f){return f===o}).style("fill","white")}function na(o){U.style("display","none"),!(t.selectedYear.indexOf(o)>-1)&&(d3.select(this).style("fill","#eaeaea"),d3.selectAll(".pbialpbuttonsText").filter(function(h){return h===o}).style("fill","#444"))}function aa(o){d3.select(this).style("fill",kt),d3.select(this.parentNode).select("text").style("fill","white")}function la(o){o!==t.selectedPartner&&(d3.select(this).style("fill","#eaeaea"),d3.select(this.parentNode).select("text").style("fill","#444"))}function ra(o){let h=d3.select(this.parentNode).datum().cbpf;o.value?(U.style("display","block").html("<strong><span class='contributionColorDarkerHTMLcolor'>"+h+"</span></strong><br style='line-height:170%;'/>Partner: <strong>"+(o.partner==="National NGO"&&t.netFunding===2?"National Partners":o.partner)+"</strong><br style='line-height:170%;'/><div>Allocations: $"+at(o.value)+"<br>("+~~(o.percentage*1e4)/100+"% of total)</div><br style='line-height:170%;'/>Allocation modalities for this partner:<div id=pbialpParallelTooltipBar></div><div style='margin:0px;display:flex;flex-wrap:wrap;width:"+Re+"px;'><div style='display:flex;flex:0 54%;white-space:pre;'>Standard <span style='color: #888;'>("+Bt(o.standard/o.value)+")</span>:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorDarkerHTMLcolor'>$"+at(o.standard)+"</span></div><div style='display:flex;flex:0 54%;white-space:pre;'>Reserve <span style='color: #888;'>("+Bt(o.reserve/o.value)+")</span>:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;'><span class='contributionColorHTMLcolor'>$"+at(o.reserve)+"</span></div><div style='display:flex;flex:0 54%;white-space:pre;margin-top:8px;'>Under Approval:</div><div style='display:flex;flex:0 46%;justify-content:flex-end;margin-top:8px;'>$"+at(o.underApproval)+"</div></div>"),nn(o,"pbialpParallelTooltipBar",Re,"value","standard","reserve")):U.style("display","block").html("<strong><span class='contributionColorDarkerHTMLcolor'>"+h+"</span></strong><br style='line-height:170%;'/>Partner: "+o.partner+"<br style='line-height:170%;'/>Allocations: $"+at(o.value));let p=d3.mouse(k.main.node()),u=this.getBoundingClientRect(),f=k.main.node().getBoundingClientRect(),w=F.node().getBoundingClientRect(),m=U.node().getBoundingClientRect(),M=u.top-w.top,L=f.left-w.left+(f.width-m.width)/2;U.style("top",p[1]>k.height+C[3]-m.height?M-m.height-8+"px":M+20+"px").style("left",L+"px")}function oa(){St||U.style("display","none")}function nn(o,h,p,u,f,w){let m=d3.select("#"+h);m.style("margin-bottom","4px").style("margin-top","4px").style("width",p+"px");let M=d3.scaleLinear().domain([0,o[u]]).range([0,p]);m.append("div").style("float","left").classed("contributionColorDarkerHTMLbc",!0).style("height","14px").style("width","0px").style("border-right",M(o[f])<1?"0px solid white":"1px solid white").transition().duration(Ht).style("width",M(o[f])+"px"),m.append("div").classed("contributionColorHTMLbc",!0).style("margin-left","0px").style("height","14px").style("width","0px").transition().duration(Ht).style("margin-left",M(o[f])+1+"px").style("width",M(o[w])+"px")}function ia(o){let h=Dt,p=100,u=[8,130,16,4],f=["standard","reserve","underApproval"],w=d3.select("#pbialpLollipopTooltipChart").append("svg").attr("width",h).attr("height",p),m=d3.scaleBand().range([u[3],h-u[1]]).domain(Z).paddingOuter(0).paddingInner(.2),M=d3.scaleBand().range([0,m.bandwidth()]).domain(f).paddingOuter(.1).paddingInner(.2),L=d3.scaleLinear().range([p-u[2],u[0]]).domain([0,d3.max(o,function(g){return d3.max(f,function(N){return g[N]})})]),T=d3.scaleOrdinal().domain(f).range(["contributionColorDarkerFill","contributionColorFill","pbialpUnderApprovalClass"]),S=d3.scaleOrdinal().domain(f).range(["Standard","Reserve","Under Approval"]),D=d3.axisRight(L).ticks(3,De).tickSizeInner(-(h-u[1]-u[3]));w.append("g").attr("class","pbialpTooltipGroupedBarYAxis").attr("transform","translate("+(h-u[1])+",0)").call(D).selectAll(".tick").filter(function(g){return g===0}).remove();let G=w.selectAll(null).data(o).enter().append("g").attr("transform",function(g){return"translate("+m(g.partner)+",0)"}),n=G.selectAll(null).data(function(g){return f.map(function(N){return{key:N,value:g[N]}})}).enter().append("rect").attr("x",function(g){return M(g.key)}).attr("width",M.bandwidth()).attr("class",function(g){return T(g.key)}).attr("y",L(0)).attr("height",0).transition().duration(Ht).attr("y",function(g){return L(g.value)}).attr("height",function(g){return p-u[2]-L(g.value)}),e=G.append("line").attr("y1",p-u[2]).attr("y2",p-u[2]).attr("x1",0).attr("x2",m.bandwidth()).style("stroke-width","1px").style("stroke","darkslategray"),y=w.selectAll(null).data(f).enter().append("g").attr("transform",function(g,N){return"translate("+(h-u[1]+40)+","+(15+N*20)+")"});y.append("rect").attr("width",10).attr("height",10).style("stroke","darkslategray").attr("class",function(g){return T(g)}),y.append("text").attr("y",9).attr("x",14).attr("class","pbialpTooltipLegend").text(function(g){return S(g)});let X=d3.axisBottom(m).tickPadding(0).tickFormat(function(g){return g==="National NGO"&&t.netFunding===2?"Nat. Partners":he(g)}),P=w.append("g").attr("class","pbialpTooltipGroupedBarXAxis").attr("transform","translate(0,"+(p-u[2])+")").call(X)}function sa(o){let h=Dt,p=100,u=[4,110,16,4],f=(p-u[0]-u[2])/2,w=d3.pie().sort(function(g,N){return g.partner===t.selectedPartner?-1:N.partner===t.selectedPartner?1:N.value-g.value}).value(function(g){return g.value}),m=d3.arc().outerRadius(f).innerRadius(f-20),M=d3.arc().outerRadius(f-4).innerRadius(f-16),L=["standard","reserve","underApproval"],T=[];L.forEach(function(g){T.push({modality:g,values:o.map(function(N){return{partner:N.partner,value:N[g]}}).filter(function(N){return N.value})})});let S=d3.select("#pbialpLollipopTooltipChart").append("svg").attr("width",h).attr("height",p),D=d3.scalePoint().range([u[3],h-u[1]]).domain(L).padding(.5),A=S.selectAll(null).data(T).enter().append("g").attr("transform",function(g){return"translate("+D(g.modality)+","+(u[0]+(p-u[2])/2)+")"}),n=A.selectAll(null).data(function(g){return w(g.values)}).enter().append("g").append("path").style("stroke","#f1f1f1").attr("class",function(g){return Ee(g.data.partner)}).transition().duration(Ht).attrTween("d",function(g){g.innerRadius=0;var N=d3.interpolate({startAngle:0,endAngle:0},g);return g.data.partner===t.selectedPartner?function(_){return m(N(_))}:function(_){return M(N(_))}}),e=A.append("text").attr("class","pbialpSlicePercent").attr("text-anchor","middle").attr("y",4).text(function(g){if(g.values.length){let N=d3.sum(g.values,function(rt){return rt.value}),_=g.values.find(function(rt){return rt.partner===t.selectedPartner});return Bt(_?_.value/N:0)}else return"No Value"}),y=S.selectAll(null).data(Z).enter().append("g").attr("transform",function(g,N){return"translate("+(h-u[1]+25)+","+(10+N*20)+")"});y.append("rect").attr("width",10).attr("height",10).style("stroke","darkslategray").attr("class",function(g){return Ee(g)}),y.append("text").attr("y",9).attr("x",14).attr("class","pbialpTooltipLegendDonut").text(function(g){let N=g===t.selectedPartner?" \u2190":"";return(g==="National NGO"&&t.netFunding===2?"Nat. Part.":he(g))+N});let X=d3.axisBottom(D).tickPadding(0),P=S.append("g").attr("class","pbialpTooltipDonutXAxis").attr("transform","translate(0,"+(p-u[2])+")").call(X)}function an(){Dn.html(function(){return t.selectedCbpfs.length===0?null:"Selected CBPFs: "+t.selectedCbpfs.sort(function(h,p){return h.toLowerCase()<p.toLowerCase()?-1:h.toLowerCase()>p.toLowerCase()?1:0}).reduce(function(h,p,u){return h+(u>=t.selectedCbpfs.length-2?u>t.selectedCbpfs.length-2?p:p+" and ":p+", ")},"")})}function Ae(){Un(s.length);let o=In(s);Hn(o),Ke(s,t.selectedPartner)}}function Un(l){R.height=l*Gt+R.padding[0]+R.padding[2],Yn.attr("height",R.height),lt=C[0]+C[2]+dt+re+Math.max(R.height,H)+2*Vt,ze===!1&&F.style("height",lt+"px"),I.transition().duration(Ht).attr("viewBox","0 0 "+B+" "+lt),I.select(".pbialpLegendGroup").attr("transform","translate("+C[3]+","+(lt-C[2]/1.5)+")")}function In(l){let i=l.map(function(s){return s.cbpf}).sort(function(s,c){return c.length-s.length}).slice(0,5),r=[];return i.forEach(function(s){let c=I.append("text").attr("class","pbialpgroupYAxisFake").style("opacity",0).text(s),d=Math.ceil(c.node().getComputedTextLength());r.push(d),c.remove()}),d3.max(r)}function Ke(l,i){let r=d3.max(l,function(s){return s[i]});ct.domain([0,Math.floor(r*dn)||1e3])}function Hn(l){let i=l+ye.tickPadding()+ye.tickSizeInner();R.padding[3]=i+yn,ct.range([R.padding[3],R.width-R.padding[1]]),Wt.range([R.padding[0],R.height-R.padding[2]])}function En(){Nt.attr("transform","translate("+R.padding[3]+",0)")}function $t(l){let i=document.createElementNS("http://www.w3.org/2000/svg","g");i.setAttributeNS(null,"transform",l);let r=i.transform.baseVal.consolidate().matrix;return[r.e,r.f]}function Ze(){Ln.html(function(){return t.selectedYear.length===1?null:"*Selected years: "+t.selectedYear.sort(function(i,r){return i-r}).reduce(function(i,r,s){return i+(s>=t.selectedYear.length-2?s>t.selectedYear.length-2?r:r+" and ":r+", ")},"")})}function jn(l,i,r){return r===0?{underApprovalPercent:0,underPlusApprovedPercent:0}:{underApprovalPercent:l/r*100,underPlusApprovedPercent:(l+i)/r*100}}function xe(l,i){ht.launched=0,ht.underApproval=0;for(let a in xt)delete xt[a];let r={};i.forEach(function(a){t.selectedYear.includes(a.AllocationYear)&&(!t.selectedCbpfs.length||t.selectedCbpfs.includes(a.PooledFundName))&&(r[a.AllocationYear]={underApproval:(r[a.AllocationYear]?r[a.AllocationYear].underApproval:0)+a.TotalUnderApprovalBudget,approved:(r[a.AllocationYear]?r[a.AllocationYear].approved:0)+a.TotalApprovedBudget,launched:(r[a.AllocationYear]?r[a.AllocationYear].launched:0)+a.TotalUSDPlanned},ht.launched+=a.TotalUSDPlanned,ht.underApproval+=a.TotalUnderApprovalBudget)});for(let a in r){let{underApprovalPercent:x,underPlusApprovedPercent:W}=jn(r[a].underApproval,r[a].approved,r[a].launched);xt[a]=x>Ve||W<Ve}let s=[],c=[];return l.filter(function(a){return t.selectedYear.indexOf(+a.AllocationYear)>-1&&+a.FundingType===t.netFunding}).forEach(function(a){if((a.OrganizationType==="Others"||a.OrganizationType==="Red Cross/Red Crescent Society")&&(a.OrganizationType="Red Cross/Crescent Movement"),a.OrganizationType==="National Partners"&&(a.OrganizationType="National NGO"),c.indexOf(a.PooledFundName)>-1){let x=s.find(function(W){return W.cbpf===a.PooledFundName});x.total+=+a.ApprovedBudget,x.standard+=+a.ApprovedStandardBudget,x.reserve+=+a.ApprovedReserveBudget,x.underApproval+=+a.PipelineBudget,x[a.OrganizationType]+=+a.ApprovedBudget,x["underApproval-"+a.OrganizationType]+=+a.PipelineBudget,x["reserve-"+a.OrganizationType]+=+a.ApprovedReserveBudget,x["standard-"+a.OrganizationType]+=+a.ApprovedStandardBudget}else{let x={clicked:!1,cbpf:a.PooledFundName,total:+a.ApprovedBudget,standard:+a.ApprovedStandardBudget,reserve:+a.ApprovedReserveBudget,underApproval:+a.PipelineBudget,"International NGO":0,"National NGO":0,"UN Agency":0,"Red Cross/Crescent Movement":0,"underApproval-International NGO":0,"underApproval-National NGO":0,"underApproval-UN Agency":0,"underApproval-Red Cross/Crescent Movement":0,"reserve-International NGO":0,"reserve-National NGO":0,"reserve-UN Agency":0,"reserve-Red Cross/Crescent Movement":0,"standard-International NGO":0,"standard-National NGO":0,"standard-UN Agency":0,"standard-Red Cross/Crescent Movement":0};x[a.OrganizationType]+=+a.ApprovedBudget,x["underApproval-"+a.OrganizationType]+=+a.PipelineBudget,x["reserve-"+a.OrganizationType]+=+a.ApprovedReserveBudget,x["standard-"+a.OrganizationType]+=+a.ApprovedStandardBudget,s.push(x),c.push(a.PooledFundName)}}),s.forEach(function(a){a.parallelData=[],Z.forEach(function(x){let W=a.total!==0?a[x]/a.total:0;a.parallelData.push({partner:x,value:a[x],percentage:W,roundPercentage:Math.round(W*100),total:a.total,standard:a["standard-"+x],reserve:a["reserve-"+x],underApproval:a["underApproval-"+x]})}),Qe(a.parallelData)}),s}function Wn(l){let i=$n(l);i.forEach(function(a){for(let x in a)x!=="CBPF Name"&&(a[x]=Math.round(a[x]*100)/100)}),i.sort(function(a,x){return x.Year-a.Year||(a["CBPF Name"].toLowerCase()<x["CBPF Name"].toLowerCase()?-1:a["CBPF Name"].toLowerCase()>x["CBPF Name"].toLowerCase()?1:0)});let r=Object.keys(i[0]),s=["Allocation (UN)","Allocation (Red Cross)","Allocation (NNGO)","Allocation (INGO)","Total Allocation","CBPF Name","Year"];r.sort(function(a,x){return s.indexOf(x)+1-(s.indexOf(a)+1)||(a<x?-1:a>x?1:0)});let c=function(a,x){return x===null?"":x},d=i.map(function(a){return r.map(function(x){return JSON.stringify(a[x],c)}).join(",")});return d.unshift(r.join(",")),d.join(`\r
`)}function $n(l){let i=d3.scaleOrdinal().domain(Z).range(["INGO","NNGO","Red Cross","UN"]),r=[],s=[],c;return t.selectedCbpfs.length?c=l.filter(function(d){return t.selectedYear.indexOf(+d.AllocationYear)>-1&&+d.FundingType===t.netFunding&&t.selectedCbpfs.indexOf(d.PooledFundName)>-1}):c=l.filter(function(d){return t.selectedYear.indexOf(+d.AllocationYear)>-1&&+d.FundingType===t.netFunding}),c.forEach(function(d){if((d.OrganizationType==="Others"||d.OrganizationType==="Red Cross/Red Crescent Society")&&(d.OrganizationType="Red Cross/Crescent Movement"),d.OrganizationType==="National Partners"&&(d.OrganizationType="National NGO"),s.indexOf(d.AllocationYear+d.PooledFundName)>-1){let a=r.find(function(x){return x["CBPF Name"]===d.PooledFundName&&x.Year===d.AllocationYear});a["Total Allocation"]+=+d.ApprovedBudget,a["Total Standard Allocation"]+=+d.ApprovedStandardBudget,a["Total Reserve Allocation"]+=+d.ApprovedReserveBudget,a["Total Under Approval Allocation"]+=+d.PipelineBudget,a["Allocation ("+i(d.OrganizationType)+")"]+=+d.ApprovedBudget,a["Under Approval Allocation ("+i(d.OrganizationType)+")"]+=+d.PipelineBudget,a["Reserve Allocation ("+i(d.OrganizationType)+")"]+=+d.ApprovedReserveBudget,a["Standard Allocation ("+i(d.OrganizationType)+")"]+=+d.ApprovedStandardBudget}else{let a={Year:d.AllocationYear,"CBPF Name":d.PooledFundName,"Total Allocation":+d.ApprovedBudget,"Total Standard Allocation":+d.ApprovedStandardBudget,"Total Reserve Allocation":+d.ApprovedReserveBudget,"Total Under Approval Allocation":+d.PipelineBudget,"Allocation (INGO)":0,"Allocation (NNGO)":0,"Allocation (UN)":0,"Allocation (Red Cross)":0,"Under Approval Allocation (INGO)":0,"Under Approval Allocation (NNGO)":0,"Under Approval Allocation (UN)":0,"Under Approval Allocation (Red)":0,"Reserve Allocation (INGO)":0,"Reserve Allocation (NNGO)":0,"Reserve Allocation (UN)":0,"Reserve Allocation (Red Cross)":0,"Standard Allocation (INGO)":0,"Standard Allocation (NNGO)":0,"Standard Allocation (UN)":0,"Standard Allocation (Red Cross)":0};a["Allocation ("+i(d.OrganizationType)+")"]+=+d.ApprovedBudget,a["Under Approval Allocation ("+i(d.OrganizationType)+")"]+=+d.PipelineBudget,a["Reserve Allocation ("+i(d.OrganizationType)+")"]+=+d.ApprovedReserveBudget,a["Standard Allocation ("+i(d.OrganizationType)+")"]+=+d.ApprovedStandardBudget,r.push(a),s.push(d.AllocationYear+d.PooledFundName)}}),r}function Qe(l){let i=d3.sum(l,function(r){return r.roundPercentage});if(i)for(;i!==100;){if(i>100){let r=l.find(function(s){return s.partner==="International NGO"});r.roundPercentage-=1}if(i<100){let r=l.find(function(s){return s.partner==="National NGO"});r.roundPercentage+=1}i=d3.sum(l,function(r){return r.roundPercentage})}}function ne(l,i){if(Ce){alert("This functionality is not supported by Internet Explorer");return}let s=d3.select("body").append("div").style("position","fixed").attr("id","pbialpDownloadingDiv").style("left",window.innerWidth/2-100+"px").style("top",window.innerHeight/2-100+"px").append("svg").attr("class","pbialpDownloadingDivSvg").attr("width",200).attr("height",100),c="Downloading "+l.toUpperCase();tn(s,200,175,c);let d=I.node().getBoundingClientRect();I.attr("width",d.width).attr("height",d.height);let a=["font-size","font-family","font-weight","fill","stroke","stroke-dasharray","stroke-width","opacity","text-anchor","text-transform","shape-rendering","letter-spacing","white-space"],x=F.node();W(I.node()),U.style("display")==="block"&&W(U.select("svg").node()),l==="png"?pt.style("opacity",0):jt.style("opacity",0),Mt.style("display","none"),html2canvas(x).then(function(q){I.attr("width",null).attr("height",null),l==="png"?pt.style("opacity",1):jt.style("opacity",1),l==="png"?_n(q):Xn(q),i&&ee&&d3.select(ee).dispatch("mouseout")});function W(q){if(!q.style)return;let K=getComputedStyle(q);for(let $=0;$<a.length;$++)q.style[a[$]]=K[a[$]];for(let $=0;$<q.childNodes.length;$++)W(q.childNodes[$])}}function _n(l){let r="AllocationsByOrgType_"+de(new Date)+".png";l.toBlob(function(s){let c=URL.createObjectURL(s),d=document.createElement("a");d.download!==void 0?(d.setAttribute("href",c),d.setAttribute("download",r),d.style="visibility:hidden",document.body.appendChild(d),d.click(),document.body.removeChild(d)):window.location.href=c}),me(),d3.select("#pbialpDownloadingDiv").remove()}function Xn(l){let i={top:10,bottom:16,left:20,right:30};d3.image("https://raw.githubusercontent.com/CBPFGMS/cbpfgms.github.io/master/img/assets/bilogo.png").then(function(r){let s,c=new jsPDF;vt();let d=c.splitTextToSize("Funding from CBPFs is directly available to UN agencies, national and international non-governmental organizations (NGOs) and Red Cross/ Red Crescent organizations. In 2018, CBPFs allocated more than $836 million to 685 partners in 18 countries to support 1,453 critical humanitarian projects. These projects targeted millions of people with healthcare, food aid, clean water, shelter and other life-saving assistance.",210-i.left-i.right,{fontSize:12}),a=d3.timeFormat("%A, %d %B %Y")(new Date);c.setTextColor(60),c.setFont("helvetica"),c.setFontType("normal"),c.setFontSize(12),c.text(i.left,48,d),c.setTextColor(65,143,222),c.setFont("helvetica"),c.setFontType("bold"),c.setFontSize(16),c.text(Ue,i.left,82),c.setFontSize(12);let x=t.selectedYear.sort(function(et,bt){return et-bt}).reduce(function(et,bt,it){return et+(it>=t.selectedYear.length-2?it>t.selectedYear.length-2?bt:bt+" and ":bt+", ")},""),W=t.selectedYear.length>1?"Selected years: ":"Selected year: ",q=t.selectedPartner==="total"?"All Partners":t.selectedPartner,K=t.selectedCbpfs.length?Pe():"Selected CBPFs-all";c.fromHTML("<div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>Date: <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+a+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+W+"<span style='color: rgb(65, 143, 222); font-weight: 700;'>"+x+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>Partners: <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+q+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+K.split("-")[0]+": <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+K.split("-")[1]+"</span></div>",i.left,88,{width:210-i.left-i.right},function(et){s=et});let $=F.node().getBoundingClientRect(),yt=210-i.left*2;c.addImage(l,"PNG",i.left,s.y+2,yt,yt*($.height/$.width));let ve=new Date;c.save("AllocationsByOrgType_"+de(ve)+".pdf"),me(),d3.select("#pbialpDownloadingDiv").remove();function vt(){let et="\xA9 OCHA CBPF Section "+ce+" | For more information, please visit cbpf.data.unocha.org";c.setFillColor(65,143,222),c.rect(0,i.top,210,15,"F"),c.setFillColor(236,161,84),c.rect(0,i.top+15,210,2,"F"),c.setFillColor(255,255,255),c.rect(i.left,i.top-1,94,20,"F"),c.ellipse(i.left,i.top+9,5,9,"F"),c.ellipse(i.left+94,i.top+9,5,9,"F"),c.addImage(r,"PNG",i.left+2,i.top,90,18),c.setFillColor(236,161,84),c.rect(0,297-i.bottom,210,2,"F"),c.setTextColor(60),c.setFont("arial"),c.setFontType("normal"),c.setFontSize(10),c.text(et,i.left,297-i.bottom+10)}function Pe(){let et=t.selectedCbpfs.length===1?"":"s",bt=t.selectedCbpfs.map(function(it){return it}).sort(function(it,Pt){return it.toLowerCase()<Pt.toLowerCase()?-1:it.toLowerCase()>Pt.toLowerCase()?1:0}).reduce(function(it,Pt,_t){return it+(_t>=t.selectedCbpfs.length-2?_t>t.selectedCbpfs.length-2?Pt:Pt+" and ":Pt+", ")},"");return"Selected CBPF"+et+"-"+bt}})}function tn(l,i,r,s){let c=l.append("g").attr("class","pbialpd3chartwheelGroup").attr("transform","translate("+i/2+","+r/4+")"),d=c.append("text").attr("text-anchor","middle").style("font-family","Roboto").style("font-weight","bold").style("font-size","11px").attr("y",50).attr("class","contributionColorFill").text(s),a=d3.arc().outerRadius(25).innerRadius(20),x=c.append("path").datum({startAngle:0,endAngle:0}).classed("contributionColorFill",!0).attr("d",a);W();function W(){x.transition().duration(1e3).attrTween("d",function(K){let $=d3.interpolate(0,Math.PI*2);return function(yt){return K.endAngle=$(yt),a(K)}}).on("end",q)}function q(){x.transition().duration(1e3).attrTween("d",function(K){let $=d3.interpolate(0,Math.PI*2);return function(yt){return K.startAngle=$(yt),a(K)}}).on("end",function(K){K.startAngle=0,W()})}}function me(){let l=d3.select(".pbialpd3chartwheelGroup");l.select("path").interrupt(),l.remove()}function qn(l){l.split(",").map(function(r){return+r.trim()}).sort(function(r,s){return r-s}).forEach(function(r){r&&j.indexOf(r)>-1&&t.selectedYear.push(r)}),t.selectedYear.length||t.selectedYear.push(new Date().getFullYear())}function en(l){if(j.indexOf(l)>-1)return l;for(;j.indexOf(l)===-1;)l=l>=ce?l-1:l+1;return l}function Jn(l){if(!l||l==="none")return;l.split(",").map(function(r){return r.trim()}).forEach(function(r){fe.indexOf(r)>-1&&t.selectedCbpfs.push(r)})}function Kn(l){return l[0].toUpperCase()+l.substring(1)}function ot(l){let i=(~~Math.log10(l)+1)%3,r=i===1?2:i===2?1:0,s=d3.formatPrefix("."+r+"~",l)(l);if(parseInt(s)===1e3){let c=s[s.length-1],d={k:"M",M:"B"};return 1+(isNaN(c)?d[c]:"")}return s}function Zn(l){if(+l==0)return 0;let i,r={Y:Math.pow(10,24),Z:Math.pow(10,21),E:Math.pow(10,18),P:Math.pow(10,15),T:Math.pow(10,12),G:Math.pow(10,9),B:Math.pow(10,9),M:Math.pow(10,6),k:Math.pow(10,3),h:Math.pow(10,2),da:Math.pow(10,1),d:Math.pow(10,-1),c:Math.pow(10,-2),m:Math.pow(10,-3),\u03BC:Math.pow(10,-6),n:Math.pow(10,-9),p:Math.pow(10,-12),f:Math.pow(10,-15),a:Math.pow(10,-18),z:Math.pow(10,-21),y:Math.pow(10,-24)};return Object.keys(r).some(function(s){if(l.indexOf(s)>0)return i=parseFloat(l.split(s)[0])*r[s],!0}),i}function Qn(l,i){l.each(function(){let r=d3.select(this),s=r.text()==="Red Cross/Crescent Movement"?["Red Cross/","Crescent Movement"]:r.text()==="National NGO"&&t.netFunding===2?["National","Partners"]:r.text().split(" "),c=0,d=1.1,a=r.attr("y"),x=parseFloat(r.attr("dy")),W=r.text(null).append("tspan").attr("x",0).attr("y",a).attr("dy",x+"em");for(;word=s.shift();)W=r.append("tspan").attr("x",0).attr("y",a).attr("dy",c++*d+x+"em").text(word)})}function ta(l,i){l.each(function(){let r=d3.select(this),s=r.text().split(/\s+/).reverse(),c,d=[],a=0,x=1.1,W=r.attr("y"),q=r.attr("x"),K=0,$=r.text(null).append("tspan").attr("x",q).attr("y",W).attr("dy",K+"em");for(;c=s.pop();)d.push(c),$.text(d.join(" ")),$.node().getComputedTextLength()>i&&(d.pop(),$.text(d.join(" ")),d=[c],$=r.append("tspan").attr("x",q).attr("y",W).attr("dy",++a*x+K+"em").text(c))})}}})();})();
