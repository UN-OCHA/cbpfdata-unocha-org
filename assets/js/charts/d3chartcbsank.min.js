(()=>{(function(){let po=window.navigator.userAgent.indexOf("MSIE")>-1||window.navigator.userAgent.indexOf("Trident")>-1,qt=window.fetch,Jt=window.URLSearchParams,uo=window.matchMedia("(pointer: coarse)").matches&&!window.matchMedia("(any-pointer: fine)").matches,Se=window.location.hostname==="cbpf.data.unocha.org",Le=window.location.hostname+window.location.pathname==="cbpf.data.unocha.org/bookmark.html",Ye="https://use.fontawesome.com/releases/v5.6.3/css/all.css",rn=["https://cbpfgms.github.io/css/d3chartstyles.css","https://cbpfgms.github.io/css/d3chartstylescbsank.css",Ye],jt="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.min.js",Dt="https://cdnjs.cloudflare.com/ajax/libs/d3-sankey/0.12.3/d3-sankey.js",ho="https://cbpfgms.github.io/libraries/html2canvas.min.js",fo="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js",Qt="https://cdn.jsdelivr.net/npm/@ungap/url-search-params@0.1.2/min.min.js",Be="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js",Ne="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.4/fetch.min.js";if(rn.forEach(function(rt){if(!dn(rt)){let C=document.createElement("link");C.setAttribute("rel","stylesheet"),C.setAttribute("type","text/css"),C.setAttribute("href",rt),rt===Ye&&(C.setAttribute("integrity","sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/"),C.setAttribute("crossorigin","anonymous")),document.getElementsByTagName("head")[0].appendChild(C)}}),!cn(jt))qt&&Jt?Q(Dt,function(){Q(jt,Tt)}):qt&&!Jt?Q(Qt,function(){Q(Dt,function(){Q(jt,Tt)})}):Q(Be,function(){Q(Ne,function(){Q(Qt,function(){Q(Dt,function(){Q(jt,Tt)})})})});else if(typeof d3<"u")qt&&Jt?Q(Dt,Tt):qt&&!Jt?Q(Qt,function(){Q(Dt,Tt)}):Q(Be,function(){Q(Ne,function(){Q(Qt,function(){Q(Dt,Tt)})})});else{let rt,C=document.getElementsByTagName("script");for(let et=C.length;et--;)C[et].src==jt&&(rt=C[et]);Q(Dt,null),rt.addEventListener("load",Tt)}function Q(rt,C){let et=document.getElementsByTagName("head")[0],At=document.createElement("script");At.type="text/javascript",At.src=rt,At.onreadystatechange=C,At.onload=C,et.appendChild(At)}function dn(rt){let C=document.getElementsByTagName("link");for(let et=C.length;et--;)if(C[et].href==rt)return!0;return!1}function cn(rt){let C=document.getElementsByTagName("script");for(let et=C.length;et--;)if(C[et].src==rt)return!0;return!1}function Tt(){let C=[14,8,4,4],et=4,At=30,K=18,Oe=446,Ee=514,Xt=C[0]+C[2]+At+et+Oe+Ee,Me=.18,te="#1F69B3",ge="#65A8DC",zt="#FBD45C",pn="#F79A3B",o="cbsank",yo=60,ee=20,Ct=20,pt="others",me="tooltipothers",un="Others",Gt="fund",go=30,Re=3,Ve=50,xe=4,ne=10,hn=10,Pt=18,mo=4,oe=-45,se=45,ae=1,ie=1,fn=120,xo=33,St=5,$e=4,yn=270,je=300,ve=2018,gn="Member State",mn=window.matchMedia("(pointer: coarse)").matches&&!window.matchMedia("(any-pointer: fine)").matches,xn="https://cbpf.data.unocha.org/bookmark.html?",Lt="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",vn="https://gms.unocha.org/content/cbpf-year",vo=.2,ze=.6,vt=8,bn=14,Ge=16,yt=.3,V=.1,Yt=.02,An=(900-C[1]-C[3])*(1-2*Me),Cn=window.innerHeight,be=new Date,Ae=be.getFullYear(),Ht=d3.local(),In=36e5,k=1e3,bo=250,nt=24,He=14,kn=32,Bt=1,Nt=d3.format(",.0f"),Ao=d3.format("~s"),Co=d3.format(".3s"),Io=d3.timeParse("%m/%d/%Y %H:%M:%S %p"),Ue=["#F15B2C","#F26222","#F57F20","#F9A11B","#FEC010","#D5A429","#AA8C5C","#5E5FAA","#3D52A3","#0073BD","#71B4D3","#7AC1BA","#7FC88F","#8CCA7B","#A9D489","#ADD255","#C4C070","#D39A6D","#D16F5F","#ED1C24"],We="all",wn="Sankey diagram",Ke="sankey",Dn="https://cbpfgms.github.io/pfbi-data/contributionSummarySankey.csv",Tn="https://cbpfapi.unocha.org/vo2/odata/AllocationTypes?PoolfundCodeAbbrv=&$format=csv",Fn="https://cbpfgms.github.io/pfbi-data/mst/MstDonor.json",Pn="https://cbpfgms.github.io/pfbi-data/mst/MstCountry.json",Sn="https://cbpfgms.github.io/pfbi-data/mst/MstAllocation.json",Ln="https://cbpfgms.github.io/img/assets/flags24.json",le=d3.utcFormat("_%Y%m%d_%H%M%S_UTC"),j=[],Ot={},re=[],de=[],p={donorNames:{},donorIsoCodes:{},donorTypes:{},fundNames:{},fundRegions:{},fundAbbreviatedNames:{},fundIsoCodes:{},fundIsoCodes3:{},allocationTypes:{},allocationTypesReversed:{},fundsInAllYears:{},cbpfIds:{},fundsInAllYearsKeys:null,fundsInAllYearsValues:null},ko="##",c={selectedYear:[],selectedFund:[],fundsInData:[]},bt=!1,Ce,dt,st=new URLSearchParams(location.search);st.has("viz")||st.append("viz",Ke);let O=d3.select("#d3chartcontainer"+o),Yn=O.node().getAttribute("data-showhelp")==="true",_e=+O.node().getAttribute("data-minpercentage")||0,Bn=O.node().getAttribute("data-showlink")==="true",Ze=O.node().getAttribute("data-title")?O.node().getAttribute("data-title"):wn,Nn=O.node().getAttribute("data-responsive")==="true",On=O.node().getAttribute("data-lazyload")==="true",En=st.has("year")?st.get("year").replace(/\|/g,","):O.node().getAttribute("data-year"),Mn=st.has("fund")?st.get("fund").replace(/\|/g,","):O.node().getAttribute("data-fund");Nn===!1&&O.style("width","900px").style("height",Xt+"px");let Ut=O.append("div").attr("class",o+"TopDiv"),Rn=Ut.append("div").attr("class",o+"TitleDiv"),gt=Ut.append("div").attr("class",o+"IconsDiv d3chartIconsDiv"),Ie=O.append("div").attr("class",o+"SelectTitleDiv"),ce=O.append("div").attr("class",o+"SelectDiv"),_=O.append("svg").attr("viewBox","0 0 900 "+Xt).style("background-color","white"),Vn=O.append("div").attr("class",o+"YearsDescriptionDiv"),qe=O.append("div").attr("class",o+"FooterDiv");qe.append("div").attr("class","d3chartFooterText").style("text-align","left").style("padding-left","2%").html("*Only Paid Contributions."),ln(_,900,Xt,"Loading visualisation...");let Et=O.append("div").attr("id",o+"SnapshotTooltip").attr("class",o+"SnapshotContent").style("display","none").on("mouseleave",()=>{bt=!1,Et.style("display","none"),z.style("display","none")});Et.append("p").attr("id",o+"SnapshotTooltipPdfText").html("Download PDF").on("click",()=>{bt=!1,pe("pdf",!0)}),Et.append("p").attr("id",o+"SnapshotTooltipPngText").html("Download Image (PNG)").on("click",()=>{bt=!1,pe("png",!0)});let Je=!mn&&(window.safari||window.navigator.userAgent.indexOf("Edge")>-1);Je&&Et.append("p").attr("id",o+"TooltipBestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default");let z=O.append("div").attr("id",o+"tooltipdiv").style("display","none");O.on("contextmenu",function(){d3.event.preventDefault();let i=d3.mouse(this);bt=!0,Et.style("display","block").style("top",i[1]-4+"px").style("left",i[0]-4+"px")});let I={main:_.append("g").attr("class",o+"buttonsPanel").attr("transform","translate("+C[3]+","+C[0]+")"),width:900-C[1]-C[3],height:At,padding:[0,0,0,0],buttonWidth:54,buttonsMargin:4,buttonsPadding:6,buttonVerticalPadding:4,arrowPadding:18},$={main:_.append("g").attr("class",o+"mapPanel").attr("transform","translate("+C[3]+","+(C[0]+I.height+et)+")"),width:900-C[1]-C[3],height:Oe,padding:[116,8,0,0]},Z={main:_.append("g").attr("class",o+"mapPanel").attr("transform","translate("+C[3]+","+(C[0]+I.height+$.height+2*et)+")"),width:900-C[1]-C[3],height:Ee,padding:[0,8,44,0]},H={main:_.append("g").attr("class",o+"mapPanel").attr("transform","translate("+(C[3]+(900-C[1]-C[3])/2)+","+(C[0]+I.height+$.height+2*et)+")"),radius:(900-C[1]-C[3])*Me,selectedFundsPadding:40},Qe=_.append("defs").append("linearGradient").attr("id",o+"centralCircleGradient").attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%");Qe.append("stop").attr("offset","0%").attr("stop-color",ge),Qe.append("stop").attr("offset","100%").attr("stop-color",zt);let Xe=d3.sankey().nodeSort(null).linkSort((i,n)=>i.value-n.value).nodeWidth(Ge).nodePadding(null).nodeId(i=>i.id).extent([[$.padding[0],0],[$.height-$.padding[2],2*H.radius]]),tn=d3.sankey().nodeSort(null).linkSort((i,n)=>i.value-n.value).nodeWidth(Ge).nodePadding(null).nodeId(i=>i.id).extent([[Z.padding[0],0],[Z.height-Z.padding[2],2*H.radius]]),Wt=d3.scaleOrdinal(),B=d3.scaleLinear().domain([0,$.width-$.padding[1]-$.padding[3]]).range([$.width-$.padding[1]-$.padding[3],0]),M=d3.scaleLinear().domain([0,Z.width-Z.padding[1]-Z.padding[3]]).range([Z.width-Z.padding[1]-Z.padding[3],0]);Se&&!Le?Promise.all([window.cbpfbiDataObject.masterDonors,window.cbpfbiDataObject.masterFunds,window.cbpfbiDataObject.masterAllocationTypes,window.cbpfbiDataObject.launchedAllocationsData,window.cbpfbiDataObject.contributionsData,window.cbpfbiDataObject.flags]).then(i=>en(i)):Promise.all([Mt(o+"MasterDonors",Fn,"master table for donors","json"),Mt(o+"MasterFunds",Pn,"master table for funds","json"),Mt(o+"MasterAllocationTypes",Sn,"master table for allocation types","json"),Mt("launchedAllocationsData",Tn,"launched allocations data","csv"),Mt(o+"contributionsData",Dn,"contributions data","csv"),Mt(o+"flags",Ln,"flags images","json")]).then(i=>en(i));function en([i,n,l,a,e,r]){Pe(),Jn(i),Qn(n),Xn(n),to(l),Gn(a,e),c.selectedFund=no(Mn),eo(En),On?(d3.select(window).on("scroll."+o,f),d3.select("body").on("d3ChartsYear."+o,()=>c.selectedYear=[on(+d3.event.detail)]),f()):nn(a,e,r);function f(){let b=O.node().getBoundingClientRect();b.bottom<0||b.top-Cn>0||(d3.select(window).on("scroll."+o,null),nn(a,e,r))}}function nn(i,n,l){let a=Te(i),e=Fe(n);$n(i,n),jn(i,n,l),zn(i,n,l),ke(e,a),we(e,l),De(a),sn(),Se||io(),Yn&&an()}function $n(i,n){let l=Rn.append("p").attr("id",o+"d3chartTitle").html(Ze),a=gt.append("button").attr("id",o+"HelpButton");a.html("HELP  ").append("span").attr("class","fa fa-info");let e=gt.append("button").attr("id",o+"DownloadButton");e.html(".CSV  ").append("span").attr("class","fa fa-download");let r=gt.append("div").attr("class",o+"SnapshotDiv");r.append("button").attr("id",o+"SnapshotButton").html("IMAGE ").append("span").attr("class","fa fa-camera");let b=r.append("div").attr("class",o+"SnapshotContent"),g=b.append("p").attr("id",o+"SnapshotPdfText").html("Download PDF").on("click",function(){pe("pdf",!1)}),P=b.append("p").attr("id",o+"SnapshotPngText").html("Download Image (PNG)").on("click",function(){pe("png",!1)}),x=gt.append("button").datum({clicked:!1}).attr("id",o+"PlayButton");if(x.html("PLAY  ").append("span").attr("class","fa fa-play"),x.on("click",function(u){u.clicked=!u.clicked,x.html(u.clicked?"PAUSE ":"PLAY  ").append("span").attr("class",u.clicked?"fa fa-pause":"fa fa-play"),u.clicked?(c.selectedYear.length=1,E(),timer=d3.interval(E,3*k)):timer.stop();function E(){let G=j.indexOf(c.selectedYear[0]);if(c.selectedYear[0]=j[(G+1)%j.length],d3.selectAll("."+o+"buttonsRects").filter(function(U){return U===c.selectedYear[0]}).dispatch("click"),j.length>K){let U=c.selectedYear[0]<j[K/2]?0:c.selectedYear[0]>j[j.length-K/2]?j.length-K:j.indexOf(c.selectedYear[0])-K/2,A=-(I.buttonWidth*U);A===0?(_.select("."+o+"LeftArrowGroup").select("text").style("fill","#ccc"),_.select("."+o+"LeftArrowGroup").attr("pointer-events","none")):(_.select("."+o+"LeftArrowGroup").select("text").style("fill","#666"),_.select("."+o+"LeftArrowGroup").attr("pointer-events","all")),Math.abs(A)>=(j.length-K)*I.buttonWidth?(_.select("."+o+"RightArrowGroup").select("text").style("fill","#ccc"),_.select("."+o+"RightArrowGroup").attr("pointer-events","none")):(_.select("."+o+"RightArrowGroup").select("text").style("fill","#666"),_.select("."+o+"RightArrowGroup").attr("pointer-events","all")),_.select("."+o+"buttonsGroup").transition().duration(k).attrTween("transform",function(){return d3.interpolateString(this.getAttribute("transform"),"translate("+A+",0)")})}}}),!Le){let u=gt.append("button").attr("id",o+"ShareButton");u.html("SHARE  ").append("span").attr("class","fa fa-share");let E=O.append("div").attr("class","d3chartShareDiv").style("display","none");u.on("mouseover",function(){E.html("Click to copy").style("display","block");let G=this.getBoundingClientRect(),w=O.node().getBoundingClientRect(),U=E.node().getBoundingClientRect(),A=G.top-w.top-(U.height-G.height)/2,v=G.left-w.left-U.width-12;E.style("top",A+"px").style("left",v+"20px")}).on("mouseout",function(){E.style("display","none")}).on("click",function(){let G=xn+st.toString();E.append("input").attr("type","text").attr("readonly",!0).attr("spellcheck","false").property("value",G).node().select(),document.execCommand("copy"),E.html("Copied!");let U=this.getBoundingClientRect(),A=O.node().getBoundingClientRect(),v=E.node().getBoundingClientRect(),F=U.left-A.left-v.width-12;E.style("left",F+"20px")})}if(Je){let u=b.append("p").attr("id",o+"BestVisualizedText").html("For best results use Chrome, Firefox, Opera or Chromium-based Edge.").attr("pointer-events","none").style("cursor","default")}r.on("mouseover",function(){b.style("display","block")}).on("mouseout",function(){b.style("display","none")}),a.on("click",an),e.on("click",function(){let u=Un(i),E=Wn(n),G=new Date,w="Allocations_"+le(G)+".csv",U="Contributions_"+le(G)+".csv",A=new Blob([u],{type:"text/csv;charset=utf-8;"}),v=new Blob([E],{type:"text/csv;charset=utf-8;"});if(navigator.msSaveBlob)navigator.msSaveBlob(A,w),navigator.msSaveBlob(v,U);else{let F=document.createElement("a");if(F.download!==void 0){let y=URL.createObjectURL(A);F.setAttribute("href",y),F.setAttribute("download",w),F.style="visibility:hidden",document.body.appendChild(F),F.click(),document.body.removeChild(F)}let S=document.createElement("a");if(S.download!==void 0){let y=URL.createObjectURL(v);S.setAttribute("href",y),S.setAttribute("download",U),S.style="visibility:hidden",document.body.appendChild(S),S.click(),document.body.removeChild(S)}}})}function jn(i,n,l){Ie.html("Select CBPF:");let a=p.fundsInAllYearsKeys.slice();a.sort(function(x,u){return p.fundsInAllYears[x].localeCompare(p.fundsInAllYears[u])}),a.unshift("All CBPFs");let e=ce.selectAll(null).data(a).enter().append("div").attr("class",o+"CheckboxDiv");e.filter(function(x){return x!=="All CBPFs"}).style("opacity",function(x){return c.fundsInData.indexOf(x)===-1?ze:1});let r=e.append("label"),f=r.append("input").attr("type","checkbox").property("checked",function(x){return c.selectedFund.length!==p.fundsInAllYearsKeys.length&&c.selectedFund.indexOf(+x)>-1}).attr("value",function(x){return x}),b=r.append("span").attr("class",o+"CheckboxText").html(function(x){return p.fundsInAllYears[x]||x}),g=e.filter(function(x){return x==="All CBPFs"}).select("input");d3.select(g.node().nextSibling).attr("class",o+"CheckboxTextAllCbpfs");let P=e.filter(function(x){return x!=="All CBPFs"}).select("input");P.property("disabled",function(x){return c.fundsInData.indexOf(x)===-1}),g.property("checked",function(){return c.selectedFund.length===p.fundsInAllYearsKeys.length}),r.select("input").on("change",function(){if(this.value==="All CBPFs")this.checked?(c.selectedFund=p.fundsInAllYearsKeys.slice(),P.property("checked",!1)):c.selectedFund.length=0;else{if(this.checked)c.selectedFund.length===p.fundsInAllYearsKeys.length?c.selectedFund=[+this.value]:c.selectedFund.push(+this.value);else{let E=c.selectedFund.indexOf(+this.value);c.selectedFund.splice(E,1)}g.property("checked",!1)}if(!c.selectedFund.length||c.selectedFund.length===p.fundsInAllYearsKeys.length)st.delete("fund");else{let E=c.selectedFund.map(function(G){return p.fundsInAllYears[G]}).join("|");st.has("fund")?st.set("fund",E):st.append("fund",E)}c.fundsInData.length=0;let x=Te(i),u=Fe(n);ke(u,x),we(u,l),De(x)})}function zn(i,n,l){let a=I.main.append("clipPath").attr("id",o+"clip").append("rect").attr("width",K*I.buttonWidth).attr("height",I.height),e=I.main.append("g").attr("class",o+"ClipPathGroup").attr("transform","translate("+I.padding[3]+",0)").attr("clip-path","url(#"+o+"clip)"),r=e.append("g").attr("class",o+"buttonsGroup").attr("transform","translate(0,0)").style("cursor","pointer"),f=r.selectAll(null).data(j).enter().append("rect").attr("rx","2px").attr("ry","2px").attr("class",o+"buttonsRects").attr("width",I.buttonWidth-I.buttonsMargin).attr("height",I.height-I.buttonVerticalPadding*2).attr("y",I.buttonVerticalPadding).attr("x",function(y,W){return W*I.buttonWidth+I.buttonsMargin/2}).style("fill",function(y){return c.selectedYear.indexOf(y)>-1?te:"#eaeaea"}),b=r.selectAll(null).data(j).enter().append("text").attr("text-anchor","middle").attr("class",o+"buttonsText").attr("y",I.height/1.6).attr("x",function(y,W){return W*I.buttonWidth+I.buttonWidth/2}).style("fill",function(y){return c.selectedYear.indexOf(y)>-1?"white":"#444"}).text(function(y){return y}),g=I.main.append("g").attr("class",o+"LeftArrowGroup").style("cursor","pointer").style("opacity",0).attr("pointer-events","none").attr("transform","translate("+I.padding[3]+",0)"),P=g.append("rect").style("fill","white").attr("width",I.arrowPadding).attr("height",I.height-I.padding[0]-I.buttonVerticalPadding*2).attr("y",I.buttonVerticalPadding),x=g.append("text").attr("class",o+"leftArrowText").attr("x",0).attr("y",I.height-I.buttonVerticalPadding*2.1).style("fill","#666").text("\u25C4"),u=I.main.append("g").attr("class",o+"RightArrowGroup").style("cursor","pointer").style("opacity",0).attr("pointer-events","none").attr("transform","translate("+(I.padding[3]+I.arrowPadding+K*I.buttonWidth)+",0)"),E=u.append("rect").style("fill","white").attr("width",I.arrowPadding).attr("height",I.height-I.padding[0]-I.buttonVerticalPadding*2).attr("y",I.buttonVerticalPadding),G=u.append("text").attr("class",o+"rightArrowText").attr("x",-1).attr("y",I.height-I.buttonVerticalPadding*2.1).style("fill","#666").text("\u25BA");j.length>K&&(e.attr("transform","translate("+(I.padding[3]+I.arrowPadding)+",0)"),u.style("opacity",1).attr("pointer-events","all"),g.style("opacity",1).attr("pointer-events","all"),A(),U(),g.on("click",function(){g.attr("pointer-events","none");let y=fe(r.attr("transform"))[0];u.select("text").style("fill","#666"),u.attr("pointer-events","all"),r.transition().duration(k).attr("transform","translate("+Math.min(0,y+K*I.buttonWidth)+",0)").on("end",w)}),u.on("click",function(){u.attr("pointer-events","none");let y=fe(r.attr("transform"))[0];g.select("text").style("fill","#666"),g.attr("pointer-events","all"),r.transition().duration(k).attr("transform","translate("+Math.max(-((j.length-K)*I.buttonWidth),-(Math.abs(y)+K*I.buttonWidth))+",0)").on("end",w)})),f.on("mouseover",v).on("mouseout",F).on("click",function(y){let W=this;if(d3.event.altKey){S(y,!1);return}Ht.get(this)!=="clicked"?(Ht.set(this,"clicked"),setTimeout(function(){Ht.get(W)==="clicked"&&S(y,!0),Ht.set(W,null)},250)):(S(y,!1),Ht.set(this,null))}),d3.select("body").on("d3ChartsYear."+o,function(){S(on(+d3.event.detail),!0),j.length>K&&A(),w()});function w(){let y=fe(r.attr("transform"))[0];y===0?(g.select("text").style("fill","#ccc"),g.attr("pointer-events","none")):(g.select("text").style("fill","#666"),g.attr("pointer-events","all")),Math.abs(y)>=(j.length-K)*I.buttonWidth?(u.select("text").style("fill","#ccc"),u.attr("pointer-events","none")):(u.select("text").style("fill","#666"),u.attr("pointer-events","all"))}function U(){let y=fe(r.attr("transform"))[0];y===0&&(g.select("text").style("fill","#ccc"),g.attr("pointer-events","none")),Math.abs(y)>=(j.length-K)*I.buttonWidth&&(u.select("text").style("fill","#ccc"),u.attr("pointer-events","none"))}function A(){let y=c.selectedYear[0]<j[K/2]?0:c.selectedYear[0]>j[j.length-K/2]?j.length-K:j.indexOf(c.selectedYear[0])-K/2;r.attr("transform","translate("+-(I.buttonWidth*y)+",0)")}function v(y){z.style("display","block").html(null),z.append("div").style("max-width","200px").attr("id",o+"InnerTooltipDiv").html("Click for selecting a single year. Double-click or ALT + click for selecting multiple years.");let q=O.node().getBoundingClientRect(),D=this.getBoundingClientRect();tooltipSize=z.node().getBoundingClientRect(),z.style("left",D.left+D.width/2-q.left>q.width-tooltipSize.width/2-C[1]?q.width-tooltipSize.width-C[1]+"px":D.left+D.width/2-q.left<tooltipSize.width/2+I.padding[3]+C[0]?I.padding[3]+C[0]+"px":D.left+D.width/2-q.left-tooltipSize.width/2+"px").style("top",D.top+D.height/2-q.top<tooltipSize.height?D.top-q.top+D.height+2+"px":D.top-q.top-tooltipSize.height-4+"px"),d3.select(this).style("fill",te),b.filter(function(Rt){return Rt===y}).style("fill","white")}function F(y){z.style("display","none"),!(c.selectedYear.indexOf(y)>-1)&&(d3.select(this).style("fill","#eaeaea"),b.filter(function(W){return W===y}).style("fill","#444"))}function S(y,W){if(W)c.selectedYear=[y];else{let X=c.selectedYear.indexOf(y);if(X>-1){if(c.selectedYear.length===1)return;c.selectedYear.splice(X,1)}else c.selectedYear.push(y)}let q=c.selectedYear.map(function(X){return X}).join("|");st.has("year")?st.set("year",q):st.append("year",q),f.style("fill",function(X){return c.selectedYear.indexOf(X)>-1?te:"#eaeaea"}),b.style("fill",function(X){return c.selectedYear.indexOf(X)>-1?"white":"#444"}),sn(),c.fundsInData.length=0;let D=Te(i),Rt=Fe(n);ce.selectAll("."+o+"CheckboxDiv").filter(function(X){return X!=="All CBPFs"}).select("input").property("disabled",function(X){return c.fundsInData.indexOf(+X)===-1}),ce.selectAll("."+o+"CheckboxDiv").filter(function(X){return X!=="All CBPFs"}).style("opacity",function(X){return c.fundsInData.indexOf(+X)===-1?ze:1}),ke(Rt,D),we(Rt,l),De(D)}}function ke(i,n){let l=H.main.selectAll("."+o+"centralCircleBackground").data([!0]).enter().append("circle").attr("class",o+"centralCircleBackground").attr("r",H.radius+bn).style("fill","white"),a=H.main.selectAll("."+o+"centralCircle").data([!0]).enter().append("circle").attr("class",o+"centralCircle").attr("r",H.radius).attr("fill","url(#"+o+"centralCircleGradient)"),e=H.main.selectAll("."+o+"centralLine").data([!0]).enter().append("line").attr("class",o+"centralLine").attr("x1",-H.radius*.5).attr("x2",H.radius*.5),r=i.nodes.length?i.nodes.find(A=>A.level===2).value:0,f=n.nodes.length?n.nodes.find(A=>A.level===1).value:0,b=H.main.selectAll("."+o+"contributionsValueText").data([r]),g=b.enter().append("text").attr("class",o+"contributionsValueText").attr("y",-H.radius*.4).text("$").append("tspan").attr("class",o+"contributionsValueTextSpan").transition().duration(k).tween("text",(A,v,F)=>{let S=d3.interpolate(it(F[v].textContent)||0,A);return y=>F[v].textContent=A?at(S(y)):0});b.select("tspan").transition().duration(k).tween("text",(A,v,F)=>{let S=d3.interpolate(it(F[v].textContent)||0,A);return y=>F[v].textContent=A?at(S(y)):0});let P=H.main.selectAll("."+o+"contributionsText").data([!0]).enter().append("text").attr("class",o+"contributionsText").attr("y",-H.radius*.24).text("Contributions*"),x=H.main.selectAll("."+o+"contributionsSubText").data([!0]);x=x.enter().append("text").attr("class",o+"contributionsSubText").attr("y",-H.radius*.1).merge(x).text(()=>c.selectedYear.length===1?"for "+c.selectedYear[0]:c.selectedYear.length>Re?"for selected years*":"for "+c.selectedYear.sort((v,F)=>v-F).reduce((v,F,S)=>v+(S>=c.selectedYear.length-2?S>c.selectedYear.length-2?F:F+" and ":F+", "),""));let u=H.main.selectAll("."+o+"launchedAllocationsValueText").data([n.launchedAllocations]),E=u.enter().append("text").attr("class",o+"launchedAllocationsValueText").attr("y",H.radius*.3).text("$").append("tspan").attr("class",o+"launchedAllocationsValueTextSpan").transition().duration(k).tween("text",(A,v,F)=>{let S=d3.interpolate(it(F[v].textContent)||0,A);return y=>F[v].textContent=A?at(S(y)):0});u.select("tspan").transition().duration(k).tween("text",(A,v,F)=>{let S=d3.interpolate(it(F[v].textContent)||0,A);return y=>F[v].textContent=A?at(S(y)):0});let G=H.main.selectAll("."+o+"launchedAllocationsText").data([!0]);G=G.enter().append("text").attr("class",o+"launchedAllocationsText").attr("y",H.radius*.5).merge(G).text(c.selectedYear.some(A=>Ot[A])?"Allocations":"Allocated"),G.append("tspan").attr("dy","1em").attr("x",0).text(c.selectedYear.some(A=>Ot[A])?"Launched":"");let w=H.main.selectAll("."+o+"selectedFundsText").data([!0]);w=w.enter().append("text").attr("class",o+"selectedFundsText").attr("y",0).attr("x",H.radius+H.selectedFundsPadding).merge(w);let U=c.selectedFund.length===p.fundsInAllYearsKeys.length?"all funds":c.selectedFund.sort((A,v)=>p.fundsInAllYears[A].localeCompare(p.fundsInAllYears[v])).reduce((A,v,F)=>A+(F>=c.selectedFund.length-2?F>c.selectedFund.length-2?p.fundsInAllYears[v]:p.fundsInAllYears[v]+" and ":p.fundsInAllYears[v]+", "),"");w.text("Selected fund"+(c.selectedFund.length===1?"":"s")+": "+U).call(so,(900-C[1]-C[3])/2-H.radius-H.selectedFundsPadding).call(lo)}function we(i,n){let l=i.nodes.length&&d3.sum(i.nodes,s=>s.value),a=$.main.selectAll("."+o+"contributionsNoData").data(l?[]:[!0]),e=a.exit().transition().duration(k).style("opacity",0).remove();if(a=a.enter().append("text").attr("class",o+"contributionsNoData").attr("x",$.width/2).attr("y",$.height/3).style("opacity",0).text("Contribution data not available").merge(a).transition().duration(k).style("opacity",1),!l){$.main.selectAll("*:not(."+o+"contributionsNoData)").remove();return}i.nodes.reverse();let r=Xe(i),f=r.nodes.filter(s=>s.level===1),b=r.nodes.filter(s=>s.level===2);Kt(f,!1),Kt(b,!1),Xe.update(r);let g=$.main.selectAll("."+o+"sankeyNodesContributions").data(r.nodes,s=>s.id),P=g.exit().transition().duration(k).style("opacity",0).remove();g=g.enter().append("rect").attr("class",o+"sankeyNodesContributions").style("fill",ge).style("opacity",0).attr("y",s=>s.x0).attr("x",s=>B(s.y1)).attr("width",s=>Math.max(ie,B(s.y0)-B(s.y1))).attr("height",s=>s.x1-s.x0).merge(g),g.transition().duration(k).style("opacity",1).attr("y",s=>s.x0).attr("x",s=>B(s.y1)).attr("width",s=>Math.max(ie,B(s.y0)-B(s.y1))).attr("height",s=>s.x1-s.x0);let u=$.main.selectAll("."+o+"sankeyLinksContributions").data(r.links,s=>s.source.id),E=u.exit().transition().duration(k).style("stroke-opacity",0).remove();u=u.enter().append("path").attr("class",o+"sankeyLinksContributions").attr("stroke-width",s=>Math.max(s.width,ae)).style("fill","none").style("stroke",ge).style("stroke-opacity",0).attr("d",ue()).merge(u),u.transition().duration(k).style("stroke-opacity",yt).attr("stroke-width",s=>Math.max(s.width,ae)).attr("d",ue());let w=$.main.selectAll("."+o+"sankeyDonorFlags").data(f,s=>s.id),U=w.exit().transition().duration(k).style("opacity",0).remove();w=w.enter().append("image").attr("class",o+"sankeyDonorFlags").style("opacity",1).attr("x",s=>(B(s.y1)+B(s.y0))/2-nt/2).attr("y",$.padding[0]-Bt-nt).attr("width",nt).attr("height",nt).attr("href",s=>s.codeId===pt?Lt:(p.donorIsoCodes[s.codeId].toLowerCase()&&!n[p.donorIsoCodes[s.codeId].toLowerCase()]&&console.warn("Missing flag: "+s.name,s),n[p.donorIsoCodes[s.codeId].toLowerCase()]||Lt)).merge(w),w.transition().duration(k).style("opacity",1).attr("x",s=>(B(s.y1)+B(s.y0))/2-nt/2);let v=$.main.selectAll("."+o+"otherFlags").data(f.length?f[0].codeId===pt?f[0].othersData.slice(0,St).reverse():[]:[],s=>s.id),F=v.exit().transition().duration(k).style("opacity",0).remove();v=v.enter().append("image").attr("class",o+"otherFlags").style("opacity",0).attr("pointer-events","none").attr("x",(B(f.length?f[0].y1:0)+B(f.length?f[0].y0:0))/2-nt/2).attr("y",$.padding[0]-Bt-nt).attr("width",nt).attr("height",nt).attr("href",s=>(p.donorIsoCodes[s.codeId].toLowerCase()&&!n[p.donorIsoCodes[s.codeId].toLowerCase()]&&console.warn("Missing flag: "+s.name,s),n[p.donorIsoCodes[s.codeId].toLowerCase()]||Lt)).merge(v),v.transition().duration(k).style("opacity",(s,L)=>(L+1)/Math.min(St,f[0].othersData.length)).attr("x",(s,L)=>(Math.min(St,f[0].othersData.length)-L-1)*$e+(B(f.length?f[0].y1:0)+B(f.length?f[0].y0:0))/2-nt/2).attr("y",(s,L)=>$.padding[0]-Bt-nt+(Math.min(St,f[0].othersData.length)-L-1)*$e/3);let y=$.main.selectAll("."+o+"sankeyDonorNames").data(f,s=>s.id),W=y.exit().transition().duration(k).style("opacity",0).remove();y=y.enter().append("text").attr("class",o+"sankeyDonorNames").style("opacity",0).attr("x",s=>(B(s.y1)+B(s.y0))/2).attr("y",$.padding[0]-xe-nt-Bt).attr("transform",s=>`rotate(${oe}, ${(B(s.y1)+B(s.y0))/2}, ${$.padding[0]-xe-nt-Bt})`).text(s=>s.codeId===pt?"Others":p.donorNames[s.codeId]).call(he,"donor").merge(y),y.text(s=>s.codeId===pt?"Others":p.donorNames[s.codeId]).transition().duration(k).style("opacity",1).attr("transform",s=>`rotate(${oe}, ${(B(s.y1)+B(s.y0))/2}, ${$.padding[0]-xe-nt-Bt})`).attr("x",s=>(B(s.y1)+B(s.y0))/2).call(he,"donor");let D=$.main.selectAll("."+o+"sankeyDonorValues").data(f,s=>s.id),Rt=D.exit().transition().duration(k).style("opacity",0).remove();D=D.enter().append("text").attr("class",o+"sankeyDonorValues").style("opacity",0).attr("x",s=>(B(s.y1)+B(s.y0))/2).attr("y",s=>s.x1+Pt).attr("transform",s=>`rotate(${se}, ${(B(s.y1)+B(s.y0))/2}, ${s.x1+Pt})`).text(s=>"$0").merge(D),D.transition().duration(k).style("opacity",1).attr("x",s=>(B(s.y1)+B(s.y0))/2).attr("transform",s=>`rotate(${se}, ${(B(s.y1)+B(s.y0))/2}, ${s.x1+Pt})`).tween("text",(s,L,ut)=>{let It=d3.interpolate(it(ut[L].textContent.split("$")[1])||0,s.value);return kt=>ut[L].textContent="$"+at(It(kt))}),g.on("mouseover",Vt).on("mouseout",Ft),y.on("mouseover",Vt).on("mouseout",Ft),w.on("mouseover",Vt).on("mouseout",Ft),u.on("mouseover",ye).on("mouseout",Ft);function Vt(s){dt=this,g.style("opacity",L=>L.id===s.id?1:V),u.style("stroke-opacity",L=>L.source.codeId===s.codeId?yt:Yt),y.style("opacity",L=>L.codeId===s.codeId?1:V),w.style("opacity",L=>L.codeId===s.codeId?1:V),D.style("opacity",L=>L.codeId===s.codeId?1:V),v.style("opacity",(L,ut)=>(ut+1)/Math.min(St,f[0].othersData.length)*(s.codeId===pt?1:V)),_t(s)}function ye(s){dt=this,g.style("opacity",L=>s.source.codeId===L.codeId?1:V),u.style("stroke-opacity",(L,ut,It)=>It[ut]===this?yt:Yt),y.style("opacity",L=>L.codeId===s.source.codeId?1:V),w.style("opacity",L=>L.codeId===s.source.codeId?1:V),D.style("opacity",L=>L.codeId===s.source.codeId?1:V),_t(s.source)}function Ft(){bt||(dt=null,g.style("opacity",1),u.style("stroke-opacity",yt),y.style("opacity",1),w.style("opacity",1),D.style("opacity",1),v.style("opacity",(s,L)=>(L+1)/Math.min(St,f[0].othersData.length)),z.style("display","none").html(null))}function _t(s){z.style("display","block").html(null);let L=z.append("div").style("max-width",yn+"px").attr("id",o+"innerTooltipDiv"),ut=L.append("div").attr("class",o+"tooltipTitleDiv").style("margin-bottom","18px");s.codeId!==pt&&ut.append("img").attr("width",nt).attr("height",nt).style("margin-right","8px").attr("src",()=>(p.donorIsoCodes[s.codeId].toLowerCase()&&!n[p.donorIsoCodes[s.codeId].toLowerCase()]&&console.warn("Missing flag: "+s.name,d),n[p.donorIsoCodes[s.codeId].toLowerCase()]||Lt));let It=ut.append("div").attr("class",o+"titleNameDiv");It.append("strong").style("font-size","16px").html(s.codeId!==pt?s.name:`Other donors (${s.othersData.length} donors)`),p.donorTypes[s.codeId]&&p.donorTypes[s.codeId]!==gn&&It.append("div").attr("class",o+"tooltipFooter").html("("+p.donorTypes[s.codeId]+")");let kt=L.append("div").style("margin","0px").style("display","flex").style("flex-wrap","wrap").style("white-space","pre").style("line-height",1.4).style("width","100%"),$t=kt.append("div").style("display","flex").style("align-items","center").style("margin-bottom","4px").style("width","100%");if($t.append("span").attr("class",o+"tooltipKeys").html("Total"),$t.append("span").attr("class",o+"tooltipLeader"),$t.append("span").attr("class",o+"tooltipValues").html("$"+Nt(s.value)),s.codeId===pt){let tt=kt.append("div").attr("class",o+"tooltipheaderDiv").html("List of donors"+(s.othersData.length>Ct+1?` (top ${Ct} donors)`:""));(s.othersData.length<=Ct+1?s.othersData:s.othersData.reduce((J,ct,ht)=>(ct.level===1&&(ht<Ct?J.push(ct):ht===Ct?J.push({codeId:me,value:ct.value}):J[Ct].value+=ct.value),J),[])).forEach(J=>{let ct=kt.append("div").attr("class",o+"tooltipDivOthers").style("display","flex").style("align-items","center").style("margin-bottom","4px").style("width","100%");ct.append("img").attr("class",o+"tooltipKeys").attr("width",He).attr("height",He).style("margin-right","2px").attr("src",()=>J.codeId===me?Lt:(p.donorIsoCodes[J.codeId].toLowerCase()&&!n[p.donorIsoCodes[J.codeId].toLowerCase()]&&console.warn("Missing flag: "+J.name,d),n[p.donorIsoCodes[J.codeId].toLowerCase()]||Lt)),ct.append("span").attr("class",o+"tooltipKeys").html(J.codeId!==me?J.name.slice(0,kn):`Remaining donors (${s.othersData.length-Ct} donors)`),ct.append("span").attr("class",o+"tooltipLeader"),ct.append("span").attr("class",o+"tooltipValues").html("$"+Nt(J.value))})}let wt=g.filter(tt=>tt.codeId===s.codeId).node().getBoundingClientRect(),t=w.filter(tt=>tt.codeId===s.codeId).node().getBoundingClientRect(),h=O.node().getBoundingClientRect(),m=z.node().getBoundingClientRect(),T=Math.min(wt.left,t.left),R=Math.max(wt.right,t.right),Y=Math.max(wt.width,t.width),N=Math.max(C[0],t.top+t.height/2-m.height/2-h.top),lt=h.right-R>m.width+vt?T-h.left+Y+vt:T-h.left-m.width-vt;z.style("top",N+"px").style("left",lt+"px")}}function De(i){let n=i.nodes.length&&d3.sum(i.nodes,t=>t.value),l=Z.main.selectAll("."+o+"allocationsNoData").data(n?[]:[!0]),a=l.exit().transition().duration(k).style("opacity",0).remove();if(l=l.enter().append("text").attr("class",o+"allocationsNoData").attr("x",Z.width/2).attr("y",Z.height/2).style("opacity",0).text("Allocation data not available").merge(l).transition().duration(k).style("opacity",1),!n){Z.main.selectAll("*:not(."+o+"allocationsNoData)").remove();return}i.nodes.reverse();let e=tn(i),r=e.nodes.filter(t=>t.level===1),f=e.nodes.filter(t=>t.level===2),b=e.nodes.filter(t=>t.level===3);Kt(r,!1),Kt(f,!0),Kt(b,!1),Wt.domain(b.map(t=>t.id).reverse()).range(d3.range(b.length).map(t=>Ue[~~(t/b.length*Ue.length)])),tn.update(e);let g=Z.main.selectAll("."+o+"sankeyNodesAllocations").data(e.nodes,t=>t.id),P=g.exit().transition().duration(k).style("opacity",0).remove();g=g.enter().append("rect").attr("class",o+"sankeyNodesAllocations").style("fill",t=>t.level===3?Wt(t.id):d3.color(zt).darker(.2)).style("opacity",0).attr("y",t=>t.x0).attr("x",t=>M(t.y1)).attr("width",t=>Math.max(ie,M(t.y0)-M(t.y1))).attr("height",t=>t.x1-t.x0).merge(g),g.transition().duration(k).style("opacity",1).style("fill",t=>t.level===3?Wt(t.id):d3.color(zt).darker(.2)).attr("y",t=>t.x0).attr("x",t=>M(t.y1)).attr("width",t=>Math.max(ie,M(t.y0)-M(t.y1))).attr("height",t=>t.x1-t.x0);let u=Z.main.selectAll("."+o+"sankeyLinksAllocations").data(e.links,t=>t.source.id+t.target.id),E=u.exit().transition().duration(k).style("stroke-opacity",0).remove();u=u.enter().append("path").attr("class",o+"sankeyLinksAllocations").attr("stroke-width",t=>Math.max(t.width,ae)).style("fill","none").style("stroke",t=>t.source.level===1?zt:Wt(t.target.id)).style("stroke-opacity",0).attr("d",ue()).merge(u),u.transition().duration(k).style("stroke",t=>t.source.level===1?zt:Wt(t.target.id)).style("stroke-opacity",yt).attr("stroke-width",t=>Math.max(t.width,ae)).attr("d",ue());let w=Z.main.selectAll("."+o+"sankeyPartnerNames").data(f,t=>t.id),U=w.exit().transition().duration(k).style("opacity",0).remove();w=w.enter().append("text").attr("class",o+"sankeyPartnerNames").style("opacity",0).attr("x",t=>(M(t.y1)+M(t.y0))/2).attr("y",t=>t.x0-ne).text(t=>p.allocationTypes[t.codeId]).merge(w),w.text(t=>p.allocationTypes[t.codeId]).transition().duration(k).style("opacity",1).attr("x",t=>(M(t.y1)+M(t.y0))/2);let v=Z.main.selectAll("."+o+"sankeyPartnerValues").data(f,t=>t.id),F=v.exit().transition().duration(k).style("opacity",0).remove();v=v.enter().append("text").attr("class",o+"sankeyPartnerValues").style("opacity",0).attr("x",t=>(M(t.y1)+M(t.y0))/2).attr("y",t=>t.x1+hn).text(t=>"$0").merge(v),v.transition().duration(k).style("opacity",1).attr("x",t=>(M(t.y1)+M(t.y0))/2).tween("text",(t,h,m)=>{let T=d3.interpolate(it(m[h].textContent.split("$")[1])||0,t.value);return R=>m[h].textContent="$"+at(T(R))});let y=Z.main.selectAll("."+o+"sankeyClusterNames").data(b,t=>t.id),W=y.exit().transition().duration(k).style("opacity",0).remove();y=y.enter().append("text").attr("class",o+"sankeyClusterNames").style("opacity",0).attr("x",t=>(M(t.y1)+M(t.y0))/2).attr("y",t=>t.x0-ne).attr("transform",t=>`rotate(${oe}, ${(M(t.y1)+M(t.y0))/2}, ${t.x0-ne})`).text(t=>p.fundAbbreviatedNames[t.codeId]).call(he,"cluster").merge(y),y.text(t=>p.fundAbbreviatedNames[t.codeId]).transition().duration(k).style("opacity",1).attr("x",t=>(M(t.y1)+M(t.y0))/2).attr("transform",t=>`rotate(${oe}, ${(M(t.y1)+M(t.y0))/2}, ${t.x0-ne})`).call(he,"cluster");let D=Z.main.selectAll("."+o+"sankeyClusterValues").data(b,t=>t.id),Rt=D.exit().transition().duration(k).style("opacity",0).remove();D=D.enter().append("text").attr("class",o+"sankeyClusterValues").style("opacity",0).attr("x",t=>(M(t.y1)+M(t.y0))/2).attr("y",t=>t.x1+Pt).attr("transform",t=>`rotate(${se}, ${(M(t.y1)+M(t.y0))/2}, ${t.x1+Pt})`).text(t=>"$0").merge(D),D.transition().duration(k).style("opacity",1).attr("x",t=>(M(t.y1)+M(t.y0))/2).attr("transform",t=>`rotate(${se}, ${(M(t.y1)+M(t.y0))/2}, ${t.x1+Pt})`).tween("text",(t,h,m)=>{let T=d3.interpolate(it(m[h].textContent.split("$")[1])||0,t.value);return R=>m[h].textContent="$"+at(T(R))}),g.filter(t=>t.level===2).on("mouseover",Vt).on("mouseout",ye),w.on("mouseover",Vt).on("mouseout",ye),g.filter(t=>t.level===3).on("mouseover",Ft).on("mouseout",_t),y.on("mouseover",Ft).on("mouseout",_t),u.filter(t=>t.source.level===1).on("mouseover",s).on("mouseout",L),u.filter(t=>t.source.level===2).on("mouseover",ut).on("mouseout",It);function Vt(t){dt=this,g.style("opacity",h=>h.level===2&&h.id===t.id||h.targetLinks.filter(m=>m.source.id===t.id).length?1:V),u.style("stroke-opacity",h=>h.source.id===t.id||h.target.id===t.id?yt:Yt),w.style("opacity",h=>h.codeId===t.codeId?1:V),v.style("opacity",h=>h.codeId===t.codeId?1:V),y.style("opacity",h=>h.targetLinks.filter(m=>m.source.id===t.id).length?1:V),D.style("opacity",h=>h.targetLinks.filter(m=>m.source.id===t.id).length?1:V),D.each((h,m,T)=>{let R=h.targetLinks.reduce((Y,N)=>(N.source.id===t.id&&(Y+=N.value),Y),0);d3.select(T[m]).transition().duration(k).tween("text",()=>{let Y=d3.interpolate(it(T[m].textContent.split("$")[1])||0,R);return N=>T[m].textContent="$"+at(Y(N))})}),kt(t)}function ye(){bt||(dt=null,wt(),z.style("display","none").html(null))}function Ft(t){dt=this,g.style("opacity",m=>m.level===3&&m.id===t.id||m.sourceLinks.filter(T=>T.target.id===t.id).length?1:V);let h=e.nodes.reduce((m,T)=>{let R=T.sourceLinks.map(Y=>Y.target.id);return T.level===2&&R.includes(t.id)&&m.push(T.id),m},[]);u.style("stroke-opacity",m=>m.target.id===t.id||h.includes(m.target.id)?yt:Yt),w.style("opacity",m=>h.includes(m.id)?1:V),v.style("opacity",m=>h.includes(m.id)?1:V),y.style("opacity",m=>m.codeId===t.codeId?1:V),D.style("opacity",m=>m.codeId===t.codeId?1:V),v.each((m,T,R)=>{let Y=m.sourceLinks.reduce((N,lt)=>(lt.target.id===t.id&&(N+=lt.value),N),0);d3.select(R[T]).transition().duration(k).tween("text",()=>{let N=d3.interpolate(it(R[T].textContent.split("$")[1])||0,Y);return lt=>R[T].textContent="$"+at(N(lt))})}),$t(t,"node")}function _t(){bt||(dt=null,wt(),z.style("display","none").html(null))}function s(t){dt=this,g.style("opacity",h=>t.target.id===h.id||h.targetLinks.filter(m=>m.source.id===t.target.id).length?1:V),u.style("stroke-opacity",h=>h.target.id===t.target.id||h.source.id===t.target.id?yt:Yt),w.style("opacity",h=>h.codeId===t.target.codeId?1:V),v.style("opacity",h=>h.codeId===t.target.codeId?1:V),y.style("opacity",h=>h.targetLinks.filter(m=>m.source.id===t.target.id).length?1:V),D.style("opacity",h=>h.targetLinks.filter(m=>m.source.id===t.target.id).length?1:V),D.each((h,m,T)=>{let R=h.targetLinks.reduce((Y,N)=>(N.source.id===t.target.id&&(Y+=N.value),Y),0);d3.select(T[m]).transition().duration(k).tween("text",()=>{let Y=d3.interpolate(it(T[m].textContent.split("$")[1])||0,R);return N=>T[m].textContent="$"+at(Y(N))})}),kt(t.target)}function L(){bt||(dt=null,wt(),z.style("display","none").html(null))}function ut(t){dt=this,g.style("opacity",h=>t.target.id===h.id||h.id===t.source.id?1:V),u.style("stroke-opacity",(h,m,T)=>h.target.id===t.source.id||T[m]===this?yt:Yt),w.style("opacity",h=>h.id===t.source.id?1:V),v.style("opacity",h=>h.id===t.source.id?1:V),y.style("opacity",h=>h.codeId===t.target.codeId?1:V),D.style("opacity",h=>h.codeId===t.target.codeId?1:V),v.each((h,m,T)=>{let R=h.sourceLinks.reduce((Y,N)=>(N.target.id===t.target.id&&(Y+=N.value),Y),0);d3.select(T[m]).transition().duration(k).tween("text",()=>{let Y=d3.interpolate(it(T[m].textContent.split("$")[1])||0,R);return N=>T[m].textContent="$"+at(Y(N))})}),D.each((h,m,T)=>{let R=h.targetLinks.reduce((Y,N)=>(N.source.id===t.source.id&&(Y+=N.value),Y),0);d3.select(T[m]).transition().duration(k).tween("text",()=>{let Y=d3.interpolate(it(T[m].textContent.split("$")[1])||0,R);return N=>T[m].textContent="$"+at(Y(N))})}),$t(t,"link")}function It(){bt||(dt=null,wt(),z.style("display","none").html(null))}function kt(t){z.style("display","block").html(null);let h=z.append("div").style("max-width",je+"px").attr("id",o+"innerTooltipDiv");h.append("div").attr("class",o+"tooltipTitleDiv").style("margin-bottom","18px").append("div").attr("class",o+"titleNameDiv").append("strong").style("font-size","16px").html(p.allocationTypes[t.codeId]);let R=h.append("div").style("margin","0px").style("display","flex").style("flex-wrap","wrap").style("white-space","pre").style("line-height",1.4).style("width","100%"),Y=R.append("div").style("display","flex").style("align-items","center").style("margin-bottom","4px").style("width","100%");Y.append("span").attr("class",o+"tooltipKeys").html("Total"),Y.append("span").attr("class",o+"tooltipLeader"),Y.append("span").attr("class",o+"tooltipValues").html("$"+Nt(t.value));let N=b.reduce((xt,ot)=>{let ft=ot.targetLinks.find(Zt=>Zt.source.id===t.id);return ft&&xt.push({codeId:ft.target.codeId,value:ft.value}),xt},[]).sort((xt,ot)=>ot.value-xt.value),lt=R.append("div").attr("class",o+"tooltipheaderDiv").html("List of funds");N.forEach(xt=>{let ot=R.append("div").attr("class",o+"tooltipDivOthers").style("display","flex").style("align-items","center").style("margin-bottom","4px").style("width","100%");ot.append("span").attr("class",o+"tooltipKeys").html(p.fundAbbreviatedNames[xt.codeId]),ot.append("span").attr("class",o+"tooltipLeader"),ot.append("span").attr("class",o+"tooltipValues").html("$"+Nt(xt.value))});let tt=g.filter(xt=>xt.id===t.id).node().getBoundingClientRect(),mt=O.node().getBoundingClientRect(),J=z.node().getBoundingClientRect(),ct=tt.top+tt.height/2-J.height/2-mt.top,ht=mt.right-tt.right>J.width+vt?tt.left-mt.left+tt.width+vt:tt.left-mt.left-J.width-vt;z.style("top",ct+"px").style("left",ht+"px")}function $t(t,h){z.style("display","block").html(null);let m=z.append("div").style("max-width",je+"px").attr("id",o+"innerTooltipDiv"),R=m.append("div").attr("class",o+"tooltipTitleDiv").style("margin-bottom","18px").append("div").attr("class",o+"titleNameDiv");R.append("strong").style("font-size","16px").html(h==="node"?p.fundAbbreviatedNames[t.codeId]:p.fundAbbreviatedNames[t.target.codeId]),h==="link"&&R.append("div").attr("class",o+"tooltipFooter").html("(from: "+p.allocationTypes[t.source.codeId]+")");let Y=m.append("div").style("margin","0px").style("display","flex").style("flex-wrap","wrap").style("white-space","pre").style("line-height",1.4).style("width","100%"),N=Y.append("div").style("display","flex").style("align-items","center").style("margin-bottom","4px").style("width","100%");if(N.append("span").attr("class",o+"tooltipKeys").html("Total"),N.append("span").attr("class",o+"tooltipLeader"),N.append("span").attr("class",o+"tooltipValues").html("$"+Nt(t.value)),h==="node"){let ht=f.reduce((ot,ft)=>{let Zt=ft.sourceLinks.find(ro=>ro.target.id===t.id);return Zt&&ot.push({codeId:Zt.source.codeId,value:Zt.value}),ot},[]).sort((ot,ft)=>ft.value-ot.value),xt=Y.append("div").attr("class",o+"tooltipheaderDiv").html("Allocation Types");ht.forEach(ot=>{let ft=Y.append("div").attr("class",o+"tooltipDivOthers").style("display","flex").style("align-items","center").style("margin-bottom","4px").style("width","100%");ft.append("span").attr("class",o+"tooltipKeys").html(p.allocationTypes[ot.codeId]),ft.append("span").attr("class",o+"tooltipLeader"),ft.append("span").attr("class",o+"tooltipValues").html("$"+Nt(ot.value))})}let lt=h==="node"?g.filter(ht=>ht.id===t.id).node().getBoundingClientRect():u.filter(ht=>ht.source.id===t.source.id&&ht.target.id===t.target.id).node().getBoundingClientRect(),tt=O.node().getBoundingClientRect(),mt=z.node().getBoundingClientRect(),J=Math.min(tt.height-mt.height-C[2],lt.top+lt.height/2-mt.height/2-tt.top),ct=tt.right-lt.right>mt.width+vt?lt.left-tt.left+lt.width+vt:Math.max(0,lt.left-tt.left-mt.width-vt);z.style("top",J+"px").style("left",ct+"px")}function wt(){g.style("opacity",1),u.style("stroke-opacity",yt),w.style("opacity",1),v.style("opacity",1),y.style("opacity",1),D.style("opacity",1),D.transition().duration(k).tween("text",(t,h,m)=>{let T=d3.interpolate(it(m[h].textContent.split("$")[1])||0,t.value);return R=>m[h].textContent="$"+at(T(R))}),v.transition().duration(k).tween("text",(t,h,m)=>{let T=d3.interpolate(it(m[h].textContent.split("$")[1])||0,t.value);return R=>m[h].textContent="$"+at(T(R))})}}function Gn(i,n){i.forEach(l=>{l.fundId=p.cbpfIds[l.PooledFundId],!re.includes(l.AllocationYear)&&+l.fundId==+l.fundId&&re.push(l.AllocationYear),!p.fundsInAllYears[l.fundId]&&+l.fundId==+l.fundId&&+l.AllocationYear>=ve&&(p.fundsInAllYears[l.fundId]=p.fundAbbreviatedNames[l.fundId])}),n.forEach(l=>{!de.includes(l.contributionYear)&&l.fundId!==Ce&&+l.fundId==+l.fundId&&de.push(l.contributionYear),!p.fundsInAllYears[l.fundId]&&l.fundId!==Ce&&+l.fundId==+l.fundId&&+l.contributionYear>=ve&&(p.fundsInAllYears[l.fundId]=p.fundAbbreviatedNames[l.fundId])}),p.fundsInAllYearsKeys=Object.keys(p.fundsInAllYears).map(l=>+l),p.fundsInAllYearsValues=Object.values(p.fundsInAllYears),re.sort((l,a)=>l-a),de.sort((l,a)=>l-a),re.forEach(l=>{de.includes(l)&&l>=ve&&j.push(l)})}function Hn(i,n,l){return l===0?{underApprovalPercent:0,underPlusApprovedPercent:0}:{underApprovalPercent:i/l*100,underPlusApprovedPercent:(i+n)/l*100}}function Te(i){let n={nodes:[],links:[],launchedAllocations:0},l={codeId:null,level:1,name:null,value:0,id:Gt};for(let e in Ot)delete Ot[e];let a={};i.forEach(e=>{e.FundId!==1&&c.selectedYear.includes(e.AllocationYear)&&c.selectedFund.includes(e.fundId)&&(a[e.AllocationYear]={underApproval:(a[e.AllocationYear]?a[e.AllocationYear].underApproval:0)+e.TotalUnderApprovalBudget,approved:(a[e.AllocationYear]?a[e.AllocationYear].approved:0)+e.TotalApprovedBudget,launched:(a[e.AllocationYear]?a[e.AllocationYear].launched:0)+e.TotalUSDPlanned})});for(let e in a){let{underApprovalPercent:r,underPlusApprovedPercent:f}=Hn(a[e].underApproval,a[e].approved,a[e].launched);Ot[e]=r>_e||f<_e}return i.forEach(e=>{if(e.FundId!==1&&(c.selectedYear.includes(e.AllocationYear)&&p.fundsInAllYearsKeys.includes(e.fundId)&&!c.fundsInData.includes(e.fundId)&&c.fundsInData.push(e.fundId),c.selectedYear.includes(e.AllocationYear)&&c.selectedFund.includes(e.fundId))){let r=Ot[e.AllocationYear]?"TotalUSDPlanned":"TotalApprovedBudget";n.launchedAllocations+=e[r];let f=n.nodes.find(x=>x.level===2&&x.codeId===p.allocationTypesReversed[e.AllocationSource.toLowerCase()]),b=n.nodes.find(x=>x.level===3&&x.codeId===e.fundId);f?f.value+=e[r]:n.nodes.push({codeId:p.allocationTypesReversed[e.AllocationSource.toLowerCase()],level:2,name:e.AllocationSource,value:e[r],id:"alloctype#"+p.allocationTypesReversed[e.AllocationSource.toLowerCase()]}),b?b.value+=e[r]:n.nodes.push({codeId:e.fundId,level:3,name:p.fundAbbreviatedNames[e.fundId],value:e[r],id:"fund#"+e.fundId});let g=n.links.find(x=>x.target==="alloctype#"+p.allocationTypesReversed[e.AllocationSource.toLowerCase()]),P=n.links.find(x=>x.source==="alloctype#"+p.allocationTypesReversed[e.AllocationSource.toLowerCase()]&&x.target==="fund#"+e.fundId);g?g.value+=e[r]:n.links.push({source:Gt,target:"alloctype#"+p.allocationTypesReversed[e.AllocationSource.toLowerCase()],value:e[r]}),P?P.value+=e[r]:n.links.push({source:"alloctype#"+p.allocationTypesReversed[e.AllocationSource.toLowerCase()],target:"fund#"+e.fundId,value:e[r]}),l.value+=e[r]}}),n.nodes.sort((e,r)=>r.value-e.value),n.nodes.length&&n.nodes.push(l),n}function Fe(i){let n={nodes:[],links:[]},l={codeId:null,level:2,name:null,value:0,id:Gt};i.forEach(e=>{if(+e.fundId==+e.fundId){if(c.selectedYear.includes(e.contributionYear)&&p.fundsInAllYearsKeys.includes(e.fundId)&&!c.fundsInData.includes(e.fundId)&&e.paidAmount&&c.fundsInData.push(e.fundId),c.selectedYear.includes(e.contributionYear)&&c.selectedFund.includes(e.fundId)&&e.paidAmount){let r=n.nodes.find(b=>b.level===1&&b.codeId===e.donorId);r?r.value+=e.paidAmount:n.nodes.push({codeId:e.donorId,level:1,name:p.donorNames[e.donorId],value:e.paidAmount,id:"donor#"+e.donorId});let f=n.links.find(b=>b.source==="donor#"+e.donorId);f?f.value+=e.paidAmount:n.links.push({source:"donor#"+e.donorId,target:Gt,value:e.paidAmount}),l.value+=e.paidAmount}}else console.warn(`cbsank, contribution data missing numeric fund ID: fund ID ${e.fundId}`)}),n.nodes.sort((e,r)=>r.value-e.value),n.nodes=n.nodes.length<=Ct+1?n.nodes:n.nodes.reduce((e,r,f)=>(f<ee?e.push(r):f===ee?e.push({codeId:pt,level:1,name:un,value:r.value,id:"donor#"+pt,othersData:[r]}):(e[ee].value+=r.value,e[ee].othersData.push(r)),e),[]),n.nodes.length&&n.nodes.push(l);let a=n.nodes.map(e=>e.id);return n.links=n.links.reduce((e,r)=>{if(a.includes(r.source))e.push(r);else{let f=e.find(b=>b.source==="donor#"+pt);f?f.value+=r.value:e.push({source:"donor#"+pt,target:Gt,value:r.value})}return e},[]),n}function Un(i){let n=[];return i.forEach(function(a){c.selectedYear.includes(a.AllocationYear)&&c.selectedFund.includes(a.fundId)&&n.push({Year:a.AllocationYear,PooledFund:p.fundAbbreviatedNames[a.fundId],AllocationType:a.AllocationSource.toLowerCase(),Budget:a.TotalUSDPlanned})}),d3.csvFormat(n)}function Wn(i){let n=[];return i.forEach(function(a){c.selectedYear.includes(a.contributionYear)&&c.selectedFund.includes(a.fundId)&&n.push({Year:a.contributionYear,Donor:p.donorNames[a.donorId],"Donor type":p.donorTypes[a.donorId],Paid:a.paidAmount,Pledged:a.pledgedAmount,Total:a.paidAmount+a.pledgedAmount})}),d3.csvFormat(n)}function pe(i,n){let a=d3.select("body").append("div").style("position","fixed").attr("id",o+"DownloadingDiv").style("left",window.innerWidth/2-100+"px").style("top",window.innerHeight/2-100+"px").append("svg").attr("class",o+"DownloadingDivSvg").attr("width",200).attr("height",100),e="Downloading "+i.toUpperCase();ln(a,200,175,e);let r=_.node().getBoundingClientRect();_.attr("width",r.width).attr("height",r.height);let f=["font-size","font-family","font-weight","fill","stroke","stroke-dasharray","stroke-width","opacity","text-anchor","text-transform","shape-rendering","letter-spacing","white-space","dominant-baseline","letter-spacing","paint-order"],b=O.node();g(_.node()),i==="png"?gt.style("opacity",0):Ut.style("opacity",0),Et.style("display","none"),html2canvas(b).then(function(P){_.attr("width",null).attr("height",null),i==="png"?gt.style("opacity",1):Ut.style("opacity",1),i==="png"?Kn(P):_n(P),n&&dt&&d3.select(dt).dispatch("mouseout")});function g(P){if(!P.style)return;let x=getComputedStyle(P);for(let u=0;u<f.length;u++)P.style[f[u]]=x[f[u]];for(let u=0;u<P.childNodes.length;u++)g(P.childNodes[u])}}function Kn(i){let n=new Date,l=Ke+"_"+le(n)+".png";i.toBlob(function(a){let e=URL.createObjectURL(a),r=document.createElement("a");r.download!==void 0?(r.setAttribute("href",e),r.setAttribute("download",l),r.style="visibility:hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r)):window.location.href=e}),Pe(),d3.select("#"+o+"DownloadingDiv").remove()}function _n(i){let n={top:10,bottom:16,left:20,right:30};d3.image("https://raw.githubusercontent.com/CBPFGMS/cbpfgms.github.io/master/img/assets/bilogo.png").then(function(l){let a,r=O.node().getBoundingClientRect(),f=210-n.left*2,b=f*(r.height/r.width),g=180,P;b>g?(P=297+b-g,a=new jsPDF({format:[210*2.834646,P*2.834646],unit:"mm"})):(P=297,a=new jsPDF);let x;v();let u=a.splitTextToSize("Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.",210-n.left-n.right,{fontSize:12}),E=d3.timeFormat("%A, %d %B %Y")(new Date);a.setTextColor(60),a.setFont("helvetica"),a.setFontType("normal"),a.setFontSize(12),a.text(n.left,48,u),a.setTextColor(65,143,222),a.setFont("helvetica"),a.setFontType("bold"),a.setFontSize(16),a.text(Ze,n.left,65),a.setFontSize(12);let G=c.selectedYear.sort(function(S,y){return S-y}).reduce(function(S,y,W){return S+(W>=c.selectedYear.length-2?W>c.selectedYear.length-2?y:y+" and ":y+", ")},""),w=c.selectedYear.length>1?"Selected years: ":"Selected year: ",U=F();a.fromHTML("<div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>Date: <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+E+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+w+"<span style='color: rgb(65, 143, 222); font-weight: 700;'>"+G+"</span></div><div style='margin-bottom: 2px; font-family: Arial, sans-serif; color: rgb(60, 60 60);'>"+U.split("-")[0]+": <span style='color: rgb(65, 143, 222); font-weight: 700;'>"+U.split("-")[1]+"</span></div>",n.left,70,{width:210-n.left-n.right},function(S){x=S}),a.addImage(i,"PNG",n.left,x.y+2,f,b);let A=new Date;a.save("AllocationFlow_"+le(A)+".pdf"),Pe(),d3.select("#"+o+"DownloadingDiv").remove();function v(){let S="\xA9 OCHA CBPF Section "+Ae+" | For more information, please visit cbpf.data.unocha.org";a.setFillColor(65,143,222),a.rect(0,n.top,210,15,"F"),a.setFillColor(236,161,84),a.rect(0,n.top+15,210,2,"F"),a.setFillColor(255,255,255),a.rect(n.left,n.top-1,94,20,"F"),a.ellipse(n.left,n.top+9,5,9,"F"),a.ellipse(n.left+94,n.top+9,5,9,"F"),a.addImage(l,"PNG",n.left+2,n.top,90,18),a.setFillColor(236,161,84),a.rect(0,P-n.bottom,210,2,"F"),a.setTextColor(60),a.setFont("arial"),a.setFontType("normal"),a.setFontSize(10),a.text(S,n.left,P-n.bottom+10)}function F(){let S=c.selectedFund.length===1?"":"s",y=c.selectedFund.length===p.fundsInAllYearsKeys.length?"all funds":c.selectedFund.map(function(W){return p.fundsInAllYears[W]}).sort(function(W,q){return W.localeCompare(q)}).reduce(function(W,q,D){return W+(D>=c.selectedFund.length-2?D>c.selectedFund.length-2?q:q+" and ":q+", ")},"");return"Selected CBPF"+S+"-"+y}})}function Kt(i,n){let l=An/(i.length+1);i.forEach((a,e)=>{n&&(a.x0+=Ve,a.x1+=Ve),a.y0+=l*(e+1),a.y1+=l*(e+1)})}function Zn(i){return[B(i.y0),i.source.x1]}function qn(i){return[B(i.y1),i.target.x0]}function ue(){return d3.linkVertical().source(Zn).target(qn)}function he(i,n){i.each((l,a,e)=>{if(n!=="donor"&&a)return;let r=e[a].textContent;for(;e[a].getComputedTextLength()>fn/(a<2?1.6:1);)d3.select(e[a]).text((r=r.slice(0,-1))+"...")})}function Jn(i){i.forEach(n=>{p.donorNames[n.id+""]=n.donorName,p.donorTypes[n.id+""]=n.donorType,p.donorIsoCodes[n.id+""]=n.donorISO2Code})}function Qn(i){i.forEach(n=>{p.fundNames[n.id+""]=n.PooledFundName,p.fundAbbreviatedNames[n.id+""]=n.PooledFundNameAbbrv,p.fundRegions[n.id+""]=n.RegionName,p.fundIsoCodes[n.id+""]=n.ISO2Code,p.fundIsoCodes3[n.id+""]=n.CountryCode,n.PooledFundName==="CERF"&&(Ce=n.id)})}function Xn(i){i.forEach(n=>{n.CBPFId&&!n.PooledFundName.includes("Closed")&&(p.cbpfIds[n.CBPFId+""]=n.id)})}function to(i){i.forEach(n=>{p.allocationTypes[n.id+""]=n.AllocationName,p.allocationTypesReversed[n.AllocationName.toLowerCase()]=n.id})}function Mt(i,n,l,a){if(localStorage.getItem(i)&&JSON.parse(localStorage.getItem(i)).timestamp>be.getTime()-In){let e=a==="csv"?d3.csvParse(JSON.parse(localStorage.getItem(i)).data,d3.autoType):JSON.parse(localStorage.getItem(i)).data;return console.info(o+" chart info: "+l+" from local storage"),Promise.resolve(e)}else{let e=a==="csv"?d3.csv:d3.json,r=a==="csv"?d3.autoType:null;return e(n,r).then(f=>{try{localStorage.setItem(i,JSON.stringify({data:a==="csv"?d3.csvFormat(f):f,timestamp:be.getTime()}))}catch(b){console.info(o+" chart, "+b)}return console.info(o+" chart info: "+l+" from API"),f})}}function eo(i){if(i.toLowerCase()===We){c.selectedYear.push(We);return}i.split(",").map(l=>+l.trim()).sort((l,a)=>l-a).forEach(l=>{l&&j.includes(l)&&c.selectedYear.push(l)}),c.selectedYear.length||c.selectedYear.push(new Date().getFullYear())}function on(i){if(j.includes(i))return i;for(;!j.includes(i);)i=i>=Ae?i-1:i+1;return i}function no(i){let n=[],l=i.split(",").map(function(e){return e.trim().toLowerCase()});return l.some(function(e){return oo(p.fundsInAllYearsValues).indexOf(e)===-1})?p.fundsInAllYearsKeys.slice():(l.forEach(function(e){p.fundsInAllYearsKeys.forEach(r=>{p.fundsInAllYears[r].toLowerCase()===e&&n.push(r)})}),n)}function oo(i){let n=[];for(let l in i)n.push(i[l].toLowerCase());return n}function sn(){Vn.html(function(){return c.selectedYear.length<=Re?null:"*Selected years: "+c.selectedYear.sort(function(n,l){return n-l}).reduce(function(n,l,a){return n+(a>=c.selectedYear.length-2?a>c.selectedYear.length-2?l:l+" and ":l+", ")},"")})}function fe(i){let n=document.createElementNS("http://www.w3.org/2000/svg","g");n.setAttributeNS(null,"transform",i);let l=n.transform.baseVal.consolidate().matrix;return[l.e,l.f]}function at(i){let n=(~~Math.log10(i)+1)%3,l=n===1?2:n===2?1:0,a=d3.formatPrefix("."+l+"~",i)(i).replace("G","B");if(parseInt(a)===1e3){let e=a[a.length-1],r={k:"M",M:"B"};return 1+(isNaN(e)?r[e]:"")}return a}function an(){gt.style("opacity",0).style("pointer-events","none");let i=O.append("div").attr("class",o+"OverDivHelp"),n=Ie.node().getBoundingClientRect(),l=window.getComputedStyle(Ie.node()),a=ce.node().getBoundingClientRect(),e=Ut.node().getBoundingClientRect(),r=gt.node().getBoundingClientRect(),f=e.height*(900/e.width),b=(n.height+a.height+parseInt(l["margin-top"])+parseInt(l["margin-bottom"]))*(900/e.width),g=i.append("svg").attr("viewBox","0 0 900 "+(Xt+f+b)),P=[{text:"CLOSE",width:90},{text:"GO TO HELP PORTAL",width:180}],x=g.selectAll(null).data(P).enter().append("g");x.append("rect").attr("rx",4).attr("ry",4).style("stroke","rgba(0, 0, 0, 0.3)").style("stroke-width","1px").style("fill",pn).style("cursor","pointer").attr("y",6).attr("height",22).attr("width",function(A){return A.width}).attr("x",function(A,v){return 900-C[1]-A.width-(v?P[0].width+8:0)}).on("click",function(A,v){gt.style("opacity",1).style("pointer-events","all"),i.remove(),v&&window.open(vn,"help_portal")}),x.append("text").attr("class",o+"AnnotationMainText").attr("text-anchor","middle").attr("x",function(A,v){return 900-C[1]-A.width/2-(v?P[0].width+8:0)}).attr("y",22).text(function(A){return A.text}),[{x:4,y:f+(b-a.height)*(e.width/900),width:892,height:a.height*(900/e.width),xTooltip:300*(e.width/900),yTooltip:(f+b+8)*(e.width/900),text:"Use these checkboxes to select the CBPFs. A disabled checkbox means that the correspondent CBPF has no data for that year."},{x:4,y:14+f+b,width:892,height:30,xTooltip:300*(e.width/900),yTooltip:(f+b+50)*(e.width/900),text:"Use these buttons to select the year. Double click or press ALT when clicking to select multiple years"},{x:4,y:68+f+b,width:892,height:420,xTooltip:300*(e.width/900),yTooltip:(f+b+250)*(e.width/900),text:"This area shows selected contributions. Hover over the donors or links to see additional information."},{x:4,y:508+f+b,width:892,height:500,xTooltip:300*(e.width/900),yTooltip:(f+b+500)*(e.width/900),text:"This area shows selected allocations. Hover over the allocation types, funds or links to see additional information."}].forEach(function(A){g.append("rect").attr("rx",4).attr("ry",4).attr("x",A.x).attr("y",A.y).attr("width",A.width).attr("height",A.height).style("stroke",te).style("stroke-width","3px").style("fill","none").style("opacity",.5).attr("class",o+"HelpRectangle").attr("pointer-events","all").on("mouseover",function(){let v=this;w(A.xTooltip,A.yTooltip,A.text,v)}).on("mouseout",U)});let E=g.append("rect").attr("x",900/2-180).attr("y",244).attr("width",360).attr("height",50).attr("pointer-events","none").style("fill","white").style("stroke","#888"),G=g.append("text").attr("class",o+"AnnotationExplanationText").attr("font-family","Roboto").attr("font-size","18px").style("fill","#222").attr("text-anchor","middle").attr("x",900/2).attr("y",264).attr("pointer-events","none").text("Hover over the elements surrounded by a blue rectangle to get additional information").call(ao,350);function w(A,v,F,S){G.style("opacity",0),E.style("opacity",0),g.selectAll("."+o+"HelpRectangle").style("opacity",.1),d3.select(S).style("opacity",1);let y=O.node().getBoundingClientRect();z.style("top",v+"px").style("left",A+"px").style("display","block").html(null).append("div").style("width","300px").html(F)}function U(){z.style("display","none"),G.style("opacity",1),E.style("opacity",1),g.selectAll("."+o+"HelpRectangle").style("opacity",.5)}}function so(i,n){i.each(function(){let l=d3.select(this),a=l.text().split(/\s+/).reverse(),e,r=[],f=0,b=1.1,g=l.attr("y"),P=l.attr("x"),x=0,u=l.text(null).append("tspan").attr("x",P).attr("y",g).attr("dy",x+"em");for(;e=a.pop();)r.push(e),u.text(r.join(" ")),u.node().getComputedTextLength()>n&&(r.pop(),u.text(r.join(" ")),r=[e],u=l.append("tspan").attr("x",P).attr("y",g).attr("dy",++f*b+x+"em").text(e))})}function ao(i,n){i.each(function(){let l=d3.select(this),a=l.text().split(/\s+/).reverse(),e,r=[],f=0,b=1.1,g=l.attr("y"),P=l.attr("x"),x=0,u=l.text(null).append("tspan").attr("x",P).attr("y",g).attr("dy",x+"em");for(;e=a.pop();)r.push(e),u.text(r.join(" ")),u.node().getComputedTextLength()>n&&(r.pop(),u.text(r.join(" ")),r=[e],u=l.append("tspan").attr("x",P).attr("y",g).attr("dy",++f*b+x+"em").text(e))})}function io(){let i="\xA9 OCHA CBPF Section "+Ae;Bn&&(i+=" | For more information, please visit <a href='https://cbpf.data.unocha.org'>cbpf.data.unocha.org</a>"),qe.append("div").attr("class","d3chartFooterText").html(i)}function lo(i){let n=i.selectAll("tspan").size(),l=i.node().getBBox().height,a=l/(n*2);i.transition().duration(k).attr("transform","translate(0,"+(n===1?0:-l/2+a)+")")}function it(i){if(+i==0)return 0;let n,l={Y:Math.pow(10,24),Z:Math.pow(10,21),E:Math.pow(10,18),P:Math.pow(10,15),T:Math.pow(10,12),G:Math.pow(10,9),B:Math.pow(10,9),M:Math.pow(10,6),k:Math.pow(10,3),h:Math.pow(10,2),da:Math.pow(10,1),d:Math.pow(10,-1),c:Math.pow(10,-2),m:Math.pow(10,-3),\u03BC:Math.pow(10,-6),n:Math.pow(10,-9),p:Math.pow(10,-12),f:Math.pow(10,-15),a:Math.pow(10,-18),z:Math.pow(10,-21),y:Math.pow(10,-24)};return Object.keys(l).some(function(a){if(i.indexOf(a)>0)return n=parseFloat(i.split(a)[0])*l[a],!0}),n}function ln(i,n,l,a){let e=i.append("g").attr("class",o+"d3chartwheelGroup").attr("transform","translate("+n/2+","+l/4+")"),r=e.append("text").attr("text-anchor","middle").style("font-family","Roboto").style("font-weight","bold").style("font-size","11px").attr("y",50).attr("class","contributionColorFill").text(a),f=d3.arc().outerRadius(25).innerRadius(20),b=e.append("path").datum({startAngle:0,endAngle:0}).classed("contributionColorFill",!0).attr("d",f);g();function g(){b.transition().duration(1e3).attrTween("d",function(x){let u=d3.interpolate(0,Math.PI*2);return function(E){return x.endAngle=u(E),f(x)}}).on("end",P)}function P(){b.transition().duration(1e3).attrTween("d",function(x){let u=d3.interpolate(0,Math.PI*2);return function(E){return x.startAngle=u(E),f(x)}}).on("end",function(x){x.startAngle=0,g()})}}function Pe(){let i=d3.select("."+o+"d3chartwheelGroup");i.select("path").interrupt(),i.remove()}}})();})();
